<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Creating the cssr R package</title>
  <meta name="description" content="Creating the <code>cssr</code> R package" />
  <meta name="generator" content="bookdown #bookdown:version# and GitBook 2.6.7" />

  <meta property="og:title" content="Creating the cssr R package" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Creating the cssr R package" />
  
  
  

<meta name="author" content="Gregory Faletto" />


<meta name="date" content="2023-02-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



<!--bookdown:title:start-->
<div id="header">
<h1 class="title">Creating the <code>cssr</code> R package</h1>
<p class="author"><em>Gregory Faletto</em></p>
<p class="date"><em>February 01, 2023</em></p>
</div>
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">
<!--bookdown:toc2:start-->
<ul>
<li><a href="#introduction" id="toc-introduction"><span class="toc-section-number">1</span> Introduction</a></li>
<li><a href="#overview" id="toc-overview"><span class="toc-section-number">2</span> Overview</a>
<ul>
<li><a href="#background" id="toc-background"><span class="toc-section-number">2.1</span> Background</a>
<ul>
<li><a href="#cpss" id="toc-cpss"><span class="toc-section-number">2.1.1</span> Complementary pairs stability selection</a></li>
<li><a href="#cluster-stability-selection" id="toc-cluster-stability-selection"><span class="toc-section-number">2.1.2</span> Cluster stability selection</a></li>
</ul></li>
<li><a href="#outline" id="toc-outline"><span class="toc-section-number">2.2</span> Outline</a></li>
<li><a href="#package-setup" id="toc-package-setup"><span class="toc-section-number">2.3</span> Package setup</a></li>
</ul></li>
<li><a href="#css" id="toc-css"><span class="toc-section-number">3</span> The core function: <code>css</code></a>
<ul>
<li><a href="#main-components-of-css" id="toc-main-components-of-css"><span class="toc-section-number">3.1</span> Main components of <code>css</code></a>
<ul>
<li><a href="#generating-subsamples" id="toc-generating-subsamples"><span class="toc-section-number">3.1.1</span> Generating subsamples</a></li>
<li><a href="#forming-selection-matrices" id="toc-forming-selection-matrices"><span class="toc-section-number">3.1.2</span> Forming selection matrices</a></li>
</ul></li>
<li><a href="#helper-functions" id="toc-helper-functions"><span class="toc-section-number">3.2</span> Helper functions</a></li>
</ul></li>
<li><a href="#tests-for-main-functions-in-cssr" id="toc-tests-for-main-functions-in-cssr"><span class="toc-section-number">4</span> Tests for main functions in <code>cssr</code></a></li>
<li><a href="#sel-and-pred" id="toc-sel-and-pred"><span class="toc-section-number">5</span> Selection and prediction functions</a></li>
<li><a href="#other-useful" id="toc-other-useful"><span class="toc-section-number">6</span> Other useful functions</a></li>
<li><a href="#wrapper-functions" id="toc-wrapper-functions"><span class="toc-section-number">7</span> Convenient wrapper functions</a></li>
<li><a href="#competitor-methods" id="toc-competitor-methods"><span class="toc-section-number">8</span> Competitor Methods</a></li>
<li><a href="#documenting-the-package-and-adding-readme" id="toc-documenting-the-package-and-adding-readme"><span class="toc-section-number">9</span> Documenting the package and adding README</a>
<ul>
<li><a href="#add-readme" id="toc-add-readme"><span class="toc-section-number">9.1</span> Add README</a></li>
</ul></li>
</ul>
<!--bookdown:toc2:end-->
      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Creating the <code>cssr</code> R package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<!-- This Rmd file contains all the code needed to define an R package.  Press "Knit" in RStudio or more generally run `rmarkdown::render("name-of-this-file.Rmd")` to generate the R package.  Remember that when you want to modify anything about the R package, you should modify this document rather than the package that is outputted.
-->
<div id="introduction" class="section level1 hasAnchor" number="1">
<h1 class="hasAnchor"><span class="header-section-number">1</span> Introduction<a href="#introduction" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Cluster stability selection is a feature selection method designed to allow stability selection to work effectively in the presence of highly correlated features. It was proposed in <a href="https://arxiv.org/abs/2201.00494">this paper</a>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">###&quot;faletto2022&quot;###</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Faletto, G., &amp; Bien, J. (2022). Cluster Stability Selection.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \emph{arXiv preprint arXiv:2201.00494}.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://arxiv.org/abs/2201.00494}.</span></span></code></pre></div>
<p>This bookdown uses <a href="https://jacobbien.github.io/litr-project/">literate programming</a> to define the <code>cssr</code> R package, which implements the procedures described in the paper. For a light introduction demonstrating how to use <code>cssr</code>, please see the package’s vignette <a href="">here</a>.</p>
<p>TODO: CREATE VIGNETTE FOR PACKAGE AND PKGDOWN SITE FOR PACKAGE AND THEN LINK IN THE ABOVE TO THE VIGNETTE THAT APPEARS IN THE PKGDOWN SITE.</p>
</div>
<div id="overview" class="section level1 hasAnchor" number="2">
<h1 class="hasAnchor"><span class="header-section-number">2</span> Overview<a href="#overview" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="background" class="section level2 hasAnchor" number="2.1">
<h2 class="hasAnchor"><span class="header-section-number">2.1</span> Background<a href="#background" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="cpss" class="section level3 hasAnchor" number="2.1.1">
<h3 class="hasAnchor"><span class="header-section-number">2.1.1</span> Complementary pairs stability selection<a href="#cpss" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The following paper introduces complementary pairs subsampling:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">###&quot;shah2013&quot;###</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Shah, R. D., &amp; Samworth, R. J.</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (2013). Variable selection with error control: Another look at stability</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection. \emph{Journal of the Royal Statistical Society. Series B:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Statistical Methodology}, 75(1), 55–80.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://doi.org/10.1109/RITA.2014.2302071}.</span></span></code></pre></div>
<p>Subsamples <span class="math inline">\(A_1, \ldots, A_B \subset [n]\)</span> of size <span class="math inline">\(\lfloor n/2 \rfloor\)</span> are drawn, as well as subsamples <span class="math inline">\(\overline{A}_b \subset [n]\)</span> of the same size with <span class="math inline">\(A_b \cap \overline{A}_b = \emptyset\)</span>. Our function <code>getSubsamps()</code> implements this subsampling.</p>
<p>Writing <span class="math inline">\(\hat{S}^\lambda(A)\)</span> for the selected features from applying a variable selection procedure with tuning parameter <span class="math inline">\(\lambda\)</span> on the data in a subset <span class="math inline">\(A\subset[n]\)</span>, Shah and Samworth suggest computing the following:</p>
<p><span class="math display">\[
\hat{\Pi}_B^{\text{(SS)}}(j) = \frac{1}{2B} \sum_{b=1}^B \left[1\left\{j \in \hat{S}^\lambda \left( A_b \right)\right\} + 1\left\{j \in \hat{S}^\lambda (\overline{A}_b)\right\} \right].
\]</span></p>
</div>
<div id="cluster-stability-selection" class="section level3 hasAnchor" number="2.1.2">
<h3 class="hasAnchor"><span class="header-section-number">2.1.2</span> Cluster stability selection<a href="#cluster-stability-selection" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We compute the proportion of the time that a feature <span class="math inline">\(j \in [p]\)</span> is selected for at least one <span class="math inline">\(\lambda \in \Lambda\)</span>:
<span class="math display">\[
\hat{\Pi}_B(j) := \frac{1}{2B} \sum_{b=1}^B \left[ 1\left\{   j \in \bigcup_{\lambda \in \Lambda} \hat{S}^\lambda \left( A_b \right) \right\} + 1\left\{  j \in  \bigcup_{\lambda \in \Lambda} \hat{S}^\lambda (\overline{A}_b)\right\} \right].
\]</span></p>
<p>We also compute a similar quantity at the level of clusters: For every cluster <span class="math inline">\(C_k\)</span>, we calculate the proportion of the time that at least one feature from <span class="math inline">\(C_k\)</span> is selected for at least one <span class="math inline">\(\lambda \in \Lambda\)</span>:</p>
<p><span class="math display">\[
\hat{\Theta}_B(C_k) :=  \frac{1}{2B} \sum_{b=1}^B \left[  1 \left\{    C_k \cap \bigcup_{\lambda \in \Lambda} \hat{S}^{\lambda}\left(A_b \right) \neq \emptyset   \right\} +  1 \left\{   C_k \cap \bigcup_{\lambda \in \Lambda} \hat{S}^{\lambda}\left(\overline{A}_b \right) \neq \emptyset  \right\} \right].
\]</span></p>
<p>We then calculate <em>cluster representatives</em> <span class="math inline">\(\boldsymbol{X}_{\cdot C_k}^{\text{rep}}\)</span> as weighted averages of the cluster members:</p>
<p><span class="math display">\[
\boldsymbol{X}_{\cdot C_k}^{\text{rep}}:=  \sum_{j \in C_k } w_{kj} \boldsymbol{X}_{\cdot j}.
\]</span>
We allow for several choices of weights:</p>
<ul>
<li><strong>Weighted averaged cluster stability selection:</strong></li>
</ul>
<p><span class="math display">\[
w_{kj} = \frac{\hat{\Pi}_B(j)}{\sum_{j&#39; \in C_k} \hat{\Pi}_B(j&#39;)} \qquad \forall j \in C_k  .
\]</span></p>
<ul>
<li><strong>Simple averaged cluster stability selection:</strong></li>
</ul>
<p><span class="math display">\[
w_{kj} = \frac{1}{\left| C_k \right|}  \qquad \forall j \in C_k .
\]</span></p>
<ul>
<li><strong>Sparse cluster stability selection:</strong> For each <span class="math inline">\(j \in C_k\)</span>,</li>
</ul>
<p><span class="math display">\[
w_{kj} = \left. 1 \left\{ j \in \underset{j&#39; \in C_k}{\arg \max}  \left\{ \hat{\Pi}_B(j&#39;) \right\} \right\} \middle/ \left| \underset{j&#39; \in C_k}{\arg \max}  \left\{ \hat{\Pi}_B(j&#39;)  \right\} \right| \right. .
\]</span></p>
</div>
</div>
<div id="outline" class="section level2 hasAnchor" number="2.2">
<h2 class="hasAnchor"><span class="header-section-number">2.2</span> Outline<a href="#outline" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will define the functions in this package in steps.</p>
<ul>
<li>First we define <a href="#css">the workhorse function of the package</a>, <code>css()</code>. This function takes as inputs a data set (<span class="math inline">\(X\)</span>, <span class="math inline">\(y\)</span>), a feature selection method <span class="math inline">\(\hat S^\lambda(\cdot)\)</span>, and clusters of features appearing in the data: <span class="math inline">\(C_1,\ldots,C_K\)</span>. It calculates random subsamples of the data (<span class="math inline">\(A_1,\ldots, A_B\)</span> and <span class="math inline">\(\bar A_1,\ldots, \bar A_B\)</span>) and gets selected sets of features on each subsample (i.e., <span class="math inline">\(\hat S^\lambda(A_b)\)</span> and <span class="math inline">\(\hat S^\lambda(\bar A_b)\)</span>). It returns a <span class="math inline">\(2B\times p\)</span> matrix of indicator variables for whether each feature was selected on each subsample (one row for each subsample, one column for each feature). It returns a similar <span class="math inline">\(2B\times K\)</span> matrix of indicator variables for whether any feature from each cluster was selected on each subsample. This is the most computationally intensive step of cluster stability selection, so it is isolated within its own function that is designed to be run only once on a data set.</li>
<li>Next we <a href="#sel-and-pred">define functions</a> that take these indicator matrices and return useful output–for example, selected sets of features, or predictions on test data. These outputs depend on the selected features, which themselves depend on user-selected parameters (for example, the cutoff for selection proportions for selected clusters).</li>
<li>Next, we define <a href="#wrapper-functions">wrapper functions</a> that compute all of the above in one step in a user-friendly way. (These functions are not recommended for large data sets or for “power users” who may want to call these functions multiple times on the same data set, because these wrapper functions make a new call to <code>css()</code> every time they are called, which is slow and computationally wasteful if the inputs to <code>css()</code> are not changed.)</li>
<li>Finally, we define <a href="#other-useful">some other useful functions</a>, like functions that generate clustered data to use for simulations or testing, or select a tuning parameter for the lasso via cross-validation.</li>
</ul>
</div>
<div id="package-setup" class="section level2 hasAnchor" number="2.3">
<h2 class="hasAnchor"><span class="header-section-number">2.3</span> Package setup<a href="#package-setup" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Before proceeding to the actual functionality of the package, we start by specifying the information needed in the DESCRIPTION file of the R package.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">create_package</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> <span class="st">&quot;.&quot;</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fields =</span> <span class="fu">list</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Package =</span> params<span class="sc">$</span>package_name,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Version =</span> <span class="st">&quot;0.1.1&quot;</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Title =</span> <span class="st">&quot;Cluster Stability Selection&quot;</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Description =</span> <span class="st">&quot;Implementation of Cluster Stability Selection (Faletto and Bien 2022).&quot;</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Authors@R</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">person</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">given =</span> <span class="st">&quot;Gregory&quot;</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="st">&quot;Faletto&quot;</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">email =</span> <span class="st">&quot;gregory.faletto@marshall.usc.edu&quot;</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">role =</span> <span class="fu">c</span>(<span class="st">&quot;aut&quot;</span>, <span class="st">&quot;cre&quot;</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      ), <span class="fu">person</span>(</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">given =</span> <span class="st">&quot;Jacob&quot;</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="st">&quot;Bien&quot;</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">email =</span> <span class="st">&quot;jbien@usc.edu&quot;</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">role =</span> <span class="fu">c</span>(<span class="st">&quot;aut&quot;</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_mit_license</span>(<span class="at">copyright_holder =</span> <span class="st">&quot;F. Last&quot;</span>)</span></code></pre></div>
<p>We also define the package-level documentation that shows up when someone types <code>package?cssr</code> in the console:</p>
<pre class="package_doc"><code>#&#39; Cluster Stability Selection
#&#39;
#&#39; DESCRIBE PACKAGE HERE AND PERHAPS POINT USER TO PKGDOWN WEBSITE ONCE 
#&#39; IT EXISTS.
#&#39; 
#&#39; @docType package
#&#39; @seealso \code{\link{css}}</code></pre>
</div>
</div>
<div id="css" class="section level1 hasAnchor" number="3">
<h1 class="hasAnchor"><span class="header-section-number">3</span> The core function: <code>css</code><a href="#css" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The main inputs that <code>css()</code> accepts are the following:</p>
<ul>
<li>a design matrix <code>X</code></li>
<li>a response <code>y</code></li>
<li>a selection method <code>fitfun</code> with specified tuning parameter <code>lambda</code>. This specifies <span class="math inline">\(\hat{S}^\lambda(A)\)</span>. In particular:</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">###&quot;param-fitfun&quot;###</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param fitfun A function; the feature selection function used on each</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; subsample by cluster stability selection. This can be any feature selection</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; method; the only requirement is that it accepts the arguments (and only the</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; arguments) `X`, `y`, and `lambda` and returns an integer vector that is a </span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; subset of `1:p`. For example, `fitfun` could be best subset selection or </span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; forward stepwise selection or LARS and `lambda` could be the desired model </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; size; or `fitfun` could be the elastic net and `lambda` could be a length-two</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vector specifying lambda and alpha. Default is `cssLasso`, an implementation </span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of lasso (relying on the R package `glmnet`), where `lambda` must be a </span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; positive numeric specifying the L1 penalty for the `lasso`.</span></span></code></pre></div>
<p>and</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">###&quot;param-lambda&quot;###</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda A tuning parameter or set of tuning parameters that may be used</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; by the feature selection method `fitfun`. In the default case when</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `fitfun = cssLasso`, lambda should be a numeric: the penalty to use for each</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; lasso fit. (`css()` does not require lambda to be any particular object because</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for a user-specified feature selection method `fitfun`, lambda can be an</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; arbitrary object. See the description of `fitfun` below.)</span></span></code></pre></div>
<ul>
<li>a specification of which features belong together in highly correlated clusters. This specifies the clusters <span class="math inline">\(C_1,\ldots, C_K\)</span>. In particular:</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">###&quot;param-clusters&quot;###</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A list of integer vectors; each vector should contain the </span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of a cluster of features (a subset of `1:p`). (If there is only one</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster, clusters can either be a list of length 1 or an integer vector.)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; All of the provided clusters must be non-overlapping. Every feature not</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; appearing in any cluster will be assumed to be unclustered (that is, they</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will be treated as if they are in a &quot;cluster&quot; containing only themselves). If</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters is a list of length 0 (or a list only containing clusters of length</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 1), then `css()` returns the same results as stability selection (so the</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; returned `feat_sel_mat` will be identical to `clus_sel_mat`). Names for the</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters will be needed later; any clusters that are not given names in the</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided list will be given names automatically by `css()`. Default is </span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `list()` (so no clusters are specified).</span></span></code></pre></div>
<ul>
<li>and a specification of the type of subsamples. For now we only consider the <a href="#cpss">complementary subsets sampling of Shah and Samworth</a>. However, we have included an option for Meinshausen-Buhlmann sampling which we may add later:</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">###&quot;param-sampling_type&quot;###</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sampling_type A character vector; either &quot;SS&quot; or &quot;MB&quot;. For &quot;MB&quot;,</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; all B subsamples are drawn randomly (as proposed by Meinshausen and Bühlmann</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 2010). For &quot;SS&quot;, in addition to these B subsamples, the B complementary pair</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; subsamples will be drawn as well (see Faletto and Bien 2022 or Shah and</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Samworth 2013 for details). Default is &quot;SS&quot;, and &quot;MB&quot; is not supported yet.</span></span></code></pre></div>
<p>The number of subsamples is also up to the user:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">###&quot;param-B&quot;###</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param B Integer or numeric; the number of subsamples. Note: For</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `sampling_type==&quot;MB&quot;` the total number of subsamples will be `B`; for</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `sampling_type=&quot;SS&quot;` the number of subsamples will be `2*B`. Default is 100</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for `sampling_type=&quot;MB&quot;` and 50 for `sampling_type=&quot;SS&quot;`.</span></span></code></pre></div>
<p>In this section, we will build the function <code>css()</code> step-by-step.</p>
<ul>
<li><p>First, <code>css()</code> creates random subsamples of the data: <span class="math inline">\(A_1,\ldots, A_B\)</span> (and <span class="math inline">\(\bar A_1,\ldots, \bar A_B\)</span> for Shah-Samworth subsampling). This is implemented in the function <code>createSubsamples()</code>.</p></li>
<li><p>Next, <code>css()</code> executes the specified feature selection method <span class="math inline">\(\hat S^\lambda(\cdot)\)</span> on each subsample. This generates a binary matrix, <code>feat_sel_mat</code>, with one row for each subsample and one column for each feature in <code>X</code>. In each row, the entry corresponding to each feature equals 1 if the feature was selected on that subsample and 0 otherwise. <code>feat_sel_mat</code> is one of the outputs of <code>css()</code>; it is used to calculate the selection proportions for individual features. This is implemented in the function <code>getSelMatrix()</code>.</p></li>
<li><p>So far this is the same as the original stability selection procedure. Now we take into account the clusters. The function <code>getClusterSelMatrix()</code> takes in the formatted clusters as well as <code>feat_sel_mat</code> and generates the binary matrix <code>clus_sel_mat</code>, which contains selection indicators for each cluster. <code>clus_sel_mat</code> has the same number of rows as <code>feat_sel_mat</code> and one column for each cluster rather than one for each feature. This is used to calculate the cluster selection proportions.</p></li>
</ul>
<p>The function <code>css()</code> is specified below. (There are some extra details that I omitted in the above description for brevity; you can read the full details below.)</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Cluster Stability Selection</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Executes cluster stability selection algorithm. Takes subsamples of data,</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; executes feature selection algorithm on each subsample, and returns matrices</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of feature selection indicators as well as cluster selection indicators.</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X An n x p numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; p &gt;= 2 features/predictors.</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y The response; can be anything that takes the form of an</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; n-dimensional vector, with the ith entry corresponding to the ith row of X.</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Typically (and for default `fitfun = cssLasso`), `y` should be an n-dimensional</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; numeric vector.</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>param<span class="sc">-</span>lambda<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>param<span class="sc">-</span>clusters<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>param<span class="sc">-</span>fitfun<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>param<span class="sc">-</span>sampling_type<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>param<span class="sc">-</span>B<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prop_feats_remove Numeric; if `prop_feats_remove` is greater than 0,</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; then on each subsample, each feature is randomly dropped from the design</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; matrix that is provided to `fitfun` with probability `prop_feats_remove`</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (independently across features). That is, in a typical subsample,</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `prop_feats_remove*p` features will be dropped (though this number will vary).</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; This is similar in spirit (but distinct from) extended stability selection</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (Beinrucker et. al. 2016); see their paper for some of the benefits of</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; dropping features (besides increasing computational speed and decreasing</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; memory requirements). For `sampling_type=&quot;SS&quot;`, the features dropped in</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; each complementary pair of subsamples are identical in order to ensure that</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the theoretical guarantees of Faletto and Bien (2022) are retained within</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; each individual pair of subsamples. (Note that this feature is not</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; investigated either theoretically or in simulations by Faletto and Bien</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 2022). Must be between 0 and 1. Default is 0.</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param train_inds Optional; an integer or numeric vector containing the</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of observations in `X` and `y` to set aside for model training by the</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; function `getCssPreds()` after feature selection. (This will only work if `y` is</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; real-valued, because `getCssPreds()` using ordinary least squares regression to</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generate predictions.) If `train_inds` is not provided, all of the observations</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in the provided data set will be used for feature selection.</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param num_cores Optional; an integer. If using parallel processing, the</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; number of cores to use for parallel processing (`num_cores` will be supplied</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; internally as the `mc.cores` argument of `parallel::mclapply()`).</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list containing the following items:</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{`feat_sel_mat`}{A `B` (or `2*B` for `sampling_type=&quot;SS&quot;`) x `p` numeric (binary) matrix. `feat_sel_mat[i, j] = 1` if feature `j` was selected by the base feature selection method on subsample `i`, and 0 otherwise.}</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{`clus_sel_mat`}{A `B` (or `2*B` for SS sampling) x `length(clusters)` numeric (binary) matrix. `clus_sel_mat[i, j] = 1` if at least one feature from cluster j was selected by the base feature selection method on subsample `i`, and 0 otherwise.}</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{`X`}{The `X` matrix provided to `css()`, coerced from a data.frame to a </span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; matrix if needed.}</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{`y`}{The `y` vector provided to `css()`.}</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{`clusters`}{A named list of integer vectors containing all of the clusters provided to `css()`, as well as size 1 clusters of any features not listed in any</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of the clusters provided to `css()`. All clusters will have names; any </span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters not provided with a name in the input to `css()` will be given names</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; automatically by `css()` (of the form c1, etc.).}</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{`train_inds`}{Identical to the `train_inds` provided to `css()`.}</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>faletto2022<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>shah2013<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Meinshausen, N., &amp; Bühlmann, P. (2010). Stability Selection. \emph{Journal of the Royal</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Statistical Society. Series B: Statistical Methodology}, 72(4), 417–473.</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://rss.onlinelibrary.wiley.com/doi/full/10.1111/j.1467-9868.2010.00740.x}.</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Beinrucker, A., Dogan, Ü., &amp;</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Blanchard, G. (2016). Extensions of stability selection using subsamples of</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; observations and covariates. \emph{Statistics and Computing}, 26(5), 1059-</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 1077. \url{https://doi.org/10.1007/s11222-015-9589-y}.</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Jerome Friedman, Trevor Hastie, Robert Tibshirani (2010). Regularization Paths for Generalized</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Linear Models via Coordinate Descent. \emph{Journal of Statistical Software},</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 33(1), 1-22. URL \url{https://www.jstatsoft.org/v33/i01/}.</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>css <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, lambda, <span class="at">clusters =</span> <span class="fu">list</span>(), <span class="at">fitfun =</span> cssLasso,</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampling_type =</span> <span class="st">&quot;SS&quot;</span>, <span class="at">B =</span> <span class="fu">ifelse</span>(sampling_type <span class="sc">==</span> <span class="st">&quot;MB&quot;</span>, 100L, 50L),</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop_feats_remove =</span> <span class="dv">0</span>, <span class="at">train_inds =</span> <span class="fu">integer</span>(), <span class="at">num_cores =</span> 1L</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>    ){</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>    check_list <span class="ot">&lt;-</span> <span class="fu">checkCssInputs</span>(X, y, lambda, clusters, fitfun, sampling_type,</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>        B, prop_feats_remove, train_inds, num_cores)</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="ot">&lt;-</span> check_list<span class="sc">$</span>feat_names</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> check_list<span class="sc">$</span>X</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> check_list<span class="sc">$</span>clusters</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(check_list)</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>    train_inds <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(train_inds)</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Create subsamples</span></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>    sel_inds <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, train_inds)</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>    n_sel <span class="ot">&lt;-</span> <span class="fu">length</span>(sel_inds)</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(n_sel <span class="sc">&lt;</span> <span class="dv">4</span>){</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Too many training indices provided (must be at least 4 observations left for feature selection, and ideally many more)&quot;</span>)</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>    subsamps_object <span class="ot">&lt;-</span> <span class="fu">createSubsamples</span>(n_sel, p, B, sampling_type,</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>        prop_feats_remove)</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Get matrix of selected feature sets from subsamples</span></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.matrix</span>(y))</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>    feat_sel_mat <span class="ot">&lt;-</span> <span class="fu">getSelMatrix</span>(X[sel_inds, ], y[sel_inds], lambda, B,</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>        sampling_type, subsamps_object, num_cores, fitfun)</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="sc">!</span><span class="fu">is.na</span>(feat_names))){</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(feat_sel_mat) <span class="ot">&lt;-</span> feat_names</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> feat_names</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Get selection proportions for clusters corresponding to each feature</span></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>    clus_sel_mat <span class="ot">&lt;-</span> <span class="fu">getClusterSelMatrix</span>(clusters, feat_sel_mat)</span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check outputs</span></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(clus_sel_mat)))</span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(clus_sel_mat) <span class="sc">==</span> <span class="fu">names</span>(clusters)))</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>    ret <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">feat_sel_mat =</span> feat_sel_mat,</span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>        <span class="at">clus_sel_mat =</span> clus_sel_mat,</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>        <span class="at">X =</span> X,</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> y,</span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">clusters =</span> clusters,</span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>        <span class="at">train_inds =</span> train_inds</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">class</span>(ret) <span class="ot">&lt;-</span> <span class="st">&quot;cssr&quot;</span></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(ret)</span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>css()</code> and the other functions in this section are located at the end of this document. Next, we’ll build the individual functions one at a time. (The one function above that I didn’t mention at all is <code>checkCssInputs()</code>, which confirms that the inputs to <code>css()</code> are as expected and does some basic formatting on the inputs. To streamline presentation, this and other helper functions are specified later.)</p>
<div id="main-components-of-css" class="section level2 hasAnchor" number="3.1">
<h2 class="hasAnchor"><span class="header-section-number">3.1</span> Main components of <code>css</code><a href="#main-components-of-css" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="generating-subsamples" class="section level3 hasAnchor" number="3.1.1">
<h3 class="hasAnchor"><span class="header-section-number">3.1.1</span> Generating subsamples<a href="#generating-subsamples" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The function <code>createSubsamples()</code> is responsible for generating the subsamples <span class="math inline">\(A_b\)</span>, where <span class="math inline">\(b\)</span> ranges from 1 to <span class="math inline">\(B\)</span> or 1 to <span class="math inline">\(2B\)</span> depending on the type of subsampling:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Creates lists of subsamples for stability selection.</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n Integer or numeric; sample size of the data set.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p Integer or numeric; number of features.</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>param<span class="sc">-</span>B<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>param<span class="sc">-</span>sampling_type<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param num_feats_remove Integer; number of features select automatically on</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; every iteration. Determined earlier from input prop_feats_remove to css.</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list of length `B` (or `2*B` for `sampling_type = &quot;SS&quot;`). If</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `prop_feats_remove = 0`, each list element is an integer vector of length</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `floor(n/2)` containing the indices of a subsample of `1:n`. (For</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `sampling_type==&quot;SS&quot;`, the last `B` subsamples will be complementary pairs of</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the first `B` subsamples; see Faletto and Bien 2022 or Shah and Samworth 2013</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for details.) If `prop_feats_remove &gt; 0`, each element is a named list with</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; members &quot;subsample&quot; (same as above) and &quot;feats_to_keep&quot;, a logical vector</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of length `p`; `feats_to_keep[j] = TRUE` if feature `j` is chosen for this</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; subsample, and false otherwise.</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>faletto2022<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>shah2013<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>createSubsamples <span class="ot">&lt;-</span> <span class="cf">function</span>(n, p, B, sampling_type, <span class="at">prop_feats_remove=</span><span class="dv">0</span>){</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(n) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(n) <span class="sc">|</span> <span class="fu">is.integer</span>(n))</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n <span class="sc">==</span> <span class="fu">round</span>(n))</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(p) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(p) <span class="sc">|</span> <span class="fu">is.integer</span>(p))</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">==</span> <span class="fu">round</span>(p))</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkSamplingType</span>(sampling_type)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkPropFeatsRemove</span>(prop_feats_remove, p)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(prop_feats_remove <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        subsamples <span class="ot">&lt;-</span> <span class="fu">getSubsamps</span>(n, B, sampling_type)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(subsamples)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># In this case, we generate subsamples as well as logical vectors</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># of features to keep</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        subsamps_and_feats <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>        subsamples <span class="ot">&lt;-</span> <span class="fu">getSubsamps</span>(n, B, sampling_type)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Logical p-vector, where each entry is TRUE with probability</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 1 - prop_feats_remove</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>            feats_to_keep_i <span class="ot">&lt;-</span> <span class="fu">as.logical</span>(stats<span class="sc">::</span><span class="fu">rbinom</span>(<span class="at">n=</span>p, <span class="at">size=</span><span class="dv">1</span>,</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>                <span class="at">prob=</span><span class="dv">1</span> <span class="sc">-</span> prop_feats_remove))</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Make sure at least two entries are equal to TRUE (so that at</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>            <span class="co"># least two features are present for every subsample)--if not,</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>            <span class="co"># randomly choose features to add</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span>(<span class="fu">sum</span>(feats_to_keep_i) <span class="sc">&lt;</span> <span class="dv">2</span>){</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>                false_inds <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span>feats_to_keep_i)</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>                sel_feat <span class="ot">&lt;-</span> <span class="fu">sample</span>(false_inds, <span class="at">size=</span><span class="dv">1</span>)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>                feats_to_keep_i[sel_feat] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>            subsamps_and_feats[[i]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">subsample=</span>subsamples[[i]],</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>                <span class="at">feats_to_keep=</span>feats_to_keep_i)</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(sampling_type<span class="sc">==</span><span class="st">&quot;SS&quot;</span>){</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">length</span>(subsamples) <span class="sc">==</span> <span class="dv">2</span><span class="sc">*</span>B)</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Keep the same features as in the other subsample (this</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>                <span class="co"># ensures that the theoretical guarantee of Shah and Samworth</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 2013 remains valid on every individual pair of subsamples)</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>                subsamps_and_feats[[B <span class="sc">+</span> i]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">subsample=</span>subsamples[[B <span class="sc">+</span> i]],</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>                    <span class="at">feats_to_keep=</span>subsamps_and_feats[[i]]<span class="sc">$</span>feats_to_keep)</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check output</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">names</span>(subsamps_and_feats) <span class="sc">==</span> <span class="fu">c</span>(<span class="st">&quot;subsample&quot;</span>,</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;feats_to_keep&quot;</span>)))</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(subsamps_and_feats)</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shouldn&#39;t be possible to reach this part of function</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;createSubsamples failed to return anything&quot;</span>)</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Notice that <code>createSubsamples()</code> calls some helper functions to check the inputs (again, these are specified later in the helper functions section). <code>createSubsamples()</code> also calls the workhorse function <code>getSubsamps()</code> to generate a list of subsamples.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generate list of subsamples</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#` Generate list of `B` (or `2*B` for sampling_type=&quot;SS&quot;) subsamples of size</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#` `n/2`</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n Integer or numeric; sample size of the data set.</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>param<span class="sc">-</span>B<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>param<span class="sc">-</span>sampling_type<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list of length `B` (or `2*B` for `sampling_type=&quot;SS&quot;`), where each</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; element is an integer vector of length `floor(n/2)` containing the indices</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of a subsample of `1:n`. For `sampling_type==&quot;SS&quot;`, the last `B` subsamples</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will be complementary pairs of the first `B` subsamples (see Faletto and</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Bien 2022 or Shah and Samworth 2013 for details).</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>faletto2022<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>shah2013<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>getSubsamps <span class="ot">&lt;-</span> <span class="cf">function</span>(n, B, sampling_type){</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    subsamples <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        subsamples[[i]] <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(<span class="at">n=</span>n, <span class="at">size=</span><span class="fu">floor</span>(n<span class="sc">/</span><span class="dv">2</span>), <span class="at">replace=</span><span class="cn">FALSE</span>))</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(subsamples) <span class="sc">==</span> B)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">(gregfaletto): add support for sampling_type=&quot;MB&quot;</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(sampling_type<span class="sc">==</span><span class="st">&quot;SS&quot;</span>){</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For the ith entry, take a subsample of size floor(n/2) from the</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># remaining n - floor(n/2) observations. (Only necessary to actually</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># take the subsample if n is odd; if not, the set we want is</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># setdiff(1:n, subsamples[[i]]), so skip the sample function.)</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(n<span class="sc">/</span><span class="dv">2</span> <span class="sc">==</span> <span class="fu">floor</span>(n<span class="sc">/</span><span class="dv">2</span>)){</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>                subsamples[[B <span class="sc">+</span> i]] <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, subsamples[[i]]))</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span>{</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                subsamples[[B <span class="sc">+</span> i]] <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample</span>(<span class="at">x=</span><span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>                    subsamples[[i]]), <span class="at">size=</span><span class="fu">floor</span>(n<span class="sc">/</span><span class="dv">2</span>), <span class="at">replace=</span><span class="cn">FALSE</span>))</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check output</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(subsamples[[B <span class="sc">+</span> i]]))</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">all</span>(subsamples[[B <span class="sc">+</span> i]] <span class="sc">==</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>                <span class="fu">round</span>(subsamples[[B <span class="sc">+</span> i]])))</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">floor</span>(n<span class="sc">/</span><span class="dv">2</span>) <span class="sc">==</span> <span class="fu">length</span>(subsamples[[B <span class="sc">+</span> i]]))</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">length</span>(subsamples[[B <span class="sc">+</span> i]]) <span class="sc">==</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>                <span class="fu">length</span>(<span class="fu">unique</span>(subsamples[[B <span class="sc">+</span> i]])))</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(subsamples) <span class="sc">==</span> <span class="dv">2</span><span class="sc">*</span>B)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(subsamples)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="forming-selection-matrices" class="section level3 hasAnchor" number="3.1.2">
<h3 class="hasAnchor"><span class="header-section-number">3.1.2</span> Forming selection matrices<a href="#forming-selection-matrices" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next function called in the body of <code>css()</code> is <code>getSelMatrix()</code>, which records for each feature <span class="math inline">\(j\)</span> and subsample <span class="math inline">\(b\)</span> whether <span class="math inline">\(j\in \hat S^\lambda(A_b)\)</span>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generates matrix of selection indicators from stability selection.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x an n x p numeric matrix or a data.frame containing the predictors.</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y A response vector; can be any response that takes the form of a</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; length n vector and is used (or not used) by fitfun. Typically (and for</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; default fitfun = cssLasso), y should be an n-dimensional numeric vector</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; containing the response.</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>param<span class="sc">-</span>lambda<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>param<span class="sc">-</span>B<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>param<span class="sc">-</span>sampling_type<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param subsamps_object A list of length `B` (or `2*B` if `sampling_type=&quot;SS&quot;`),</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; where each element is one of the following: \item{subsample}{An integer</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vector of size `n/2` containing the indices of the observations in the</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; subsample.} \item{drop_var_input}{A named list containing two elements: one</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; named &quot;subsample&quot;, matching the previous description, and a logical vector</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; named &quot;feats_to_keep&quot; containing the indices of the features to be</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; automatically selected.} (The first object is the output of the function</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; createSubsamples when the provided prop_feats_remove is 0, the default, and</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the second object is the output of createSubsamples when prop_feats_remove &gt;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 0.)</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param num_cores Optional; an integer. If using parallel processing, the</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; number of cores to use for parallel processing (num_cores will be supplied</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; internally as the mc.cores argument of parallel::mclapply).</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>param<span class="sc">-</span>fitfun<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A binary integer matrix of dimension `B` x `p` (if sampling_type ==</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;MB&quot;) or `2*B` x `p` (if sampling_type == &quot;SS&quot;). res[i, j] = 1 if feature j</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; was selected on subsample i and equals 0 otherwise. (That is, each row is a</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected set.)</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>getSelMatrix <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, lambda, B, sampling_type, subsamps_object,</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    num_cores, <span class="at">fitfun=</span>cssLasso){</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(x))</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)))</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(x)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(y) <span class="sc">==</span> n)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.matrix</span>(y))</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Intentionally don&#39;t check y or lambda further to allow for flexibility--these</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inputs should be checked within fitfun.</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkSamplingType</span>(sampling_type)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get list of selected feature sets from subsamples</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    res_list <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(<span class="at">X=</span>subsamps_object, <span class="at">FUN=</span>cssLoop, <span class="at">x=</span>x, <span class="at">y=</span>y,</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda=</span>lambda, <span class="at">fitfun=</span>fitfun, <span class="at">mc.cores=</span>num_cores)</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store selected sets in B x p (or `2*B` x p for &quot;SS&quot;) binary matrix</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(sampling_type<span class="sc">==</span><span class="st">&quot;SS&quot;</span>){</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>        res <span class="ot">&lt;-</span> <span class="fu">matrix</span>(0L, <span class="dv">2</span><span class="sc">*</span>B, p)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(sampling_type<span class="sc">==</span><span class="st">&quot;MB&quot;</span>){</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>        res <span class="ot">&lt;-</span> <span class="fu">matrix</span>(0L, B, p)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;!(sampling_type %in% c(SS, MB)) (don&#39;t know how to set dimensions of res&quot;</span>)</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(res_list) <span class="sc">==</span> <span class="fu">nrow</span>(res))</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get selected sets into matrix res</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(res)){</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(res_list[[i]]) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If no features are selected, don&#39;t fill in anything in this row</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">next</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.integer</span>(res_list[[i]])){</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>            <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;failed on iteration&quot;</span>, i))</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>            <span class="fu">print</span>(res_list[[i]])</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stop</span>(<span class="st">&quot;Something seems to be wrong with the feature selection method (fitfun failed to return an integer vector)&quot;</span>)</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(res_list[[i]]) <span class="sc">&lt;=</span> p <span class="sc">&amp;</span> <span class="fu">length</span>(res_list[[i]]) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res_list[[i]])))</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">max</span>(res_list[[i]]) <span class="sc">&lt;=</span> p)</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">min</span>(res_list[[i]]) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(res_list[[i]]) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(res_list[[i]])))</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="sc">!</span>(<span class="st">&quot;try-error&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(res_list[[i]]) <span class="sc">|</span></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;error&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(res_list[[i]]) <span class="sc">|</span></span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;simpleError&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(res_list[[i]]) <span class="sc">|</span></span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;condition&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(res_list[[i]])))</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store selected variables in the ith row of res</span></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>        res[i, res_list[[i]]] <span class="ot">&lt;-</span> 1L</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(sampling_type<span class="sc">==</span><span class="st">&quot;SS&quot;</span>){</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(res) <span class="sc">==</span> <span class="dv">2</span><span class="sc">*</span>B)</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(res) <span class="sc">==</span> B)</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(res) <span class="sc">==</span> p)</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(res <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)))</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(res)</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Again, <code>getSelMatrix()</code> uses some helper functions to check the inputs for safety. <code>getSelMatrix()</code> leverages the function <code>parallel::mclapply()</code> package, in order to allow for parallel processing if the user has set this up. This requires a helper function <code>cssLoop()</code>, which is also specified in the later section for helper functions.
We add the <code>parallel</code> package to the DESCRIPTION file:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_package</span>(<span class="st">&quot;parallel&quot;</span>)</span></code></pre></div>
<pre><code>## ✔ Adding &#39;parallel&#39; to Imports field in DESCRIPTION
## • Refer to functions with `parallel::fun()`</code></pre>
<p><code>getSelMatrix()</code> also uses a feature selection function <code>fitfun</code> as an input. <code>fitfun</code> can be provided by the user as an input to <code>css()</code>. We provide one default <code>fitfun</code>, <code>cssLasso()</code>, which works on a real-valued response y given a specified penalty parameter lambda &gt; 0. Both for its own importance and to show an example of a valid <code>fitfun</code>, we show <code>cssLasso()</code> here.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Provided fitfun implementing the lasso</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Function used to select features with the lasso on each subsample in cluster</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; stability selection. Uses glmnet implementation of the lasso.</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X A design matrix containing the predictors. (In practice this will</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be a subsample of the full design matrix provided to `css()`.)</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y A numeric vector containing the response.</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda Numeric; a nonnegative number for the lasso penalty to use</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; on each subsample. (For now, only one lambda value can be provided to</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `cssLasso()`; in the future, we plan to allow for multiple lambda values to be</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided to `cssLasso()`, as described in Faletto and Bien 2022.)</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return An integer vector; the indices of the features selected by the lasso.</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references </span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>faletto2022<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Jerome Friedman, Trevor Hastie,</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Robert Tibshirani (2010). Regularization Paths for Generalized Linear Models</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; via Coordinate Descent. \emph{Journal of Statistical Software}, 33(1), 1-22.</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; URL \url{https://www.jstatsoft.org/v33/i01/}.</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>cssLasso <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, lambda){</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">(gregfaletto) allow cssLasso to accept a vector of lambda values rather</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># than just a single one.</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkCssLassoInputs</span>(X, y, lambda)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit a lasso path (full path for speed, per glmnet documentation)</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    lasso_model <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(X, y, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all.equal</span>(<span class="fu">class</span>(lasso_model), <span class="fu">c</span>(<span class="st">&quot;elnet&quot;</span>, <span class="st">&quot;glmnet&quot;</span>)))</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get coefficients at desired lambda</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(lasso_model, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>,</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">s=</span>lambda, <span class="at">exact=</span><span class="cn">TRUE</span>, <span class="at">newx=</span>X, <span class="at">x=</span>X, <span class="at">y=</span>y)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(pred[[<span class="dv">1</span>]])){<span class="fu">return</span>(<span class="fu">integer</span>())}</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.data.frame</span>(pred))</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span>(<span class="st">&quot;try-error&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(pred) <span class="sc">|</span> <span class="st">&quot;error&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(pred) <span class="sc">|</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;simpleError&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(pred) <span class="sc">|</span> <span class="st">&quot;condition&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(pred)))</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">dim</span>(pred)) <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>        selected_glmnet <span class="ot">&lt;-</span> pred[, <span class="dv">1</span>]</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">dim</span>(pred)) <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>        selected_glmnet <span class="ot">&lt;-</span> pred[, <span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">dim</span>(pred)) <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>        selected_glmnet <span class="ot">&lt;-</span> pred</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;length(dim(pred)) not 1, 2, or 3&quot;</span>)</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_glmnet) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_glmnet) <span class="sc">&lt;=</span> <span class="fu">ncol</span>(X))</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(selected_glmnet <span class="sc">==</span> <span class="fu">round</span>(selected_glmnet)))</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_glmnet) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(selected_glmnet)))</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    selected_glmnet <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(selected_glmnet)</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    selected <span class="ot">&lt;-</span> <span class="fu">sort</span>(selected_glmnet)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(selected)</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Notice that <code>cssLasso()</code> depends on the package <code>glmnet</code>, and calls the function <code>checkCssLassoInputs()</code>, which verifies that the inputs to <code>cssLasso()</code> are as needed. (In particular, the function <code>css()</code> imposes very few requirements on <code>lambda</code> and <code>y</code> to allow the end user flexibility for any specified <code>fitfun</code>. <code>checkCssLassoInputs()</code> ensures that <code>y</code> is a real-valued response, <code>lambda</code> is a nonnegative real number, etc.) <code>checkCssLassoInputs()</code> is specified in the helper functions section later.</p>
<p>We add <code>glmnet</code> to the DESCRIPTION file as well:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_package</span>(<span class="st">&quot;glmnet&quot;</span>)</span></code></pre></div>
<pre><code>## ✔ Adding &#39;glmnet&#39; to Imports field in DESCRIPTION
## • Refer to functions with `glmnet::fun()`</code></pre>
<p>Finally, <code>getClusterSelMatrix()</code> is the last significant function called within <code>css()</code>. It takes the information from <code>getSelMatrix()</code>, i.e. whether feature <span class="math inline">\(j\in\hat S^\lambda(A_b)\)</span>, and outputs for every cluster <span class="math inline">\(C\)</span> whether <span class="math inline">\(C\cap S^\lambda(A_b)\neq\emptyset\)</span>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Get cluster selection matrix</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Given a matrix of feature selection indicator variables and a list of</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters of features, returns a matrix of cluster indicator variables.</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A named list where each entry is an integer vector of indices</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of features that are in a common cluster, as in the output of formatClusters.</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (The length of list clusters is equal to the number of clusters.) All</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; identified clusters must be non-overlapping, and all features must appear in</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; exactly one cluster (any unclustered features should be in their own</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;cluster&quot; of size 1).</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param res A binary integer matrix. es[i, j] = 1 if feature j was selected</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; on subsample i and equals 0 otherwise, as in the output of `getSelMatrix()`.</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (That is, each row is a selected set.)</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A binary integer matrix with the same number of rows</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; as res and length(clusters) columns. Entry i, j is 1 if at least</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; one member of cluster j was selected on subsample i, and 0 otherwise.</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>getClusterSelMatrix <span class="ot">&lt;-</span> <span class="cf">function</span>(clusters, res){</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check input</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkGetClusterSelMatrixInput</span>(clusters, res)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(res)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    n_clusters <span class="ot">&lt;-</span> <span class="fu">length</span>(clusters)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Matrix of cluster selection proportions (with n_clusters columns)</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    res_n_clusters <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(0L, <span class="fu">nrow</span>(res)<span class="sc">*</span>n_clusters), <span class="at">nrow=</span><span class="fu">nrow</span>(res),</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncol=</span>n_clusters)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(res_n_clusters) <span class="ot">&lt;-</span> <span class="fu">names</span>(clusters)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusters){</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify rows of res where at least one feature from this cluster</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># was selected</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        rows_j_sel <span class="ot">&lt;-</span> <span class="fu">apply</span>(res, <span class="dv">1</span>, <span class="cf">function</span>(x){<span class="fu">any</span>(x[clusters[[j]]] <span class="sc">==</span> <span class="dv">1</span>)})</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Put ones in these rows of res_n_clusters[, j]</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        res_n_clusters[rows_j_sel, j] <span class="ot">&lt;-</span> 1L</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(clusters[[j]]) <span class="sc">&lt;=</span> <span class="dv">1</span>){</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">next</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(res_n_clusters))</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">identical</span>(<span class="fu">colnames</span>(res_n_clusters), <span class="fu">names</span>(clusters)))</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(res_n_clusters <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)))</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(res_n_clusters) <span class="sc">==</span> <span class="fu">length</span>(clusters))</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(res_n_clusters)</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The helper function <code>checkGetClusterSelMatrixInput()</code> verifies the inputs to <code>getClusterSelMatrix()</code>.</p>
<p>With the above and the helper functions below, the <code>css()</code> function is complete!</p>
</div>
</div>
<div id="helper-functions" class="section level2 hasAnchor" number="3.2">
<h2 class="hasAnchor"><span class="header-section-number">3.2</span> Helper functions<a href="#helper-functions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Below, we specify some of the helper functions for <code>css()</code>, which are less important for understanding what <code>css()</code> does.</p>
<ul>
<li>The function <code>checkCssInputs()</code> is called at the beginning of the <code>css()</code> function. It confirms that the inputs to <code>css()</code> are as expected. Also, <code>css()</code> allows some flexibility in how the inputs are formatted, and <code>checkCssInputs()</code> converts the inputs into consistent formats for later use.
<ul>
<li>The function <code>checkCssClustersInput()</code> is called within <code>checkCssInputs()</code>, and specifically checks the clusters input.</li>
<li><code>formatClusters()</code> modifies clusters, ensuring every feature appears in exactly one cluster (any unclustered features are put in a “cluster” by themselves).
<ul>
<li><code>checkFormatClustersInput()</code> verifies the input to <code>formatClusters()</code> for safety (this might seem a little redundant here, but <code>formatClusters()</code> is also called by different functions in this package).
<ul>
<li><code>checkY()</code> ensures (here and elsewhere) that the provided <code>y</code> is as expected. (In particular, in general the inputted <code>y</code> can be a vector of any type as long as the specified <code>fitfun</code> can handle <code>y</code> appropriately. For some function inputs, <code>y</code> must be a numeric vector. <code>checkY()</code> enforces this, among other things.)</li>
</ul></li>
<li><code>checkClusters()</code> verifies that the output of <code>formatClusters()</code> is as expected.</li>
<li><code>getPrototypes()</code> identifies the prototypes of each cluster–the feature within each cluster that has the largest marginal sample correlation with <code>y</code>.
<ul>
<li><code>identifyPrototype()</code> is the workhorse of <code>getPrototypes()</code>, identifying the prototype given a single cluster.
<ul>
<li><code>corFunction()</code> is a helper function called within <code>identifyPrototype()</code> to calculate the absolute value of the correlation between two vectors.</li>
</ul></li>
</ul></li>
</ul></li>
<li><code>checkSamplingType()</code> ensures that the input <code>sampling_type</code> is as expected.</li>
<li><code>checkB()</code> ensures that the input <code>B</code> is as expected.</li>
<li><code>checkPropFeatsRemove()</code> ensures that the input <code>prop_feats_remove</code> is as expected.</li>
</ul></li>
<li>The function <code>cssLoop()</code> is called within <code>css()</code>. In particular, it is a helper function needed in order to allow for parallel processing of the feature selection method on each of the subsamples.
<ul>
<li><code>checkCssLoopOutput()</code> verifies that the output of <code>cssLoop()</code> is as expected. This is particularly important because the user can specify their own feature selection method; <code>checkCssLoopOutput()</code> verifies that the output of the feature selection method is valid, and provides an informative error message if not.</li>
</ul></li>
<li><code>checkCssLassoInputs()</code> checks that the inputs to the provided <code>fitfun</code>, <code>cssLasso()</code>, are as needed.</li>
<li><code>checkGetClusterSelMatrixInput()</code> verifies that the input to <code>getClusterSelMatrix()</code> is as expected.</li>
</ul>
<p>Tests are written for all of these functions and appear as early as possible after the function is defined. (For functions that don’t depend on any other functions, tests appear immediately after the function; for functions with dependencies, the tests appear after all dependencies have been defined.)</p>
<p><code>checkCssInputs()</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that inputs to the function `css()` are as expected,</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; and modify inputs if needed</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X An n x p numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; p &gt;= 2 features/predictors.</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y The response; can be anything that takes the form of an</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; n-dimensional vector, with the ith entry corresponding to the ith row of X.</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Typically (and for default fitfun = cssLasso), y should be an n-dimensional</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; numeric vector.</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>param<span class="sc">-</span>lambda<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;&lt;</span>param<span class="sc">-</span>clusters<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param fitfun A function; the feature selection function used on each</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; subsample by cluster stability selection. This can be any feature selection</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; method; the only requirement is that it accepts the arguments (and only the</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; arguments) X, y, and lambda and returns an integer vector that is a subset of</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 1:p. For example, fitfun could be best subset selection or forward stepwise</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection or LARS and lambda could be the desired model size; or fitfun could be the</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; elastic net and lambda could be a length-two vector specifying lambda and</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; alpha. Default is cssLasso, an implementation of lasso (relying on the R</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; package glmnet), where lambda must be a positive numeric specifying the L1</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; penalty for the lasso.</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sampling_type A character vector; either &quot;SS&quot; or &quot;MB&quot;. For &quot;MB&quot;,</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; all B subsamples are drawn randomly (as proposed by Meinshausen and Bühlmann</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 2010). For &quot;SS&quot;, in addition to these B subsamples, the B complementary pair</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; subsamples will be drawn as well (see Faletto and Bien 2022 or Shah and</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Samworth 2013 for details). Default is &quot;SS&quot;, and &quot;MB&quot; is not supported yet.</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param B Integer or numeric; the number of subsamples. Note: For</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; sampling.type==&quot;MB&quot; the total number of subsamples will be `B`; for</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; sampling_type=&quot;SS&quot; the number of subsamples will be `2*B`. Default is 100</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for sampling_type=&quot;MB&quot; and 50 for sampling_type=&quot;SS&quot;.</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prop_feats_remove Numeric; if prop_feats_remove is greater than 0,</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; then on each subsample, each feature is randomly dropped from the design</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; matrix that is provided to fitfun with probability prop_feats_remove</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (independently across features). That is, in a typical subsample,</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; prop_feats_remove*p features will be dropped (though this number will vary).</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; This is similar in spirit (but distinct from) extended stability selection</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (Beinrucker et. al. 2016); see their paper for some of the benefits of</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; dropping features (besides increasing computational speed and decreasing</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; memory requirements). For sampling_type=&quot;SS&quot;, the features dropped in</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; each complementary pair of subsamples are identical in order to ensure that</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the theoretical guarantees of Faletto and Bien (2022) are retained within</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; each individual pair of subsamples. (Note that this feature is not</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; investigated either theoretically or in simulations by Faletto and Bien</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 2022). Must be between 0 and 1. Default is 0.</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param train_inds Optional; an integer or numeric vector containing the</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of observations in X and y to set aside for model training by the</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; function getCssPreds after feature selection. (This will only work if y is</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; real-valued, because getCssPreds using ordinary least squares regression to</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generate predictions.) If train_inds is not provided, all of the observations</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in the provided data set will be used for feature selection.</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param num_cores Optional; an integer. If using parallel processing, the</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; number of cores to use for parallel processing (num_cores will be supplied</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; internally as the mc.cores argument of parallel::mclapply).</span></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with the following elements: \item{feat_names}{A </span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; character vector containing the column names of X (if the provided X</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; had column names). If the provided X did not have column names, feat_names</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will be NA.} \item{X}{The provided X, converted to a matrix if it was</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; originally provided as a data.frame, and with feature names removed if they</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; had been provided.}\item{clusters}{A list of integer vectors; each vector</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will contain the indices of a cluster of features. Any duplicated clusters</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided in the input will be removed.}</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>checkCssInputs <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, lambda, clusters, fitfun, sampling_type, B,</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    prop_feats_remove, train_inds, num_cores){</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X) <span class="sc">|</span> <span class="fu">is.data.frame</span>(X))</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>    clust_names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(clusters)) <span class="sc">&amp;</span> <span class="fu">is.list</span>(clusters)){</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>        clust_names <span class="ot">&lt;-</span> <span class="fu">names</span>(clusters)</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if x is a matrix; if it&#39;s a data.frame, convert to matrix.</span></span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.data.frame</span>(X)){</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X)</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> X[, <span class="fu">colnames</span>(X) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X))</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(X)))</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)</span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(X))){</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>        feat_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X)</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(X))){</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>        feat_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X)</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(feat_names) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(feat_names) <span class="sc">==</span> p)</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.na</span>(feat_names))</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(y) <span class="sc">==</span> n)</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Intentionally don&#39;t check y or lambda further to allow for flexibility--these</span></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inputs should be checked within fitfun.</span></span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check clusters argument</span></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> <span class="fu">checkCssClustersInput</span>(clusters)</span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Format clusters into a list where all features are in exactly one</span></span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cluster (any unclustered features are put in their own &quot;cluster&quot; of size</span></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1).</span></span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> <span class="fu">formatClusters</span>(clusters, <span class="at">p=</span>p, <span class="at">clust_names=</span>clust_names)<span class="sc">$</span>clusters</span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">class</span>(fitfun) <span class="sc">==</span> <span class="st">&quot;function&quot;</span>)</span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(fitfun) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">identical</span>(<span class="fu">formals</span>(fitfun), <span class="fu">formals</span>(cssLasso))){</span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>        err_mess <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;fitfun must accept arguments named X, y, and lambda. Detected arguments to fitfun:&quot;</span>,</span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste</span>(<span class="fu">names</span>(<span class="fu">formals</span>(fitfun)), <span class="at">collapse=</span><span class="st">&quot;, &quot;</span>))</span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(err_mess)</span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkSamplingType</span>(sampling_type)</span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkB</span>(B)</span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkPropFeatsRemove</span>(prop_feats_remove, p)</span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(train_inds) <span class="sc">|</span> <span class="fu">is.integer</span>(train_inds))</span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(train_inds) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(train_inds)))</span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">round</span>(train_inds) <span class="sc">==</span> train_inds))</span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(train_inds) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(train_inds)))</span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(train_inds <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(train_inds) <span class="sc">&lt;=</span> n)</span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(train_inds) <span class="sc">&lt;=</span> n <span class="sc">-</span> <span class="dv">2</span>)</span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(train_inds) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(num_cores) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(num_cores) <span class="sc">|</span> <span class="fu">is.numeric</span>(num_cores))</span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(num_cores))</span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(num_cores <span class="sc">==</span> <span class="fu">round</span>(num_cores))</span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(num_cores <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(num_cores <span class="sc">&lt;=</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">feat_names=</span>feat_names, <span class="at">X=</span>X, <span class="at">clusters=</span>clusters))</span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>checkCssClustersInput:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that clusters input to css is as expected</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>param<span class="sc">-</span>clusters<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return Same as the input, but all of the clusters will be coerced to</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; integers.</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>checkCssClustersInput <span class="ot">&lt;-</span> <span class="cf">function</span>(clusters){</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(clusters))</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.list</span>(clusters)){</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(clusters)))</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(clusters) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(clusters)))</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(clusters) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(clusters)){</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">length</span>(clusters[[i]]) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(clusters[[i]])))</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(clusters[[i]])))</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(clusters[[i]]) <span class="sc">|</span> <span class="fu">is.numeric</span>(clusters[[i]]))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">all</span>(clusters[[i]] <span class="sc">==</span> <span class="fu">round</span>(clusters[[i]])))</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">all</span>(clusters[[i]] <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>                clusters[[i]] <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(clusters[[i]])</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">length</span>(clusters) <span class="sc">&gt;=</span> <span class="dv">2</span>){</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check that clusters are non-overlapping</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(clusters) <span class="sc">-</span> <span class="dv">1</span>)){</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span>(j <span class="cf">in</span> (i<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(clusters)){</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(clusters[[i]], clusters[[j]])) <span class="sc">!=</span> <span class="dv">0</span>){</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>                            error_mes <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Overlapping clusters detected; clusters must be non-overlapping. Overlapping clusters: &quot;</span>,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>                                i, <span class="st">&quot;, &quot;</span>, j, <span class="st">&quot;.&quot;</span>, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">stop</span>(error_mes)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>                        }</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If clusters is not a list, it should be a vector of indices of</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># features that are in the (one) cluster</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(clusters) <span class="sc">|</span> <span class="fu">is.integer</span>(clusters))</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(clusters) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(clusters)))</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(clusters)))</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(clusters) <span class="sc">|</span> <span class="fu">is.numeric</span>(clusters))</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(clusters <span class="sc">==</span> <span class="fu">round</span>(clusters)))</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(clusters <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>        clusters <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(clusters)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(clusters)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>tests for checkCssClustersInput:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkCssClustersInput works&quot;</span>, {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Intentionally don&#39;t provide clusters for all feature, mix up formatting,</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># etc.</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>4L, <span class="at">green_cluster=</span>5L<span class="sc">:</span>8L)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkCssClustersInput</span>(good_clusters)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># clusters</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="fu">length</span>(<span class="fu">names</span>(res)))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res))))</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">names</span>(res))))</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res))))</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  clust_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res)){</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    clust_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(clust_feats, res[[i]])</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">unique</span>(clust_feats)))</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">intersect</span>(clust_feats,</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>                                                               <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>)))</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying other inputs</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  unnamed_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(1L<span class="sc">:</span>3L, 5L<span class="sc">:</span>8L)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkCssClustersInput</span>(unnamed_clusters)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># clusters</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  clust_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res)){</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    clust_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(clust_feats, res[[i]])</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">unique</span>(clust_feats)))</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">intersect</span>(clust_feats,</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>                                                               <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>)))</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssClustersInput</span>(<span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>)),</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Overlapping clusters detected; clusters must be non-overlapping. Overlapping clusters: 1, 2.&quot;</span>,</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssClustersInput</span>(<span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>)),</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(clusters) == length(unique(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssClustersInput</span>(<span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">as.integer</span>(<span class="cn">NA</span>))),</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.na(clusters) are not all TRUE&quot;</span>,</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssClustersInput</span>(<span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">5</span>))),</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(clusters[[i]]) == length(unique(clusters[[i]])) is not TRUE&quot;</span>,</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssClustersInput</span>(<span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="sc">-</span><span class="dv">1</span>)),</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(clusters[[i]] &gt;= 1) is not TRUE&quot;</span>,</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssClustersInput</span>(<span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.6</span>)),</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(clusters == round(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Single cluster</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>  res_sing_clust <span class="ot">&lt;-</span> <span class="fu">checkCssClustersInput</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res_sing_clust), <span class="dv">4</span>)</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p><code>formatClusters()</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Formats clusters in standardized way, optionally estimating cluster</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; prototypes</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters Either an integer vector of a list of integer vectors; each</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vector should contain the indices of a cluster of features. (If there is only</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; one cluster, clusters can either be a list of length 1 or simply an integer</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vector.) If clusters is specified then R is ignored.</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p integer or numeric; the numbe of features in x (should match </span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; ncol(x), if x is provided)</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clust_names A character vector of the names of the clusters in</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters.</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param get_prototypes Logical: if TRUE, will identify prototype from each</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster (the feature from each cluster that is most correlated with the</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response) for the protolasso. In this case, x and y must be provided.</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x n x p numeric matrix; design matrix. Only needs to be provided if</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; get_prototypes is TRUE.</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y Numeric response vector; only needs to be provided if get_prototypes</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; is TRUE. Note: in general, the css function does not require y to be a</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; numeric vector, because the provided fitfun could use a different form of y</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (for example, a categorical response variable). However, y must be numeric in</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; order to provide prototypes because the prototypes are determined using the</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; correlation between cluster members (columns of x) and y.</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param R Numeric p x p matrix; not currently used. Entry ij contains the </span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;substitutive value&quot; of feature i for feature j (diagonal must consist of</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; ones, all entries must be between 0 and 1, and matrix must be symmetric)</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with the following elements: \item{clusters}{A named</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; list where each entry is an integer vector of indices of features that are in</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; a common cluster. (The length of list clusters is equal to the number of</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters.) All identified clusters are non-overlapping. All features appear</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in exactly one cluster (any unclustered features will be put in their own</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;cluster&quot; of size 1).} \item{multiple}{Logical; TRUE if there is more than</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; one cluster of size greater than 1, FALSE otherwise.} \item{prototypes}{only</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; returned if get_prototypes=TRUE. An integer vector whose length is equal to</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the number of clusters. Entry i is the index of the feature belonging to</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster i that is most highly correlated with y (that is, the prototype for</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the cluster, as in the protolasso; see Reid and Tibshirani 2016).}</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references Reid, S., &amp; Tibshirani, R. (2016). Sparse regression and marginal</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; testing using cluster prototypes. \emph{Biostatistics}, 17(2), 364–376.</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://doi.org/10.1093/biostatistics/kxv049}.</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>formatClusters <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">clusters=</span><span class="cn">NA</span>, <span class="at">p=</span><span class="sc">-</span><span class="dv">1</span>, <span class="at">clust_names=</span><span class="cn">NA</span>, </span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">get_prototypes=</span><span class="cn">FALSE</span>, <span class="at">x=</span><span class="cn">NA</span>, <span class="at">y=</span><span class="cn">NA</span>, <span class="at">R=</span><span class="cn">NA</span>){</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> <span class="fu">checkFormatClustersInput</span>(clusters, p, clust_names,</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>        get_prototypes, x, y, R)</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    multiple <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">lengths</span>(clusters) <span class="sc">&gt;</span> <span class="dv">1</span>)){ <span class="co"># &amp; length(clusters) &gt; 1</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only care about clusters with more than one element (only ones that</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># need to be treated differently)</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># keep track of whether there&#39;s more than one cluster or not</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>        multiple <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">lengths</span>(clusters) <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">&gt;</span> <span class="dv">1</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For any features not already in a cluster, add a cluster containing only</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that feature</span></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    orig_length_clusters <span class="ot">&lt;-</span> <span class="fu">length</span>(clusters)</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>        feat_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(orig_length_clusters <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>orig_length_clusters){</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>                <span class="co"># If i is in cluster j, break out of this loop and consider the</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>                <span class="co"># next i</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(i <span class="sc">%in%</span> clusters[[j]]){</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>                    feat_i_found <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If feature i wasn&#39;t found in any cluster, add a cluster containing</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># just feature i</span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span>feat_i_found){</span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>            clusters[[<span class="fu">length</span>(clusters) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> i</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>    n_clusters <span class="ot">&lt;-</span> <span class="fu">length</span>(clusters)</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add names to clusters</span></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(<span class="fu">names</span>(clusters))){</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(clusters) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;c&quot;</span>, <span class="dv">1</span><span class="sc">:</span>n_clusters, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># What clusters need names?</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>        unnamed_clusts <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(<span class="fu">names</span>(clusters)) <span class="sc">|</span> <span class="fu">names</span>(clusters) <span class="sc">==</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(unnamed_clusts) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>            proposed_clust_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;c&quot;</span>, unnamed_clusts, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Replace any proposed cluster names that are already in use</span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">any</span>(proposed_clust_names <span class="sc">%in%</span> <span class="fu">names</span>(clusters))){</span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>                proposed_clust_names[proposed_clust_names <span class="sc">%in%</span> <span class="fu">names</span>(clusters)] <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;c&quot;</span>,</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>                    unnamed_clusts[proposed_clust_names <span class="sc">%in%</span> <span class="fu">names</span>(clusters)] <span class="sc">+</span> p,</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>                    <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>            while_counter <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span>(<span class="fu">any</span>(proposed_clust_names <span class="sc">%in%</span> <span class="fu">names</span>(clusters))){</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>                proposed_clust_names[proposed_clust_names <span class="sc">%in%</span> <span class="fu">names</span>(clusters)] <span class="ot">&lt;-</span> <span class="fu">paste</span>(proposed_clust_names[proposed_clust_names <span class="sc">%in%</span> <span class="fu">names</span>(clusters)],</span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;_1&quot;</span>, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>                while_counter <span class="ot">&lt;-</span> while_counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(while_counter <span class="sc">&gt;=</span> <span class="dv">100</span>){</span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">stop</span>(<span class="st">&quot;Function formatClusters stuck in an infinite while loop&quot;</span>)</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">length</span>(unnamed_clusts) <span class="sc">==</span> <span class="fu">length</span>(proposed_clust_names))</span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>            <span class="fu">names</span>(clusters)[unnamed_clusts] <span class="ot">&lt;-</span> proposed_clust_names</span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkClusters</span>(clusters, p)</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(multiple))</span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(multiple) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(multiple))</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(get_prototypes){</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>        prototypes <span class="ot">&lt;-</span> <span class="fu">getPrototypes</span>(clusters, x, y)</span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">clusters=</span>clusters, <span class="at">multiple=</span>multiple,</span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>            <span class="at">prototypes=</span>prototypes))</span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">clusters=</span>clusters, <span class="at">multiple=</span>multiple))</span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkFormatClustersInput()</code>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to ensure that the inputs to formatClusters are as expected</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters Either an integer vector of a list of integer vectors; each</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vector should contain the indices of a cluster of features. (If there is only</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; one cluster, clusters can either be a list of length 1 or simply an integer</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vector.) If clusters is specified then R is ignored.</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p integer or numeric; the numbe of features in x (should match </span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; ncol(x), if x is provided)</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clust_names A character vector of the names of the clusters in clusters.</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param get_prototypes Logical: if TRUE, will identify prototype from each</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster (the feature from each cluster that is most correlated with the</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response) for the protolasso. In this case, x and y must be provided.</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x n x p numeric matrix; design matrix. Only needs to be provided if</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; get_prototypes is TRUE.</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y Numeric response vector; only needs to be provided if get_prototypes</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; is TRUE. Note: in general, the css function does not require y to be a</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; numeric vector, because the provided fitfun could use a different form of y</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (for example, a categorical response variable). However, y must be numeric in</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; order to provide prototypes because the prototypes are determined using the</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; correlation between cluster members (columns of x) and y.</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param R Numeric p x p matrix; not currently used. Entry ij contains the </span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;substitutive value&quot; of feature i for feature j (diagonal must consist of</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; ones, all entries must be between 0 and 1, and matrix must be symmetric)</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list of integer vectors; each vector will contain the indices of a</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster of features. Any duplicated clusters provided in the input will be</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; removed.</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>checkFormatClustersInput <span class="ot">&lt;-</span> <span class="cf">function</span>(clusters, p, clust_names, </span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    get_prototypes, x, y, R){</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(clusters)) <span class="sc">&amp;</span> <span class="fu">any</span>(<span class="fu">is.na</span>(R))){</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Must specify one of clusters or R (or does one of these provided inputs contain NA?)&quot;</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(p) <span class="sc">|</span> <span class="fu">is.numeric</span>(p))</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(p) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">==</span> <span class="fu">round</span>(p))</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(p))</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(p <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    use_R <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(clusters)) <span class="sc">|</span> <span class="fu">length</span>(clusters) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(R))){</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(R))</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">dim</span>(R) <span class="sc">==</span> p))</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">diag</span>(R) <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">identical</span>(R, <span class="fu">t</span>(R)))</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(R)))</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">all</span>(R <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)))</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>            use_R <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.list</span>(clusters) <span class="sc">|</span> <span class="fu">all</span>(<span class="fu">lengths</span>(clusters) <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.list</span>(clusters) <span class="sc">|</span> <span class="fu">length</span>(clusters) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(clusters)))</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.list</span>(clusters) <span class="sc">&amp;</span> <span class="fu">length</span>(clusters) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(clusters)){</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">length</span>(clusters[[i]]) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(clusters[[i]])))</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(clusters[[i]])))</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">all</span>(clusters[[i]] <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(clusters[[i]]))</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">length</span>(clusters) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(clusters)))</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>            clusters <span class="ot">&lt;-</span> clusters[<span class="sc">!</span><span class="fu">duplicated</span>(clusters)]</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">length</span>(clusters) <span class="sc">&gt;=</span> <span class="dv">2</span>){</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check that clusters are non-overlapping</span></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(clusters) <span class="sc">-</span> <span class="dv">1</span>)){</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span>(j <span class="cf">in</span> (i<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(clusters)){</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(clusters[[i]],</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>                            clusters[[j]])) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">any</span>(<span class="sc">!</span><span class="fu">is.na</span>(clust_names))){</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">length</span>(clust_names) <span class="sc">==</span> <span class="fu">length</span>(clusters))</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.list</span>(clusters)){</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>            clusters_temp <span class="ot">&lt;-</span> clusters</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>            clusters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>            clusters[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> clusters_temp</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rm</span>(clusters_temp)</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(get_prototypes) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(get_prototypes))</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="sc">!</span><span class="fu">is.na</span>(clust_names))){</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(clust_names))</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(get_prototypes){</span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)))</span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(x))</span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>        n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>        <span class="fu">checkY</span>(y, n)</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(use_R){</span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine clusters from R</span></span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>        clusters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(R)){</span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>            clusters[[i]] <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">which</span>(R[i, ] <span class="sc">&gt;</span> <span class="dv">0</span>))</span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">length</span>(clusters[[i]]) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(clusters[[i]])))</span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(clusters[[i]])))</span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(clusters[[i]]))</span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a>        clusters <span class="ot">&lt;-</span> <span class="fu">unique</span>(clusters)</span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.list</span>(clusters))</span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(clusters) <span class="sc">&gt;=</span> <span class="dv">2</span>){</span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check that clusters are non-overlapping</span></span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(clusters) <span class="sc">-</span> <span class="dv">1</span>)){</span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span>(j <span class="cf">in</span> (i<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(clusters)){</span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(clusters[[i]], clusters[[j]])) <span class="sc">!=</span> <span class="dv">0</span>){</span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">stop</span>(<span class="st">&quot;Invalid R matrix with overlapping clusters (clusters must not be overlapping)&quot;</span>)</span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.list</span>(clusters))</span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(clusters)</span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkY()</code>:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the argument y to several functions is</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; as expected</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y Numeric response vector.</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n Number of observations of covariates; should match length of y.</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>checkY <span class="ot">&lt;-</span> <span class="cf">function</span>(y, n){</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(y)))</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(y) <span class="sc">|</span> <span class="fu">is.integer</span>(y))</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">unique</span>(y)) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(n) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(n))</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(n) <span class="sc">|</span> <span class="fu">is.integer</span>(n))</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n <span class="sc">==</span> <span class="fu">round</span>(n))</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n <span class="sc">==</span> <span class="fu">length</span>(y))</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkY()</code>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkY works&quot;</span>, {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkY</span>(<span class="fu">as.numeric</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)<span class="sc">*</span>.<span class="dv">1</span>, <span class="dv">20</span>))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkY</span>(1L<span class="sc">:</span>15L, <span class="dv">15</span>))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkY</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="dv">8</span>), <span class="st">&quot;n == length(y) is not TRUE&quot;</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkY</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="sc">-</span><span class="dv">7</span>), <span class="st">&quot;n &gt; 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkY</span>(<span class="fu">rep</span>(<span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="dv">13</span>), <span class="dv">13</span>),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(!is.na(y)) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkY</span>(<span class="fu">rep</span>(<span class="fl">5.2</span>, <span class="dv">9</span>), <span class="dv">9</span>),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(unique(y)) &gt; 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkY</span>(<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>), <span class="dv">3</span>),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(y) | is.integer(y) is not TRUE&quot;</span>,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🌈</code></pre>
<p>Tests for <code>checkFormatClustersInput()</code>:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkFormatClustersInput works&quot;</span>, {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Intentionally don&#39;t provide clusters for all feature, mix up formatting,</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># etc.</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>4L, <span class="at">green_cluster=</span>5L<span class="sc">:</span>8L)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkFormatClustersInput</span>(good_clusters, <span class="at">p=</span><span class="dv">10</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">clust_names=</span><span class="fu">c</span>(<span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;green_cluster&quot;</span>),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">get_prototypes=</span><span class="cn">FALSE</span>, <span class="at">x=</span><span class="cn">NA</span>, <span class="at">y=</span><span class="cn">NA</span>, <span class="at">R=</span><span class="cn">NA</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  clust_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res)){</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    clust_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(clust_feats, res[[i]])</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">unique</span>(clust_feats)))</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">intersect</span>(clust_feats,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>                                                               <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>)))</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying other inputs</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  unnamed_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(1L<span class="sc">:</span>3L, 5L<span class="sc">:</span>8L)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkFormatClustersInput</span>(unnamed_clusters, <span class="at">p=</span><span class="dv">10</span>, <span class="at">clust_names=</span><span class="cn">NA</span>,</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">get_prototypes=</span><span class="cn">FALSE</span>, <span class="at">x=</span><span class="cn">NA</span>, <span class="at">y=</span><span class="cn">NA</span>, <span class="at">R=</span><span class="cn">NA</span>)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># clusters</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  clust_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res)){</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    clust_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(clust_feats, res[[i]])</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">unique</span>(clust_feats)))</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">intersect</span>(clust_feats,</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>                                                               <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>)))</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormatClustersInput</span>(<span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>), <span class="at">p=</span><span class="dv">10</span>,</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">clust_names=</span><span class="cn">NA</span>,</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">get_prototypes=</span><span class="cn">FALSE</span>, <span class="at">x=</span><span class="cn">NA</span>,</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">y=</span><span class="cn">NA</span>, <span class="at">R=</span><span class="cn">NA</span>),</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(intersect(clusters[[i]], clusters[[j]])) == 0 is not TRUE&quot;</span>,</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormatClustersInput</span>(<span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>), <span class="at">p=</span><span class="dv">10</span>,</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">clust_names=</span><span class="cn">NA</span>, <span class="at">get_prototypes=</span><span class="cn">FALSE</span>, <span class="at">x=</span><span class="cn">NA</span>,</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">y=</span><span class="cn">NA</span>, <span class="at">R=</span><span class="cn">NA</span>),</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(clusters) == length(unique(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormatClustersInput</span>(<span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">as.integer</span>(<span class="cn">NA</span>)),</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">p=</span><span class="dv">10</span>,</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">clust_names=</span><span class="cn">NA</span>,</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">get_prototypes=</span><span class="cn">FALSE</span>, <span class="at">x=</span><span class="cn">NA</span>,</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">y=</span><span class="cn">NA</span>, <span class="at">R=</span><span class="cn">NA</span>),</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Must specify one of clusters or R (or does one of these provided inputs contain NA?)&quot;</span>,</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormatClustersInput</span>(<span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">5</span>)),</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">p=</span><span class="dv">10</span>,</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">clust_names=</span><span class="cn">NA</span>,</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">get_prototypes=</span><span class="cn">FALSE</span>, <span class="at">x=</span><span class="cn">NA</span>,</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">y=</span><span class="cn">NA</span>, <span class="at">R=</span><span class="cn">NA</span>),</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(clusters[[i]]) == length(unique(clusters[[i]])) is not TRUE&quot;</span>,</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>   testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormatClustersInput</span>(<span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">p=</span><span class="dv">10</span>,</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">clust_names=</span><span class="cn">NA</span>,</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">get_prototypes=</span><span class="cn">FALSE</span>, <span class="at">x=</span><span class="cn">NA</span>,</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">y=</span><span class="cn">NA</span>, <span class="at">R=</span><span class="cn">NA</span>),</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(clusters[[i]] &gt;= 1) is not TRUE&quot;</span>,</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>   testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormatClustersInput</span>(<span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="fu">c</span>(<span class="fl">2.3</span>, <span class="fl">1.2</span>)),</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">p=</span><span class="dv">10</span>,</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">clust_names=</span><span class="cn">NA</span>,</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">get_prototypes=</span><span class="cn">FALSE</span>, <span class="at">x=</span><span class="cn">NA</span>,</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">y=</span><span class="cn">NA</span>, <span class="at">R=</span><span class="cn">NA</span>),</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.integer(clusters[[i]]) is not TRUE&quot;</span>,</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Single cluster</span></span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>   testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(<span class="fu">checkFormatClustersInput</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>), <span class="at">p=</span><span class="dv">10</span>,</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>                                                          <span class="at">clust_names=</span><span class="cn">NA</span>,</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>                                                          <span class="at">get_prototypes=</span><span class="cn">FALSE</span>,</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>                                                          <span class="at">x=</span><span class="cn">NA</span>, <span class="at">y=</span><span class="cn">NA</span>, <span class="at">R=</span><span class="cn">NA</span>)))</span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😸</code></pre>
<p><code>checkClusters()</code>:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the argument clusters to several functions is</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; as expected</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A named list where each entry is an integer vector of indices</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of features that are in a common cluster, as in the output of css or</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; formatClusters. (The length of list clusters is equal to the number of</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters.) All identified clusters must be non-overlapping, and all features</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; must appear in exactly one cluster (any unclustered features should be in</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; their own &quot;cluster&quot; of size 1).</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p The number of features; must be at least as large as the number of</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters.</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>checkClusters <span class="ot">&lt;-</span> <span class="cf">function</span>(clusters, p){</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.list</span>(clusters))</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">lengths</span>(clusters) <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(clusters)))</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    n_clusters <span class="ot">&lt;-</span> <span class="fu">length</span>(clusters)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n_clusters <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(clusters)))</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n_clusters <span class="sc">&lt;=</span> p)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(clusters)))</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(<span class="fu">names</span>(clusters)))</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">names</span>(clusters)) <span class="sc">&amp;</span> <span class="fu">names</span>(clusters) <span class="sc">!=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(clusters))) <span class="sc">==</span> n_clusters)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    all_clustered_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusters){</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(clusters[[i]]))</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        all_clustered_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(all_clustered_feats, clusters[[i]])</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(all_clustered_feats) <span class="sc">==</span> p)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">unique</span>(all_clustered_feats)) <span class="sc">==</span> p)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(all_clustered_feats <span class="sc">&lt;=</span> p))</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(all_clustered_feats <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkClusters()</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkClusters works&quot;</span>, {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">c1=</span>1L<span class="sc">:</span>5L, <span class="at">c2=</span>6L<span class="sc">:</span>8L, <span class="at">c3=</span>9L)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkClusters</span>(good_clusters, <span class="dv">9</span>))</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkClusters</span>(good_clusters, <span class="dv">10</span>),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(all_clustered_feats) == p is not TRUE&quot;</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkClusters</span>(1L<span class="sc">:</span>10L, <span class="dv">10</span>),</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.list(clusters) is not TRUE&quot;</span>,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkClusters</span>(<span class="fu">list</span>(<span class="at">c1=</span>1L<span class="sc">:</span>5L, <span class="at">c2=</span>6L<span class="sc">:</span>8L, <span class="at">c3=</span>9L,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">c4=</span><span class="fu">integer</span>()), <span class="dv">9</span>),</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(lengths(clusters) &gt;= 1) is not TRUE&quot;</span>,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkClusters</span>(<span class="fu">list</span>(<span class="at">c1=</span>1L<span class="sc">:</span>5L, <span class="at">c2=</span>6L<span class="sc">:</span>8L, <span class="at">c3=</span>9L,</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">c4=</span><span class="fu">as.integer</span>(<span class="cn">NA</span>)), <span class="dv">9</span>),</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(!is.na(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkClusters</span>(<span class="fu">list</span>(<span class="at">c1=</span>1L<span class="sc">:</span>5L, <span class="at">c2=</span>6L<span class="sc">:</span>8L, <span class="at">c3=</span>9L,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">c2=</span>6L<span class="sc">:</span>8L), <span class="dv">9</span>),</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n_clusters == length(unique(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkClusters</span>(<span class="fu">list</span>(<span class="at">c1=</span>1L<span class="sc">:</span>5L, <span class="at">c2=</span>6L<span class="sc">:</span>8L, <span class="at">c3=</span>10L), <span class="dv">9</span>),</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(all_clustered_feats &lt;= p) is not TRUE&quot;</span>,</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🎉</code></pre>
<p><code>getPrototypes()</code>:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Estimate prototypes from a list of clusters</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Takes in list of clusters, x, and y and returns an integer vector (of length</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; equal to the number of clusters) of the indices of the feature prototypes</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (the features from each cluster most correlated with the response).</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A list where each entry is an integer vector of indices of</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features that are in a common cluster. (The length of list clusters must be</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; equal to the number of clusters.) All identified clusters must be</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; non-overlapping. Must only include clusters of size 2 or larger.</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x n x p numeric matrix; design matrix.</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y Numeric response vector. Note: in general, the css function does not</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; require y to be a numeric vector, because the provided fitfun could use a</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; different form of y (for example, a categorical response variable). However,</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; y must be numeric in order to provide prototypes because the prototypes are</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; determined using the correlation between cluster members (columns of x) and</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; y.</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return An integer vector of the same length as clusters. Entry j is the</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; index of the feature identified as the prototype for cluster j.</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>getPrototypes <span class="ot">&lt;-</span> <span class="cf">function</span>(clusters, x, y){</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.list</span>(clusters) <span class="sc">|</span> <span class="fu">all</span>(<span class="fu">lengths</span>(clusters) <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.list</span>(clusters) <span class="sc">|</span> <span class="fu">length</span>(clusters) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)))</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(x))</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(x)</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkY</span>(y, n)</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identify prototypes</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(clusters) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.list</span>(clusters)){</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>            prototypes <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">as.integer</span>(<span class="cn">NA</span>), <span class="fu">length</span>(clusters))</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(clusters)){</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>                prototypes[i] <span class="ot">&lt;-</span> <span class="fu">identifyPrototype</span>(clusters[[i]], x, y)</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span>{</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If clusters is not a list, then there is only one cluster.</span></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>            prototypes <span class="ot">&lt;-</span> <span class="fu">identifyPrototype</span>(clusters, x, y)</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>    }  <span class="cf">else</span>{</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>        prototypes <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(prototypes))</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(clusters) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.list</span>(clusters)){</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">length</span>(prototypes) <span class="sc">==</span> <span class="fu">length</span>(clusters))</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">length</span>(prototypes) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(prototypes) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(prototypes)))</span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(prototypes) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(prototypes)))</span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(prototypes)</span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>identifyPrototype()</code>:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Estimate prototypes from a single cluster</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Takes in a single cluster, x, and y and returns an integer of the index of</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the feature prototype (the feature from the cluster most correlated with the</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response).</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cluster_members_i An integer vector of indices of features that are in</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; a common cluster. Must have length at least 2.</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x n x p numeric matrix; design matrix.</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y Numeric response vector. Note: in general, the css function does not</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; require y to be a numeric vector, because the provided fitfun could use a</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; different form of y (for example, a categorical response variable). However,</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; y must be numeric in order to provide prototypes because the prototypes are</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; determined using the correlation between cluster members (columns of x) and</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; y.</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return integer; the index of the feature identified as the prototype for</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the cluster.</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>identifyPrototype <span class="ot">&lt;-</span> <span class="cf">function</span>(cluster_members_i, x, y){</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check input</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(cluster_members_i))</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If cluster only has one member, that member is the prototype</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(cluster_members_i) <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(cluster_members_i)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose which cluster member to represent cluster for stability</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># metric purposes by choosing the one most highly correlated</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># with y</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    cors_i <span class="ot">&lt;-</span> <span class="fu">apply</span>(x[, cluster_members_i], <span class="dv">2</span>, corFunction, <span class="at">y=</span>y)</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    max_index_i <span class="ot">&lt;-</span> <span class="fu">which.max</span>(cors_i)[<span class="dv">1</span>]</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(max_index_i) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(max_index_i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cluster_members_i))</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    ret <span class="ot">&lt;-</span> cluster_members_i[max_index_i]</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(ret))</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(ret) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(ret <span class="sc">%in%</span> cluster_members_i)</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">identical</span>(x[, cluster_members_i][, max_index_i],</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>        x[, ret]))</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(ret)</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>corFunction()</code>:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Absolute value of sample correlation between two vectors</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Calculates the absolute value of correlation of t and y. If either input has</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; only one unique value, returns 0 by definition.</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param t A numeric or integer vector.</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y A numeric or integer vector; must have the same length as t.</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A numeric vector of the same length as cluster_i containing the</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; weights corresponding to each of the features in cluster_i. The weights</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will all be nonnegative and sum to 1.</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>corFunction <span class="ot">&lt;-</span> <span class="cf">function</span>(t, y){</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(t) <span class="sc">|</span> <span class="fu">is.integer</span>(t))</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(y) <span class="sc">|</span> <span class="fu">is.integer</span>(y))</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(t) <span class="sc">==</span> <span class="fu">length</span>(y))</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">unique</span>(t)) <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">unique</span>(y)) <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">&quot;The second argument to corFunction only had one unique entry&quot;</span>)</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">abs</span>(stats<span class="sc">::</span><span class="fu">cor</span>(t, y)))</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>corFunction()</code></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;corFunction works&quot;</span>, {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">corFunction</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>), <span class="dv">0</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">corFunction</span>(<span class="fu">rep</span>(<span class="fl">1.2</span>, <span class="dv">5</span>), <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>), <span class="dv">0</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">23451</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">corFunction</span>(x, y), <span class="fu">abs</span>(stats<span class="sc">::</span><span class="fu">cor</span>(x, y)))</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">corFunction</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="fu">rep</span>(<span class="fl">1.2</span>, <span class="dv">5</span>)),</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;The second argument to corFunction only had one unique entry&quot;</span>,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">corFunction</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>),</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(t) | is.integer(t) is not TRUE&quot;</span>,</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">corFunction</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">8</span>, <span class="st">&quot;2&quot;</span>),</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(y) | is.integer(y) is not TRUE&quot;</span>,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">corFunction</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>),</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(t) == length(y) is not TRUE&quot;</span>,</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😸</code></pre>
<p>Tests for <code>identifyPrototype()</code> (requires <code>corFunction()</code>):</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;identifyPrototype works&quot;</span>, {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">identifyPrototype</span>(10L, <span class="st">&quot;a&quot;</span>, <span class="dv">5</span>), 10L)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">9834</span>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(n<span class="sc">*</span>p), <span class="at">nrow=</span>n, <span class="at">ncol=</span>p)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> X[, p]</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">identifyPrototype</span>(<span class="fu">as.integer</span>(p), X, y), p)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">identifyPrototype</span>(2L, X, y), <span class="dv">2</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">identifyPrototype</span>(<span class="fu">as.integer</span>(<span class="dv">2</span><span class="sc">:</span>p), X, y), p)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">identifyPrototype</span>(<span class="fu">as.integer</span>(<span class="dv">2</span><span class="sc">:</span>p), y, X),</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;incorrect number of dimensions&quot;</span>,</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  y2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">identifyPrototype</span>(<span class="fu">c</span>(2L, 3L), X, y2)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res))</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">1</span>)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res <span class="sc">%in%</span> <span class="fu">c</span>(2L, 3L))</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🎊</code></pre>
<p>Tests for <code>getPrototypes()</code></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getPrototypes works&quot;</span>, {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">902689</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(n<span class="sc">*</span>p), <span class="at">nrow=</span>n, <span class="at">ncol=</span>p)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> X[, p]</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">getPrototypes</span>(<span class="fu">list</span>(1L, 2L, 3L, 4L, 5L), X, y), <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">getPrototypes</span>(<span class="fu">list</span>(1L<span class="sc">:</span>5L), X, y), 5L)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">getPrototypes</span>(<span class="fu">list</span>(1L, 2L<span class="sc">:</span>5L), X, y), <span class="fu">c</span>(1L, 5L))</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">getPrototypes</span>(<span class="fu">list</span>(3L<span class="sc">:</span>5L), X, y), 5L)</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  y2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getPrototypes</span>(<span class="fu">list</span>(1L, <span class="fu">c</span>(2L, 3L), <span class="fu">c</span>(4L, 5L)), X, y2)</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res))</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">3</span>)</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res[<span class="dv">1</span>], 1L)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res[<span class="dv">2</span>] <span class="sc">%in%</span> <span class="fu">c</span>(2L, 3L))</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res[<span class="dv">3</span>] <span class="sc">%in%</span> <span class="fu">c</span>(4L, 5L))</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getPrototypes</span>(<span class="fu">list</span>(1L, 2L, 3L, 4L, 5L), y, X),</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;is.matrix(x) is not TRUE&quot;</span>,</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>                          <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getPrototypes</span>(<span class="fu">list</span>(1L, 2L, 3L, 4L, 5L), X, y[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>]),</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n == length(y) is not TRUE&quot;</span>,</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🎊</code></pre>
<p>Finally, tests for <code>formatClusters()</code>:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;formatClusters works&quot;</span>, {</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Intentionally don&#39;t provide clusters for all feature, mix up formatting,</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># etc.</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">formatClusters</span>(good_clusters, <span class="at">p=</span><span class="dv">10</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;clusters&quot;</span>, <span class="st">&quot;multiple&quot;</span>))</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clusters</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>clusters))</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>clusters), <span class="dv">5</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">5</span>, <span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters)))</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">5</span>, <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters))))</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="st">&quot;red_cluster&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(res<span class="sc">$</span>clusters))</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters))))</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters))))</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters) <span class="sc">!=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  clust_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  true_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">9</span>, <span class="dv">10</span>)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>clusters)){</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>clusters[[i]]))</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(clust_feats, res<span class="sc">$</span>clusters[[i]])), <span class="dv">0</span>)</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>clusters[[i]] <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>))</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>clusters[[i]]),</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">length</span>(<span class="fu">unique</span>(res<span class="sc">$</span>clusters[[i]])))</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>clusters[[i]] <span class="sc">==</span> true_list[[i]]))</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    clust_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(clust_feats, res<span class="sc">$</span>clusters[[i]])</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="dv">10</span>)</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">10</span>, <span class="fu">length</span>(<span class="fu">unique</span>(clust_feats)))</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">10</span>, <span class="fu">length</span>(<span class="fu">intersect</span>(clust_feats, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)))</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Multiple</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res<span class="sc">$</span>multiple)</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_false</span>(<span class="fu">formatClusters</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">10</span>)<span class="sc">$</span>multiple)</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying other inputs</span></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formatClusters</span>(<span class="fu">list</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">7</span>, <span class="dv">7</span><span class="sc">:</span><span class="dv">10</span>), <span class="at">p=</span><span class="dv">15</span>),</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(intersect(clusters[[i]], clusters[[j]])) == 0 is not TRUE&quot;</span>,</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formatClusters</span>(<span class="fu">list</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>), <span class="at">p=</span><span class="dv">9</span>),</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(clusters) == length(unique(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formatClusters</span>(<span class="fu">list</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>), <span class="at">p=</span><span class="dv">7</span>),</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(all_clustered_feats) == p is not TRUE&quot;</span>,</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formatClusters</span>(<span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">as.integer</span>(<span class="cn">NA</span>)), <span class="at">p=</span><span class="dv">10</span>),</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Must specify one of clusters or R (or does one of these provided inputs contain NA?)&quot;</span>,</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formatClusters</span>(<span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">5</span>)), <span class="at">p=</span><span class="dv">8</span>),</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(clusters[[i]]) == length(unique(clusters[[i]])) is not TRUE&quot;</span>,</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>   testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formatClusters</span>(<span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="sc">-</span><span class="dv">1</span>), <span class="at">p=</span><span class="dv">10</span>),</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(clusters[[i]] &gt;= 1) is not TRUE&quot;</span>,</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>   testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formatClusters</span>(<span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="fu">c</span>(<span class="fl">2.3</span>, <span class="fl">1.2</span>))),</span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.integer(clusters[[i]]) is not TRUE&quot;</span>,</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>   <span class="do">### Test prototypes feature</span></span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">690289</span>)</span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(n<span class="sc">*</span>p), <span class="at">nrow=</span>n, <span class="at">ncol=</span>p)</span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> X[, p]</span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">formatClusters</span>(<span class="at">clusters=</span><span class="fu">list</span>(), <span class="at">p=</span>p, <span class="at">get_prototypes=</span><span class="cn">TRUE</span>, <span class="at">x=</span>X, <span class="at">y=</span>y)</span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;clusters&quot;</span>, <span class="st">&quot;multiple&quot;</span>,</span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">&quot;prototypes&quot;</span>))</span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>prototypes))</span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res<span class="sc">$</span>prototypes, <span class="dv">1</span><span class="sc">:</span>p)</span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">formatClusters</span>(<span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span>p, <span class="at">p=</span>p,</span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">get_prototypes=</span><span class="cn">TRUE</span>, <span class="at">x=</span>X,</span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">y=</span>y)<span class="sc">$</span>prototypes, p)</span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">formatClusters</span>(<span class="at">clusters=</span><span class="fu">list</span>(1L, 2L<span class="sc">:</span>p), <span class="at">p=</span>p,</span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">get_prototypes=</span><span class="cn">TRUE</span>, <span class="at">x=</span>X,</span>
<span id="cb43-95"><a href="#cb43-95" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">y=</span>y)<span class="sc">$</span>prototypes,</span>
<span id="cb43-96"><a href="#cb43-96" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">as.integer</span>(<span class="fu">c</span>(<span class="dv">1</span>, p)))</span>
<span id="cb43-97"><a href="#cb43-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-98"><a href="#cb43-98" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">formatClusters</span>(<span class="at">clusters=</span>3L<span class="sc">:</span>p, <span class="at">p=</span>p,</span>
<span id="cb43-99"><a href="#cb43-99" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">get_prototypes=</span><span class="cn">TRUE</span>, <span class="at">x=</span>X,</span>
<span id="cb43-100"><a href="#cb43-100" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">y=</span>y)<span class="sc">$</span>prototypes,</span>
<span id="cb43-101"><a href="#cb43-101" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">as.integer</span>(<span class="fu">c</span>(p, <span class="dv">1</span>, <span class="dv">2</span>)))</span>
<span id="cb43-102"><a href="#cb43-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-103"><a href="#cb43-103" aria-hidden="true" tabindex="-1"></a>    y2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb43-104"><a href="#cb43-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-105"><a href="#cb43-105" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">formatClusters</span>(<span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">5</span>), <span class="at">p=</span>p, <span class="at">get_prototypes=</span><span class="cn">TRUE</span>,</span>
<span id="cb43-106"><a href="#cb43-106" aria-hidden="true" tabindex="-1"></a>                          <span class="at">x=</span>X, <span class="at">y=</span>y2)<span class="sc">$</span>prototypes</span>
<span id="cb43-107"><a href="#cb43-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-108"><a href="#cb43-108" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res))</span>
<span id="cb43-109"><a href="#cb43-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-110"><a href="#cb43-110" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">4</span>)</span>
<span id="cb43-111"><a href="#cb43-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-112"><a href="#cb43-112" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(res[<span class="dv">1</span>] <span class="sc">%in%</span> <span class="fu">c</span>(2L, 3L))</span>
<span id="cb43-113"><a href="#cb43-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-114"><a href="#cb43-114" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(res[<span class="dv">2</span>] <span class="sc">%in%</span> <span class="fu">c</span>(4L, 5L))</span>
<span id="cb43-115"><a href="#cb43-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-116"><a href="#cb43-116" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(res[<span class="dv">3</span>], 1L)</span>
<span id="cb43-117"><a href="#cb43-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-118"><a href="#cb43-118" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(res[<span class="dv">4</span>], p)</span>
<span id="cb43-119"><a href="#cb43-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-120"><a href="#cb43-120" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formatClusters</span>(<span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">5</span>), <span class="at">p=</span>p,</span>
<span id="cb43-121"><a href="#cb43-121" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">get_prototypes=</span><span class="cn">TRUE</span>, <span class="at">x=</span>y2, <span class="at">y=</span>X),</span>
<span id="cb43-122"><a href="#cb43-122" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;is.matrix(x) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-123"><a href="#cb43-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-124"><a href="#cb43-124" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formatClusters</span>(<span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">5</span>), <span class="at">p=</span>p,</span>
<span id="cb43-125"><a href="#cb43-125" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">get_prototypes=</span><span class="cn">TRUE</span>, <span class="at">x=</span>X,</span>
<span id="cb43-126"><a href="#cb43-126" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">y=</span>y2[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)]),</span>
<span id="cb43-127"><a href="#cb43-127" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;n == length(y) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-128"><a href="#cb43-128" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😀</code></pre>
<p><code>checkSamplingType()</code>:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the argument sampling_type to several </span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; functions is as expected</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sampling_type A character vector; either &quot;SS&quot; or &quot;MB&quot;. &quot;MB&quot; is not</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; supported yet.</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>checkSamplingType <span class="ot">&lt;-</span> <span class="cf">function</span>(sampling_type){</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(sampling_type))</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(sampling_type) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(sampling_type))</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(sampling_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;SS&quot;</span>, <span class="st">&quot;MB&quot;</span>))</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(sampling_type <span class="sc">==</span> <span class="st">&quot;MB&quot;</span>){</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;sampling_type MB is not yet supported (and isn&#39;t recommended anyway)&quot;</span>)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkSamplingType()</code>:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkSamplingType works&quot;</span>, {</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkSamplingType</span>(<span class="st">&quot;SS&quot;</span>))</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkSamplingType</span>(<span class="st">&quot;MB&quot;</span>),</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sampling_type MB is not yet supported (and isn&#39;t recommended anyway)&quot;</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkSamplingType</span>(<span class="fu">c</span>(<span class="st">&quot;SS&quot;</span>, <span class="st">&quot;SS&quot;</span>)),</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(sampling_type) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkSamplingType</span>(<span class="dv">1</span>),</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.character(sampling_type) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkSamplingType</span>(<span class="fu">as.character</span>(<span class="cn">NA</span>)),</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.na(sampling_type) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p><code>checkB()</code>:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the argument B to several functions is as</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; expected</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param B Integer or numeric; the number of subsamples. Note: For</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; sampling.type==&quot;MB&quot; the total number of subsamples will be `B`; for</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; sampling_type=&quot;SS&quot; the number of subsamples will be `2*B`.</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>checkB <span class="ot">&lt;-</span> <span class="cf">function</span>(B){</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(B) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(B) <span class="sc">|</span> <span class="fu">is.integer</span>(B))</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(B))</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(B <span class="sc">==</span> <span class="fu">round</span>(B))</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(B <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(B <span class="sc">&lt;</span> <span class="dv">10</span>){</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">&quot;Small values of B may lead to poor results.&quot;</span>)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (B <span class="sc">&gt;</span> <span class="dv">2000</span>){</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">&quot;Large values of B may require long computation times.&quot;</span>)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkB()</code>:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkB works&quot;</span>, {</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkB</span>(<span class="dv">1500</span>))</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkB</span>(<span class="dv">15</span>))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkB</span>(<span class="st">&quot;B&quot;</span>),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(B) | is.integer(B) is not TRUE&quot;</span>,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkB</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">25</span>), <span class="st">&quot;length(B) == 1 is not TRUE&quot;</span>,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkB</span>(<span class="fu">as.integer</span>(<span class="cn">NA</span>)), <span class="st">&quot;!is.na(B) is not TRUE&quot;</span>,</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkB</span>(<span class="fl">1.2</span>), <span class="st">&quot;B == round(B) is not TRUE&quot;</span>,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkB</span>(<span class="sc">-</span><span class="dv">100</span>), <span class="st">&quot;B &gt; 0 is not TRUE&quot;</span>,</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">checkB</span>(<span class="dv">5</span>),</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Small values of B may lead to poor results.&quot;</span>,</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">checkB</span>(<span class="dv">2200</span>),</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Large values of B may require long computation times.&quot;</span>,</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🎉</code></pre>
<p><code>checkPropFeatsRemove()</code>:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the argument prop_feats_remove to several </span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; functions is as expected</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prop_feats_remove Numeric; proportion of features that are dropped on</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; each subsample. Must be between 0 and 1.</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p The number of features; must be greater than 2 if prop_feats_remove</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; is greater than 0.</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>checkPropFeatsRemove <span class="ot">&lt;-</span> <span class="cf">function</span>(prop_feats_remove, p){</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(prop_feats_remove) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(prop_feats_remove) <span class="sc">|</span> <span class="fu">is.integer</span>(prop_feats_remove))</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(prop_feats_remove))</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(prop_feats_remove <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> prop_feats_remove <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(prop_feats_remove <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Make sure p is at least 2 or else this doesn&#39;t make sense</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkPropFeatsRemove()</code>:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkPropFeatsRemove works&quot;</span>, {</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkPropFeatsRemove</span>(<span class="dv">0</span>, <span class="dv">5</span>))</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkPropFeatsRemove</span>(.<span class="dv">3</span>, <span class="dv">10</span>))</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkPropFeatsRemove</span>(<span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;prop_feats_remove &gt;= 0 &amp; prop_feats_remove &lt; 1 is not TRUE&quot;</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkPropFeatsRemove</span>(<span class="fu">c</span>(.<span class="dv">5</span>, .<span class="dv">6</span>), <span class="dv">17</span>),</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(prop_feats_remove) == 1 is not TRUE&quot;</span>,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkPropFeatsRemove</span>(<span class="st">&quot;.3&quot;</span>, <span class="dv">99</span>),</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(prop_feats_remove) | is.integer(prop_feats_remove) is not TRUE&quot;</span>,</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkPropFeatsRemove</span>(<span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="dv">172</span>),</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.na(prop_feats_remove) is not TRUE&quot;</span>,</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkPropFeatsRemove</span>(.<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;p &gt;= 2 is not TRUE&quot;</span>,</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🎉</code></pre>
<p>Finally, tests for <code>checkCssInputs()</code>:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkCssInputs works&quot;</span>, {</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">80526</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span><span class="sc">*</span><span class="dv">11</span>), <span class="at">nrow=</span><span class="dv">15</span>, <span class="at">ncol=</span><span class="dv">11</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Intentionally don&#39;t provide clusters for all feature, mix up formatting,</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># etc.</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>5L,</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">green_cluster=</span>6L<span class="sc">:</span>8L</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># , c4=10:11</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkCssInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fitfun =</span> cssLasso, <span class="at">sampling_type =</span> <span class="st">&quot;SS&quot;</span>, <span class="at">B =</span> <span class="dv">13</span>,</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>                        <span class="at">prop_feats_remove =</span> <span class="dv">0</span>, <span class="at">train_inds =</span> <span class="fu">integer</span>(),</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>                        <span class="at">num_cores =</span> 1L)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Basic output</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;feat_names&quot;</span>, <span class="st">&quot;X&quot;</span>, <span class="st">&quot;clusters&quot;</span>))</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># feat_names</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res<span class="sc">$</span>feat_names))</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(res<span class="sc">$</span>feat_names))</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>feat_names), <span class="dv">1</span>)</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>X))</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>X)))</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>X))</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>X), <span class="dv">11</span>)</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>X), <span class="dv">15</span>)</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># clusters</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>clusters))</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>clusters), <span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters)))</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>clusters),</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters))))</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters))))</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters))))</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>  clust_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>clusters)){</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    clust_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(clust_feats, res<span class="sc">$</span>clusters[[i]])</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">unique</span>(clust_feats)))</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">intersect</span>(clust_feats,</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>                                                               <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>)))</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying other inputs</span></span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Custom fitfun with nonsense lambda (which will be ignored by fitfun, and</span></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># shouldn&#39;t throw any error, because the acceptable input for lambda should be</span></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># enforced only by fitfun)</span></span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>  testFitfun <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, lambda){</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose p/2 features randomly</span></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>    selected <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(p, <span class="at">size=</span><span class="fu">floor</span>(p<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(selected)</span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>  res_fitfun <span class="ot">&lt;-</span> <span class="fu">checkCssInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span>x, <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>                               <span class="at">fitfun =</span> testFitfun, <span class="at">sampling_type =</span> <span class="st">&quot;SS&quot;</span>,</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>                               <span class="at">B =</span> <span class="dv">13</span>, <span class="at">prop_feats_remove =</span> <span class="dv">0</span>,</span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>                               <span class="at">train_inds =</span> <span class="fu">integer</span>(), <span class="at">num_cores =</span> 1L)</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_fitfun))</span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Single cluster</span></span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>  res_sing_clust <span class="ot">&lt;-</span> <span class="fu">checkCssInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">lambda=</span><span class="fu">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="st">&quot;bar&quot;</span>),</span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">fitfun =</span> testFitfun,</span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">sampling_type =</span> <span class="st">&quot;SS&quot;</span>, <span class="at">B =</span> <span class="dv">13</span>,</span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">prop_feats_remove =</span> <span class="dv">0</span>,</span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">train_inds =</span> <span class="fu">integer</span>(), <span class="at">num_cores =</span> 1L)</span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_sing_clust))</span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res_sing_clust<span class="sc">$</span>clusters), <span class="dv">11</span> <span class="sc">-</span> <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res_sing_clust<span class="sc">$</span>clusters))) <span class="sc">==</span> <span class="dv">11</span> <span class="sc">-</span></span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>                          <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">names</span>(res_sing_clust<span class="sc">$</span>clusters))))</span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res_sing_clust<span class="sc">$</span>clusters))))</span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Other sampling types</span></span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fu">c</span>(<span class="st">&quot;foo&quot;</span>,</span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>                                                           <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">&quot;bar&quot;</span>), <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">fitfun =</span> testFitfun,</span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">sampling_type =</span> <span class="st">&quot;MB&quot;</span>, <span class="at">B =</span> <span class="dv">13</span>,</span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">prop_feats_remove =</span> <span class="dv">0</span>,</span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">train_inds =</span> <span class="fu">integer</span>(), <span class="at">num_cores =</span> 1L),</span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sampling_type MB is not yet supported (and isn&#39;t recommended anyway)&quot;</span>,</span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Error has quotation marks in it</span></span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fu">c</span>(<span class="st">&quot;foo&quot;</span>,</span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a>                                                           <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">&quot;bar&quot;</span>), <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">fitfun =</span> testFitfun,</span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">sampling_type =</span> <span class="st">&quot;S&quot;</span>, <span class="at">B =</span> <span class="dv">13</span>,</span>
<span id="cb54-101"><a href="#cb54-101" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">prop_feats_remove =</span> <span class="dv">0</span>,</span>
<span id="cb54-102"><a href="#cb54-102" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">train_inds =</span> <span class="fu">integer</span>(), <span class="at">num_cores =</span> 1L))</span>
<span id="cb54-103"><a href="#cb54-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-104"><a href="#cb54-104" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fu">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>,</span>
<span id="cb54-105"><a href="#cb54-105" aria-hidden="true" tabindex="-1"></a>                                                           <span class="fu">as.character</span>(<span class="cn">NA</span>)),</span>
<span id="cb54-106"><a href="#cb54-106" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">fitfun =</span> testFitfun,</span>
<span id="cb54-107"><a href="#cb54-107" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">sampling_type =</span> <span class="dv">2</span>, <span class="at">B =</span> <span class="dv">13</span>,</span>
<span id="cb54-108"><a href="#cb54-108" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">prop_feats_remove =</span> <span class="dv">0</span>,</span>
<span id="cb54-109"><a href="#cb54-109" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">train_inds =</span> <span class="fu">integer</span>(), <span class="at">num_cores =</span> 1L),</span>
<span id="cb54-110"><a href="#cb54-110" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.character(sampling_type) is not TRUE&quot;</span>,</span>
<span id="cb54-111"><a href="#cb54-111" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb54-112"><a href="#cb54-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-113"><a href="#cb54-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># B</span></span>
<span id="cb54-114"><a href="#cb54-114" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">checkCssInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fu">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>,</span>
<span id="cb54-115"><a href="#cb54-115" aria-hidden="true" tabindex="-1"></a>                                                           <span class="fu">as.character</span>(<span class="cn">NA</span>)),</span>
<span id="cb54-116"><a href="#cb54-116" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">fitfun =</span> testFitfun,</span>
<span id="cb54-117"><a href="#cb54-117" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">sampling_type =</span> <span class="st">&quot;SS&quot;</span>, <span class="at">B =</span> <span class="dv">5</span>,</span>
<span id="cb54-118"><a href="#cb54-118" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">prop_feats_remove =</span> <span class="dv">0</span>,</span>
<span id="cb54-119"><a href="#cb54-119" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">train_inds =</span> <span class="fu">integer</span>(), <span class="at">num_cores =</span> 1L),</span>
<span id="cb54-120"><a href="#cb54-120" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Small values of B may lead to poor results.&quot;</span>,</span>
<span id="cb54-121"><a href="#cb54-121" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb54-122"><a href="#cb54-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-123"><a href="#cb54-123" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fu">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>,</span>
<span id="cb54-124"><a href="#cb54-124" aria-hidden="true" tabindex="-1"></a>                                                           <span class="fu">as.character</span>(<span class="cn">NA</span>)),</span>
<span id="cb54-125"><a href="#cb54-125" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">fitfun =</span> testFitfun,</span>
<span id="cb54-126"><a href="#cb54-126" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">sampling_type =</span> <span class="st">&quot;SS&quot;</span>, <span class="at">B =</span> <span class="st">&quot;foo&quot;</span>,</span>
<span id="cb54-127"><a href="#cb54-127" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">prop_feats_remove =</span> <span class="dv">0</span>,</span>
<span id="cb54-128"><a href="#cb54-128" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">train_inds =</span> <span class="fu">integer</span>(), <span class="at">num_cores =</span> 1L),</span>
<span id="cb54-129"><a href="#cb54-129" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;is.numeric(B) | is.integer(B) is not TRUE&quot;</span>,</span>
<span id="cb54-130"><a href="#cb54-130" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb54-131"><a href="#cb54-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-132"><a href="#cb54-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prop_feats_remove</span></span>
<span id="cb54-133"><a href="#cb54-133" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(<span class="fu">checkCssInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb54-134"><a href="#cb54-134" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">lambda=</span><span class="fu">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>,</span>
<span id="cb54-135"><a href="#cb54-135" aria-hidden="true" tabindex="-1"></a>                                                        <span class="fu">as.character</span>(<span class="cn">NA</span>)),</span>
<span id="cb54-136"><a href="#cb54-136" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">fitfun=</span>testFitfun,</span>
<span id="cb54-137"><a href="#cb54-137" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">sampling_type =</span> <span class="st">&quot;SS&quot;</span>, <span class="at">B =</span> <span class="dv">12</span>,</span>
<span id="cb54-138"><a href="#cb54-138" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">prop_feats_remove =</span> <span class="fl">0.3</span>,</span>
<span id="cb54-139"><a href="#cb54-139" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">train_inds =</span> <span class="fu">integer</span>(),</span>
<span id="cb54-140"><a href="#cb54-140" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">num_cores =</span> 1L)))</span>
<span id="cb54-141"><a href="#cb54-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-142"><a href="#cb54-142" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use train_inds argument</span></span>
<span id="cb54-143"><a href="#cb54-143" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(<span class="fu">checkCssInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb54-144"><a href="#cb54-144" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">lambda=</span><span class="fu">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>,</span>
<span id="cb54-145"><a href="#cb54-145" aria-hidden="true" tabindex="-1"></a>                                                        <span class="fu">as.character</span>(<span class="cn">NA</span>)),</span>
<span id="cb54-146"><a href="#cb54-146" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">fitfun=</span>testFitfun,</span>
<span id="cb54-147"><a href="#cb54-147" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">sampling_type =</span> <span class="st">&quot;SS&quot;</span>, <span class="at">B =</span> <span class="dv">12</span>,</span>
<span id="cb54-148"><a href="#cb54-148" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">prop_feats_remove =</span> <span class="fl">0.3</span>,</span>
<span id="cb54-149"><a href="#cb54-149" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">train_inds =</span> <span class="dv">11</span><span class="sc">:</span><span class="dv">15</span>,</span>
<span id="cb54-150"><a href="#cb54-150" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">num_cores =</span> 1L)))</span>
<span id="cb54-151"><a href="#cb54-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-152"><a href="#cb54-152" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥳</code></pre>
<p><code>cssLoop()</code>:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function run on each subsample</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Runs provided feature selection method `fitfun` on each subsample for cluster</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; stability selection (this function is called within `mclapply`).</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param input Could be one of two things: \item{subsample}{An integer vector</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of size `n/2` containing the indices of the observations in the subsample.}</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{drop_var_input}{A named list containing two elements: one named</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;subsample&quot; and the same as the previous description, and a logical vector</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; named &quot;feats_to_keep&quot; containing the indices of the features to be</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; automatically selected.} (The first object is the output of the function</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `createSubsamples()` when the provided `prop_feats_remove` is 0, the default, and</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the second object is the output of `createSubsamples()` when `prop_feats_remove &gt;</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 0`.)</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x an n x p numeric matrix containing the predictors. (This should be</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the full design matrix provided to css.)</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y A response; can be any response that takes the form of a length n</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vector and is used (or not used) by `fitfun`. Typically (and for default</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `fitfun = cssLasso`), `y` should be an n-dimensional numeric vector containing the</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response. This should be the full response provided to css.</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda A tuning parameter or set of tuning parameters that may be used</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; by the feature selection method. For example, in the default case when</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `fitfun = cssLasso`, `lambda` is a numeric: the penalty to use for each lasso</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; fit.</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param fitfun A function that takes in arguments X, y, and lambda and returns</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; a vector of indices of the columns of X (selected features).</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return An integer vector; the indices of the features selected by `fitfun`.</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>cssLoop <span class="ot">&lt;-</span> <span class="cf">function</span>(input, x, y, lambda, fitfun){</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(x))</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)))</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(x) <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(x)</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(y) <span class="sc">==</span> n)</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.matrix</span>(y))</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Intentionally don&#39;t check y or lambda further to allow for flexibility--these</span></span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inputs should be checked within fitfun.</span></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.list</span>(input)){</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>        subsample <span class="ot">&lt;-</span> input</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>        feats_to_keep <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">TRUE</span>, p)</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">names</span>(input) <span class="sc">==</span> <span class="fu">c</span>(<span class="st">&quot;subsample&quot;</span>, <span class="st">&quot;feats_to_keep&quot;</span>)))</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>        subsample <span class="ot">&lt;-</span> input<span class="sc">$</span>subsample</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>        feats_to_keep <span class="ot">&lt;-</span> input<span class="sc">$</span>feats_to_keep</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(subsample))</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(subsample <span class="sc">==</span> <span class="fu">round</span>(subsample)))</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">floor</span>(n<span class="sc">/</span><span class="dv">2</span>) <span class="sc">==</span> <span class="fu">length</span>(subsample))</span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(subsample) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(subsample)))</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(feats_to_keep))</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(feats_to_keep) <span class="sc">==</span> p)</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>    selected <span class="ot">&lt;-</span> <span class="fu">do.call</span>(fitfun, <span class="fu">list</span>(<span class="at">X=</span>x[subsample, feats_to_keep],</span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">y=</span>y[subsample], <span class="at">lambda=</span>lambda))</span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>    selected <span class="ot">&lt;-</span> <span class="fu">which</span>(feats_to_keep)[selected]</span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkCssLoopOutput</span>(selected, p, <span class="fu">as.integer</span>(<span class="fu">which</span>(feats_to_keep)))</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">as.integer</span>(selected))</span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkCssLoopOutput()</code>:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the outputs of the provided feature selection</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; method are as required. </span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param selected An integer vector; the indices of the features selected by</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the lasso.</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p The total number of observed features; all selected features must be</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in 1:p.</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param feats_on_subsamp Integer; the indices of the features considered by</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the feature selection method. All selected features must be among these</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features.</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>checkCssLoopOutput <span class="ot">&lt;-</span> <span class="cf">function</span>(selected, p, feats_on_subsamp){</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;selected&quot;</span>)){</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;The provided feature selection method fitfun failed to return anything on (at least) one subsample&quot;</span>)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.integer</span>(selected) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.numeric</span>(selected)){</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;The provided feature selection method fitfun failed to return an integer or numeric vector on (at least) one subsample&quot;</span>)</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(selected))){</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;The provided feature selection method fitfun returned a vector containing NA values on (at least) one subsample&quot;</span>)</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">all</span>(selected <span class="sc">==</span> <span class="fu">round</span>(selected))){</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;The provided feature selection method fitfun failed to return a vector of valid (integer) indices on (at least) one subsample&quot;</span>)</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(selected) <span class="sc">!=</span> <span class="fu">length</span>(<span class="fu">unique</span>(selected))){</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;The provided feature selection method fitfun returned a vector of selected features containing repeated indices on (at least) one subsample&quot;</span>)</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(selected) <span class="sc">&gt;</span> p){</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;The provided feature selection method fitfun returned a vector of selected features longer than p on (at least) one subsample&quot;</span>)</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(selected) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">max</span>(selected) <span class="sc">&gt;</span> p){</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stop</span>(<span class="st">&quot;The provided feature selection method fitfun returned a vector of selected features containing an index greater than ncol(X) on (at least) one subsample&quot;</span>)</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">min</span>(selected) <span class="sc">&lt;=</span> <span class="dv">0</span>){</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stop</span>(<span class="st">&quot;The provided feature selection method fitfun returned a vector of selected features containing a non-positive index on (at least) one subsample&quot;</span>)</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="st">&quot;try-error&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(selected) <span class="sc">|</span></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;error&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(selected) <span class="sc">|</span> <span class="st">&quot;simpleError&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(selected) <span class="sc">|</span></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;condition&quot;</span> <span class="sc">%in%</span> <span class="fu">class</span>(selected)){</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;The provided feature selection method fitfun returned an error on (at least) one subsample&quot;</span>)</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">all</span>(selected <span class="sc">%in%</span> feats_on_subsamp)){</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;The provided feature selection method somehow selected features that were not provided for it to consider.&quot;</span>)</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkCssLoopOutput()</code>:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkCssLoopOutput works&quot;</span>, {</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkCssLoopOutput</span>(<span class="at">selected=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">6</span>,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">feats_on_subsamp=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>))</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLoopOutput</span>(<span class="at">selected=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">4</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">feats_on_subsamp=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>),</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;The provided feature selection method fitfun returned a vector of selected features longer than p on (at least) one subsample&quot;</span>,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLoopOutput</span>(<span class="at">selected=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">7</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">feats_on_subsamp=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>),</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;The provided feature selection method somehow selected features that were not provided for it to consider.&quot;</span>,</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLoopOutput</span>(<span class="at">selected=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="fl">4.4</span>, <span class="dv">5</span>), <span class="at">p=</span><span class="dv">7</span>,</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">feats_on_subsamp=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>),</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;The provided feature selection method fitfun failed to return a vector of valid (integer) indices on (at least) one subsample&quot;</span>,</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLoopOutput</span>(<span class="at">selected=</span><span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="at">p=</span><span class="dv">7</span>,</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">feats_on_subsamp=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>),</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;The provided feature selection method fitfun returned a vector of selected features containing repeated indices on (at least) one subsample&quot;</span>,</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLoopOutput</span>(<span class="at">selected=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">5</span>), <span class="at">p=</span><span class="dv">7</span>,</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">feats_on_subsamp=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>),</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;The provided feature selection method fitfun returned a vector of selected features containing a non-positive index on (at least) one subsample&quot;</span>,</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLoopOutput</span>(<span class="at">selected=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">p=</span><span class="dv">7</span>,</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">feats_on_subsamp=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>),</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;The provided feature selection method fitfun returned a vector of selected features containing a non-positive index on (at least) one subsample&quot;</span>,</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLoopOutput</span>(<span class="at">selected=</span><span class="fu">as.integer</span>(<span class="cn">NA</span>), <span class="at">p=</span><span class="dv">7</span>,</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">feats_on_subsamp=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>),</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;The provided feature selection method fitfun returned a vector containing NA values on (at least) one subsample&quot;</span>,</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLoopOutput</span>(<span class="at">selected=</span><span class="fu">c</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>, <span class="st">&quot;3&quot;</span>), <span class="at">p=</span><span class="dv">7</span>,</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">feats_on_subsamp=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>),</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;The provided feature selection method fitfun failed to return an integer or numeric vector on (at least) one subsample&quot;</span>,</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🌈</code></pre>
<p><code>checkCssLassoInputs()</code>:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the inputs to `cssLasso()` are as expected. </span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X A design matrix containing the predictors. (Note that we don&#39;t need</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to check X very much, because X will have already been checked by the</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; function `checkCssInputs()` when it was provided to `css()`.)</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y A numeric vector containing the response.</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda Numeric; a nonnegative number for the lasso penalty to use</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; on each subsample. (For now, only one lambda value can be provided to</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `cssLasso()`; in the future, we plan to allow for multiple lambda values to be</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided to `cssLasso()`, as described in Faletto and Bien 2022.)</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>checkCssLassoInputs <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, lambda){</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.numeric</span>(y)){</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;For method cssLasso, y must be a numeric vector.&quot;</span>)</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.matrix</span>(y)){</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;For method cssLasso, y must be a numeric vector (inputted y was a matrix).&quot;</span>)</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(n <span class="sc">!=</span> <span class="fu">length</span>(y)){</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;For method cssLasso, y must be a vector of length equal to nrow(X).&quot;</span>)</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">unique</span>(y)) <span class="sc">&lt;=</span> <span class="dv">1</span>){</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Subsample with only one unique value of y detected--for method cssLasso, all subsamples of y of size floor(n/2) must have more than one unique value.&quot;</span>)</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.numeric</span>(lambda) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.integer</span>(lambda)){</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;For method cssLasso, lambda must be a numeric.&quot;</span>)</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(lambda))){</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;NA detected in provided lambda input to cssLasso&quot;</span>)</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(lambda) <span class="sc">!=</span> <span class="dv">1</span>){</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;For method cssLasso, lambda must be a numeric of length 1.&quot;</span>)</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(lambda <span class="sc">&lt;</span> <span class="dv">0</span>){</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;For method cssLasso, lambda must be nonnegative.&quot;</span>)</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkCssLassoInputs()</code>:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkCssLassoInputs works&quot;</span>, {</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">761</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span><span class="sc">*</span><span class="dv">4</span>), <span class="at">nrow=</span><span class="dv">15</span>, <span class="at">ncol=</span><span class="dv">4</span>)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkCssLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>))</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span><span class="fu">logical</span>(<span class="dv">15</span>), <span class="at">lambda=</span><span class="fl">0.05</span>),</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, y must be a numeric vector.&quot;</span>,</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLassoInputs</span>(<span class="at">X=</span>x[<span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>, ], <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>),</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, y must be a vector of length equal to nrow(X).&quot;</span>,</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span><span class="fu">rep</span>(<span class="fl">1.2</span>, <span class="dv">15</span>), <span class="at">lambda=</span><span class="fl">0.05</span>),</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Subsample with only one unique value of y detected--for method cssLasso, all subsamples of y of size floor(n/2) must have more than one unique value.&quot;</span>,</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="cn">TRUE</span>),</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be a numeric.&quot;</span>,</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>)),</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;NA detected in provided lambda input to cssLasso&quot;</span>,</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="sc">-</span><span class="fl">0.01</span>),</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be nonnegative.&quot;</span>,</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span>x),</span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be a numeric of length 1.&quot;</span>,</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fu">numeric</span>()),</span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be a numeric of length 1.&quot;</span>,</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCssLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="sc">-</span><span class="fl">0.01</span>),</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be nonnegative.&quot;</span>,</span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🌈</code></pre>
<p>Tests for <code>cssLoop()</code> (had to define <code>checkCssLassoInputs()</code> first):</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;cssLoop works&quot;</span>, {</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">89134</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">9</span><span class="sc">*</span><span class="dv">8</span>), <span class="at">nrow=</span><span class="dv">9</span>, <span class="at">ncol=</span><span class="dv">8</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">9</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">cssLoop</span>(<span class="at">input=</span>1L<span class="sc">:</span>4L, <span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.05</span>,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fitfun=</span>cssLasso)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(output))</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(output), <span class="fu">length</span>(<span class="fu">unique</span>(output)))</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(output) <span class="sc">&lt;=</span> <span class="dv">8</span>)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(output <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(output <span class="sc">&lt;=</span> <span class="dv">8</span>))</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssLoop</span>(<span class="at">input=</span>1L<span class="sc">:</span>6L, <span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.05</span>,</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">fitfun=</span>cssLasso),</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;floor(n/2) == length(subsample) is not TRUE&quot;</span>,</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssLoop</span>(<span class="at">input=</span>1L<span class="sc">:</span>4L, <span class="at">x=</span>x, <span class="at">y=</span>y[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>],</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">lambda=</span><span class="fl">0.05</span>, <span class="at">fitfun=</span>cssLasso),</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(y) == n is not TRUE&quot;</span>,</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssLoop</span>(<span class="at">input=</span>1L<span class="sc">:</span>4L, <span class="at">x=</span>x, <span class="at">y=</span><span class="fu">logical</span>(<span class="dv">9</span>),</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">lambda=</span><span class="fl">0.05</span>, <span class="at">fitfun=</span>cssLasso),</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, y must be a numeric vector.&quot;</span>,</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssLoop</span>(<span class="at">input=</span>1L<span class="sc">:</span>4L, <span class="at">x=</span>x, <span class="at">y=</span>y,</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">lambda=</span>x, <span class="at">fitfun=</span>cssLasso),</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be a numeric of length 1.&quot;</span>,</span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test other input format</span></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>  alt_input <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;subsample&quot;</span><span class="ot">=</span><span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>, <span class="st">&quot;feats_to_keep&quot;</span><span class="ot">=</span><span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="fu">rep</span>(<span class="cn">TRUE</span>, <span class="dv">4</span>),</span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>                                                       <span class="fu">rep</span>(<span class="cn">FALSE</span>, <span class="dv">2</span>), <span class="cn">TRUE</span>))</span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>  output2 <span class="ot">&lt;-</span> <span class="fu">cssLoop</span>(<span class="at">input=</span>alt_input, <span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.08</span>, <span class="at">fitfun=</span>cssLasso)</span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(output2))</span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(output2), <span class="fu">length</span>(<span class="fu">unique</span>(output2)))</span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(output2) <span class="sc">&lt;=</span> <span class="dv">8</span>)</span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(output2 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">8</span>)))</span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssLoop</span>(<span class="at">input=</span> <span class="fu">list</span>(<span class="st">&quot;subsample&quot;</span><span class="ot">=</span><span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">&quot;feats_to_keep&quot;</span><span class="ot">=</span><span class="fu">c</span>(<span class="cn">FALSE</span>,</span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>                                                               <span class="fu">rep</span>(<span class="cn">TRUE</span>, <span class="dv">4</span>),</span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>                                                               <span class="fu">rep</span>(<span class="cn">FALSE</span>, <span class="dv">2</span>))),</span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.08</span>, <span class="at">fitfun=</span>cssLasso),</span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(feats_to_keep) == p is not TRUE&quot;</span>,</span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Custom fitfun with nonsense lambda (which will be ignored by fitfun, and</span></span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># shouldn&#39;t throw any error, because the acceptable input for lambda should be</span></span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># enforced only by fitfun) and nonsense y</span></span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a>  testFitfun <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, lambda){</span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose p/2 features randomly</span></span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a>    selected <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(p, <span class="at">size=</span><span class="fu">floor</span>(p<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(selected)</span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(<span class="fu">cssLoop</span>(<span class="at">input=</span>1L<span class="sc">:</span>4L, <span class="at">x=</span>x, <span class="at">y=</span>y,</span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">lambda=</span><span class="cn">TRUE</span>, <span class="at">fitfun=</span>testFitfun)))</span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(<span class="fu">cssLoop</span>(<span class="at">input=</span>1L<span class="sc">:</span>4L, <span class="at">x=</span>x,</span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">y=</span><span class="fu">character</span>(<span class="dv">9</span>), <span class="at">lambda=</span>.<span class="dv">05</span>,</span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">fitfun=</span>testFitfun)))</span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🎊</code></pre>
<p><code>checkGetClusterSelMatrixInput()</code>:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to check inputs to getClusterSelMatrix function</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A named list where each entry is an integer vector of indices</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of features that are in a common cluster, as in the output of formatClusters.</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (The length of list clusters is equal to the number of clusters.) All</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; identified clusters must be non-overlapping, and all features must appear in</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; exactly one cluster (any unclustered features should be in their own</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;cluster&quot; of size 1).</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param res A binary integer matrix. res[i, j] = 1 if feature j was selected</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; on subsample i and equals 0 otherwise, as in the output of getSelMatrix.</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (That is, each row is a selected set.)</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return The parameter B, corresponding to half of the subsamples for </span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; sampling_type &quot;SS&quot;.</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>checkGetClusterSelMatrixInput <span class="ot">&lt;-</span> <span class="cf">function</span>(clusters, res){</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(res <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)))</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(res)</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(res) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkClusters</span>(clusters, p)</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkGetClusterSelMatrixInput()</code>:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkGetClusterSelMatrixInput works&quot;</span>, {</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">happy=</span>1L<span class="sc">:</span>8L, <span class="at">sad=</span>9L<span class="sc">:</span>10L, <span class="at">med=</span>11L)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">size=</span><span class="dv">6</span><span class="sc">*</span><span class="dv">11</span>, <span class="at">replace=</span><span class="cn">TRUE</span>), <span class="at">nrow=</span><span class="dv">6</span>, <span class="at">ncol=</span><span class="dv">11</span>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkGetClusterSelMatrixInput</span>(good_clusters, res))</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetClusterSelMatrixInput</span>(<span class="fu">list</span>(<span class="at">happy=</span>1L<span class="sc">:</span>8L,</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>                                                            <span class="at">med=</span>11L), res),</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(all_clustered_feats) == p is not TRUE&quot;</span>,</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetClusterSelMatrixInput</span>(good_clusters, <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>),</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.matrix(res) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetClusterSelMatrixInput</span>(good_clusters, res <span class="sc">+</span> .<span class="dv">3</span>),</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(res %in% c(0, 1)) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetClusterSelMatrixInput</span>(good_clusters,</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>                                                       res[, <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>]),</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(all_clustered_feats) == p is not TRUE&quot;</span>,</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetClusterSelMatrixInput</span>(1L<span class="sc">:</span>10L, res),</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.list(clusters) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetClusterSelMatrixInput</span>(<span class="fu">list</span>(<span class="at">c1=</span>1L<span class="sc">:</span>5L,</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>                                                            <span class="at">c2=</span>6L<span class="sc">:</span>8L,</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>                                                            <span class="at">c3=</span>9L,</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>                                                            <span class="at">c4=</span><span class="fu">integer</span>()), res),</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(lengths(clusters) &gt;= 1) is not TRUE&quot;</span>,</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetClusterSelMatrixInput</span>(<span class="fu">list</span>(<span class="at">c1=</span>1L<span class="sc">:</span>5L,</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">c2=</span>6L<span class="sc">:</span>8L, <span class="at">c3=</span>9L,</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">c4=</span><span class="fu">as.integer</span>(<span class="cn">NA</span>)), res),</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(!is.na(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetClusterSelMatrixInput</span>(<span class="fu">list</span>(<span class="at">c1=</span>1L<span class="sc">:</span>5L,</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">c2=</span>6L<span class="sc">:</span>8L, <span class="at">c3=</span>9L,</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">c2=</span>6L<span class="sc">:</span>8L), res),</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n_clusters == length(unique(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetClusterSelMatrixInput</span>(<span class="fu">list</span>(<span class="at">c1=</span>1L<span class="sc">:</span>5L,</span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">c2=</span>6L<span class="sc">:</span>8L, <span class="at">c3=</span>14L), res),</span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(all_clustered_feats) == p is not TRUE&quot;</span>,</span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🎉</code></pre>
</div>
</div>
<div id="tests-for-main-functions-in-cssr" class="section level1 hasAnchor" number="4">
<h1 class="hasAnchor"><span class="header-section-number">4</span> Tests for main functions in <code>cssr</code><a href="#tests-for-main-functions-in-cssr" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Now that the helper functions have been defined, we move on to tests for the main functions in the package.</p>
<p>Tests for <code>createSubsamples()</code>:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;createSubsamples works&quot;</span>, {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">createSubsamples</span>(<span class="at">n=</span>20L, <span class="at">p=</span>5L, <span class="at">B=</span>11L, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">prop_feats_remove=</span><span class="dv">0</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span><span class="sc">*</span><span class="dv">11</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">lengths</span>(res) <span class="sc">==</span> <span class="dv">20</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">unique</span>(res[[<span class="dv">13</span>]])), <span class="dv">20</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>  set <span class="ot">&lt;-</span> res[[<span class="dv">4</span>]]</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>  comp_set <span class="ot">&lt;-</span> res[[<span class="dv">4</span> <span class="sc">+</span> <span class="dv">11</span>]]</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(set, comp_set)), <span class="dv">0</span>)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">union</span>(set, comp_set)), <span class="fu">length</span>(<span class="fu">c</span>(set, comp_set)))</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">20</span>, <span class="fu">length</span>(<span class="fu">c</span>(set, comp_set)))</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try odd n</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>  res_odd <span class="ot">&lt;-</span> <span class="fu">createSubsamples</span>(<span class="at">n=</span>19L, <span class="at">p=</span>23L, <span class="at">B=</span>13L, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>                              <span class="at">prop_feats_remove=</span><span class="dv">0</span>)</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_odd))</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res_odd), <span class="dv">2</span><span class="sc">*</span><span class="dv">13</span>)</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">lengths</span>(res_odd) <span class="sc">==</span> <span class="fu">floor</span>(<span class="dv">19</span><span class="sc">/</span><span class="dv">2</span>)))</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">unique</span>(res_odd[[<span class="dv">3</span>]])), <span class="fu">floor</span>(<span class="dv">19</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>  set_odd <span class="ot">&lt;-</span> res_odd[[<span class="dv">2</span>]]</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>  comp_set_odd <span class="ot">&lt;-</span> res_odd[[<span class="dv">2</span> <span class="sc">+</span> <span class="dv">13</span>]]</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(set_odd, comp_set_odd)), <span class="dv">0</span>)</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">union</span>(set_odd, comp_set_odd)),</span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">c</span>(set_odd, comp_set_odd)))</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">19</span> <span class="sc">-</span> <span class="dv">1</span>, <span class="fu">length</span>(<span class="fu">c</span>(set_odd, comp_set_odd)))</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">createSubsamples</span>(<span class="at">n=</span>20L, <span class="at">p=</span>5L, <span class="at">B=</span>11L, <span class="at">sampling_type=</span><span class="st">&quot;MB&quot;</span>,</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>                          <span class="at">prop_feats_remove=</span><span class="dv">0</span>),</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sampling_type MB is not yet supported (and isn&#39;t recommended anyway)&quot;</span>,</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># misspecified sampling_type (not specifying error because contains quotation</span></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># marks)</span></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">createSubsamples</span>(<span class="at">n=</span>20L, <span class="at">p=</span>5L, <span class="at">B=</span>11L, <span class="at">sampling_type=</span><span class="st">&quot;S&quot;</span>,</span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>                          <span class="at">prop_feats_remove=</span><span class="dv">0</span>))</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">createSubsamples</span>(<span class="at">n=</span><span class="fl">11.1</span>, <span class="at">p=</span>5L, <span class="at">B=</span>11L, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>                          <span class="at">prop_feats_remove=</span><span class="dv">0</span>),</span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n == round(n) is not TRUE&quot;</span>,</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">createSubsamples</span>(<span class="at">n=</span><span class="sc">-</span>20L, <span class="at">p=</span>5L, <span class="at">B=</span>11L, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>                          <span class="at">prop_feats_remove=</span><span class="dv">0</span>),</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n &gt; 0 is not TRUE&quot;</span>,</span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">createSubsamples</span>(<span class="at">n=</span>20L, <span class="at">p=</span>5L, <span class="at">B=</span><span class="fl">25.6</span>, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>                          <span class="at">prop_feats_remove=</span><span class="dv">0</span>),</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(subsamples) == B is not TRUE&quot;</span>,</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😸</code></pre>
<p>Tests for <code>getSubsamps()</code>:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getSubsamps works&quot;</span>, {</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getSubsamps</span>(<span class="at">n=</span>18L, <span class="at">B=</span>21L, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span><span class="sc">*</span><span class="dv">21</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">lengths</span>(res) <span class="sc">==</span> <span class="dv">18</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">unique</span>(res[[<span class="dv">7</span>]])), <span class="dv">18</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  set <span class="ot">&lt;-</span> res[[<span class="dv">3</span>]]</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  comp_set <span class="ot">&lt;-</span> res[[<span class="dv">3</span> <span class="sc">+</span> <span class="dv">21</span>]]</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(set, comp_set)), <span class="dv">0</span>)</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">union</span>(set, comp_set)), <span class="fu">length</span>(<span class="fu">c</span>(set, comp_set)))</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">18</span>, <span class="fu">length</span>(<span class="fu">c</span>(set, comp_set)))</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😸</code></pre>
<p>Tests for <code>getSelMatrix()</code>:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getSelMatrix works&quot;</span>, {</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">98623</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">25</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">25</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">25</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  subsamps_object <span class="ot">&lt;-</span> <span class="fu">createSubsamples</span>(<span class="at">n=</span><span class="dv">25</span>, <span class="at">p=</span><span class="dv">6</span>, <span class="at">B=</span><span class="dv">12</span>, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">prop_feats_remove=</span><span class="dv">0</span>)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getSelMatrix</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B=</span><span class="dv">12</span>, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">subsamps_object=</span>subsamps_object, <span class="at">num_cores=</span><span class="dv">1</span>,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fitfun=</span>cssLasso)</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res), <span class="dv">2</span><span class="sc">*</span><span class="dv">12</span>)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res), <span class="dv">6</span>)</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)))</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">is.integer</span>(res)))</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try a different fitfun</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>  testFitfun <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, lambda){</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose p/2 features randomly</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>    selected <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(p, <span class="at">size=</span><span class="fu">floor</span>(p<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(selected)</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note that value of lambda doesn&#39;t matter</span></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>  res2 <span class="ot">&lt;-</span> <span class="fu">getSelMatrix</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="st">&quot;foo&quot;</span>, <span class="at">B=</span><span class="dv">12</span>, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>                      <span class="at">subsamps_object=</span>subsamps_object, <span class="at">num_cores=</span><span class="dv">1</span>,</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fitfun=</span>testFitfun)</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res2))</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res2), <span class="dv">2</span><span class="sc">*</span><span class="dv">12</span>)</span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res2), <span class="dv">6</span>)</span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res2 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)))</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">is.integer</span>(res2)))</span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getSelMatrix</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="st">&quot;0.02&quot;</span>, <span class="at">B=</span><span class="dv">12</span>, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>                      <span class="at">subsamps_object=</span><span class="st">&quot;subsamps_object&quot;</span>, <span class="at">num_cores=</span><span class="dv">1</span>,</span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fitfun=</span>testFitfun),</span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;is.integer(subsample) is not TRUE&quot;</span>,</span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getSelMatrix</span>(<span class="at">x=</span>x[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, ], <span class="at">y=</span>y, <span class="at">lambda=</span><span class="st">&quot;foo&quot;</span>, <span class="at">B=</span><span class="dv">12</span>, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>                      <span class="at">subsamps_object=</span>subsamps_object, <span class="at">num_cores=</span><span class="dv">1</span>,</span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fitfun=</span>testFitfun),</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;length(y) == n is not TRUE&quot;</span>,</span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getSelMatrix</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="sc">-</span><span class="fl">0.02</span>, <span class="at">B=</span><span class="dv">12</span>, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>                      <span class="at">subsamps_object=</span>subsamps_object, <span class="at">num_cores=</span><span class="dv">1</span>,</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fitfun=</span>cssLasso),</span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;For method cssLasso, lambda must be nonnegative.&quot;</span>,</span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Wrong B</span></span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getSelMatrix</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.02</span>, <span class="at">B=</span><span class="dv">37</span>, <span class="at">sampling_type=</span><span class="st">&quot;SS&quot;</span>,</span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a>                      <span class="at">subsamps_object=</span>subsamps_object, <span class="at">num_cores=</span><span class="dv">1</span>,</span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fitfun=</span>cssLasso),</span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;length(res_list) == nrow(res) is not TRUE&quot;</span>,</span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🎉</code></pre>
<p>Tests for <code>cssLasso()</code>:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;cssLasso works&quot;</span>, {</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">24509</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span><span class="sc">*</span><span class="dv">4</span>), <span class="at">nrow=</span><span class="dv">15</span>, <span class="at">ncol=</span><span class="dv">4</span>)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span>)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssLasso</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>)</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res))</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res) <span class="sc">&lt;=</span> <span class="dv">4</span>)</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res) <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(res)))</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res <span class="sc">&lt;=</span> <span class="dv">4</span>))</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssLasso</span>(<span class="at">X=</span>x[<span class="dv">1</span><span class="sc">:</span><span class="dv">13</span>, ], <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>),</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, y must be a vector of length equal to nrow(X).&quot;</span>,</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssLasso</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="sc">-</span><span class="fl">0.01</span>),</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be nonnegative.&quot;</span>,</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😀</code></pre>
<p>Tests for <code>getClusterSelMatrix()</code>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getClusterSelMatrix works&quot;</span>, {</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>5L,</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">green_cluster=</span>6L<span class="sc">:</span>8L, <span class="at">blue_clust=</span>9L)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  B <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="dv">9</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  res_entries <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">size=</span><span class="dv">2</span><span class="sc">*</span>B<span class="sc">*</span>p, <span class="at">replace=</span><span class="cn">TRUE</span>))</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>  good_res <span class="ot">&lt;-</span> <span class="fu">matrix</span>(res_entries, <span class="at">nrow=</span><span class="dv">2</span><span class="sc">*</span>B, <span class="at">ncol=</span>p)</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getClusterSelMatrix</span>(good_clusters, good_res)</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res), <span class="dv">2</span><span class="sc">*</span>B)</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3 clusters</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res), <span class="dv">3</span>)</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(res), <span class="fu">c</span>(<span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;green_cluster&quot;</span>,</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;blue_clust&quot;</span>))</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">is.integer</span>(res)))</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)))</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>  clust_2 <span class="ot">&lt;-</span> good_clusters[[<span class="dv">2</span>]]</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>  any_one <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(good_res[, clust_2]) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(any_one)){</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res[any_one, <span class="dv">2</span>] <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>  all_zeros <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(good_res[, clust_2]) <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(all_zeros)){</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res[all_zeros, <span class="dv">2</span>] <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Not all features in a cluster</span></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>  bad_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>5L, <span class="at">green_cluster=</span>6L<span class="sc">:</span>7L, <span class="at">blue_clust=</span>9L)</span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getClusterSelMatrix</span>(bad_clusters, good_res),</span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(all_clustered_feats) == p is not TRUE&quot;</span>,</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>  bad_res_entries <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="at">size=</span><span class="dv">2</span><span class="sc">*</span>B<span class="sc">*</span>p, <span class="at">replace=</span><span class="cn">TRUE</span>))</span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>  bad_res <span class="ot">&lt;-</span> <span class="fu">matrix</span>(bad_res_entries, <span class="at">nrow=</span><span class="dv">2</span><span class="sc">*</span>B, <span class="at">ncol=</span>p)</span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getClusterSelMatrix</span>(good_clusters, bad_res),</span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(res %in% c(0, 1)) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🌈</code></pre>
<p>Finally, tests for <code>css()</code> itself!</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;css works&quot;</span>, {</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">8712</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span><span class="sc">*</span><span class="dv">11</span>), <span class="at">nrow=</span><span class="dv">15</span>, <span class="at">ncol=</span><span class="dv">11</span>)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span>)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Intentionally don&#39;t provide clusters for all feature, mix up formatting,</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># etc.</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>5L,</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">green_cluster=</span>6L<span class="sc">:</span>8L,</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">c4=</span><span class="dv">10</span><span class="sc">:</span><span class="dv">11</span>)</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters, <span class="at">fitfun =</span> cssLasso,</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampling_type =</span> <span class="st">&quot;SS&quot;</span>, <span class="at">B =</span> <span class="dv">13</span>,</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop_feats_remove =</span> <span class="dv">0</span>, <span class="at">train_inds =</span> <span class="fu">integer</span>(), <span class="at">num_cores =</span> 1L)</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Basic output</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">class</span>(res), <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;feat_sel_mat&quot;</span>, <span class="st">&quot;clus_sel_mat&quot;</span>, <span class="st">&quot;X&quot;</span>,</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;y&quot;</span>, <span class="st">&quot;clusters&quot;</span>, <span class="st">&quot;train_inds&quot;</span>))</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># feat_sel mat</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>feat_sel_mat))</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>feat_sel_mat))</span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>feat_sel_mat <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)))</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>feat_sel_mat), <span class="dv">11</span>)</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>feat_sel_mat))</span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># clus_sel_mat</span></span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>clus_sel_mat))</span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>clus_sel_mat))</span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>clus_sel_mat <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)))</span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4 clusters</span></span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>clus_sel_mat), <span class="dv">4</span>)</span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>clus_sel_mat), <span class="fu">names</span>(res<span class="sc">$</span>clusters))</span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>clus_sel_mat)), <span class="dv">4</span>)</span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>clus_sel_mat))), <span class="dv">4</span>)</span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>clus_sel_mat))))</span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>clus_sel_mat))))</span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X</span></span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>X))</span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>X)))</span>
<span id="cb78-45"><a href="#cb78-45" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>X))</span>
<span id="cb78-46"><a href="#cb78-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>X), <span class="dv">11</span>)</span>
<span id="cb78-47"><a href="#cb78-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>X), <span class="dv">15</span>)</span>
<span id="cb78-48"><a href="#cb78-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-49"><a href="#cb78-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y</span></span>
<span id="cb78-50"><a href="#cb78-50" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>y))</span>
<span id="cb78-51"><a href="#cb78-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>y), <span class="dv">15</span>)</span>
<span id="cb78-52"><a href="#cb78-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-53"><a href="#cb78-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># clusters</span></span>
<span id="cb78-54"><a href="#cb78-54" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>clusters))</span>
<span id="cb78-55"><a href="#cb78-55" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>clusters), <span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters)))</span>
<span id="cb78-56"><a href="#cb78-56" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>clusters),</span>
<span id="cb78-57"><a href="#cb78-57" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters))))</span>
<span id="cb78-58"><a href="#cb78-58" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters))))</span>
<span id="cb78-59"><a href="#cb78-59" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res<span class="sc">$</span>clusters))))</span>
<span id="cb78-60"><a href="#cb78-60" aria-hidden="true" tabindex="-1"></a>  clust_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb78-61"><a href="#cb78-61" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>clusters)){</span>
<span id="cb78-62"><a href="#cb78-62" aria-hidden="true" tabindex="-1"></a>    clust_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(clust_feats, res<span class="sc">$</span>clusters[[i]])</span>
<span id="cb78-63"><a href="#cb78-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-64"><a href="#cb78-64" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">unique</span>(clust_feats)))</span>
<span id="cb78-65"><a href="#cb78-65" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="fu">length</span>(<span class="fu">intersect</span>(clust_feats,</span>
<span id="cb78-66"><a href="#cb78-66" aria-hidden="true" tabindex="-1"></a>                                                               <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>)))</span>
<span id="cb78-67"><a href="#cb78-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># train_inds</span></span>
<span id="cb78-68"><a href="#cb78-68" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res<span class="sc">$</span>train_inds, <span class="fu">integer</span>())</span>
<span id="cb78-69"><a href="#cb78-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-70"><a href="#cb78-70" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying other inputs</span></span>
<span id="cb78-71"><a href="#cb78-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-72"><a href="#cb78-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a data.frame</span></span>
<span id="cb78-73"><a href="#cb78-73" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb78-74"><a href="#cb78-74" aria-hidden="true" tabindex="-1"></a>  res_fitfun <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df, <span class="at">y=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)), <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb78-75"><a href="#cb78-75" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">class</span>(res_fitfun), <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb78-76"><a href="#cb78-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-77"><a href="#cb78-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a dataframe with factors (number of columns of final design matrix</span></span>
<span id="cb78-78"><a href="#cb78-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after one-hot encoding factors won&#39;t match number of columns of df2)</span></span>
<span id="cb78-79"><a href="#cb78-79" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> X_df</span>
<span id="cb78-80"><a href="#cb78-80" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>cyl)</span>
<span id="cb78-81"><a href="#cb78-81" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>vs)</span>
<span id="cb78-82"><a href="#cb78-82" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>am)</span>
<span id="cb78-83"><a href="#cb78-83" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>gear)</span>
<span id="cb78-84"><a href="#cb78-84" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>carb)</span>
<span id="cb78-85"><a href="#cb78-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-86"><a href="#cb78-86" aria-hidden="true" tabindex="-1"></a>  res_fitfun <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>df2, <span class="at">y=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)), <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb78-87"><a href="#cb78-87" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">class</span>(res_fitfun), <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb78-88"><a href="#cb78-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-89"><a href="#cb78-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a matrix with column names</span></span>
<span id="cb78-90"><a href="#cb78-90" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> x</span>
<span id="cb78-91"><a href="#cb78-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x2) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb78-92"><a href="#cb78-92" aria-hidden="true" tabindex="-1"></a>  res_names <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x2, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">13</span>)</span>
<span id="cb78-93"><a href="#cb78-93" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">class</span>(res_names), <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb78-94"><a href="#cb78-94" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(x2), <span class="fu">colnames</span>(res_names<span class="sc">$</span>X))</span>
<span id="cb78-95"><a href="#cb78-95" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(x2), <span class="fu">colnames</span>(res_names<span class="sc">$</span>feat_sel_mat))</span>
<span id="cb78-96"><a href="#cb78-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-97"><a href="#cb78-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Custom fitfun with nonsense lambda (which will be ignored by fitfun, and</span></span>
<span id="cb78-98"><a href="#cb78-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># shouldn&#39;t throw any error, because the acceptable input for lambda should be</span></span>
<span id="cb78-99"><a href="#cb78-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># enforced only by fitfun)</span></span>
<span id="cb78-100"><a href="#cb78-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-101"><a href="#cb78-101" aria-hidden="true" tabindex="-1"></a>  testFitfun <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, lambda){</span>
<span id="cb78-102"><a href="#cb78-102" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb78-103"><a href="#cb78-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb78-104"><a href="#cb78-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose p/2 features randomly</span></span>
<span id="cb78-105"><a href="#cb78-105" aria-hidden="true" tabindex="-1"></a>    selected <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(p, <span class="at">size=</span><span class="fu">floor</span>(p<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb78-106"><a href="#cb78-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(selected)</span>
<span id="cb78-107"><a href="#cb78-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-108"><a href="#cb78-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-109"><a href="#cb78-109" aria-hidden="true" tabindex="-1"></a>  res_fitfun <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fu">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="st">&quot;bar&quot;</span>),</span>
<span id="cb78-110"><a href="#cb78-110" aria-hidden="true" tabindex="-1"></a>                    <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">B =</span> <span class="dv">10</span>, <span class="at">fitfun=</span>testFitfun)</span>
<span id="cb78-111"><a href="#cb78-111" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">class</span>(res_fitfun), <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb78-112"><a href="#cb78-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-113"><a href="#cb78-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad lambda</span></span>
<span id="cb78-114"><a href="#cb78-114" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="sc">-</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>),</span>
<span id="cb78-115"><a href="#cb78-115" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be nonnegative.&quot;</span>,</span>
<span id="cb78-116"><a href="#cb78-116" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb78-117"><a href="#cb78-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-118"><a href="#cb78-118" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="st">&quot;foo&quot;</span>, <span class="at">B =</span> <span class="dv">10</span>),</span>
<span id="cb78-119"><a href="#cb78-119" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be a numeric.&quot;</span>,</span>
<span id="cb78-120"><a href="#cb78-120" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb78-121"><a href="#cb78-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-122"><a href="#cb78-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Single cluster</span></span>
<span id="cb78-123"><a href="#cb78-123" aria-hidden="true" tabindex="-1"></a>  res_sing_clust <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb78-124"><a href="#cb78-124" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">class</span>(res_sing_clust), <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb78-125"><a href="#cb78-125" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res_sing_clust<span class="sc">$</span>clusters), <span class="dv">11</span> <span class="sc">-</span> <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb78-126"><a href="#cb78-126" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res_sing_clust<span class="sc">$</span>clusters))) <span class="sc">==</span> <span class="dv">11</span> <span class="sc">-</span></span>
<span id="cb78-127"><a href="#cb78-127" aria-hidden="true" tabindex="-1"></a>                          <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb78-128"><a href="#cb78-128" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">names</span>(res_sing_clust<span class="sc">$</span>clusters))))</span>
<span id="cb78-129"><a href="#cb78-129" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res_sing_clust<span class="sc">$</span>clusters))))</span>
<span id="cb78-130"><a href="#cb78-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-131"><a href="#cb78-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># No cluster</span></span>
<span id="cb78-132"><a href="#cb78-132" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">class</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)), <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb78-133"><a href="#cb78-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-134"><a href="#cb78-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># All clusters named</span></span>
<span id="cb78-135"><a href="#cb78-135" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">class</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span><span class="fu">list</span>(<span class="st">&quot;a&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb78-136"><a href="#cb78-136" aria-hidden="true" tabindex="-1"></a>                                                               <span class="st">&quot;b&quot;</span><span class="ot">=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb78-137"><a href="#cb78-137" aria-hidden="true" tabindex="-1"></a>                                                               <span class="st">&quot;c&quot;</span><span class="ot">=</span><span class="dv">11</span>),</span>
<span id="cb78-138"><a href="#cb78-138" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B=</span><span class="dv">10</span>)), <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb78-139"><a href="#cb78-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-140"><a href="#cb78-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Other sampling types</span></span>
<span id="cb78-141"><a href="#cb78-141" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="dv">1</span>, <span class="at">sampling_type=</span><span class="st">&quot;MB&quot;</span>),</span>
<span id="cb78-142"><a href="#cb78-142" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sampling_type MB is not yet supported (and isn&#39;t recommended anyway)&quot;</span>,</span>
<span id="cb78-143"><a href="#cb78-143" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb78-144"><a href="#cb78-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-145"><a href="#cb78-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Error has quotation marks in it</span></span>
<span id="cb78-146"><a href="#cb78-146" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="dv">1</span>, <span class="at">sampling_type=</span><span class="st">&quot;S&quot;</span>))</span>
<span id="cb78-147"><a href="#cb78-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-148"><a href="#cb78-148" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="dv">1</span>, <span class="at">sampling_type=</span><span class="dv">1</span>),</span>
<span id="cb78-149"><a href="#cb78-149" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.character(sampling_type) is not TRUE&quot;</span>,</span>
<span id="cb78-150"><a href="#cb78-150" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb78-151"><a href="#cb78-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-152"><a href="#cb78-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># B</span></span>
<span id="cb78-153"><a href="#cb78-153" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="dv">1</span>, <span class="at">B=</span><span class="dv">5</span>),</span>
<span id="cb78-154"><a href="#cb78-154" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Small values of B may lead to poor results.&quot;</span>,</span>
<span id="cb78-155"><a href="#cb78-155" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb78-156"><a href="#cb78-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-157"><a href="#cb78-157" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="dv">1</span>, <span class="at">B=</span><span class="fu">list</span>(<span class="dv">10</span>)),</span>
<span id="cb78-158"><a href="#cb78-158" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;is.numeric(B) | is.integer(B) is not TRUE&quot;</span>,</span>
<span id="cb78-159"><a href="#cb78-159" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb78-160"><a href="#cb78-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-161"><a href="#cb78-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clusters</span></span>
<span id="cb78-162"><a href="#cb78-162" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="dv">1</span>, <span class="at">clusters=</span><span class="st">&quot;red&quot;</span>),</span>
<span id="cb78-163"><a href="#cb78-163" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;is.numeric(clusters) | is.integer(clusters) is not TRUE&quot;</span>,</span>
<span id="cb78-164"><a href="#cb78-164" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb78-165"><a href="#cb78-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-166"><a href="#cb78-166" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prop_feats_remove</span></span>
<span id="cb78-167"><a href="#cb78-167" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">class</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>,</span>
<span id="cb78-168"><a href="#cb78-168" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">prop_feats_remove=</span><span class="fl">0.3</span>)), <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb78-169"><a href="#cb78-169" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Weirdly high, but still valid, value of prop_feats_remove</span></span>
<span id="cb78-170"><a href="#cb78-170" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">class</span>(<span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>,</span>
<span id="cb78-171"><a href="#cb78-171" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">prop_feats_remove=</span><span class="fl">0.9999999999</span>)), <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb78-172"><a href="#cb78-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-173"><a href="#cb78-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use train_inds argument</span></span>
<span id="cb78-174"><a href="#cb78-174" aria-hidden="true" tabindex="-1"></a>  res_train <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>, <span class="at">train_inds=</span><span class="dv">11</span><span class="sc">:</span><span class="dv">15</span>)</span>
<span id="cb78-175"><a href="#cb78-175" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(res_train<span class="sc">$</span>train_inds, <span class="dv">11</span><span class="sc">:</span><span class="dv">15</span>)</span>
<span id="cb78-176"><a href="#cb78-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-177"><a href="#cb78-177" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥳</code></pre>
</div>
<div id="sel-and-pred" class="section level1 hasAnchor" number="5">
<h1 class="hasAnchor"><span class="header-section-number">5</span> Selection and prediction functions<a href="#sel-and-pred" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Now that <code>css()</code> has been defined and tested, we write functions to work with the output of <code>css()</code>. The output of these functions will be of more direct interest for most end users than the output of <code>css()</code>. These functions are defined separately from <code>css()</code> because the most computationally intensive steps happen within <code>css()</code>. <code>css()</code> can be called only once on a data set, and then the functions that follow can be explored relatively quickly (one can try different parameters, etc.).</p>
<ul>
<li><code>getCssSelections()</code> takes in the results of <code>css()</code> along with user-defined parameters on how to select clusters (a minimum or maximum number of clusters to select, along with a cutoff for cluster selection proportions) and selects clusters as well as features from those clusters.</li>
<li><code>getCssDesign()</code> takes in the same inputs as <code>getCssSelections()</code> along with an unlabeled test matrix of features X (containing the same features as the X matrix provided originally to <code>css()</code>). It uses the results from <code>css()</code> to select clusters like <code>getCssSelections()</code>, then it uses a user-selected weighting scheme to compute weighted averages of the cluster members. It returns a test matrix of cluster representatives, which can be used for downstream predictive tasks.</li>
<li>Finally, <code>getCssPreds()</code> has the same inputs as <code>getCssPreds()</code> <em>FIX THIS TYPO</em>, except it also accepts a set of labeled training data (where the response must be real-valued). <code>getCssPreds()</code> selects clusters, forms matrices of cluster representatives on the training and test data, uses the training matrix of cluster representatives (along with the vector of responses for the training data) to estimate a linear model via ordinary least squares, and finally generates predictions on the test data using this linear model.</li>
</ul>
<p>As in the previous section, we first define each function and then define the helper functions called by that function. Tests are written for each function as soon as all of its dependencies have been defined.</p>
<ul>
<li><code>getCssSelections()</code>
<ul>
<li>Calls <code>checkCutoff()</code>, which checks that the specified cutoff input is as expected</li>
<li><code>checkWeighting()</code> verifies the weighting input to <code>getCssSelections()</code></li>
<li><code>checkMinNumClusts()</code> confirms that the <code>min_num_clusts</code> parameter provided to <code>getCssSelections()</code> is as expected</li>
<li>Likewise for <code>checkMaxNumClusts()</code></li>
<li><code>getSelectedClusters()</code> is the workhorse function of <code>getCssSelections()</code>, doing most of the work to get the selected clusters (and the selected features from those clusters) with the verified inputs
<ul>
<li><code>checkSelectedClusters()</code> checks internally that the selected clusters are as expected</li>
<li><code>getAllClustWeights()</code> gets the weights for each of the members of the selected clusters
<ul>
<li><code>getClustWeights()</code> gets the weights for a single cluster</li>
</ul></li>
<li><code>checkGetSelectedClustersOutput()</code> verifies the output of <code>getSelectedClusters()</code></li>
</ul></li>
</ul></li>
<li><code>getCssDesign()</code>
<ul>
<li><code>checkNewXProvided()</code> confirms that the design matrix provided to <code>getCssDesign()</code> matches the characteristics of the matrix that was provided to <code>css()</code>.
<ul>
<li><code>checkXInputResults()</code> also verifies these inputs (and is also used by <code>getCssPreds()</code> on both the training and test data)</li>
</ul></li>
<li><code>formCssDesign()</code> is the workhorse function, generating a matrix of cluster representatives with the verified inputs to <code>getCssDesign()</code>
<ul>
<li><code>checkFormCssDesignInputs()</code> verifies the inputs to <code>formCssDesign()</code> (somewhat redundantly here, but <code>formCssDesign()</code> is called by more than one function, so this verifies the inputs to <code>formCssDesign()</code> regardless of where it is called).</li>
</ul></li>
</ul></li>
<li><code>getCssPreds()</code>
<ul>
<li><code>checkGetCssPredsInputs()</code> verifies the inputs to <code>getCssPreds()</code></li>
</ul></li>
</ul>
<p><code>getCssSelections()</code>:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Obtain a selected set of clusters and features</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generate sets of selected clusters and features from cluster stability</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection.</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weighting Character; determines how to calculate the weights for</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual features within the selected clusters. Only those features with</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; nonzero weight within the selected clusters will be returned. Must be one of</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;sparse&quot;, &quot;weighted_avg&quot;, or &quot;simple_avg&#39;. For &quot;sparse&quot;, all the weight is</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; put on the most frequently</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected individual cluster member (or divided equally among all the clusters</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; that are tied for the top selection proportion if there is a tie). For</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;weighted_avg&quot;, only the features within a selected cluster that were</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; themselves selected on at least one subsample will have nonzero weight. For</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&quot;, each cluster member gets equal weight regardless of the</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual feature selection proportions (that is, all cluster members within</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; each selected cluster will be returned.). See Faletto and Bien (2022) for</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; details. Default is &quot;sparse&quot;.</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; getCssSelections will select and return only of those</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters with selection proportions equal to at least cutoff. Must be between</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 0 and 1. Default is 0 (in which case either all clusters are selected, or</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts are selected, if max_num_clusts is specified).</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.) Default is 1.</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) Default is NA (in which case</span></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts is ignored).</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with two items. \item{selected_clusts}{A named list of</span></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; integer vectors; each vector contains the indices of the features in one of</span></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the selected clusters.} \item{selected_feats}{A named integer vector; the</span></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of the features with nonzero weights from all of the selected</span></span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters.}</span></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references </span></span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>faletto2022<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>getCssSelections <span class="ot">&lt;-</span> <span class="cf">function</span>(css_results, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>){</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">class</span>(css_results) <span class="sc">==</span> <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkCutoff</span>(cutoff)</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkWeighting</span>(weighting)</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(css_results<span class="sc">$</span>feat_sel_mat)</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkMinNumClusts</span>(min_num_clusts, p, <span class="fu">length</span>(css_results<span class="sc">$</span>clusters))</span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>    max_num_clusts <span class="ot">&lt;-</span> <span class="fu">checkMaxNumClusts</span>(max_num_clusts, min_num_clusts, p,</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(css_results<span class="sc">$</span>clusters))</span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>    sel_results <span class="ot">&lt;-</span> <span class="fu">getSelectedClusters</span>(css_results, weighting, cutoff,</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>        min_num_clusts, max_num_clusts)</span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sel_results$selected_clusts is guaranteed to have length at least 1 by</span></span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># getSelectedClusters</span></span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>    sel_clust_names <span class="ot">&lt;-</span> <span class="fu">names</span>(sel_results<span class="sc">$</span>selected_clusts)</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(sel_clust_names) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(sel_clust_names <span class="sc">%in%</span> <span class="fu">names</span>(css_results<span class="sc">$</span>clusters)))</span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>    sel_clusts <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sel_clust_names)){</span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>        sel_clusts[[i]] <span class="ot">&lt;-</span> css_results<span class="sc">$</span>clusters[[sel_clust_names[i]]]</span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(sel_clusts)[i] <span class="ot">&lt;-</span> sel_clust_names[i]</span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.list</span>(sel_clusts))</span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(sel_clusts) <span class="sc">==</span> <span class="fu">length</span>(sel_clust_names))</span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sel_results$selected_feats is guaranteed to have length at least as long</span></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># as sel_results$selected_clusts by getSelectedClusters</span></span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">selected_clusts=</span>sel_clusts,</span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a>        <span class="at">selected_feats=</span>sel_results<span class="sc">$</span>selected_feats))</span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkCutoff()</code>:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the argument cutoff to several functions is</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; as expected</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; only those clusters with selection proportions equal</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to at least cutoff will be selected by cluster stability selection. Must be</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; between 0 and 1.</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>checkCutoff <span class="ot">&lt;-</span> <span class="cf">function</span>(cutoff){</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(cutoff) <span class="sc">|</span> <span class="fu">is.integer</span>(cutoff))</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(cutoff) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(cutoff))</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(cutoff <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(cutoff <span class="sc">&lt;=</span> <span class="dv">1</span>)</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkCutoff()</code>:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkCutoff works&quot;</span>, {</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkCutoff</span>(<span class="dv">0</span>))</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkCutoff</span>(<span class="fl">0.2</span>))</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkCutoff</span>(<span class="dv">1</span>))</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCutoff</span>(<span class="sc">-</span>.<span class="dv">2</span>), <span class="st">&quot;cutoff &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCutoff</span>(<span class="dv">2</span>), <span class="st">&quot;cutoff &lt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCutoff</span>(<span class="st">&quot;.3&quot;</span>),</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;is.numeric(cutoff) | is.integer(cutoff) is not TRUE&quot;</span>,</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCutoff</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="at">nrow=</span><span class="dv">4</span>, <span class="at">ncol=</span><span class="dv">3</span>)),</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(cutoff) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCutoff</span>(<span class="fu">numeric</span>()),</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(cutoff) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkCutoff</span>(<span class="fu">as.numeric</span>(<span class="cn">NA</span>)),</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.na(cutoff) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😀</code></pre>
<p><code>checkWeighting()</code>:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the argument weighting to several </span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; functions is as expected</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weighting Character; determines how to calculate the weights to</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; combine features from the selected clusters into weighted averages, called</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster representatives. Must be one of &quot;sparse&quot;, &quot;weighted_avg&quot;, or</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&#39;.</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>checkWeighting <span class="ot">&lt;-</span> <span class="cf">function</span>(weighting){</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(weighting)<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(weighting))</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.character</span>(weighting)){</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Weighting must be a character&quot;</span>)</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>(weighting <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;sparse&quot;</span>, <span class="st">&quot;simple_avg&quot;</span>, <span class="st">&quot;weighted_avg&quot;</span>))){</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Weighting must be a character and one of sparse, simple_avg, or weighted_avg&quot;</span>)</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkWeighting()</code>:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkWeighting works&quot;</span>, {</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkWeighting</span>(<span class="st">&quot;sparse&quot;</span>))</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkWeighting</span>(<span class="st">&quot;simple_avg&quot;</span>))</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkWeighting</span>(<span class="st">&quot;weighted_avg&quot;</span>))</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkWeighting</span>(<span class="fu">c</span>(<span class="st">&quot;sparse&quot;</span>, <span class="st">&quot;simple_avg&quot;</span>)),</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(weighting) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkWeighting</span>(<span class="cn">NA</span>), <span class="st">&quot;!is.na(weighting) is not TRUE&quot;</span>,</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkWeighting</span>(<span class="dv">1</span>), <span class="st">&quot;Weighting must be a character&quot;</span>,</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkWeighting</span>(<span class="st">&quot;spasre&quot;</span>),</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character and one of sparse, simple_avg, or weighted_avg&quot;</span>,</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🌈</code></pre>
<p><code>checkMinNumClusts()</code>:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the argument min_num_clusts to several </span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; functions is as expected</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.)</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p The number of features; since this is an upper bound on the number</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of clusters of features, it is also an upper bound on min_num_clusts.</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n_clusters The number of clusters; note that this is an upper bound</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; on min_num_clusts</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>checkMinNumClusts <span class="ot">&lt;-</span> <span class="cf">function</span>(min_num_clusts, p, n_clusters){</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(min_num_clusts) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(min_num_clusts) <span class="sc">|</span> <span class="fu">is.integer</span>(min_num_clusts))</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(min_num_clusts))</span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(min_num_clusts <span class="sc">==</span> <span class="fu">round</span>(min_num_clusts))</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(min_num_clusts <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(min_num_clusts <span class="sc">&lt;=</span> p)</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(min_num_clusts <span class="sc">&lt;=</span> n_clusters)</span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkMinNumClusts()</code>:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkMinNumClusts works&quot;</span>, {</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkMinNumClusts</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">4</span>))</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkMinNumClusts</span>(<span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkMinNumClusts</span>(<span class="dv">3</span>, <span class="dv">1932</span>, <span class="dv">3</span>))</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMinNumClusts</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>), <span class="dv">5</span>, <span class="dv">4</span>),</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(min_num_clusts) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMinNumClusts</span>(<span class="st">&quot;3&quot;</span>, <span class="st">&quot;1932&quot;</span>, <span class="st">&quot;3&quot;</span>),</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(min_num_clusts) | is.integer(min_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMinNumClusts</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(min_num_clusts) | is.integer(min_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMinNumClusts</span>(<span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>                                           <span class="fu">as.numeric</span>(<span class="cn">NA</span>)),</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.na(min_num_clusts) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMinNumClusts</span>(<span class="dv">0</span>, <span class="dv">13</span>, <span class="dv">7</span>),</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMinNumClusts</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">9</span>, <span class="dv">8</span>),</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMinNumClusts</span>(<span class="dv">6</span>, <span class="dv">5</span>, <span class="dv">5</span>),</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMinNumClusts</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">5</span>),</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &lt;= n_clusters is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p><code>checkMaxNumClusts()</code>:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the argument max_num_clusts to several </span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; functions is as expected</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) Can be NA, in which case</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts will be ignored.</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.) max_num_clusts must be at least as</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; large as min_num_clusts.</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p The number of features; since this is an upper bound on the number</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of clusters of features, it is also an upper bound on max_num_clusts.</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n_clusters The number of clusters; note that this is an upper bound</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; on max_num_clusts</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return The provided max_num_clusts, coerced to an integer if needed, and</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; coerced to be less than or equal to the total number of clusters.</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>checkMaxNumClusts <span class="ot">&lt;-</span> <span class="cf">function</span>(max_num_clusts, min_num_clusts, p, n_clusters){</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(max_num_clusts) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(max_num_clusts)){</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(max_num_clusts) <span class="sc">|</span> <span class="fu">is.integer</span>(max_num_clusts))</span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(max_num_clusts <span class="sc">==</span> <span class="fu">round</span>(max_num_clusts))</span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(max_num_clusts <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(max_num_clusts <span class="sc">&lt;=</span> p)</span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>        max_num_clusts <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">min</span>(n_clusters, max_num_clusts))</span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(max_num_clusts <span class="sc">&gt;=</span> min_num_clusts)</span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(max_num_clusts)</span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkMaxNumClusts()</code>:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkMaxNumClusts works&quot;</span>, {</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="dv">4</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">p=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">4</span>), <span class="dv">4</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="dv">5</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">p=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">4</span>), <span class="dv">4</span>)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">min_num_clusts=</span><span class="dv">3</span>, <span class="at">p=</span><span class="dv">5</span>,</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">n_clusters=</span><span class="dv">4</span>)))</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="st">&quot;4&quot;</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">p=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">4</span>),</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(max_num_clusts) | is.integer(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="fl">3.2</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">p=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">4</span>),</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts == round(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="dv">1</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">p=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">4</span>),</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &gt;= min_num_clusts is not TRUE&quot;</span>,</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>),</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">p=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">4</span>),</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(max_num_clusts) == 1 is not TRUE&quot;</span>,</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="st">&quot;4&quot;</span>,</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">min_num_clusts=</span><span class="st">&quot;2&quot;</span>,</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">p=</span><span class="st">&quot;5&quot;</span>, <span class="at">n_clusters=</span><span class="st">&quot;4&quot;</span>),</span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(max_num_clusts) | is.integer(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="sc">-</span><span class="dv">1</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">p=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">4</span>),</span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="dv">6</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">p=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">4</span>),</span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkMaxNumClusts</span>(<span class="at">max_num_clusts=</span><span class="dv">1</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">p=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">4</span>),</span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &gt;= min_num_clusts is not TRUE&quot;</span>,</span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😀</code></pre>
<p><code>getSelectedClusters()</code>:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; From css output, obtain names of selected clusters and selection proportions,</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of all selected features, and weights of individual cluster members</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; If cutoff is too high for at least min_num_clusts clusters to be selected,</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; then it will be lowered until min_num_clusts can be selected. After that, if</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the cutoff is too low such that more than max_num_clusts are selected, then</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the cutoff will be increased until no more than max_num_clusts are selected.</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Note that because clusters can have tied selection proportions, it is</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; possible that the number of selected clusters will be strictly lower than</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts or strictly greater than min_num_clusts. In fact, it is</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; possible that both cutoffs won&#39;t be able to be satisfied simulteaneously,</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; even if there is a strictly positive difference between max_num_clusts and</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts. If this occurs, max_num_clusts will take precedence over</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts. getSelectedClusters will throw an error if the provided</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; inputs don&#39;t allow it to select any clusters. </span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weighting Character; determines how to calculate the weights for</span></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual features within the selected clusters. Only those features with</span></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; nonzero weight within the selected clusters will be returned. Must be one of</span></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;sparse&quot;, &quot;weighted_avg&quot;, or &quot;simple_avg&#39;. For &quot;sparse&quot;, all the weight is</span></span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; put on the most frequently</span></span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected individual cluster member (or divided equally among all the clusters</span></span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; that are tied for the top selection proportion if there is a tie). For</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;weighted_avg&quot;, only the features within a selected cluster that were</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; themselves selected on at least one subsample will have nonzero weight. For</span></span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&quot;, each cluster member gets equal weight regardless of the</span></span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual feature selection proportions (that is, all cluster members within</span></span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; each selected cluster will be returned.). See Faletto and Bien (2022) for</span></span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; details.</span></span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; getCssSelections will select and return only of those</span></span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters with selection proportions equal to at least cutoff. Must be between</span></span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 0 and 1.</span></span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb93-36"><a href="#cb93-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb93-37"><a href="#cb93-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb93-38"><a href="#cb93-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.)</span></span>
<span id="cb93-39"><a href="#cb93-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb93-40"><a href="#cb93-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb93-41"><a href="#cb93-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb93-42"><a href="#cb93-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) If NA, max_num_clusts is ignored.</span></span>
<span id="cb93-43"><a href="#cb93-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with the following elements: \item{selected_clusts}{A</span></span>
<span id="cb93-44"><a href="#cb93-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; named numeric vector containing the selection proportions for the selected</span></span>
<span id="cb93-45"><a href="#cb93-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters. The name of each entry is the name of the corresponding cluster.}</span></span>
<span id="cb93-46"><a href="#cb93-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{selected_feats}{A named integer vector; the indices of the features</span></span>
<span id="cb93-47"><a href="#cb93-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; with nonzero weights from all of the selected clusters.} \item{weights}{A</span></span>
<span id="cb93-48"><a href="#cb93-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; named list of the same length as the number of selected clusters. Each list</span></span>
<span id="cb93-49"><a href="#cb93-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; element weights[[j]] is a numeric vector of the weights to use for the jth</span></span>
<span id="cb93-50"><a href="#cb93-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected cluster, and it has the same name as the cluster it corresponds</span></span>
<span id="cb93-51"><a href="#cb93-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to.}</span></span>
<span id="cb93-52"><a href="#cb93-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb93-53"><a href="#cb93-53" aria-hidden="true" tabindex="-1"></a>getSelectedClusters <span class="ot">&lt;-</span> <span class="cf">function</span>(css_results, weighting, cutoff, min_num_clusts,</span>
<span id="cb93-54"><a href="#cb93-54" aria-hidden="true" tabindex="-1"></a>    max_num_clusts){</span>
<span id="cb93-55"><a href="#cb93-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check input</span></span>
<span id="cb93-56"><a href="#cb93-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">class</span>(css_results) <span class="sc">==</span> <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb93-57"><a href="#cb93-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-58"><a href="#cb93-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Eliminate clusters with selection proportions below cutoff</span></span>
<span id="cb93-59"><a href="#cb93-59" aria-hidden="true" tabindex="-1"></a>    clus_sel_props <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(css_results<span class="sc">$</span>clus_sel_mat)</span>
<span id="cb93-60"><a href="#cb93-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-61"><a href="#cb93-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get selected clusters</span></span>
<span id="cb93-62"><a href="#cb93-62" aria-hidden="true" tabindex="-1"></a>    selected_clusts <span class="ot">&lt;-</span> clus_sel_props[clus_sel_props <span class="sc">&gt;=</span> cutoff]</span>
<span id="cb93-63"><a href="#cb93-63" aria-hidden="true" tabindex="-1"></a>    B <span class="ot">&lt;-</span> <span class="fu">nrow</span>(css_results<span class="sc">$</span>feat_sel_mat)</span>
<span id="cb93-64"><a href="#cb93-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-65"><a href="#cb93-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check that selected_clusts has length at least min_num_clusts</span></span>
<span id="cb93-66"><a href="#cb93-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(<span class="fu">length</span>(selected_clusts) <span class="sc">&lt;</span> min_num_clusts){</span>
<span id="cb93-67"><a href="#cb93-67" aria-hidden="true" tabindex="-1"></a>        cutoff <span class="ot">&lt;-</span> cutoff <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span>B</span>
<span id="cb93-68"><a href="#cb93-68" aria-hidden="true" tabindex="-1"></a>        selected_clusts <span class="ot">&lt;-</span> clus_sel_props[clus_sel_props <span class="sc">&gt;=</span> cutoff]</span>
<span id="cb93-69"><a href="#cb93-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb93-70"><a href="#cb93-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-71"><a href="#cb93-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check that selected_clusts has length at most max_num_clusts</span></span>
<span id="cb93-72"><a href="#cb93-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(max_num_clusts)){</span>
<span id="cb93-73"><a href="#cb93-73" aria-hidden="true" tabindex="-1"></a>        n_clusters <span class="ot">&lt;-</span> <span class="fu">ncol</span>(css_results<span class="sc">$</span>clus_sel_mat)</span>
<span id="cb93-74"><a href="#cb93-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span>(<span class="fu">length</span>(selected_clusts) <span class="sc">&gt;</span> max_num_clusts){</span>
<span id="cb93-75"><a href="#cb93-75" aria-hidden="true" tabindex="-1"></a>            cutoff <span class="ot">&lt;-</span> cutoff <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>B</span>
<span id="cb93-76"><a href="#cb93-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(cutoff <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb93-77"><a href="#cb93-77" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb93-78"><a href="#cb93-78" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb93-79"><a href="#cb93-79" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Make sure we don&#39;t reduce to a selected set of size 0</span></span>
<span id="cb93-80"><a href="#cb93-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">any</span>(clus_sel_props <span class="sc">&gt;=</span> cutoff)){</span>
<span id="cb93-81"><a href="#cb93-81" aria-hidden="true" tabindex="-1"></a>                selected_clusts <span class="ot">&lt;-</span> clus_sel_props[clus_sel_props <span class="sc">&gt;=</span> cutoff]</span>
<span id="cb93-82"><a href="#cb93-82" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span>{</span>
<span id="cb93-83"><a href="#cb93-83" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb93-84"><a href="#cb93-84" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb93-85"><a href="#cb93-85" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb93-86"><a href="#cb93-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb93-87"><a href="#cb93-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-88"><a href="#cb93-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_clusts) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb93-89"><a href="#cb93-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-90"><a href="#cb93-90" aria-hidden="true" tabindex="-1"></a>    clust_names <span class="ot">&lt;-</span> <span class="fu">names</span>(selected_clusts)</span>
<span id="cb93-91"><a href="#cb93-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-92"><a href="#cb93-92" aria-hidden="true" tabindex="-1"></a>    n_sel_clusts <span class="ot">&lt;-</span> <span class="fu">length</span>(selected_clusts)</span>
<span id="cb93-93"><a href="#cb93-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-94"><a href="#cb93-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check that n_sel_clusts is as expected, and throw warnings or an error if</span></span>
<span id="cb93-95"><a href="#cb93-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># not</span></span>
<span id="cb93-96"><a href="#cb93-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkSelectedClusters</span>(n_sel_clusts, min_num_clusts, max_num_clusts,</span>
<span id="cb93-97"><a href="#cb93-97" aria-hidden="true" tabindex="-1"></a>        <span class="fu">max</span>(clus_sel_props))</span>
<span id="cb93-98"><a href="#cb93-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-99"><a href="#cb93-99" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Get selected features from selected clusters</span></span>
<span id="cb93-100"><a href="#cb93-100" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> css_results<span class="sc">$</span>clusters</span>
<span id="cb93-101"><a href="#cb93-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(clust_names <span class="sc">%in%</span> <span class="fu">names</span>(clusters)))</span>
<span id="cb93-102"><a href="#cb93-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-103"><a href="#cb93-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get a list of weights for all of the selected clusters</span></span>
<span id="cb93-104"><a href="#cb93-104" aria-hidden="true" tabindex="-1"></a>    weights <span class="ot">&lt;-</span> <span class="fu">getAllClustWeights</span>(css_results, selected_clusts, weighting)</span>
<span id="cb93-105"><a href="#cb93-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-106"><a href="#cb93-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get selected features from each cluster (those features with nonzero</span></span>
<span id="cb93-107"><a href="#cb93-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># weights)</span></span>
<span id="cb93-108"><a href="#cb93-108" aria-hidden="true" tabindex="-1"></a>    selected_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb93-109"><a href="#cb93-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sel_clusts){</span>
<span id="cb93-110"><a href="#cb93-110" aria-hidden="true" tabindex="-1"></a>        clus_i_name <span class="ot">&lt;-</span> clust_names[i]</span>
<span id="cb93-111"><a href="#cb93-111" aria-hidden="true" tabindex="-1"></a>        clust_i <span class="ot">&lt;-</span> clusters[[clus_i_name]]</span>
<span id="cb93-112"><a href="#cb93-112" aria-hidden="true" tabindex="-1"></a>        weights_i <span class="ot">&lt;-</span> weights[[i]]</span>
<span id="cb93-113"><a href="#cb93-113" aria-hidden="true" tabindex="-1"></a>        selected_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(selected_feats, clust_i[weights_i <span class="sc">!=</span> <span class="dv">0</span>])</span>
<span id="cb93-114"><a href="#cb93-114" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb93-115"><a href="#cb93-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-116"><a href="#cb93-116" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(css_results<span class="sc">$</span>feat_sel_mat)</span>
<span id="cb93-117"><a href="#cb93-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-118"><a href="#cb93-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(selected_feats) <span class="ot">&lt;-</span> feat_names[selected_feats]</span>
<span id="cb93-119"><a href="#cb93-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-120"><a href="#cb93-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output (already checked weights wihin getAllClustWeights)</span></span>
<span id="cb93-121"><a href="#cb93-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-122"><a href="#cb93-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkGetSelectedClustersOutput</span>(selected_clusts, selected_feats,</span>
<span id="cb93-123"><a href="#cb93-123" aria-hidden="true" tabindex="-1"></a>        weights, <span class="at">n_clusters=</span><span class="fu">length</span>(clusters), <span class="at">p=</span><span class="fu">ncol</span>(css_results<span class="sc">$</span>feat_sel_mat))</span>
<span id="cb93-124"><a href="#cb93-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-125"><a href="#cb93-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">selected_clusts=</span>selected_clusts,</span>
<span id="cb93-126"><a href="#cb93-126" aria-hidden="true" tabindex="-1"></a>        <span class="at">selected_feats=</span>selected_feats, <span class="at">weights=</span>weights))</span>
<span id="cb93-127"><a href="#cb93-127" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkSelectedClusters()</code>:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to check operations within getSelectedClusters function</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n_sel_clusts The number of selected clusters; should be constrained</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; by min_num_clusts and max_num_clusts (though it may not be possible to</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; satisfy both constraints simulteneously, in which case a warning will be</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; thrown).</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.)</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) If NA, max_num_clusts is ignored.</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_sel_prop Numeric; the maximum selection proportion observed for </span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; any cluster.</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>checkSelectedClusters <span class="ot">&lt;-</span> <span class="cf">function</span>(n_sel_clusts, min_num_clusts, max_num_clusts,</span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>    max_sel_prop){</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(n_sel_clusts <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>        err <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;No clusters selected with this cutoff (try a cutoff below the maximum cluster selection proportion, &quot;</span>,</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>            max_sel_prop, <span class="st">&quot;)&quot;</span>, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(err)</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n_sel_clusts <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># It may be impossible to get at least min_num_clusts or at most</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># max_num_clusts; if so, give a warning</span></span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(n_sel_clusts <span class="sc">&lt;</span> min_num_clusts){</span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>        warn <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Returning fewer than min_num_clusts = &quot;</span>, min_num_clusts,</span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot; clusters because decreasing the cutoff any further would require returning more than max_num_clusts = &quot;</span>,</span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>            max_num_clusts, <span class="st">&quot; clusters&quot;</span>, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(warn)</span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(max_num_clusts)){</span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(n_sel_clusts <span class="sc">&gt;</span> max_num_clusts){</span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a>            warn <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Returning more than max_num_clusts = &quot;</span>,</span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a>                max_num_clusts,</span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot; clusters because increasing the cutoff any further would require returning 0 clusters&quot;</span>,</span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a>                <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a>            <span class="fu">warning</span>(warn)</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Test for <code>checkSelectedClusters()</code>:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkSelectedClusters works&quot;</span>, {</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkSelectedClusters</span>(<span class="at">n_sel_clusts=</span><span class="dv">5</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">max_sel_prop=</span>.<span class="dv">8</span>))</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkSelectedClusters</span>(<span class="at">n_sel_clusts=</span><span class="dv">5</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">max_num_clusts=</span><span class="dv">5</span>, <span class="at">max_sel_prop=</span>.<span class="dv">3</span>))</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkSelectedClusters</span>(<span class="at">n_sel_clusts=</span><span class="dv">2</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">max_num_clusts=</span><span class="dv">5</span>, <span class="at">max_sel_prop=</span>.<span class="dv">3</span>))</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkSelectedClusters</span>(<span class="at">n_sel_clusts=</span><span class="dv">0</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">max_num_clusts=</span><span class="dv">5</span>,</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">max_sel_prop=</span>.<span class="dv">6</span>),</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;No clusters selected with this cutoff (try a cutoff below the maximum cluster selection proportion, 0.6)&quot;</span>,</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">checkSelectedClusters</span>(<span class="at">n_sel_clusts=</span><span class="dv">1</span>,</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">max_num_clusts=</span><span class="dv">5</span>,</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">max_sel_prop=</span>.<span class="dv">6</span>),</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Returning fewer than min_num_clusts = 2 clusters because decreasing the cutoff any further would require returning more than max_num_clusts = 5 clusters&quot;</span>,</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">checkSelectedClusters</span>(<span class="at">n_sel_clusts=</span><span class="dv">6</span>,</span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">max_num_clusts=</span><span class="dv">5</span>,</span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">max_sel_prop=</span>.<span class="dv">6</span>),</span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Returning more than max_num_clusts = 5 clusters because increasing the cutoff any further would require returning 0 clusters&quot;</span>,</span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p><code>getAllClustWeights()</code>:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Calculate weights for each cluster member of all of the selected clusters.</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sel_clusters A named numeric vector containing the selection</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; proportions for the selected clusters. The name of each entry is the name</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of the corresponding cluster.</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weighting Character; determines how to calculate the weights for</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual features within the selected clusters. Only those features with</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; nonzero weight within the selected clusters will be returned. Must be one of</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;sparse&quot;, &quot;weighted_avg&quot;, or &quot;simple_avg&#39;. For &quot;sparse&quot;, all the weight is</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; put on the most frequently</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected individual cluster member (or divided equally among all the clusters</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; that are tied for the top selection proportion if there is a tie). For</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;weighted_avg&quot;, only the features within a selected cluster that were</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; themselves selected on at least one subsample will have nonzero weight. For</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&quot;, each cluster member gets equal weight regardless of the</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual feature selection proportions (that is, all cluster members within</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; each selected cluster will be returned.). See Faletto and Bien (2022) for</span></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; details.</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list of the same length as sel_clusters of numeric vectors.</span></span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; weights[[j]] is the weights to use for the jth selected cluster, and it has</span></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the same name as the cluster it corresponds to.</span></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>getAllClustWeights <span class="ot">&lt;-</span> <span class="cf">function</span>(css_results, sel_clusters, weighting){</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">class</span>(css_results) <span class="sc">==</span> <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(sel_clusters))</span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>    p_ret <span class="ot">&lt;-</span> <span class="fu">length</span>(sel_clusters)</span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(sel_clusters))) <span class="sc">==</span> p_ret)</span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p_ret <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkWeighting</span>(weighting)</span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get selection proportions and clusters</span></span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a>    feat_sel_props <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(css_results<span class="sc">$</span>feat_sel_mat)</span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">length</span>(feat_sel_props)</span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> p_ret)</span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> css_results<span class="sc">$</span>clusters</span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">names</span>(sel_clusters) <span class="sc">%in%</span> <span class="fu">names</span>(clusters)))</span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identify weights</span></span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a>    weights <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb97-48"><a href="#cb97-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-49"><a href="#cb97-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p_ret){</span>
<span id="cb97-50"><a href="#cb97-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find the members of the cluster feature j is a member of</span></span>
<span id="cb97-51"><a href="#cb97-51" aria-hidden="true" tabindex="-1"></a>        cluster_j <span class="ot">&lt;-</span> clusters[[<span class="fu">names</span>(sel_clusters)[j]]]</span>
<span id="cb97-52"><a href="#cb97-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the weights for this cluster and add them to the list</span></span>
<span id="cb97-53"><a href="#cb97-53" aria-hidden="true" tabindex="-1"></a>        weights[[j]] <span class="ot">&lt;-</span> <span class="fu">getClustWeights</span>(cluster_j, weighting, feat_sel_props)</span>
<span id="cb97-54"><a href="#cb97-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb97-55"><a href="#cb97-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-56"><a href="#cb97-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add names to weights</span></span>
<span id="cb97-57"><a href="#cb97-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(weights) <span class="ot">&lt;-</span> <span class="fu">names</span>(sel_clusters)</span>
<span id="cb97-58"><a href="#cb97-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-59"><a href="#cb97-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb97-60"><a href="#cb97-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-61"><a href="#cb97-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(weights) <span class="sc">==</span> p_ret)</span>
<span id="cb97-62"><a href="#cb97-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.list</span>(weights))</span>
<span id="cb97-63"><a href="#cb97-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-64"><a href="#cb97-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p_ret){</span>
<span id="cb97-65"><a href="#cb97-65" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(clusters[[<span class="fu">names</span>(sel_clusters)[i]]]) <span class="sc">==</span></span>
<span id="cb97-66"><a href="#cb97-66" aria-hidden="true" tabindex="-1"></a>            <span class="fu">length</span>(weights[[i]]))</span>
<span id="cb97-67"><a href="#cb97-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(weights[[i]] <span class="sc">&gt;=</span> <span class="dv">0</span>))</span>
<span id="cb97-68"><a href="#cb97-68" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(weights[[i]] <span class="sc">&lt;=</span> <span class="dv">1</span>))</span>
<span id="cb97-69"><a href="#cb97-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">abs</span>(<span class="fu">sum</span>(weights[[i]]) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">6</span>))</span>
<span id="cb97-70"><a href="#cb97-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb97-71"><a href="#cb97-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(weights)</span>
<span id="cb97-72"><a href="#cb97-72" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>getClustWeights()</code>:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Calculate weights for members of a cluster using selection proportions</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Given a cluster of features, the selection proportions for each cluster</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; member, and a specified weighting scheme, calculate the appropriate weights</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for the cluster.</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cluster_i An integer vector containing the indices of the members</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of a cluster.</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weighting Character; determines how to calculate the weights for</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual features within the selected clusters. Only those features with</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; nonzero weight within the selected clusters will be returned. Must be one of</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;sparse&quot;, &quot;weighted_avg&quot;, or &quot;simple_avg&#39;. For &quot;sparse&quot;, all the weight is</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; put on the most frequently</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected individual cluster member (or divided equally among all the clusters</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; that are tied for the top selection proportion if there is a tie). For</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;weighted_avg&quot;, only the features within a selected cluster that were</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; themselves selected on at least one subsample will have nonzero weight. For</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&quot;, each cluster member gets equal weight regardless of the</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual feature selection proportions (that is, all cluster members within</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; each selected cluster will be returned.). See Faletto and Bien (2022) for</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; details.</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param feat_sel_props A numeric vector of selection proportions corresponding</span></span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to each of the p features.</span></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A numeric vector of the same length as cluster_i containing the</span></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; weights corresponding to each of the features in cluster_i. The weights</span></span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will all be nonnegative and sum to 1.</span></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>getClustWeights <span class="ot">&lt;-</span> <span class="cf">function</span>(cluster_i, weighting, feat_sel_props){</span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(cluster_i) <span class="sc">|</span> <span class="fu">is.numeric</span>(cluster_i))</span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(cluster_i <span class="sc">==</span> <span class="fu">round</span>(cluster_i)))</span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>    n_weights <span class="ot">&lt;-</span> <span class="fu">length</span>(cluster_i)</span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">unique</span>(cluster_i)) <span class="sc">==</span> n_weights)</span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">length</span>(feat_sel_props)</span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(cluster_i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span>p))</span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the selection proportions of each cluster member</span></span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a>    sel_props <span class="ot">&lt;-</span> feat_sel_props[cluster_i]</span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(sel_props <span class="sc">&gt;=</span> <span class="dv">0</span>))</span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(sel_props <span class="sc">&lt;=</span> <span class="dv">1</span>))</span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a>    weights_i <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">as.numeric</span>(<span class="cn">NA</span>), n_weights)</span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Weighted or simple average?</span></span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(weighting <span class="sc">==</span> <span class="st">&quot;sparse&quot;</span>){</span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sparse cluster stability selection: All features in cluster with</span></span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># selection proportion equal to the max</span></span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for the cluster get equal weight; rest of cluster gets 0 weight</span></span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">sum</span>(sel_props) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a>            weights_i <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>n_weights, n_weights)</span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span>{</span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a>            maxes <span class="ot">&lt;-</span> sel_props<span class="sc">==</span><span class="fu">max</span>(sel_props)</span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">sum</span>(maxes) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">sum</span>(maxes) <span class="sc">&lt;=</span> n_weights)</span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a>            weights_i <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n_weights)</span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a>            weights_i[maxes] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sum</span>(maxes)</span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(weighting <span class="sc">==</span> <span class="st">&quot;weighted_avg&quot;</span>){</span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get weights for weighted average</span></span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">sum</span>(sel_props) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a>            weights_i <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>n_weights, n_weights)</span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span>{</span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a>            weights_i <span class="ot">&lt;-</span> sel_props<span class="sc">/</span><span class="fu">sum</span>(sel_props)</span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(weighting <span class="sc">==</span> <span class="st">&quot;simple_avg&quot;</span>){</span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a>        weights_i <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>n_weights, n_weights)</span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;weighting must be one of sparse, simple_avg, or weighted_avg&quot;</span>)</span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">abs</span>(<span class="fu">sum</span>(weights_i) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">6</span>))</span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(weights_i) <span class="sc">==</span> n_weights)</span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(weights_i) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(weights_i <span class="sc">&gt;=</span> <span class="dv">0</span>))</span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(weights_i <span class="sc">&lt;=</span> <span class="dv">1</span>))</span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(weights_i)</span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>getClustWeights()</code>:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getClustWeights works&quot;</span>, {</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  sel_props <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.9</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sparse</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">getClustWeights</span>(<span class="at">cluster_i=</span><span class="fu">c</span>(3L, 4L, 5L),</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">feat_sel_props=</span>sel_props),</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># weighted_avg</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>  cluster<span class="ot">=</span><span class="fu">c</span>(1L, 3L, 5L)</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>  true_weights <span class="ot">&lt;-</span> sel_props[cluster]<span class="sc">/</span><span class="fu">sum</span>(sel_props[cluster])</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">getClustWeights</span>(<span class="at">cluster_i=</span>cluster,</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">feat_sel_props=</span>sel_props),</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>                             true_weights)</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simple_avg</span></span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">getClustWeights</span>(<span class="at">cluster_i=</span><span class="fu">c</span>(2L, 3L, 4L, 5L),</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>,</span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">feat_sel_props=</span>sel_props),</span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rep</span>(<span class="fl">0.25</span>, <span class="dv">4</span>))</span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥳</code></pre>
<p>Tests for <code>getAllClustWeights()</code>:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getAllClustWeights works&quot;</span>, {</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1872</span>)</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">5</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">5</span>)</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  clust_names <span class="ot">&lt;-</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">5</span>)</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(good_clusters) <span class="ot">&lt;-</span> clust_names</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters, <span class="at">fitfun =</span> cssLasso,</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampling_type =</span> <span class="st">&quot;SS&quot;</span>, <span class="at">B =</span> <span class="dv">10</span>, <span class="at">prop_feats_remove =</span> <span class="dv">0</span>, <span class="at">train_inds =</span> <span class="fu">integer</span>(),</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_cores =</span> 1L)</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>  sel_props <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(res<span class="sc">$</span>feat_sel_mat)</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>  sel_clusts <span class="ot">&lt;-</span> <span class="fu">list</span>(1L<span class="sc">:</span>2L, 3L<span class="sc">:</span>4L)</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(sel_clusts) <span class="ot">&lt;-</span> clust_names[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sparse</span></span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>  true_weights <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>    weights_i <span class="ot">&lt;-</span> sel_props[sel_clusts[[i]]]<span class="sc">/</span><span class="fu">sum</span>(sel_props[sel_clusts[[i]]])</span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>    true_weights[[i]] <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(weights_i))</span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>    true_weights[[i]][weights_i <span class="sc">==</span> <span class="fu">max</span>(weights_i)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(true_weights) <span class="ot">&lt;-</span> clust_names[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">getAllClustWeights</span>(res,</span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">colMeans</span>(res<span class="sc">$</span>clus_sel_mat[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">&quot;sparse&quot;</span>), true_weights)</span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># weighted_avg</span></span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>  true_weights <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a>    true_weights[[i]] <span class="ot">&lt;-</span> sel_props[sel_clusts[[i]]]<span class="sc">/</span><span class="fu">sum</span>(sel_props[sel_clusts[[i]]])</span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(true_weights) <span class="ot">&lt;-</span> clust_names[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb101-47"><a href="#cb101-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-48"><a href="#cb101-48" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">getAllClustWeights</span>(res,</span>
<span id="cb101-49"><a href="#cb101-49" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">colMeans</span>(res<span class="sc">$</span>clus_sel_mat[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb101-50"><a href="#cb101-50" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">&quot;weighted_avg&quot;</span>), true_weights)</span>
<span id="cb101-51"><a href="#cb101-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-52"><a href="#cb101-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simple_avg</span></span>
<span id="cb101-53"><a href="#cb101-53" aria-hidden="true" tabindex="-1"></a>  true_weights <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb101-54"><a href="#cb101-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-55"><a href="#cb101-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb101-56"><a href="#cb101-56" aria-hidden="true" tabindex="-1"></a>    n_weights_i <span class="ot">&lt;-</span> <span class="fu">length</span>(sel_clusts[[i]])</span>
<span id="cb101-57"><a href="#cb101-57" aria-hidden="true" tabindex="-1"></a>    true_weights[[i]] <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>n_weights_i, n_weights_i)</span>
<span id="cb101-58"><a href="#cb101-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-59"><a href="#cb101-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-60"><a href="#cb101-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(true_weights) <span class="ot">&lt;-</span> clust_names[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb101-61"><a href="#cb101-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-62"><a href="#cb101-62" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">getAllClustWeights</span>(res,</span>
<span id="cb101-63"><a href="#cb101-63" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">colMeans</span>(res<span class="sc">$</span>clus_sel_mat[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb101-64"><a href="#cb101-64" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">&quot;simple_avg&quot;</span>), true_weights)</span>
<span id="cb101-65"><a href="#cb101-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-66"><a href="#cb101-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Errors</span></span>
<span id="cb101-67"><a href="#cb101-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-68"><a href="#cb101-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># css_results not correct (error has quotation marks)</span></span>
<span id="cb101-69"><a href="#cb101-69" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getAllClustWeights</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="fu">colMeans</span>(res<span class="sc">$</span>clus_sel_mat[,</span>
<span id="cb101-70"><a href="#cb101-70" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb101-71"><a href="#cb101-71" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">&quot;simple_avg&quot;</span>))</span>
<span id="cb101-72"><a href="#cb101-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-73"><a href="#cb101-73" aria-hidden="true" tabindex="-1"></a>  bad_sel_clusts <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(res<span class="sc">$</span>clus_sel_mat[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb101-74"><a href="#cb101-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(bad_sel_clusts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;apple&quot;</span>, <span class="st">&quot;banana&quot;</span>)</span>
<span id="cb101-75"><a href="#cb101-75" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getAllClustWeights</span>(res, bad_sel_clusts, <span class="st">&quot;sparse&quot;</span>),</span>
<span id="cb101-76"><a href="#cb101-76" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(names(sel_clusters) %in% names(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb101-77"><a href="#cb101-77" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb101-78"><a href="#cb101-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-79"><a href="#cb101-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-80"><a href="#cb101-80" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getAllClustWeights</span>(res, <span class="fu">colMeans</span>(res<span class="sc">$</span>clus_sel_mat[,</span>
<span id="cb101-81"><a href="#cb101-81" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb101-82"><a href="#cb101-82" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">c</span>(<span class="st">&quot;sparse&quot;</span>, <span class="st">&quot;simple_avg&quot;</span>)),</span>
<span id="cb101-83"><a href="#cb101-83" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(weighting) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb101-84"><a href="#cb101-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-85"><a href="#cb101-85" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getAllClustWeights</span>(res, <span class="fu">colMeans</span>(res<span class="sc">$</span>clus_sel_mat[,</span>
<span id="cb101-86"><a href="#cb101-86" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb101-87"><a href="#cb101-87" aria-hidden="true" tabindex="-1"></a>                                            <span class="cn">NA</span>),</span>
<span id="cb101-88"><a href="#cb101-88" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.na(weighting) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb101-89"><a href="#cb101-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-90"><a href="#cb101-90" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getAllClustWeights</span>(res, <span class="fu">colMeans</span>(res<span class="sc">$</span>clus_sel_mat[,</span>
<span id="cb101-91"><a href="#cb101-91" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb101-92"><a href="#cb101-92" aria-hidden="true" tabindex="-1"></a>                                            <span class="dv">1</span>),</span>
<span id="cb101-93"><a href="#cb101-93" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb101-94"><a href="#cb101-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-95"><a href="#cb101-95" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getAllClustWeights</span>(res, <span class="fu">colMeans</span>(res<span class="sc">$</span>clus_sel_mat[,</span>
<span id="cb101-96"><a href="#cb101-96" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb101-97"><a href="#cb101-97" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">&quot;spasre&quot;</span>),</span>
<span id="cb101-98"><a href="#cb101-98" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character and one of sparse, simple_avg, or weighted_avg&quot;</span>,</span>
<span id="cb101-99"><a href="#cb101-99" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb101-100"><a href="#cb101-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-101"><a href="#cb101-101" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p><code>checkGetSelectedClustersOutput()</code>:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to check that output of getSelectedClusters is as expected</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param selected_clusts A named numeric vector containing the selection</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; proportions for the selected clusters. The name of each entry is the name of</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the corresponding cluster.</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param selected_feats A named integer vector; the indices of the features</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; with nonzero weights from all of the selected clusters.</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weights A named list of the same length as the number of selected</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters. Each list element weights[[j]] is a numeric vector of the weights</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to use for the jth selected cluster, and it has the same name as the cluster</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; it corresponds to.</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n_clusters Integer; the number of clusters in the data (upper bound</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for the length of selected_clusts)</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p Integer; number of features in the data (all selected_feats should</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be in 1:p)</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>checkGetSelectedClustersOutput <span class="ot">&lt;-</span> <span class="cf">function</span>(selected_clusts, selected_feats,</span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>    weights, n_clusters, p){</span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(selected_clusts))</span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(selected_clusts <span class="sc">&gt;=</span> <span class="dv">0</span>))</span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(selected_clusts <span class="sc">&lt;=</span> <span class="dv">1</span>))</span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_clusts) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_clusts) <span class="sc">&lt;=</span> n_clusters)</span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">names</span>(selected_clusts)) <span class="sc">==</span></span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(selected_clusts))))</span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(selected_clusts)))</span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">names</span>(selected_clusts)) <span class="sc">&amp;</span></span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(selected_clusts) <span class="sc">!=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">names</span>(selected_clusts)) <span class="sc">==</span> <span class="fu">length</span>(selected_clusts))</span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(selected_feats))</span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_feats) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(selected_feats)))</span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(selected_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span>p))</span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_clusts) <span class="sc">&lt;=</span> <span class="fu">length</span>(selected_feats))</span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">identical</span>(<span class="fu">names</span>(weights), <span class="fu">names</span>(selected_clusts)))</span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(weights) <span class="sc">==</span> <span class="fu">length</span>(selected_clusts)) </span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkGetSelectedClustersOutput()</code>:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkGetSelectedClustersOutput works&quot;</span>, {</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  sel_clusts <span class="ot">&lt;-</span> <span class="fl">0.1</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(sel_clusts) <span class="ot">&lt;-</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  weights <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>){</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    weights[[i]] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>)</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  weights[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(weights) <span class="ot">&lt;-</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>  sel_feats <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">26</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(sel_feats) <span class="ot">&lt;-</span> LETTERS[<span class="dv">10</span><span class="sc">:</span><span class="dv">26</span>]</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span>sel_clusts,</span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">selected_feats=</span>sel_feats,</span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">weights=</span>weights,</span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>))</span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span>letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>],</span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">selected_feats=</span>sel_feats,</span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">weights=</span>weights,</span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(selected_clusts) is not TRUE&quot;</span>,</span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span><span class="sc">-</span>sel_clusts,</span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">selected_feats=</span>sel_feats,</span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">weights=</span>weights,</span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(selected_clusts &gt;= 0) is not TRUE&quot;</span>,</span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span><span class="dv">10</span><span class="sc">*</span>sel_clusts,</span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">selected_feats=</span>sel_feats,</span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">weights=</span>weights,</span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(selected_clusts &lt;= 1) is not TRUE&quot;</span>,</span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span><span class="fu">numeric</span>(),</span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">selected_feats=</span>sel_feats,</span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">weights=</span>weights,</span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(selected_clusts) &gt;= 1 is not TRUE&quot;</span>,</span>
<span id="cb104-48"><a href="#cb104-48" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-49"><a href="#cb104-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-50"><a href="#cb104-50" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span>sel_clusts,</span>
<span id="cb104-51"><a href="#cb104-51" aria-hidden="true" tabindex="-1"></a>                               <span class="at">selected_feats=</span>sel_feats,</span>
<span id="cb104-52"><a href="#cb104-52" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights=</span>weights,</span>
<span id="cb104-53"><a href="#cb104-53" aria-hidden="true" tabindex="-1"></a>                               <span class="at">n_clusters=</span><span class="dv">8</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-54"><a href="#cb104-54" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(selected_clusts) &lt;= n_clusters is not TRUE&quot;</span>,</span>
<span id="cb104-55"><a href="#cb104-55" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-56"><a href="#cb104-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-57"><a href="#cb104-57" aria-hidden="true" tabindex="-1"></a>  bad_clusts <span class="ot">&lt;-</span> sel_clusts</span>
<span id="cb104-58"><a href="#cb104-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(bad_clusts) <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&quot;a&quot;</span>, <span class="fu">length</span>(bad_clusts))</span>
<span id="cb104-59"><a href="#cb104-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-60"><a href="#cb104-60" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span>bad_clusts,</span>
<span id="cb104-61"><a href="#cb104-61" aria-hidden="true" tabindex="-1"></a>                               <span class="at">selected_feats=</span>sel_feats,</span>
<span id="cb104-62"><a href="#cb104-62" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights=</span>weights,</span>
<span id="cb104-63"><a href="#cb104-63" aria-hidden="true" tabindex="-1"></a>                               <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-64"><a href="#cb104-64" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(names(selected_clusts)) == length(unique(names(selected_clusts))) is not TRUE&quot;</span>,</span>
<span id="cb104-65"><a href="#cb104-65" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-66"><a href="#cb104-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-67"><a href="#cb104-67" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span><span class="fu">unname</span>(sel_clusts),</span>
<span id="cb104-68"><a href="#cb104-68" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">selected_feats=</span>sel_feats,</span>
<span id="cb104-69"><a href="#cb104-69" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">weights=</span>weights,</span>
<span id="cb104-70"><a href="#cb104-70" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-71"><a href="#cb104-71" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.null(names(selected_clusts)) is not TRUE&quot;</span>,</span>
<span id="cb104-72"><a href="#cb104-72" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-73"><a href="#cb104-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-74"><a href="#cb104-74" aria-hidden="true" tabindex="-1"></a>  bad_clusts <span class="ot">&lt;-</span> sel_clusts</span>
<span id="cb104-75"><a href="#cb104-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(bad_clusts)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;&quot;</span></span>
<span id="cb104-76"><a href="#cb104-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-77"><a href="#cb104-77" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span>bad_clusts,</span>
<span id="cb104-78"><a href="#cb104-78" aria-hidden="true" tabindex="-1"></a>                               <span class="at">selected_feats=</span>sel_feats, <span class="at">weights=</span>weights,</span>
<span id="cb104-79"><a href="#cb104-79" aria-hidden="true" tabindex="-1"></a>                               <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-80"><a href="#cb104-80" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(!is.na(names(selected_clusts)) &amp; names(selected_clusts) !=  .... is not TRUE&quot;</span>,</span>
<span id="cb104-81"><a href="#cb104-81" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-82"><a href="#cb104-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-83"><a href="#cb104-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(bad_clusts)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)</span>
<span id="cb104-84"><a href="#cb104-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-85"><a href="#cb104-85" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span>bad_clusts,</span>
<span id="cb104-86"><a href="#cb104-86" aria-hidden="true" tabindex="-1"></a>                               <span class="at">selected_feats=</span>sel_feats, <span class="at">weights=</span>weights,</span>
<span id="cb104-87"><a href="#cb104-87" aria-hidden="true" tabindex="-1"></a>                               <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-88"><a href="#cb104-88" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(!is.na(names(selected_clusts)) &amp; names(selected_clusts) !=  .... is not TRUE&quot;</span>,</span>
<span id="cb104-89"><a href="#cb104-89" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-90"><a href="#cb104-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-91"><a href="#cb104-91" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span>sel_clusts,</span>
<span id="cb104-92"><a href="#cb104-92" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">selected_feats=</span><span class="fl">0.1</span>,</span>
<span id="cb104-93"><a href="#cb104-93" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">weights=</span>weights,</span>
<span id="cb104-94"><a href="#cb104-94" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-95"><a href="#cb104-95" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.integer(selected_feats) is not TRUE&quot;</span>,</span>
<span id="cb104-96"><a href="#cb104-96" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-97"><a href="#cb104-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-98"><a href="#cb104-98" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span>sel_clusts,</span>
<span id="cb104-99"><a href="#cb104-99" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">selected_feats=</span><span class="fu">c</span>(1L,</span>
<span id="cb104-100"><a href="#cb104-100" aria-hidden="true" tabindex="-1"></a>                                                                        <span class="fu">rep</span>(2L,</span>
<span id="cb104-101"><a href="#cb104-101" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="dv">2</span>)),</span>
<span id="cb104-102"><a href="#cb104-102" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">weights=</span>weights,</span>
<span id="cb104-103"><a href="#cb104-103" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">30</span>),</span>
<span id="cb104-104"><a href="#cb104-104" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(selected_feats) == length(unique(selected_feats)) is not TRUE&quot;</span>,</span>
<span id="cb104-105"><a href="#cb104-105" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-106"><a href="#cb104-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-107"><a href="#cb104-107" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span>sel_clusts,</span>
<span id="cb104-108"><a href="#cb104-108" aria-hidden="true" tabindex="-1"></a>                               <span class="at">selected_feats=</span>sel_feats, <span class="at">weights=</span>weights,</span>
<span id="cb104-109"><a href="#cb104-109" aria-hidden="true" tabindex="-1"></a>                               <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">25</span>),</span>
<span id="cb104-110"><a href="#cb104-110" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(selected_feats %in% 1:p) is not TRUE&quot;</span>,</span>
<span id="cb104-111"><a href="#cb104-111" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-112"><a href="#cb104-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-113"><a href="#cb104-113" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetSelectedClustersOutput</span>(<span class="at">selected_clusts=</span>sel_clusts,</span>
<span id="cb104-114"><a href="#cb104-114" aria-hidden="true" tabindex="-1"></a>                               <span class="at">selected_feats=</span>sel_feats[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>], <span class="at">weights=</span>weights,</span>
<span id="cb104-115"><a href="#cb104-115" aria-hidden="true" tabindex="-1"></a>                               <span class="at">n_clusters=</span><span class="dv">10</span>, <span class="at">p=</span><span class="dv">25</span>),</span>
<span id="cb104-116"><a href="#cb104-116" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(selected_clusts) &lt;= length(selected_feats) is not TRUE&quot;</span>,</span>
<span id="cb104-117"><a href="#cb104-117" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-118"><a href="#cb104-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-119"><a href="#cb104-119" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p>Tests for <code>getSelectedClusters()</code></p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getSelectedClusters works&quot;</span>, {</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">26717</span>)</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">5</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">5</span>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;apple&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="st">&quot;banana&quot;</span><span class="ot">=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">&quot;cantaloupe&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>  css_res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getSelectedClusters</span>(css_res, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.05</span>,</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>)</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">3</span>)</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>,</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;weights&quot;</span>))</span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts))))</span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_clusts <span class="sc">&gt;=</span> <span class="dv">0</span>))</span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_clusts <span class="sc">&lt;=</span> <span class="dv">1</span>))</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats))))</span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&lt;=</span> <span class="dv">5</span>))</span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats),</span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(<span class="fu">unique</span>(res<span class="sc">$</span>selected_feats)))</span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts), <span class="fu">length</span>(res<span class="sc">$</span>weights))</span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>weights)){</span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a>    weights_i <span class="ot">&lt;-</span> res<span class="sc">$</span>weights[[i]]</span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a>    num_nonzero_weights <span class="ot">&lt;-</span> <span class="fu">sum</span>(weights_i <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For &quot;sparse&quot; weighting, tither there should only be one nonzero weight and</span></span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it should equal 1 (if there were no ties in selection proportions among</span></span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cluster members) or the nonzero weights should all be</span></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1/num_nonzero_weights</span></span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(weights_i[weights_i <span class="sc">&gt;</span> <span class="dv">0</span>] <span class="sc">==</span> <span class="dv">1</span><span class="sc">/</span>num_nonzero_weights))</span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># weighted_avg</span></span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a>  res_weighted <span class="ot">&lt;-</span> <span class="fu">getSelectedClusters</span>(css_res, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">cutoff=</span><span class="fl">0.05</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">max_num_clusts=</span><span class="cn">NA</span>)</span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res_weighted<span class="sc">$</span>selected_clusts),</span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res_weighted<span class="sc">$</span>weights))</span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res_weighted<span class="sc">$</span>weights)){</span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a>    weights_i <span class="ot">&lt;-</span> res_weighted<span class="sc">$</span>weights[[i]]</span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(weights_i <span class="sc">&gt;=</span> <span class="dv">0</span>))</span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(weights_i <span class="sc">&lt;=</span> <span class="dv">1</span>))</span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simple_avg</span></span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a>  res_simple <span class="ot">&lt;-</span> <span class="fu">getSelectedClusters</span>(css_res, <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>,</span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">cutoff=</span><span class="fl">0.05</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">max_num_clusts=</span><span class="cn">NA</span>)</span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res_simple<span class="sc">$</span>selected_clusts),</span>
<span id="cb106-69"><a href="#cb106-69" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res_simple<span class="sc">$</span>weights))</span>
<span id="cb106-70"><a href="#cb106-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res_simple<span class="sc">$</span>weights)){</span>
<span id="cb106-71"><a href="#cb106-71" aria-hidden="true" tabindex="-1"></a>    weights_i <span class="ot">&lt;-</span> res_simple<span class="sc">$</span>weights[[i]]</span>
<span id="cb106-72"><a href="#cb106-72" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">unique</span>(weights_i)), <span class="dv">1</span>)</span>
<span id="cb106-73"><a href="#cb106-73" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(weights_i), <span class="fu">sum</span>(weights_i <span class="sc">&gt;</span> <span class="dv">0</span>))</span>
<span id="cb106-74"><a href="#cb106-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-75"><a href="#cb106-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-76"><a href="#cb106-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test min_num_clusts</span></span>
<span id="cb106-77"><a href="#cb106-77" aria-hidden="true" tabindex="-1"></a>  res2 <span class="ot">&lt;-</span> <span class="fu">getSelectedClusters</span>(css_res, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">1</span>,</span>
<span id="cb106-78"><a href="#cb106-78" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">3</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>)</span>
<span id="cb106-79"><a href="#cb106-79" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res2))</span>
<span id="cb106-80"><a href="#cb106-80" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res2<span class="sc">$</span>selected_clusts), <span class="dv">3</span>)</span>
<span id="cb106-81"><a href="#cb106-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-82"><a href="#cb106-82" aria-hidden="true" tabindex="-1"></a>  res3 <span class="ot">&lt;-</span> <span class="fu">getSelectedClusters</span>(css_res, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="dv">1</span>,</span>
<span id="cb106-83"><a href="#cb106-83" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">2</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>)</span>
<span id="cb106-84"><a href="#cb106-84" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res3<span class="sc">$</span>selected_clusts) <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb106-85"><a href="#cb106-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-86"><a href="#cb106-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test max_num_clusts</span></span>
<span id="cb106-87"><a href="#cb106-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure there is at least one relevant feature</span></span>
<span id="cb106-88"><a href="#cb106-88" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> x</span>
<span id="cb106-89"><a href="#cb106-89" aria-hidden="true" tabindex="-1"></a>  x2[, <span class="dv">5</span>] <span class="ot">&lt;-</span> y</span>
<span id="cb106-90"><a href="#cb106-90" aria-hidden="true" tabindex="-1"></a>  css_res2 <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x2, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb106-91"><a href="#cb106-91" aria-hidden="true" tabindex="-1"></a>  res4 <span class="ot">&lt;-</span> <span class="fu">getSelectedClusters</span>(css_res2, <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb106-92"><a href="#cb106-92" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">1</span>)</span>
<span id="cb106-93"><a href="#cb106-93" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res4))</span>
<span id="cb106-94"><a href="#cb106-94" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res4<span class="sc">$</span>selected_clusts), <span class="dv">1</span>)</span>
<span id="cb106-95"><a href="#cb106-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-96"><a href="#cb106-96" aria-hidden="true" tabindex="-1"></a>  res5 <span class="ot">&lt;-</span> <span class="fu">getSelectedClusters</span>(css_res, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb106-97"><a href="#cb106-97" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">2</span>)</span>
<span id="cb106-98"><a href="#cb106-98" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res5<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span> <span class="dv">2</span>)</span>
<span id="cb106-99"><a href="#cb106-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-100"><a href="#cb106-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Name features</span></span>
<span id="cb106-101"><a href="#cb106-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(x)]</span>
<span id="cb106-102"><a href="#cb106-102" aria-hidden="true" tabindex="-1"></a>  css_res3 <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb106-103"><a href="#cb106-103" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getSelectedClusters</span>(css_res3, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.05</span>,</span>
<span id="cb106-104"><a href="#cb106-104" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>)</span>
<span id="cb106-105"><a href="#cb106-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-106"><a href="#cb106-106" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb106-107"><a href="#cb106-107" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">3</span>)</span>
<span id="cb106-108"><a href="#cb106-108" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>,</span>
<span id="cb106-109"><a href="#cb106-109" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;weights&quot;</span>))</span>
<span id="cb106-110"><a href="#cb106-110" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span></span>
<span id="cb106-111"><a href="#cb106-111" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb106-112"><a href="#cb106-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-113"><a href="#cb106-113" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb106-114"><a href="#cb106-114" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb106-115"><a href="#cb106-115" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb106-116"><a href="#cb106-116" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb106-117"><a href="#cb106-117" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb106-118"><a href="#cb106-118" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts))))</span>
<span id="cb106-119"><a href="#cb106-119" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_clusts <span class="sc">&gt;=</span> <span class="dv">0</span>))</span>
<span id="cb106-120"><a href="#cb106-120" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_clusts <span class="sc">&lt;=</span> <span class="dv">1</span>))</span>
<span id="cb106-121"><a href="#cb106-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-122"><a href="#cb106-122" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb106-123"><a href="#cb106-123" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb106-124"><a href="#cb106-124" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb106-125"><a href="#cb106-125" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats))))</span>
<span id="cb106-126"><a href="#cb106-126" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb106-127"><a href="#cb106-127" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&lt;=</span> <span class="dv">5</span>))</span>
<span id="cb106-128"><a href="#cb106-128" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats),</span>
<span id="cb106-129"><a href="#cb106-129" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(<span class="fu">unique</span>(res<span class="sc">$</span>selected_feats)))</span>
<span id="cb106-130"><a href="#cb106-130" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb106-131"><a href="#cb106-131" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb106-132"><a href="#cb106-132" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb106-133"><a href="#cb106-133" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats))))</span>
<span id="cb106-134"><a href="#cb106-134" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🎊</code></pre>
<p>Finally, tests for <code>getCssSelections()</code></p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getCssSelections works&quot;</span>, {</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">26717</span>)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">7</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">7</span>)</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;apple&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="st">&quot;banana&quot;</span><span class="ot">=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">&quot;cantaloupe&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>  css_res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getCssSelections</span>(css_res)</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts))))</span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>  already_used_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts)){</span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>    sels_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts[[i]]</span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(sels_i) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(sels_i))</span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sels_i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sels_i), <span class="fu">length</span>(<span class="fu">unique</span>(sels_i)))</span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(already_used_feats, sels_i)), <span class="dv">0</span>)</span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a>    already_used_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(already_used_feats, sels_i)</span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(already_used_feats) <span class="sc">&lt;=</span> <span class="dv">11</span>)</span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(already_used_feats),</span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(already_used_feats)))</span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(already_used_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats))))</span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&lt;=</span> <span class="dv">7</span>))</span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats),</span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(<span class="fu">unique</span>(res<span class="sc">$</span>selected_feats)))</span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test min_num_clusts (should be 5 clusters--3 named ones, plus last two get</span></span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># put in their own unnamed clusters automatically by css)</span></span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a>  res2 <span class="ot">&lt;-</span> <span class="fu">getCssSelections</span>(css_res, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">1</span>,</span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">5</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>)</span>
<span id="cb108-53"><a href="#cb108-53" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res2))</span>
<span id="cb108-54"><a href="#cb108-54" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res2<span class="sc">$</span>selected_clusts), <span class="dv">5</span>)</span>
<span id="cb108-55"><a href="#cb108-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-56"><a href="#cb108-56" aria-hidden="true" tabindex="-1"></a>  res3 <span class="ot">&lt;-</span> <span class="fu">getCssSelections</span>(css_res, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="dv">1</span>,</span>
<span id="cb108-57"><a href="#cb108-57" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">3</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>)</span>
<span id="cb108-58"><a href="#cb108-58" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res3<span class="sc">$</span>selected_clusts) <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb108-59"><a href="#cb108-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-60"><a href="#cb108-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test max_num_clusts</span></span>
<span id="cb108-61"><a href="#cb108-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure there is at least one relevant feature</span></span>
<span id="cb108-62"><a href="#cb108-62" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> x</span>
<span id="cb108-63"><a href="#cb108-63" aria-hidden="true" tabindex="-1"></a>  x2[, <span class="dv">5</span>] <span class="ot">&lt;-</span> y</span>
<span id="cb108-64"><a href="#cb108-64" aria-hidden="true" tabindex="-1"></a>  css_res2 <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x2, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb108-65"><a href="#cb108-65" aria-hidden="true" tabindex="-1"></a>  res4 <span class="ot">&lt;-</span> <span class="fu">getCssSelections</span>(css_res2, <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb108-66"><a href="#cb108-66" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">1</span>)</span>
<span id="cb108-67"><a href="#cb108-67" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res4))</span>
<span id="cb108-68"><a href="#cb108-68" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res4<span class="sc">$</span>selected_clusts), <span class="dv">1</span>)</span>
<span id="cb108-69"><a href="#cb108-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-70"><a href="#cb108-70" aria-hidden="true" tabindex="-1"></a>  res5 <span class="ot">&lt;-</span> <span class="fu">getCssSelections</span>(css_res, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb108-71"><a href="#cb108-71" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">2</span>)</span>
<span id="cb108-72"><a href="#cb108-72" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res5<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span> <span class="dv">2</span>)</span>
<span id="cb108-73"><a href="#cb108-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-74"><a href="#cb108-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Name features</span></span>
<span id="cb108-75"><a href="#cb108-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(x)]</span>
<span id="cb108-76"><a href="#cb108-76" aria-hidden="true" tabindex="-1"></a>  css_res3 <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb108-77"><a href="#cb108-77" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getCssSelections</span>(css_res3, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.05</span>,</span>
<span id="cb108-78"><a href="#cb108-78" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>)</span>
<span id="cb108-79"><a href="#cb108-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-80"><a href="#cb108-80" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb108-81"><a href="#cb108-81" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb108-82"><a href="#cb108-82" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb108-83"><a href="#cb108-83" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span></span>
<span id="cb108-84"><a href="#cb108-84" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb108-85"><a href="#cb108-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-86"><a href="#cb108-86" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb108-87"><a href="#cb108-87" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb108-88"><a href="#cb108-88" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb108-89"><a href="#cb108-89" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats))))</span>
<span id="cb108-90"><a href="#cb108-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-91"><a href="#cb108-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad inputs</span></span>
<span id="cb108-92"><a href="#cb108-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Error has quotation marks in it</span></span>
<span id="cb108-93"><a href="#cb108-93" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssSelections</span>(<span class="st">&quot;css_results&quot;</span>))</span>
<span id="cb108-94"><a href="#cb108-94" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssSelections</span>(css_res, <span class="at">weighting=</span><span class="st">&quot;spasre&quot;</span>),</span>
<span id="cb108-95"><a href="#cb108-95" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character and one of sparse, simple_avg, or weighted_avg&quot;</span>,</span>
<span id="cb108-96"><a href="#cb108-96" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb108-97"><a href="#cb108-97" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssSelections</span>(css_res, <span class="at">cutoff=</span><span class="sc">-</span>.<span class="dv">5</span>),</span>
<span id="cb108-98"><a href="#cb108-98" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;cutoff &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb108-99"><a href="#cb108-99" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssSelections</span>(css_res, <span class="at">min_num_clusts=</span><span class="dv">0</span>),</span>
<span id="cb108-100"><a href="#cb108-100" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb108-101"><a href="#cb108-101" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssSelections</span>(css_res, <span class="at">min_num_clusts=</span><span class="dv">0</span>),</span>
<span id="cb108-102"><a href="#cb108-102" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb108-103"><a href="#cb108-103" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssSelections</span>(css_res, <span class="at">max_num_clusts=</span><span class="dv">50</span>),</span>
<span id="cb108-104"><a href="#cb108-104" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb108-105"><a href="#cb108-105" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssSelections</span>(css_res, <span class="at">max_num_clusts=</span><span class="fl">4.5</span>),</span>
<span id="cb108-106"><a href="#cb108-106" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts == round(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb108-107"><a href="#cb108-107" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb108-108"><a href="#cb108-108" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥳</code></pre>
<p><code>getCssDesign()</code></p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Obtain a design matrix of cluster representatives</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Takes a matrix of observations from the original feature space and returns</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; a matrix of representatives from the selected clusters based on the results</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of cluster stability selection.</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param newX A numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the data that will be used to generate the design matrix of cluster</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; representatives. Must contain the same features (in the same</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; number of columns) as the X matrix provided to css, and if the columns of</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; newX are labeled, the names must match the variable names provided to css.</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; newX may be omitted if train_inds were provided to css to set aside</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; observations for model estimation. If this is the case, then when newX is</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; omitted getCssDesign will return a design matrix of cluster representatives</span></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; formed from the train_inds observations from the matrix X provided to css.</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (If no train_inds were provided to css, newX must be provided to</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; getCssDesign.) Default is NA.</span></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weighting Character; determines how to calculate the weights to</span></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; combine features from the selected clusters into weighted averages, called</span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster representatives. Must be one of &quot;sparse&quot;, &quot;weighted_avg&quot;, or</span></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&#39;. For &quot;sparse&quot;, all the weight is put on the most frequently</span></span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected individual cluster member (or divided equally among all the clusters</span></span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; that are tied for the top selection proportion if there is a tie). For</span></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;weighted_avg&quot;, the weight used for each cluster member is calculated in</span></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; proportion to the individual selection proportions of each feature. For</span></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&quot;, each cluster member gets equal weight regardless of the</span></span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual feature selection proportions (that is, the cluster representative</span></span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; is just a simple average of all the cluster members). See Faletto and Bien</span></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (2022) for details. Default is &quot;weighted_avg&quot;.</span></span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; getCssDesign will only include those clusters with</span></span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection proportions equal to at least cutoff. Must be between 0 and 1.</span></span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Default is 0 (in which case either all clusters are used, or max_num_clusts</span></span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; are used, if max_num_clusts is specified).</span></span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.) Default is 1.</span></span>
<span id="cb110-40"><a href="#cb110-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb110-41"><a href="#cb110-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb110-42"><a href="#cb110-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb110-43"><a href="#cb110-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) Default is NA (in which case</span></span>
<span id="cb110-44"><a href="#cb110-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts is ignored).</span></span>
<span id="cb110-45"><a href="#cb110-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A design matrix with either nrow(newX) (or length(train_inds), if</span></span>
<span id="cb110-46"><a href="#cb110-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; train_inds was provided to css and newX was not provided to getCssDesign)</span></span>
<span id="cb110-47"><a href="#cb110-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; observations and number of columns equal to the number of selected clusters,</span></span>
<span id="cb110-48"><a href="#cb110-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; containing the cluster representatives for each cluster.</span></span>
<span id="cb110-49"><a href="#cb110-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb110-50"><a href="#cb110-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb110-51"><a href="#cb110-51" aria-hidden="true" tabindex="-1"></a>getCssDesign <span class="ot">&lt;-</span> <span class="cf">function</span>(css_results, <span class="at">newX=</span><span class="cn">NA</span>, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb110-52"><a href="#cb110-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">cutoff=</span><span class="dv">0</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>){</span>
<span id="cb110-53"><a href="#cb110-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb110-54"><a href="#cb110-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">class</span>(css_results) <span class="sc">==</span> <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb110-55"><a href="#cb110-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-56"><a href="#cb110-56" aria-hidden="true" tabindex="-1"></a>    check_results <span class="ot">&lt;-</span> <span class="fu">checkNewXProvided</span>(newX, css_results)</span>
<span id="cb110-57"><a href="#cb110-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-58"><a href="#cb110-58" aria-hidden="true" tabindex="-1"></a>    newX <span class="ot">&lt;-</span> check_results<span class="sc">$</span>newX</span>
<span id="cb110-59"><a href="#cb110-59" aria-hidden="true" tabindex="-1"></a>    newXProvided <span class="ot">&lt;-</span> check_results<span class="sc">$</span>newXProvided</span>
<span id="cb110-60"><a href="#cb110-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-61"><a href="#cb110-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(check_results)</span>
<span id="cb110-62"><a href="#cb110-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-63"><a href="#cb110-63" aria-hidden="true" tabindex="-1"></a>    n_train <span class="ot">&lt;-</span> <span class="fu">nrow</span>(newX)</span>
<span id="cb110-64"><a href="#cb110-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-65"><a href="#cb110-65" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">checkXInputResults</span>(newX, css_results<span class="sc">$</span>X)</span>
<span id="cb110-66"><a href="#cb110-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-67"><a href="#cb110-67" aria-hidden="true" tabindex="-1"></a>    newX <span class="ot">&lt;-</span> results<span class="sc">$</span>newx</span>
<span id="cb110-68"><a href="#cb110-68" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="ot">&lt;-</span> results<span class="sc">$</span>feat_names</span>
<span id="cb110-69"><a href="#cb110-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-70"><a href="#cb110-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(results)</span>
<span id="cb110-71"><a href="#cb110-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-72"><a href="#cb110-72" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(newX)</span>
<span id="cb110-73"><a href="#cb110-73" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(newX)</span>
<span id="cb110-74"><a href="#cb110-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-75"><a href="#cb110-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkCutoff</span>(cutoff)</span>
<span id="cb110-76"><a href="#cb110-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkWeighting</span>(weighting)</span>
<span id="cb110-77"><a href="#cb110-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkMinNumClusts</span>(min_num_clusts, p, <span class="fu">length</span>(css_results<span class="sc">$</span>clusters))</span>
<span id="cb110-78"><a href="#cb110-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-79"><a href="#cb110-79" aria-hidden="true" tabindex="-1"></a>    max_num_clusts <span class="ot">&lt;-</span> <span class="fu">checkMaxNumClusts</span>(max_num_clusts, min_num_clusts, p,</span>
<span id="cb110-80"><a href="#cb110-80" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(css_results<span class="sc">$</span>clusters))</span>
<span id="cb110-81"><a href="#cb110-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-82"><a href="#cb110-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Take provided training design matrix and testX and turn them into</span></span>
<span id="cb110-83"><a href="#cb110-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># matrices of cluster representatives using information from css_results</span></span>
<span id="cb110-84"><a href="#cb110-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(newXProvided){</span>
<span id="cb110-85"><a href="#cb110-85" aria-hidden="true" tabindex="-1"></a>        newX_clusters <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(css_results, weighting, cutoff,</span>
<span id="cb110-86"><a href="#cb110-86" aria-hidden="true" tabindex="-1"></a>            min_num_clusts, max_num_clusts, <span class="at">newx=</span>newX)</span>
<span id="cb110-87"><a href="#cb110-87" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb110-88"><a href="#cb110-88" aria-hidden="true" tabindex="-1"></a>        newX_clusters <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(css_results, weighting, cutoff,</span>
<span id="cb110-89"><a href="#cb110-89" aria-hidden="true" tabindex="-1"></a>            min_num_clusts, max_num_clusts)</span>
<span id="cb110-90"><a href="#cb110-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb110-91"><a href="#cb110-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-92"><a href="#cb110-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(newX_clusters)</span>
<span id="cb110-93"><a href="#cb110-93" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkNewXProvided()</code></p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that the new X matrix provided to getCssDesign or</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; getCssPreds matches the characteristics of the X that was provided to css.</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param trainX A numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix). Must contain</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the same features (in the same number of columns) as the X matrix provided to</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css, and if the columns of trainX are labeled, the names must match the</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; variable names provided to css. trainX may be omitted if train_inds were</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided to css to set aside observations.</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with the following elements: \item{newX}{If trainX was</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided, this is the provided trainX matrix, coerced from a data.frame to a</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; matrix if the provided trainX was a data.frame. If trainX was not provided,</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; this is a matrix made up of the training indices provided to css in the</span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; train_inds argument.} \item{newXProvided}{Logical; indicates whether a valid</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; trainX input was provided.}</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>checkNewXProvided <span class="ot">&lt;-</span> <span class="cf">function</span>(trainX, css_results){</span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>    newXProvided <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(trainX)) <span class="sc">&amp;</span> <span class="fu">length</span>(trainX) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>        newXProvided <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>        trainX <span class="ot">&lt;-</span> <span class="fu">checkXInputResults</span>(trainX, css_results<span class="sc">$</span>X)<span class="sc">$</span>newx</span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>        n_train <span class="ot">&lt;-</span> <span class="fu">nrow</span>(trainX)</span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(n_train <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(css_results<span class="sc">$</span>train_inds) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stop</span>(<span class="st">&quot;css was not provided with indices to set aside for model training (train_inds), so must provide new X in order to generate a design matrix&quot;</span>)</span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a>        trainX <span class="ot">&lt;-</span> css_results<span class="sc">$</span>X[css_results<span class="sc">$</span>train_inds, ]</span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(trainX))</span>
<span id="cb111-35"><a href="#cb111-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(trainX) <span class="sc">|</span> <span class="fu">is.integer</span>(trainX))</span>
<span id="cb111-36"><a href="#cb111-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(trainX)))</span>
<span id="cb111-37"><a href="#cb111-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(trainX) <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb111-38"><a href="#cb111-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-39"><a href="#cb111-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">newX=</span>trainX, <span class="at">newXProvided=</span>newXProvided))</span>
<span id="cb111-40"><a href="#cb111-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkXInputResults()</code></p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that inputs to several functions are as expected,</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; and modify inputs if needed</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param newx A numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the data that will be used to generate the design matrix of cluster</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; representatives. Must contain the same features (in the same</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; number of columns) as the X matrix provided to css, and if the columns of</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; newX are labeled, the names must match the variable names provided to css.</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_X The X matrix provided to css, as in the output of the css</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; function (after having been coerced from a data.frame to a matrix by css if</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; needed).</span></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with the following elements. \item{feat_names}{A </span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; character vector containing the column names of newx (if the provided newx</span></span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; had column names). If the provided newx did not have column names, feat_names</span></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will be NA.} \item{newx}{The provided newx matrix, coerced from a data.frame</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to a matrix if the provided newx was a data.frame.}</span></span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>checkXInputResults <span class="ot">&lt;-</span> <span class="cf">function</span>(newx, css_X){</span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if x is a matrix; if it&#39;s a data.frame, convert to matrix.</span></span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.data.frame</span>(newx)){</span>
<span id="cb112-23"><a href="#cb112-23" aria-hidden="true" tabindex="-1"></a>        newx <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., newx)</span>
<span id="cb112-24"><a href="#cb112-24" aria-hidden="true" tabindex="-1"></a>        newx <span class="ot">&lt;-</span> newx[, <span class="fu">colnames</span>(newx) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb112-25"><a href="#cb112-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb112-26"><a href="#cb112-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-27"><a href="#cb112-27" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)</span>
<span id="cb112-28"><a href="#cb112-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(newx))){</span>
<span id="cb112-29"><a href="#cb112-29" aria-hidden="true" tabindex="-1"></a>        feat_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(newx)</span>
<span id="cb112-30"><a href="#cb112-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">identical</span>(feat_names, <span class="fu">colnames</span>(css_X)))</span>
<span id="cb112-31"><a href="#cb112-31" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb112-32"><a href="#cb112-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># In this case, newx has no column names, so same better be true of</span></span>
<span id="cb112-33"><a href="#cb112-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># css_X</span></span>
<span id="cb112-34"><a href="#cb112-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(css_X))){</span>
<span id="cb112-35"><a href="#cb112-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">warning</span>(<span class="st">&quot;New X provided had no variable names (column names) even though the X provided to css did.&quot;</span>)</span>
<span id="cb112-36"><a href="#cb112-36" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb112-37"><a href="#cb112-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb112-38"><a href="#cb112-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-39"><a href="#cb112-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(newx))</span>
<span id="cb112-40"><a href="#cb112-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(newx)))</span>
<span id="cb112-41"><a href="#cb112-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-42"><a href="#cb112-42" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(newx)</span>
<span id="cb112-43"><a href="#cb112-43" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(newx)</span>
<span id="cb112-44"><a href="#cb112-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb112-45"><a href="#cb112-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(feat_names) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb112-46"><a href="#cb112-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(feat_names) <span class="sc">==</span> p)</span>
<span id="cb112-47"><a href="#cb112-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="sc">!</span>(<span class="st">&quot;(Intercept)&quot;</span> <span class="sc">%in%</span> feat_names))</span>
<span id="cb112-48"><a href="#cb112-48" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb112-49"><a href="#cb112-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.na</span>(feat_names))</span>
<span id="cb112-50"><a href="#cb112-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb112-51"><a href="#cb112-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-52"><a href="#cb112-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(newx) <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb112-53"><a href="#cb112-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-54"><a href="#cb112-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confirm that newx matches css_results$X</span></span>
<span id="cb112-55"><a href="#cb112-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(p <span class="sc">!=</span> <span class="fu">ncol</span>(css_X)){</span>
<span id="cb112-56"><a href="#cb112-56" aria-hidden="true" tabindex="-1"></a>        err <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;Number of columns in newx must match number of columns from matrix provided to css. Number of columns in new provided X: &quot;</span>,</span>
<span id="cb112-57"><a href="#cb112-57" aria-hidden="true" tabindex="-1"></a>            p, <span class="st">&quot;. Number of columns in matrix provided to css: &quot;</span>, <span class="fu">ncol</span>(css_X),</span>
<span id="cb112-58"><a href="#cb112-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;.&quot;</span>, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb112-59"><a href="#cb112-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(err)</span>
<span id="cb112-60"><a href="#cb112-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb112-61"><a href="#cb112-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(feat_names) <span class="sc">!=</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(feat_names))){</span>
<span id="cb112-62"><a href="#cb112-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">identical</span>(feat_names, <span class="fu">colnames</span>(css_X))){</span>
<span id="cb112-63"><a href="#cb112-63" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stop</span>(<span class="st">&quot;Provided feature names for newx do not match feature names provided to css&quot;</span>)</span>
<span id="cb112-64"><a href="#cb112-64" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb112-65"><a href="#cb112-65" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb112-66"><a href="#cb112-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-67"><a href="#cb112-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">feat_names=</span>feat_names, <span class="at">newx=</span>newx))</span>
<span id="cb112-68"><a href="#cb112-68" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkXInputResults()</code></p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkXInputResults works&quot;</span>, {</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">72617</span>)</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  x_select <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">5</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">5</span>)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  x_new <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span><span class="sc">*</span><span class="dv">5</span>), <span class="at">nrow=</span><span class="dv">8</span>, <span class="at">ncol=</span><span class="dv">5</span>)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  y_select <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>  y_new <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span>)</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;red&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="st">&quot;blue&quot;</span><span class="ot">=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">&quot;green&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>  css_res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkXInputResults</span>(x_new, css_res<span class="sc">$</span>X)</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;feat_names&quot;</span>, <span class="st">&quot;newx&quot;</span>))</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res<span class="sc">$</span>feat_names))</span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(res<span class="sc">$</span>feat_names))</span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>newx))</span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>newx))</span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>newx), <span class="dv">8</span>)</span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>newx), <span class="dv">5</span>)</span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>newx))</span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try naming variables</span></span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_select) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a>  css_res_named <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Named variables for css matrix but not new one--should get a warning</span></span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">checkXInputResults</span>(x_new, css_res_named<span class="sc">$</span>X),</span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;New X provided had no variable names (column names) even though the X provided to css did.&quot;</span>,</span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try mismatching variable names</span></span>
<span id="cb113-40"><a href="#cb113-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> LETTERS[<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb113-41"><a href="#cb113-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkXInputResults</span>(x_new, css_res_named<span class="sc">$</span>X),</span>
<span id="cb113-42"><a href="#cb113-42" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;identical(feat_names, colnames(css_X)) is not TRUE&quot;</span>,</span>
<span id="cb113-43"><a href="#cb113-43" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb113-44"><a href="#cb113-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-45"><a href="#cb113-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb113-46"><a href="#cb113-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-47"><a href="#cb113-47" aria-hidden="true" tabindex="-1"></a>  res_named <span class="ot">&lt;-</span> <span class="fu">checkXInputResults</span>(x_new, css_res_named<span class="sc">$</span>X)</span>
<span id="cb113-48"><a href="#cb113-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-49"><a href="#cb113-49" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_named))</span>
<span id="cb113-50"><a href="#cb113-50" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_named), <span class="fu">c</span>(<span class="st">&quot;feat_names&quot;</span>, <span class="st">&quot;newx&quot;</span>))</span>
<span id="cb113-51"><a href="#cb113-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-52"><a href="#cb113-52" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res_named<span class="sc">$</span>feat_names))</span>
<span id="cb113-53"><a href="#cb113-53" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res_named<span class="sc">$</span>feat_names, LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span>
<span id="cb113-54"><a href="#cb113-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-55"><a href="#cb113-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try data.frame input to css and checkXInputResults</span></span>
<span id="cb113-56"><a href="#cb113-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-57"><a href="#cb113-57" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb113-58"><a href="#cb113-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-59"><a href="#cb113-59" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_df)</span>
<span id="cb113-60"><a href="#cb113-60" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(n)</span>
<span id="cb113-61"><a href="#cb113-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-62"><a href="#cb113-62" aria-hidden="true" tabindex="-1"></a>  selec_inds <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">round</span>(n<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb113-63"><a href="#cb113-63" aria-hidden="true" tabindex="-1"></a>  fit_inds <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, selec_inds)</span>
<span id="cb113-64"><a href="#cb113-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-65"><a href="#cb113-65" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb113-66"><a href="#cb113-66" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">checkXInputResults</span>(X_df[fit_inds, ], css_res_df<span class="sc">$</span>X)</span>
<span id="cb113-67"><a href="#cb113-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-68"><a href="#cb113-68" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_df))</span>
<span id="cb113-69"><a href="#cb113-69" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_df), <span class="fu">c</span>(<span class="st">&quot;feat_names&quot;</span>, <span class="st">&quot;newx&quot;</span>))</span>
<span id="cb113-70"><a href="#cb113-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-71"><a href="#cb113-71" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res_df<span class="sc">$</span>feat_names))</span>
<span id="cb113-72"><a href="#cb113-72" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res_df<span class="sc">$</span>feat_names, <span class="fu">colnames</span>(css_res_df<span class="sc">$</span>X))</span>
<span id="cb113-73"><a href="#cb113-73" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res_df<span class="sc">$</span>feat_names, <span class="fu">colnames</span>(X_df))</span>
<span id="cb113-74"><a href="#cb113-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-75"><a href="#cb113-75" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb113-76"><a href="#cb113-76" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb113-77"><a href="#cb113-77" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb113-78"><a href="#cb113-78" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_df<span class="sc">$</span>newx), <span class="fu">ncol</span>(css_res_df<span class="sc">$</span>X))</span>
<span id="cb113-79"><a href="#cb113-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-80"><a href="#cb113-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try again with X as a dataframe with factors (number of columns of final</span></span>
<span id="cb113-81"><a href="#cb113-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># design matrix after one-hot encoding factors won&#39;t match number of columns</span></span>
<span id="cb113-82"><a href="#cb113-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># of X_df)</span></span>
<span id="cb113-83"><a href="#cb113-83" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>cyl)</span>
<span id="cb113-84"><a href="#cb113-84" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>vs)</span>
<span id="cb113-85"><a href="#cb113-85" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>am)</span>
<span id="cb113-86"><a href="#cb113-86" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>gear)</span>
<span id="cb113-87"><a href="#cb113-87" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>carb)</span>
<span id="cb113-88"><a href="#cb113-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-89"><a href="#cb113-89" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb113-90"><a href="#cb113-90" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">checkXInputResults</span>(X_df[fit_inds, ], css_res_df<span class="sc">$</span>X)</span>
<span id="cb113-91"><a href="#cb113-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-92"><a href="#cb113-92" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_df))</span>
<span id="cb113-93"><a href="#cb113-93" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_df), <span class="fu">c</span>(<span class="st">&quot;feat_names&quot;</span>, <span class="st">&quot;newx&quot;</span>))</span>
<span id="cb113-94"><a href="#cb113-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-95"><a href="#cb113-95" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res_df<span class="sc">$</span>feat_names))</span>
<span id="cb113-96"><a href="#cb113-96" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res_df<span class="sc">$</span>feat_names, <span class="fu">colnames</span>(css_res_df<span class="sc">$</span>X))</span>
<span id="cb113-97"><a href="#cb113-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-98"><a href="#cb113-98" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>( <span class="sc">~</span>., X_df)</span>
<span id="cb113-99"><a href="#cb113-99" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> mat[, <span class="fu">colnames</span>(mat) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb113-100"><a href="#cb113-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-101"><a href="#cb113-101" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res_df<span class="sc">$</span>feat_names, <span class="fu">colnames</span>(mat))</span>
<span id="cb113-102"><a href="#cb113-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-103"><a href="#cb113-103" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb113-104"><a href="#cb113-104" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb113-105"><a href="#cb113-105" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb113-106"><a href="#cb113-106" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_df<span class="sc">$</span>newx), <span class="fu">ncol</span>(css_res_df<span class="sc">$</span>X))</span>
<span id="cb113-107"><a href="#cb113-107" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🌈</code></pre>
<p>Tests for <code>checkNewXProvided()</code></p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkNewXProvided works&quot;</span>, {</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2673</span>)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  x_select <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">5</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">5</span>)</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  x_new <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span><span class="sc">*</span><span class="dv">5</span>), <span class="at">nrow=</span><span class="dv">8</span>, <span class="at">ncol=</span><span class="dv">5</span>)</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>  y_select <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>  y_new <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span>)</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;red&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="st">&quot;blue&quot;</span><span class="ot">=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">&quot;green&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>  css_res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkNewXProvided</span>(x_new, css_res)</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;newX&quot;</span>, <span class="st">&quot;newXProvided&quot;</span>))</span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>newX))</span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>newX))</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>newX), <span class="dv">8</span>)</span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>newX), <span class="dv">5</span>)</span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>newX))</span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.logical</span>(res<span class="sc">$</span>newXProvided))</span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>newXProvided), <span class="dv">1</span>)</span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>newXProvided))</span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res<span class="sc">$</span>newXProvided)</span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add training indices</span></span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a>  css_res_train <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>, <span class="at">train_inds=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Training indices should be ignored if new x is provided</span></span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-36"><a href="#cb115-36" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkNewXProvided</span>(x_new, css_res_train)</span>
<span id="cb115-37"><a href="#cb115-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-38"><a href="#cb115-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb115-39"><a href="#cb115-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;newX&quot;</span>, <span class="st">&quot;newXProvided&quot;</span>))</span>
<span id="cb115-40"><a href="#cb115-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-41"><a href="#cb115-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_new <span class="sc">-</span> res<span class="sc">$</span>newX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb115-42"><a href="#cb115-42" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res<span class="sc">$</span>newXProvided)</span>
<span id="cb115-43"><a href="#cb115-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-44"><a href="#cb115-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Things should still work if new x is not provided</span></span>
<span id="cb115-45"><a href="#cb115-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-46"><a href="#cb115-46" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkNewXProvided</span>(<span class="cn">NA</span>, css_res_train)</span>
<span id="cb115-47"><a href="#cb115-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-48"><a href="#cb115-48" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb115-49"><a href="#cb115-49" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;newX&quot;</span>, <span class="st">&quot;newXProvided&quot;</span>))</span>
<span id="cb115-50"><a href="#cb115-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-51"><a href="#cb115-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>newX))</span>
<span id="cb115-52"><a href="#cb115-52" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>newX))</span>
<span id="cb115-53"><a href="#cb115-53" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>newX), <span class="dv">5</span>)</span>
<span id="cb115-54"><a href="#cb115-54" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>newX), <span class="dv">5</span>)</span>
<span id="cb115-55"><a href="#cb115-55" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>newX))</span>
<span id="cb115-56"><a href="#cb115-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-57"><a href="#cb115-57" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_false</span>(res<span class="sc">$</span>newXProvided)</span>
<span id="cb115-58"><a href="#cb115-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-59"><a href="#cb115-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try not providing training indices and omitting newx--should get error</span></span>
<span id="cb115-60"><a href="#cb115-60" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkNewXProvided</span>(<span class="cn">NA</span>, css_res),</span>
<span id="cb115-61"><a href="#cb115-61" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;css was not provided with indices to set aside for model training (train_inds), so must provide new X in order to generate a design matrix&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb115-62"><a href="#cb115-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-63"><a href="#cb115-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try naming variables</span></span>
<span id="cb115-64"><a href="#cb115-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-65"><a href="#cb115-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_select) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb115-66"><a href="#cb115-66" aria-hidden="true" tabindex="-1"></a>  css_res_named <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb115-67"><a href="#cb115-67" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb115-68"><a href="#cb115-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-69"><a href="#cb115-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Named variables for css matrix but not new one--should get a warning</span></span>
<span id="cb115-70"><a href="#cb115-70" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">checkNewXProvided</span>(x_new, css_res_named),</span>
<span id="cb115-71"><a href="#cb115-71" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;New X provided had no variable names (column names) even though the X provided to css did.&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb115-72"><a href="#cb115-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-73"><a href="#cb115-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try mismatching variable names</span></span>
<span id="cb115-74"><a href="#cb115-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> LETTERS[<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb115-75"><a href="#cb115-75" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkNewXProvided</span>(x_new, css_res_named),</span>
<span id="cb115-76"><a href="#cb115-76" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;identical(feat_names, colnames(css_X)) is not TRUE&quot;</span>,</span>
<span id="cb115-77"><a href="#cb115-77" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb115-78"><a href="#cb115-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-79"><a href="#cb115-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb115-80"><a href="#cb115-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-81"><a href="#cb115-81" aria-hidden="true" tabindex="-1"></a>  res_named <span class="ot">&lt;-</span> <span class="fu">checkNewXProvided</span>(x_new, css_res_named)</span>
<span id="cb115-82"><a href="#cb115-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-83"><a href="#cb115-83" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_named))</span>
<span id="cb115-84"><a href="#cb115-84" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_named), <span class="fu">c</span>(<span class="st">&quot;newX&quot;</span>, <span class="st">&quot;newXProvided&quot;</span>))</span>
<span id="cb115-85"><a href="#cb115-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-86"><a href="#cb115-86" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_new <span class="sc">-</span> res_named<span class="sc">$</span>newX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb115-87"><a href="#cb115-87" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res_named<span class="sc">$</span>newXProvided)</span>
<span id="cb115-88"><a href="#cb115-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-89"><a href="#cb115-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try data.frame input to css and checkNewXProvided</span></span>
<span id="cb115-90"><a href="#cb115-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-91"><a href="#cb115-91" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb115-92"><a href="#cb115-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-93"><a href="#cb115-93" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_df)</span>
<span id="cb115-94"><a href="#cb115-94" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(n)</span>
<span id="cb115-95"><a href="#cb115-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-96"><a href="#cb115-96" aria-hidden="true" tabindex="-1"></a>  selec_inds <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">round</span>(n<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb115-97"><a href="#cb115-97" aria-hidden="true" tabindex="-1"></a>  fit_inds <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, selec_inds)</span>
<span id="cb115-98"><a href="#cb115-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-99"><a href="#cb115-99" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb115-100"><a href="#cb115-100" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">checkNewXProvided</span>(X_df[fit_inds, ], css_res_df)</span>
<span id="cb115-101"><a href="#cb115-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-102"><a href="#cb115-102" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_df))</span>
<span id="cb115-103"><a href="#cb115-103" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_df), <span class="fu">c</span>(<span class="st">&quot;newX&quot;</span>, <span class="st">&quot;newXProvided&quot;</span>))</span>
<span id="cb115-104"><a href="#cb115-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-105"><a href="#cb115-105" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df<span class="sc">$</span>newX))</span>
<span id="cb115-106"><a href="#cb115-106" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df<span class="sc">$</span>newX))</span>
<span id="cb115-107"><a href="#cb115-107" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df<span class="sc">$</span>newX), <span class="fu">length</span>(fit_inds))</span>
<span id="cb115-108"><a href="#cb115-108" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_df<span class="sc">$</span>newX), <span class="fu">ncol</span>(css_res_df<span class="sc">$</span>X))</span>
<span id="cb115-109"><a href="#cb115-109" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res_df<span class="sc">$</span>newX))</span>
<span id="cb115-110"><a href="#cb115-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-111"><a href="#cb115-111" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.logical</span>(res_df<span class="sc">$</span>newXProvided))</span>
<span id="cb115-112"><a href="#cb115-112" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res_df<span class="sc">$</span>newXProvided), <span class="dv">1</span>)</span>
<span id="cb115-113"><a href="#cb115-113" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(res_df<span class="sc">$</span>newXProvided))</span>
<span id="cb115-114"><a href="#cb115-114" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res_df<span class="sc">$</span>newXProvided)</span>
<span id="cb115-115"><a href="#cb115-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-116"><a href="#cb115-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try again with X as a dataframe with factors (number of columns of final</span></span>
<span id="cb115-117"><a href="#cb115-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># design matrix after one-hot encoding factors won&#39;t match number of columns</span></span>
<span id="cb115-118"><a href="#cb115-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># of X_df)</span></span>
<span id="cb115-119"><a href="#cb115-119" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>cyl)</span>
<span id="cb115-120"><a href="#cb115-120" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>vs)</span>
<span id="cb115-121"><a href="#cb115-121" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>am)</span>
<span id="cb115-122"><a href="#cb115-122" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>gear)</span>
<span id="cb115-123"><a href="#cb115-123" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>carb)</span>
<span id="cb115-124"><a href="#cb115-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-125"><a href="#cb115-125" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb115-126"><a href="#cb115-126" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">checkNewXProvided</span>(X_df[fit_inds, ], css_res_df)</span>
<span id="cb115-127"><a href="#cb115-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-128"><a href="#cb115-128" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_df))</span>
<span id="cb115-129"><a href="#cb115-129" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_df), <span class="fu">c</span>(<span class="st">&quot;newX&quot;</span>, <span class="st">&quot;newXProvided&quot;</span>))</span>
<span id="cb115-130"><a href="#cb115-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-131"><a href="#cb115-131" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df<span class="sc">$</span>newX))</span>
<span id="cb115-132"><a href="#cb115-132" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df<span class="sc">$</span>newX))</span>
<span id="cb115-133"><a href="#cb115-133" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df<span class="sc">$</span>newX), <span class="fu">length</span>(fit_inds))</span>
<span id="cb115-134"><a href="#cb115-134" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_df<span class="sc">$</span>newX), <span class="fu">ncol</span>(css_res_df<span class="sc">$</span>X))</span>
<span id="cb115-135"><a href="#cb115-135" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res_df<span class="sc">$</span>newX))</span>
<span id="cb115-136"><a href="#cb115-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-137"><a href="#cb115-137" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.logical</span>(res_df<span class="sc">$</span>newXProvided))</span>
<span id="cb115-138"><a href="#cb115-138" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res_df<span class="sc">$</span>newXProvided), <span class="dv">1</span>)</span>
<span id="cb115-139"><a href="#cb115-139" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(res_df<span class="sc">$</span>newXProvided))</span>
<span id="cb115-140"><a href="#cb115-140" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res_df<span class="sc">$</span>newXProvided)</span>
<span id="cb115-141"><a href="#cb115-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-142"><a href="#cb115-142" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😀</code></pre>
<p><code>formCssDesign()</code>:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Create design matrix of cluster representatives from matrix of raw features</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; using results of css function</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weighting Character; determines how to calculate the weights to</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; combine features from the selected clusters into weighted averages, called</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster representatives. Must be one of &quot;sparse&quot;, &quot;weighted_avg&quot;, or</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&#39;. For &quot;sparse&quot;, all the weight is put on the most frequently</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected individual cluster member (or divided equally among all the clusters</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; that are tied for the top selection proportion if there is a tie). For</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;weighted_avg&quot;, the weight used for each cluster member is calculated in</span></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; proportion to the individual selection proportions of each feature. For</span></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&quot;, each cluster member gets equal weight regardless of the</span></span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual feature selection proportions (that is, the cluster representative</span></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; is just a simple average of all the cluster members). See Faletto and Bien</span></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (2022) for details. Default is &quot;weighted_avg&quot;.</span></span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; css will return only those clusters with selection</span></span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; proportions equal to at least cutoff. Must be between 0 and 1. Default is 0</span></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (in which case all clusters are returned in decreasing order of selection</span></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; proportion).</span></span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.) Default is 1.</span></span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) Default is NA (in which case</span></span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts is ignored).</span></span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param newx A numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb117-32"><a href="#cb117-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb117-33"><a href="#cb117-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the data that will be used to generate the design matrix of cluster</span></span>
<span id="cb117-34"><a href="#cb117-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; representatives. Must contain the same features (in the same</span></span>
<span id="cb117-35"><a href="#cb117-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; number of columns) as the X matrix provided to css, and if the columns of</span></span>
<span id="cb117-36"><a href="#cb117-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; newx are labeled, the names must match the variable names provided to css.</span></span>
<span id="cb117-37"><a href="#cb117-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; newx may be omitted if train_inds were provided to css to set aside</span></span>
<span id="cb117-38"><a href="#cb117-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; observations for model estimation. If this is the case, then when newx is</span></span>
<span id="cb117-39"><a href="#cb117-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; omitted formCssDesign will return a design matrix of cluster representatives</span></span>
<span id="cb117-40"><a href="#cb117-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; formed from the train_inds observations from the matrix X provided to css.</span></span>
<span id="cb117-41"><a href="#cb117-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (If no train_inds were provided to css, newX must be provided to</span></span>
<span id="cb117-42"><a href="#cb117-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; formCssDesign.) Default is NA.</span></span>
<span id="cb117-43"><a href="#cb117-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A design matrix with the same number of rows as newx (or the </span></span>
<span id="cb117-44"><a href="#cb117-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; train_inds provided to css) where the columns are the constructed cluster</span></span>
<span id="cb117-45"><a href="#cb117-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; representatives.</span></span>
<span id="cb117-46"><a href="#cb117-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb117-47"><a href="#cb117-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references</span></span>
<span id="cb117-48"><a href="#cb117-48" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>faletto2022<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb117-49"><a href="#cb117-49" aria-hidden="true" tabindex="-1"></a>formCssDesign <span class="ot">&lt;-</span> <span class="cf">function</span>(css_results, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb117-50"><a href="#cb117-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">newx=</span><span class="cn">NA</span>){</span>
<span id="cb117-51"><a href="#cb117-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-52"><a href="#cb117-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb117-53"><a href="#cb117-53" aria-hidden="true" tabindex="-1"></a>    ret <span class="ot">&lt;-</span> <span class="fu">checkFormCssDesignInputs</span>(css_results, weighting, cutoff,</span>
<span id="cb117-54"><a href="#cb117-54" aria-hidden="true" tabindex="-1"></a>        min_num_clusts, max_num_clusts, newx)</span>
<span id="cb117-55"><a href="#cb117-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-56"><a href="#cb117-56" aria-hidden="true" tabindex="-1"></a>    newx <span class="ot">&lt;-</span> ret<span class="sc">$</span>newx</span>
<span id="cb117-57"><a href="#cb117-57" aria-hidden="true" tabindex="-1"></a>    max_num_clusts <span class="ot">&lt;-</span> ret<span class="sc">$</span>max_num_clusts</span>
<span id="cb117-58"><a href="#cb117-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-59"><a href="#cb117-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(ret)</span>
<span id="cb117-60"><a href="#cb117-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-61"><a href="#cb117-61" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(newx)</span>
<span id="cb117-62"><a href="#cb117-62" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(newx)</span>
<span id="cb117-63"><a href="#cb117-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-64"><a href="#cb117-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the names of the selected clusters and the weights for the features</span></span>
<span id="cb117-65"><a href="#cb117-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># within each cluster, according to the provided weighting rule</span></span>
<span id="cb117-66"><a href="#cb117-66" aria-hidden="true" tabindex="-1"></a>    weights <span class="ot">&lt;-</span> <span class="fu">getSelectedClusters</span>(css_results, weighting, cutoff,</span>
<span id="cb117-67"><a href="#cb117-67" aria-hidden="true" tabindex="-1"></a>        min_num_clusts, max_num_clusts)<span class="sc">$</span>weights</span>
<span id="cb117-68"><a href="#cb117-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-69"><a href="#cb117-69" aria-hidden="true" tabindex="-1"></a>    n_sel_clusts <span class="ot">&lt;-</span> <span class="fu">length</span>(weights)</span>
<span id="cb117-70"><a href="#cb117-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-71"><a href="#cb117-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Form matrix of cluster representatives of selected clusters</span></span>
<span id="cb117-72"><a href="#cb117-72" aria-hidden="true" tabindex="-1"></a>    X_clus_reps <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">as.numeric</span>(<span class="cn">NA</span>), n<span class="sc">*</span>n_sel_clusts), <span class="at">nrow=</span>n,</span>
<span id="cb117-73"><a href="#cb117-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncol=</span>n_sel_clusts)</span>
<span id="cb117-74"><a href="#cb117-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(X_clus_reps) <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">as.character</span>(<span class="cn">NA</span>), n_sel_clusts)</span>
<span id="cb117-75"><a href="#cb117-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-76"><a href="#cb117-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sel_clusts){</span>
<span id="cb117-77"><a href="#cb117-77" aria-hidden="true" tabindex="-1"></a>        clust_i_name <span class="ot">&lt;-</span> <span class="fu">names</span>(weights)[i]</span>
<span id="cb117-78"><a href="#cb117-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-79"><a href="#cb117-79" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(clust_i_name) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb117-80"><a href="#cb117-80" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(clust_i_name <span class="sc">%in%</span> <span class="fu">names</span>(weights))</span>
<span id="cb117-81"><a href="#cb117-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-82"><a href="#cb117-82" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(X_clus_reps)[i] <span class="ot">&lt;-</span> clust_i_name</span>
<span id="cb117-83"><a href="#cb117-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-84"><a href="#cb117-84" aria-hidden="true" tabindex="-1"></a>        clust_i <span class="ot">&lt;-</span> css_results<span class="sc">$</span>clusters[[clust_i_name]]</span>
<span id="cb117-85"><a href="#cb117-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-86"><a href="#cb117-86" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(clust_i) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb117-87"><a href="#cb117-87" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(clust_i) <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span>p)</span>
<span id="cb117-88"><a href="#cb117-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-89"><a href="#cb117-89" aria-hidden="true" tabindex="-1"></a>        weights_i <span class="ot">&lt;-</span> weights[[clust_i_name]]</span>
<span id="cb117-90"><a href="#cb117-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-91"><a href="#cb117-91" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(clust_i) <span class="sc">==</span> <span class="fu">length</span>(weights_i))</span>
<span id="cb117-92"><a href="#cb117-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-93"><a href="#cb117-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(weights_i) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb117-94"><a href="#cb117-94" aria-hidden="true" tabindex="-1"></a>            X_clus_reps[, i] <span class="ot">&lt;-</span> newx[, clust_i] <span class="sc">%*%</span> weights_i</span>
<span id="cb117-95"><a href="#cb117-95" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span>{</span>
<span id="cb117-96"><a href="#cb117-96" aria-hidden="true" tabindex="-1"></a>            X_clus_reps[, i] <span class="ot">&lt;-</span> newx[, clust_i]<span class="sc">*</span>weights_i</span>
<span id="cb117-97"><a href="#cb117-97" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb117-98"><a href="#cb117-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb117-99"><a href="#cb117-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-100"><a href="#cb117-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb117-101"><a href="#cb117-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(X_clus_reps)))</span>
<span id="cb117-102"><a href="#cb117-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(X_clus_reps) <span class="sc">==</span> n_sel_clusts)</span>
<span id="cb117-103"><a href="#cb117-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(X_clus_reps) <span class="sc">==</span> n)</span>
<span id="cb117-104"><a href="#cb117-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-105"><a href="#cb117-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(X_clus_reps)</span>
<span id="cb117-106"><a href="#cb117-106" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkFormCssDesignInputs()</code>:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to check that the inputs to formCssDesign are as expected</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weighting Character; determines how to calculate the weights to</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; combine features from the selected clusters into weighted averages, called</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster representatives. Must be one of &quot;sparse&quot;, &quot;weighted_avg&quot;, or</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&#39;.</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; css will return only those clusters with selection</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; proportions equal to at least cutoff. Must be between 0 and 1.</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.)</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.)</span></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param newx A numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the data that will be used to generate the design matrix of cluster</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; representatives. Must contain the same features (in the same</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; number of columns) as the X matrix provided to css, and if the columns of</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; newx are labeled, the names must match the variable names provided to css.</span></span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; newx may be omitted if train_inds were provided to css to set aside</span></span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; observations for model estimation. If this is the case, then when newx is</span></span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; omitted formCssDesign will return a design matrix of cluster representatives</span></span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; formed from the train_inds observations from the matrix X provided to css.</span></span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (If no train_inds were provided to css, newX must be provided to</span></span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; formCssDesign.)</span></span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with the following elements: \item{newx}{If newx was</span></span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided, the provided newx matrix, coerced from a data.frame to a matrix if</span></span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; needed. If newx was not provided, a matrix formed by the train_inds set</span></span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; aside in the original function call to css.} \item{max_num_clusts}{The</span></span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided max_num_clusts, coerced to an integer if needed, and coerced to be</span></span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; less than or equal to the total number of clusters.}</span></span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a>checkFormCssDesignInputs <span class="ot">&lt;-</span> <span class="cf">function</span>(css_results, weighting, cutoff,</span>
<span id="cb118-39"><a href="#cb118-39" aria-hidden="true" tabindex="-1"></a>    min_num_clusts, max_num_clusts, newx){    </span>
<span id="cb118-40"><a href="#cb118-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">class</span>(css_results) <span class="sc">==</span> <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb118-41"><a href="#cb118-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-42"><a href="#cb118-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(newx) <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb118-43"><a href="#cb118-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.na</span>(newx)){</span>
<span id="cb118-44"><a href="#cb118-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">length</span>(css_results<span class="sc">$</span>train_inds) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb118-45"><a href="#cb118-45" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stop</span>(<span class="st">&quot;If css was not provided with indices to set aside for model training, then newx must be provided to formCssDesign&quot;</span>)</span>
<span id="cb118-46"><a href="#cb118-46" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb118-47"><a href="#cb118-47" aria-hidden="true" tabindex="-1"></a>            newx <span class="ot">&lt;-</span> css_results<span class="sc">$</span>X[css_results<span class="sc">$</span>train_inds, ]</span>
<span id="cb118-48"><a href="#cb118-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># feat_names &lt;- colnames(newx)</span></span>
<span id="cb118-49"><a href="#cb118-49" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span>{</span>
<span id="cb118-50"><a href="#cb118-50" aria-hidden="true" tabindex="-1"></a>            results <span class="ot">&lt;-</span> <span class="fu">checkXInputResults</span>(newx, css_results<span class="sc">$</span>X)</span>
<span id="cb118-51"><a href="#cb118-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-52"><a href="#cb118-52" aria-hidden="true" tabindex="-1"></a>            newx <span class="ot">&lt;-</span> results<span class="sc">$</span>newx</span>
<span id="cb118-53"><a href="#cb118-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># feat_names &lt;- results$feat_names</span></span>
<span id="cb118-54"><a href="#cb118-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-55"><a href="#cb118-55" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rm</span>(results)</span>
<span id="cb118-56"><a href="#cb118-56" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb118-57"><a href="#cb118-57" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb118-58"><a href="#cb118-58" aria-hidden="true" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">checkXInputResults</span>(newx, css_results<span class="sc">$</span>X)</span>
<span id="cb118-59"><a href="#cb118-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-60"><a href="#cb118-60" aria-hidden="true" tabindex="-1"></a>        newx <span class="ot">&lt;-</span> results<span class="sc">$</span>newx</span>
<span id="cb118-61"><a href="#cb118-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># feat_names &lt;- results$feat_names</span></span>
<span id="cb118-62"><a href="#cb118-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-63"><a href="#cb118-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rm</span>(results)</span>
<span id="cb118-64"><a href="#cb118-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb118-65"><a href="#cb118-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-66"><a href="#cb118-66" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(newx)</span>
<span id="cb118-67"><a href="#cb118-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-68"><a href="#cb118-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkCutoff</span>(cutoff)</span>
<span id="cb118-69"><a href="#cb118-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkWeighting</span>(weighting)</span>
<span id="cb118-70"><a href="#cb118-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkMinNumClusts</span>(min_num_clusts, p, <span class="fu">length</span>(css_results<span class="sc">$</span>clusters))</span>
<span id="cb118-71"><a href="#cb118-71" aria-hidden="true" tabindex="-1"></a>    max_num_clusts <span class="ot">&lt;-</span> <span class="fu">checkMaxNumClusts</span>(max_num_clusts, min_num_clusts, p,</span>
<span id="cb118-72"><a href="#cb118-72" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(css_results<span class="sc">$</span>clusters))</span>
<span id="cb118-73"><a href="#cb118-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-74"><a href="#cb118-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">newx=</span>newx, <span class="at">max_num_clusts=</span>max_num_clusts))</span>
<span id="cb118-75"><a href="#cb118-75" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkFormCssDesignInputs()</code></p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkFormCssDesignInputs works&quot;</span>, {</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">72617</span>)</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  x_select <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  x_new <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">8</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>  y_select <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>  y_new <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span>)</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;red&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="st">&quot;blue&quot;</span><span class="ot">=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">&quot;green&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>  css_res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">cutoff=</span><span class="fl">0.5</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">newx=</span>x_new)</span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;newx&quot;</span>, <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>newx))</span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>newx))</span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>newx), <span class="dv">8</span>)</span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>newx), <span class="dv">6</span>)</span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>newx))</span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_new <span class="sc">-</span> res<span class="sc">$</span>newX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>max_num_clusts), <span class="dv">1</span>)</span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(res<span class="sc">$</span>max_num_clusts))</span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add training indices</span></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a>  css_res_train <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B=</span><span class="dv">10</span>, <span class="at">train_inds=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Training indices should be ignored if new x is provided</span></span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res_train,</span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">min_num_clusts=</span><span class="dv">2</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">newx=</span>x_new)</span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;newx&quot;</span>, <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>newx))</span>
<span id="cb119-46"><a href="#cb119-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>newx))</span>
<span id="cb119-47"><a href="#cb119-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>newx), <span class="dv">8</span>)</span>
<span id="cb119-48"><a href="#cb119-48" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>newx), <span class="dv">6</span>)</span>
<span id="cb119-49"><a href="#cb119-49" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>newx))</span>
<span id="cb119-50"><a href="#cb119-50" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_new <span class="sc">-</span> res<span class="sc">$</span>newX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb119-51"><a href="#cb119-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-52"><a href="#cb119-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Things should still work if new x is not provided</span></span>
<span id="cb119-53"><a href="#cb119-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-54"><a href="#cb119-54" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res_train, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb119-55"><a href="#cb119-55" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">cutoff=</span><span class="dv">1</span>, <span class="at">min_num_clusts=</span><span class="dv">3</span>,</span>
<span id="cb119-56"><a href="#cb119-56" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">newx=</span><span class="cn">NA</span>)</span>
<span id="cb119-57"><a href="#cb119-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-58"><a href="#cb119-58" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb119-59"><a href="#cb119-59" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;newx&quot;</span>, <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb119-60"><a href="#cb119-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-61"><a href="#cb119-61" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>newx))</span>
<span id="cb119-62"><a href="#cb119-62" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>newx))</span>
<span id="cb119-63"><a href="#cb119-63" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>newx), <span class="fu">length</span>(<span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>))</span>
<span id="cb119-64"><a href="#cb119-64" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>newx), <span class="dv">6</span>)</span>
<span id="cb119-65"><a href="#cb119-65" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res<span class="sc">$</span>newx))</span>
<span id="cb119-66"><a href="#cb119-66" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_select[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, ] <span class="sc">-</span> res<span class="sc">$</span>newX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb119-67"><a href="#cb119-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-68"><a href="#cb119-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try not providing training indices and omitting newx--should get error</span></span>
<span id="cb119-69"><a href="#cb119-69" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-70"><a href="#cb119-70" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb119-71"><a href="#cb119-71" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.5</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-72"><a href="#cb119-72" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="dv">5</span>, <span class="at">newx=</span><span class="cn">NA</span>),</span>
<span id="cb119-73"><a href="#cb119-73" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;If css was not provided with indices to set aside for model training, then newx must be provided to formCssDesign&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-74"><a href="#cb119-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-75"><a href="#cb119-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try naming variables</span></span>
<span id="cb119-76"><a href="#cb119-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-77"><a href="#cb119-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_select) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb119-78"><a href="#cb119-78" aria-hidden="true" tabindex="-1"></a>  css_res_named <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb119-79"><a href="#cb119-79" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb119-80"><a href="#cb119-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-81"><a href="#cb119-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Named variables for css matrix but not new one--should get a warning</span></span>
<span id="cb119-82"><a href="#cb119-82" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res_named,</span>
<span id="cb119-83"><a href="#cb119-83" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>,</span>
<span id="cb119-84"><a href="#cb119-84" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">cutoff=</span><span class="fl">0.9</span>,</span>
<span id="cb119-85"><a href="#cb119-85" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-86"><a href="#cb119-86" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">max_num_clusts=</span><span class="dv">3</span>,</span>
<span id="cb119-87"><a href="#cb119-87" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">newx=</span>x_new),</span>
<span id="cb119-88"><a href="#cb119-88" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;New X provided had no variable names (column names) even though the X provided to css did.&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-89"><a href="#cb119-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-90"><a href="#cb119-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try mismatching variable names</span></span>
<span id="cb119-91"><a href="#cb119-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> LETTERS[<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>]</span>
<span id="cb119-92"><a href="#cb119-92" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res_named,</span>
<span id="cb119-93"><a href="#cb119-93" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb119-94"><a href="#cb119-94" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-95"><a href="#cb119-95" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-96"><a href="#cb119-96" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-97"><a href="#cb119-97" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;identical(feat_names, colnames(css_X)) is not TRUE&quot;</span>,</span>
<span id="cb119-98"><a href="#cb119-98" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-99"><a href="#cb119-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-100"><a href="#cb119-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb119-101"><a href="#cb119-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-102"><a href="#cb119-102" aria-hidden="true" tabindex="-1"></a>  res_named <span class="ot">&lt;-</span> <span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res_named,</span>
<span id="cb119-103"><a href="#cb119-103" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.5</span>,</span>
<span id="cb119-104"><a href="#cb119-104" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">min_num_clusts=</span><span class="dv">2</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-105"><a href="#cb119-105" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">newx=</span>x_new)</span>
<span id="cb119-106"><a href="#cb119-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-107"><a href="#cb119-107" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_named))</span>
<span id="cb119-108"><a href="#cb119-108" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_named), <span class="fu">c</span>(<span class="st">&quot;newx&quot;</span>, <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb119-109"><a href="#cb119-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-110"><a href="#cb119-110" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_named<span class="sc">$</span>newx))</span>
<span id="cb119-111"><a href="#cb119-111" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_named<span class="sc">$</span>newx))</span>
<span id="cb119-112"><a href="#cb119-112" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_named<span class="sc">$</span>newx), <span class="dv">8</span>)</span>
<span id="cb119-113"><a href="#cb119-113" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_named<span class="sc">$</span>newx), <span class="dv">6</span>)</span>
<span id="cb119-114"><a href="#cb119-114" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res_named<span class="sc">$</span>newx))</span>
<span id="cb119-115"><a href="#cb119-115" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(css_res_named<span class="sc">$</span>X), LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span>
<span id="cb119-116"><a href="#cb119-116" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_new <span class="sc">-</span> res_named<span class="sc">$</span>newX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb119-117"><a href="#cb119-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-118"><a href="#cb119-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try data.frame input to css and checkFormCssDesignInputs</span></span>
<span id="cb119-119"><a href="#cb119-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-120"><a href="#cb119-120" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb119-121"><a href="#cb119-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-122"><a href="#cb119-122" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_df)</span>
<span id="cb119-123"><a href="#cb119-123" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(n)</span>
<span id="cb119-124"><a href="#cb119-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-125"><a href="#cb119-125" aria-hidden="true" tabindex="-1"></a>  selec_inds <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">round</span>(n<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb119-126"><a href="#cb119-126" aria-hidden="true" tabindex="-1"></a>  fit_inds <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, selec_inds)</span>
<span id="cb119-127"><a href="#cb119-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-128"><a href="#cb119-128" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb119-129"><a href="#cb119-129" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res_df,</span>
<span id="cb119-130"><a href="#cb119-130" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.7</span>,</span>
<span id="cb119-131"><a href="#cb119-131" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">min_num_clusts=</span><span class="dv">3</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-132"><a href="#cb119-132" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">newx=</span>X_df[fit_inds, ])</span>
<span id="cb119-133"><a href="#cb119-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-134"><a href="#cb119-134" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_df))</span>
<span id="cb119-135"><a href="#cb119-135" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_df), <span class="fu">c</span>(<span class="st">&quot;newx&quot;</span>, <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb119-136"><a href="#cb119-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-137"><a href="#cb119-137" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb119-138"><a href="#cb119-138" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb119-139"><a href="#cb119-139" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb119-140"><a href="#cb119-140" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df<span class="sc">$</span>newx), <span class="fu">length</span>(fit_inds))</span>
<span id="cb119-141"><a href="#cb119-141" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_df<span class="sc">$</span>newx), <span class="fu">ncol</span>(css_res_df<span class="sc">$</span>X))</span>
<span id="cb119-142"><a href="#cb119-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-143"><a href="#cb119-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try again with X as a dataframe with factors (number of columns of final</span></span>
<span id="cb119-144"><a href="#cb119-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># design matrix after one-hot encoding factors won&#39;t match number of columns</span></span>
<span id="cb119-145"><a href="#cb119-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># of X_df)</span></span>
<span id="cb119-146"><a href="#cb119-146" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>cyl)</span>
<span id="cb119-147"><a href="#cb119-147" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>vs)</span>
<span id="cb119-148"><a href="#cb119-148" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>am)</span>
<span id="cb119-149"><a href="#cb119-149" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>gear)</span>
<span id="cb119-150"><a href="#cb119-150" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>carb)</span>
<span id="cb119-151"><a href="#cb119-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-152"><a href="#cb119-152" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb119-153"><a href="#cb119-153" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res_df,</span>
<span id="cb119-154"><a href="#cb119-154" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.3</span>,</span>
<span id="cb119-155"><a href="#cb119-155" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">4</span>,</span>
<span id="cb119-156"><a href="#cb119-156" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">newx=</span>X_df[fit_inds, ])</span>
<span id="cb119-157"><a href="#cb119-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-158"><a href="#cb119-158" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_df))</span>
<span id="cb119-159"><a href="#cb119-159" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_df), <span class="fu">c</span>(<span class="st">&quot;newx&quot;</span>, <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb119-160"><a href="#cb119-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-161"><a href="#cb119-161" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb119-162"><a href="#cb119-162" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb119-163"><a href="#cb119-163" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_null</span>(<span class="fu">colnames</span>(res_df<span class="sc">$</span>newx))</span>
<span id="cb119-164"><a href="#cb119-164" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df<span class="sc">$</span>newx), <span class="fu">length</span>(fit_inds))</span>
<span id="cb119-165"><a href="#cb119-165" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_df<span class="sc">$</span>newx), <span class="fu">ncol</span>(css_res_df<span class="sc">$</span>X))</span>
<span id="cb119-166"><a href="#cb119-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-167"><a href="#cb119-167" aria-hidden="true" tabindex="-1"></a>  <span class="do">##### Try other bad inputs</span></span>
<span id="cb119-168"><a href="#cb119-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-169"><a href="#cb119-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb119-170"><a href="#cb119-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-171"><a href="#cb119-171" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-172"><a href="#cb119-172" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb119-173"><a href="#cb119-173" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="sc">-</span><span class="fl">0.3</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-174"><a href="#cb119-174" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="dv">4</span>,</span>
<span id="cb119-175"><a href="#cb119-175" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-176"><a href="#cb119-176" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;cutoff &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-177"><a href="#cb119-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-178"><a href="#cb119-178" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-179"><a href="#cb119-179" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb119-180"><a href="#cb119-180" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="st">&quot;0.5&quot;</span>,</span>
<span id="cb119-181"><a href="#cb119-181" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-182"><a href="#cb119-182" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">newx=</span>x_new),</span>
<span id="cb119-183"><a href="#cb119-183" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;is.numeric(cutoff) | is.integer(cutoff) is not TRUE&quot;</span>,</span>
<span id="cb119-184"><a href="#cb119-184" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-185"><a href="#cb119-185" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-186"><a href="#cb119-186" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-187"><a href="#cb119-187" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb119-188"><a href="#cb119-188" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb119-189"><a href="#cb119-189" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-190"><a href="#cb119-190" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-191"><a href="#cb119-191" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-192"><a href="#cb119-192" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;!is.na(cutoff) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-193"><a href="#cb119-193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-194"><a href="#cb119-194" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-195"><a href="#cb119-195" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="fu">c</span>(<span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb119-196"><a href="#cb119-196" aria-hidden="true" tabindex="-1"></a>                                                              <span class="st">&quot;simple_avg&quot;</span>),</span>
<span id="cb119-197"><a href="#cb119-197" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-198"><a href="#cb119-198" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-199"><a href="#cb119-199" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-200"><a href="#cb119-200" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-201"><a href="#cb119-201" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(weighting) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-202"><a href="#cb119-202" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-203"><a href="#cb119-203" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-204"><a href="#cb119-204" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="dv">1</span>,</span>
<span id="cb119-205"><a href="#cb119-205" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-206"><a href="#cb119-206" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-207"><a href="#cb119-207" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-208"><a href="#cb119-208" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-209"><a href="#cb119-209" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-210"><a href="#cb119-210" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-211"><a href="#cb119-211" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-212"><a href="#cb119-212" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;spasre&quot;</span>,</span>
<span id="cb119-213"><a href="#cb119-213" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-214"><a href="#cb119-214" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-215"><a href="#cb119-215" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-216"><a href="#cb119-216" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-217"><a href="#cb119-217" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character and one of sparse, simple_avg, or weighted_avg&quot;</span>,</span>
<span id="cb119-218"><a href="#cb119-218" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-219"><a href="#cb119-219" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-220"><a href="#cb119-220" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-221"><a href="#cb119-221" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb119-222"><a href="#cb119-222" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-223"><a href="#cb119-223" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb119-224"><a href="#cb119-224" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-225"><a href="#cb119-225" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-226"><a href="#cb119-226" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(min_num_clusts) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-227"><a href="#cb119-227" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-228"><a href="#cb119-228" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-229"><a href="#cb119-229" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb119-230"><a href="#cb119-230" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-231"><a href="#cb119-231" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="st">&quot;3&quot;</span>,</span>
<span id="cb119-232"><a href="#cb119-232" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-233"><a href="#cb119-233" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-234"><a href="#cb119-234" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(min_num_clusts) | is.integer(min_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb119-235"><a href="#cb119-235" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-236"><a href="#cb119-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-237"><a href="#cb119-237" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-238"><a href="#cb119-238" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb119-239"><a href="#cb119-239" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-240"><a href="#cb119-240" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">0</span>,</span>
<span id="cb119-241"><a href="#cb119-241" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-242"><a href="#cb119-242" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-243"><a href="#cb119-243" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-244"><a href="#cb119-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-245"><a href="#cb119-245" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-246"><a href="#cb119-246" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb119-247"><a href="#cb119-247" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-248"><a href="#cb119-248" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">6</span>,</span>
<span id="cb119-249"><a href="#cb119-249" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb119-250"><a href="#cb119-250" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-251"><a href="#cb119-251" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &lt;= n_clusters is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-252"><a href="#cb119-252" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-253"><a href="#cb119-253" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-254"><a href="#cb119-254" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-255"><a href="#cb119-255" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb119-256"><a href="#cb119-256" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-257"><a href="#cb119-257" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-258"><a href="#cb119-258" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="st">&quot;4&quot;</span>,</span>
<span id="cb119-259"><a href="#cb119-259" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-260"><a href="#cb119-260" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(max_num_clusts) | is.integer(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb119-261"><a href="#cb119-261" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-262"><a href="#cb119-262" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-263"><a href="#cb119-263" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-264"><a href="#cb119-264" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb119-265"><a href="#cb119-265" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-266"><a href="#cb119-266" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-267"><a href="#cb119-267" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="fl">3.5</span>,</span>
<span id="cb119-268"><a href="#cb119-268" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-269"><a href="#cb119-269" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts == round(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb119-270"><a href="#cb119-270" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-271"><a href="#cb119-271" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-272"><a href="#cb119-272" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-273"><a href="#cb119-273" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb119-274"><a href="#cb119-274" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-275"><a href="#cb119-275" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb119-276"><a href="#cb119-276" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb119-277"><a href="#cb119-277" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-278"><a href="#cb119-278" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &gt;= min_num_clusts is not TRUE&quot;</span>,</span>
<span id="cb119-279"><a href="#cb119-279" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-280"><a href="#cb119-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-281"><a href="#cb119-281" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkFormCssDesignInputs</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb119-282"><a href="#cb119-282" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb119-283"><a href="#cb119-283" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb119-284"><a href="#cb119-284" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb119-285"><a href="#cb119-285" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">max_num_clusts=</span><span class="dv">8</span>,</span>
<span id="cb119-286"><a href="#cb119-286" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">newx=</span>x_new),</span>
<span id="cb119-287"><a href="#cb119-287" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-288"><a href="#cb119-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-289"><a href="#cb119-289" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-290"><a href="#cb119-290" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p>Tests for <code>formCssDesign()</code></p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;formCssDesign works&quot;</span>, {</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">17230</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  x_select <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  x_new <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">8</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>  y_select <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>  y_new <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span>)</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;red&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="st">&quot;blue&quot;</span><span class="ot">=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">&quot;green&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>  css_res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(css_res, <span class="at">newx=</span>x_new)</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res), <span class="dv">8</span>)</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res), <span class="fu">length</span>(css_res<span class="sc">$</span>clusters))</span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res) <span class="sc">%in%</span> <span class="fu">names</span>(css_res<span class="sc">$</span>clusters)))</span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">names</span>(css_res<span class="sc">$</span>clusters) <span class="sc">%in%</span> <span class="fu">colnames</span>(res)))</span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add training indices</span></span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a>  css_res_train <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb121-25"><a href="#cb121-25" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B=</span><span class="dv">10</span>, <span class="at">train_inds=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb121-26"><a href="#cb121-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-27"><a href="#cb121-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Training indices should be ignored if new x is provided</span></span>
<span id="cb121-28"><a href="#cb121-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-29"><a href="#cb121-29" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res_train, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb121-30"><a href="#cb121-30" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cutoff=</span><span class="dv">0</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb121-31"><a href="#cb121-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">newx=</span>x_new)</span>
<span id="cb121-32"><a href="#cb121-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-33"><a href="#cb121-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb121-34"><a href="#cb121-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb121-35"><a href="#cb121-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res), <span class="dv">8</span>)</span>
<span id="cb121-36"><a href="#cb121-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res), <span class="fu">length</span>(css_res_train<span class="sc">$</span>clusters))</span>
<span id="cb121-37"><a href="#cb121-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res) <span class="sc">%in%</span> <span class="fu">names</span>(css_res_train<span class="sc">$</span>clusters)))</span>
<span id="cb121-38"><a href="#cb121-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">names</span>(css_res_train<span class="sc">$</span>clusters) <span class="sc">%in%</span> <span class="fu">colnames</span>(res)))</span>
<span id="cb121-39"><a href="#cb121-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-40"><a href="#cb121-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Things should still work if new x is not provided</span></span>
<span id="cb121-41"><a href="#cb121-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-42"><a href="#cb121-42" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res_train, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb121-43"><a href="#cb121-43" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cutoff=</span><span class="dv">0</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>)</span>
<span id="cb121-44"><a href="#cb121-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-45"><a href="#cb121-45" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb121-46"><a href="#cb121-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb121-47"><a href="#cb121-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res), <span class="dv">5</span>)</span>
<span id="cb121-48"><a href="#cb121-48" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res), <span class="fu">length</span>(css_res_train<span class="sc">$</span>clusters))</span>
<span id="cb121-49"><a href="#cb121-49" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res) <span class="sc">%in%</span> <span class="fu">names</span>(css_res_train<span class="sc">$</span>clusters)))</span>
<span id="cb121-50"><a href="#cb121-50" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">names</span>(css_res_train<span class="sc">$</span>clusters) <span class="sc">%in%</span> <span class="fu">colnames</span>(res)))</span>
<span id="cb121-51"><a href="#cb121-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-52"><a href="#cb121-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try not providing training indices and omitting newx--should get error</span></span>
<span id="cb121-53"><a href="#cb121-53" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb121-54"><a href="#cb121-54" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">cutoff=</span><span class="fl">0.5</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb121-55"><a href="#cb121-55" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">max_num_clusts=</span><span class="dv">5</span>, <span class="at">newx=</span><span class="cn">NA</span>),</span>
<span id="cb121-56"><a href="#cb121-56" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;If css was not provided with indices to set aside for model training, then newx must be provided to formCssDesign&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-57"><a href="#cb121-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-58"><a href="#cb121-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try naming variables</span></span>
<span id="cb121-59"><a href="#cb121-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-60"><a href="#cb121-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_select) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb121-61"><a href="#cb121-61" aria-hidden="true" tabindex="-1"></a>  css_res_named <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb121-62"><a href="#cb121-62" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb121-63"><a href="#cb121-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-64"><a href="#cb121-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Named variables for css matrix but not new one--should get a warning</span></span>
<span id="cb121-65"><a href="#cb121-65" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res_named,</span>
<span id="cb121-66"><a href="#cb121-66" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.9</span>,</span>
<span id="cb121-67"><a href="#cb121-67" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">3</span>,</span>
<span id="cb121-68"><a href="#cb121-68" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">newx=</span>x_new),</span>
<span id="cb121-69"><a href="#cb121-69" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;New X provided had no variable names (column names) even though the X provided to css did.&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-70"><a href="#cb121-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-71"><a href="#cb121-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try mismatching variable names</span></span>
<span id="cb121-72"><a href="#cb121-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> LETTERS[<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>]</span>
<span id="cb121-73"><a href="#cb121-73" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res_named,</span>
<span id="cb121-74"><a href="#cb121-74" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb121-75"><a href="#cb121-75" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb121-76"><a href="#cb121-76" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-77"><a href="#cb121-77" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;identical(feat_names, colnames(css_X)) is not TRUE&quot;</span>,</span>
<span id="cb121-78"><a href="#cb121-78" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-79"><a href="#cb121-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-80"><a href="#cb121-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb121-81"><a href="#cb121-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-82"><a href="#cb121-82" aria-hidden="true" tabindex="-1"></a>  res_named <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res_named,</span>
<span id="cb121-83"><a href="#cb121-83" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.5</span>,</span>
<span id="cb121-84"><a href="#cb121-84" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">min_num_clusts=</span><span class="dv">2</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb121-85"><a href="#cb121-85" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">newx=</span>x_new)</span>
<span id="cb121-86"><a href="#cb121-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-87"><a href="#cb121-87" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_named))</span>
<span id="cb121-88"><a href="#cb121-88" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_named))</span>
<span id="cb121-89"><a href="#cb121-89" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_named), <span class="dv">8</span>)</span>
<span id="cb121-90"><a href="#cb121-90" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(res_named) <span class="sc">&lt;=</span> <span class="fu">length</span>(css_res_named<span class="sc">$</span>clusters))</span>
<span id="cb121-91"><a href="#cb121-91" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res_named) <span class="sc">%in%</span> <span class="fu">names</span>(css_res_named<span class="sc">$</span>clusters)))</span>
<span id="cb121-92"><a href="#cb121-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-93"><a href="#cb121-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try data.frame input to css and formCssDesign</span></span>
<span id="cb121-94"><a href="#cb121-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-95"><a href="#cb121-95" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb121-96"><a href="#cb121-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-97"><a href="#cb121-97" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_df)</span>
<span id="cb121-98"><a href="#cb121-98" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(n)</span>
<span id="cb121-99"><a href="#cb121-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-100"><a href="#cb121-100" aria-hidden="true" tabindex="-1"></a>  selec_inds <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">round</span>(n<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb121-101"><a href="#cb121-101" aria-hidden="true" tabindex="-1"></a>  fit_inds <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, selec_inds)</span>
<span id="cb121-102"><a href="#cb121-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-103"><a href="#cb121-103" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb121-104"><a href="#cb121-104" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res_df, <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>,</span>
<span id="cb121-105"><a href="#cb121-105" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cutoff=</span><span class="fl">0.7</span>, <span class="at">min_num_clusts=</span><span class="dv">3</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb121-106"><a href="#cb121-106" aria-hidden="true" tabindex="-1"></a>                          <span class="at">newx=</span>X_df[fit_inds, ])</span>
<span id="cb121-107"><a href="#cb121-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-108"><a href="#cb121-108" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df))</span>
<span id="cb121-109"><a href="#cb121-109" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df))</span>
<span id="cb121-110"><a href="#cb121-110" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df), <span class="fu">length</span>(fit_inds))</span>
<span id="cb121-111"><a href="#cb121-111" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(res_df) <span class="sc">&lt;=</span> <span class="fu">length</span>(css_res_df<span class="sc">$</span>clusters))</span>
<span id="cb121-112"><a href="#cb121-112" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res_df) <span class="sc">%in%</span> <span class="fu">names</span>(css_res_df<span class="sc">$</span>clusters)))</span>
<span id="cb121-113"><a href="#cb121-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-114"><a href="#cb121-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try again with X as a dataframe with factors (number of columns of final</span></span>
<span id="cb121-115"><a href="#cb121-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># design matrix after one-hot encoding factors won&#39;t match number of columns</span></span>
<span id="cb121-116"><a href="#cb121-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># of X_df)</span></span>
<span id="cb121-117"><a href="#cb121-117" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>cyl)</span>
<span id="cb121-118"><a href="#cb121-118" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>vs)</span>
<span id="cb121-119"><a href="#cb121-119" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>am)</span>
<span id="cb121-120"><a href="#cb121-120" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>gear)</span>
<span id="cb121-121"><a href="#cb121-121" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>carb)</span>
<span id="cb121-122"><a href="#cb121-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-123"><a href="#cb121-123" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb121-124"><a href="#cb121-124" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res_df, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb121-125"><a href="#cb121-125" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cutoff=</span><span class="fl">0.3</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">4</span>,</span>
<span id="cb121-126"><a href="#cb121-126" aria-hidden="true" tabindex="-1"></a>                          <span class="at">newx=</span>X_df[fit_inds, ])</span>
<span id="cb121-127"><a href="#cb121-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-128"><a href="#cb121-128" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df))</span>
<span id="cb121-129"><a href="#cb121-129" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df))</span>
<span id="cb121-130"><a href="#cb121-130" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df), <span class="fu">length</span>(fit_inds))</span>
<span id="cb121-131"><a href="#cb121-131" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(res_df) <span class="sc">&lt;=</span> <span class="fu">length</span>(css_res_df<span class="sc">$</span>clusters))</span>
<span id="cb121-132"><a href="#cb121-132" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res_df) <span class="sc">%in%</span> <span class="fu">names</span>(css_res_df<span class="sc">$</span>clusters)))</span>
<span id="cb121-133"><a href="#cb121-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-134"><a href="#cb121-134" aria-hidden="true" tabindex="-1"></a>  <span class="do">##### Try other bad inputs</span></span>
<span id="cb121-135"><a href="#cb121-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-136"><a href="#cb121-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb121-137"><a href="#cb121-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-138"><a href="#cb121-138" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">cutoff=</span><span class="sc">-</span><span class="fl">0.3</span>,</span>
<span id="cb121-139"><a href="#cb121-139" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new), <span class="st">&quot;cutoff &gt;= 0 is not TRUE&quot;</span>,</span>
<span id="cb121-140"><a href="#cb121-140" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-141"><a href="#cb121-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-142"><a href="#cb121-142" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">cutoff=</span><span class="st">&quot;0.5&quot;</span>,</span>
<span id="cb121-143"><a href="#cb121-143" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-144"><a href="#cb121-144" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(cutoff) | is.integer(cutoff) is not TRUE&quot;</span>,</span>
<span id="cb121-145"><a href="#cb121-145" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-146"><a href="#cb121-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-147"><a href="#cb121-147" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb121-148"><a href="#cb121-148" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">cutoff=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">newx=</span>x_new),</span>
<span id="cb121-149"><a href="#cb121-149" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;!is.na(cutoff) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-150"><a href="#cb121-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-151"><a href="#cb121-151" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb121-152"><a href="#cb121-152" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">weighting=</span><span class="fu">c</span>(<span class="st">&quot;sparse&quot;</span>, <span class="st">&quot;simple_avg&quot;</span>),</span>
<span id="cb121-153"><a href="#cb121-153" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-154"><a href="#cb121-154" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(weighting) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-155"><a href="#cb121-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-156"><a href="#cb121-156" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">weighting=</span><span class="dv">1</span>,</span>
<span id="cb121-157"><a href="#cb121-157" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-158"><a href="#cb121-158" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-159"><a href="#cb121-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-160"><a href="#cb121-160" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">weighting=</span><span class="st">&quot;spasre&quot;</span>,</span>
<span id="cb121-161"><a href="#cb121-161" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-162"><a href="#cb121-162" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character and one of sparse, simple_avg, or weighted_avg&quot;</span>,</span>
<span id="cb121-163"><a href="#cb121-163" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-164"><a href="#cb121-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-165"><a href="#cb121-165" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb121-166"><a href="#cb121-166" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">min_num_clusts=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">newx=</span>x_new),</span>
<span id="cb121-167"><a href="#cb121-167" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(min_num_clusts) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-168"><a href="#cb121-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-169"><a href="#cb121-169" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">min_num_clusts=</span><span class="st">&quot;3&quot;</span>,</span>
<span id="cb121-170"><a href="#cb121-170" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-171"><a href="#cb121-171" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(min_num_clusts) | is.integer(min_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb121-172"><a href="#cb121-172" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-173"><a href="#cb121-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-174"><a href="#cb121-174" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">min_num_clusts=</span><span class="dv">0</span>,</span>
<span id="cb121-175"><a href="#cb121-175" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-176"><a href="#cb121-176" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-177"><a href="#cb121-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-178"><a href="#cb121-178" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">min_num_clusts=</span><span class="dv">6</span>,</span>
<span id="cb121-179"><a href="#cb121-179" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-180"><a href="#cb121-180" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &lt;= n_clusters is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-181"><a href="#cb121-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-182"><a href="#cb121-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-183"><a href="#cb121-183" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">max_num_clusts=</span><span class="st">&quot;4&quot;</span>,</span>
<span id="cb121-184"><a href="#cb121-184" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-185"><a href="#cb121-185" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(max_num_clusts) | is.integer(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb121-186"><a href="#cb121-186" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-187"><a href="#cb121-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-188"><a href="#cb121-188" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">max_num_clusts=</span><span class="fl">3.5</span>,</span>
<span id="cb121-189"><a href="#cb121-189" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-190"><a href="#cb121-190" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts == round(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb121-191"><a href="#cb121-191" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-192"><a href="#cb121-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-193"><a href="#cb121-193" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb121-194"><a href="#cb121-194" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">max_num_clusts=</span><span class="dv">1</span>, <span class="at">newx=</span>x_new),</span>
<span id="cb121-195"><a href="#cb121-195" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &gt;= min_num_clusts is not TRUE&quot;</span>,</span>
<span id="cb121-196"><a href="#cb121-196" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-197"><a href="#cb121-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-198"><a href="#cb121-198" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">formCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">max_num_clusts=</span><span class="dv">8</span>,</span>
<span id="cb121-199"><a href="#cb121-199" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newx=</span>x_new),</span>
<span id="cb121-200"><a href="#cb121-200" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb121-201"><a href="#cb121-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-202"><a href="#cb121-202" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-203"><a href="#cb121-203" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p>Finally, tests for <code>getCssDesign()</code></p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getCssDesign works&quot;</span>, {</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">23170</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>  x_select <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  x_new <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">8</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  y_select <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>  y_new <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span>)</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;red&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="st">&quot;blue&quot;</span><span class="ot">=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">&quot;green&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>  css_res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getCssDesign</span>(css_res, <span class="at">newX=</span>x_new)</span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res), <span class="dv">8</span>)</span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res), <span class="fu">length</span>(css_res<span class="sc">$</span>clusters))</span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res) <span class="sc">%in%</span> <span class="fu">names</span>(css_res<span class="sc">$</span>clusters)))</span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">names</span>(css_res<span class="sc">$</span>clusters) <span class="sc">%in%</span> <span class="fu">colnames</span>(res)))</span>
<span id="cb123-22"><a href="#cb123-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-23"><a href="#cb123-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add training indices</span></span>
<span id="cb123-24"><a href="#cb123-24" aria-hidden="true" tabindex="-1"></a>  css_res_train <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb123-25"><a href="#cb123-25" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B=</span><span class="dv">10</span>, <span class="at">train_inds=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb123-26"><a href="#cb123-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-27"><a href="#cb123-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Training indices should be ignored if new x is provided</span></span>
<span id="cb123-28"><a href="#cb123-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-29"><a href="#cb123-29" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res_train, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb123-30"><a href="#cb123-30" aria-hidden="true" tabindex="-1"></a>                      <span class="at">min_num_clusts=</span><span class="dv">2</span>, <span class="at">newX=</span>x_new)</span>
<span id="cb123-31"><a href="#cb123-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-32"><a href="#cb123-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb123-33"><a href="#cb123-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb123-34"><a href="#cb123-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res), <span class="dv">8</span>)</span>
<span id="cb123-35"><a href="#cb123-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res), <span class="fu">length</span>(css_res_train<span class="sc">$</span>clusters))</span>
<span id="cb123-36"><a href="#cb123-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res) <span class="sc">%in%</span> <span class="fu">names</span>(css_res_train<span class="sc">$</span>clusters)))</span>
<span id="cb123-37"><a href="#cb123-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">names</span>(css_res_train<span class="sc">$</span>clusters) <span class="sc">%in%</span> <span class="fu">colnames</span>(res)))</span>
<span id="cb123-38"><a href="#cb123-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-39"><a href="#cb123-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Things should still work if new x is not provided</span></span>
<span id="cb123-40"><a href="#cb123-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-41"><a href="#cb123-41" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res_train, <span class="at">min_num_clusts=</span><span class="dv">2</span>)</span>
<span id="cb123-42"><a href="#cb123-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-43"><a href="#cb123-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb123-44"><a href="#cb123-44" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb123-45"><a href="#cb123-45" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res), <span class="dv">5</span>)</span>
<span id="cb123-46"><a href="#cb123-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res), <span class="fu">length</span>(css_res_train<span class="sc">$</span>clusters))</span>
<span id="cb123-47"><a href="#cb123-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res) <span class="sc">%in%</span> <span class="fu">names</span>(css_res_train<span class="sc">$</span>clusters)))</span>
<span id="cb123-48"><a href="#cb123-48" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">names</span>(css_res_train<span class="sc">$</span>clusters) <span class="sc">%in%</span> <span class="fu">colnames</span>(res)))</span>
<span id="cb123-49"><a href="#cb123-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-50"><a href="#cb123-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try not providing training indices and omitting newX--should get error</span></span>
<span id="cb123-51"><a href="#cb123-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb123-52"><a href="#cb123-52" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">cutoff=</span><span class="fl">0.5</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb123-53"><a href="#cb123-53" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">max_num_clusts=</span><span class="dv">5</span>, <span class="at">newX=</span><span class="cn">NA</span>),</span>
<span id="cb123-54"><a href="#cb123-54" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;css was not provided with indices to set aside for model training (train_inds), so must provide new X in order to generate a design matrix&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-55"><a href="#cb123-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-56"><a href="#cb123-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try naming variables</span></span>
<span id="cb123-57"><a href="#cb123-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-58"><a href="#cb123-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_select) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb123-59"><a href="#cb123-59" aria-hidden="true" tabindex="-1"></a>  css_res_named <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb123-60"><a href="#cb123-60" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb123-61"><a href="#cb123-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-62"><a href="#cb123-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Named variables for css matrix but not new one--should get a warning</span></span>
<span id="cb123-63"><a href="#cb123-63" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res_named,</span>
<span id="cb123-64"><a href="#cb123-64" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.9</span>,</span>
<span id="cb123-65"><a href="#cb123-65" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">3</span>,</span>
<span id="cb123-66"><a href="#cb123-66" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">newX=</span>x_new),</span>
<span id="cb123-67"><a href="#cb123-67" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;New X provided had no variable names (column names) even though the X provided to css did.&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-68"><a href="#cb123-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-69"><a href="#cb123-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try mismatching variable names</span></span>
<span id="cb123-70"><a href="#cb123-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> LETTERS[<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>]</span>
<span id="cb123-71"><a href="#cb123-71" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res_named,</span>
<span id="cb123-72"><a href="#cb123-72" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.2</span>,</span>
<span id="cb123-73"><a href="#cb123-73" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb123-74"><a href="#cb123-74" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">newX=</span>x_new),</span>
<span id="cb123-75"><a href="#cb123-75" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;identical(feat_names, colnames(css_X)) is not TRUE&quot;</span>,</span>
<span id="cb123-76"><a href="#cb123-76" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-77"><a href="#cb123-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-78"><a href="#cb123-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb123-79"><a href="#cb123-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-80"><a href="#cb123-80" aria-hidden="true" tabindex="-1"></a>  res_named <span class="ot">&lt;-</span> <span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res_named, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb123-81"><a href="#cb123-81" aria-hidden="true" tabindex="-1"></a>                            <span class="at">cutoff=</span><span class="fl">0.5</span>, <span class="at">min_num_clusts=</span><span class="dv">2</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb123-82"><a href="#cb123-82" aria-hidden="true" tabindex="-1"></a>                            <span class="at">newX=</span>x_new)</span>
<span id="cb123-83"><a href="#cb123-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-84"><a href="#cb123-84" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_named))</span>
<span id="cb123-85"><a href="#cb123-85" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_named))</span>
<span id="cb123-86"><a href="#cb123-86" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_named), <span class="dv">8</span>)</span>
<span id="cb123-87"><a href="#cb123-87" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(res_named) <span class="sc">&lt;=</span> <span class="fu">length</span>(css_res_named<span class="sc">$</span>clusters))</span>
<span id="cb123-88"><a href="#cb123-88" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res_named) <span class="sc">%in%</span> <span class="fu">names</span>(css_res_named<span class="sc">$</span>clusters)))</span>
<span id="cb123-89"><a href="#cb123-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-90"><a href="#cb123-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try data.frame input to css and getCssDesign</span></span>
<span id="cb123-91"><a href="#cb123-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-92"><a href="#cb123-92" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb123-93"><a href="#cb123-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-94"><a href="#cb123-94" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_df)</span>
<span id="cb123-95"><a href="#cb123-95" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(n)</span>
<span id="cb123-96"><a href="#cb123-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-97"><a href="#cb123-97" aria-hidden="true" tabindex="-1"></a>  selec_inds <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">round</span>(n<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb123-98"><a href="#cb123-98" aria-hidden="true" tabindex="-1"></a>  fit_inds <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, selec_inds)</span>
<span id="cb123-99"><a href="#cb123-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-100"><a href="#cb123-100" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb123-101"><a href="#cb123-101" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res_df, <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>,</span>
<span id="cb123-102"><a href="#cb123-102" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cutoff=</span><span class="fl">0.7</span>, <span class="at">min_num_clusts=</span><span class="dv">3</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb123-103"><a href="#cb123-103" aria-hidden="true" tabindex="-1"></a>                          <span class="at">newX=</span>X_df[fit_inds, ])</span>
<span id="cb123-104"><a href="#cb123-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-105"><a href="#cb123-105" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df))</span>
<span id="cb123-106"><a href="#cb123-106" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df))</span>
<span id="cb123-107"><a href="#cb123-107" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df), <span class="fu">length</span>(fit_inds))</span>
<span id="cb123-108"><a href="#cb123-108" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(res_df) <span class="sc">&lt;=</span> <span class="fu">length</span>(css_res_df<span class="sc">$</span>clusters))</span>
<span id="cb123-109"><a href="#cb123-109" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res_df) <span class="sc">%in%</span> <span class="fu">names</span>(css_res_df<span class="sc">$</span>clusters)))</span>
<span id="cb123-110"><a href="#cb123-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-111"><a href="#cb123-111" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try again with X as a dataframe with factors (number of columns of final</span></span>
<span id="cb123-112"><a href="#cb123-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># design matrix after one-hot encoding factors won&#39;t match number of columns</span></span>
<span id="cb123-113"><a href="#cb123-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># of X_df)</span></span>
<span id="cb123-114"><a href="#cb123-114" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>cyl)</span>
<span id="cb123-115"><a href="#cb123-115" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>vs)</span>
<span id="cb123-116"><a href="#cb123-116" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>am)</span>
<span id="cb123-117"><a href="#cb123-117" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>gear)</span>
<span id="cb123-118"><a href="#cb123-118" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>carb)</span>
<span id="cb123-119"><a href="#cb123-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-120"><a href="#cb123-120" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb123-121"><a href="#cb123-121" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res_df, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb123-122"><a href="#cb123-122" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cutoff=</span><span class="fl">0.3</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">4</span>,</span>
<span id="cb123-123"><a href="#cb123-123" aria-hidden="true" tabindex="-1"></a>                         <span class="at">newX=</span>X_df[fit_inds, ])</span>
<span id="cb123-124"><a href="#cb123-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-125"><a href="#cb123-125" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df))</span>
<span id="cb123-126"><a href="#cb123-126" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df))</span>
<span id="cb123-127"><a href="#cb123-127" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df), <span class="fu">length</span>(fit_inds))</span>
<span id="cb123-128"><a href="#cb123-128" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(res_df) <span class="sc">&lt;=</span> <span class="fu">length</span>(css_res_df<span class="sc">$</span>clusters))</span>
<span id="cb123-129"><a href="#cb123-129" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(res_df) <span class="sc">%in%</span> <span class="fu">names</span>(css_res_df<span class="sc">$</span>clusters)))</span>
<span id="cb123-130"><a href="#cb123-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-131"><a href="#cb123-131" aria-hidden="true" tabindex="-1"></a>  <span class="do">##### Try other bad inputs</span></span>
<span id="cb123-132"><a href="#cb123-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-133"><a href="#cb123-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_new) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb123-134"><a href="#cb123-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-135"><a href="#cb123-135" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">cutoff=</span><span class="sc">-</span><span class="fl">0.3</span>,</span>
<span id="cb123-136"><a href="#cb123-136" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new), <span class="st">&quot;cutoff &gt;= 0 is not TRUE&quot;</span>,</span>
<span id="cb123-137"><a href="#cb123-137" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-138"><a href="#cb123-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-139"><a href="#cb123-139" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">cutoff=</span><span class="st">&quot;0.5&quot;</span>,</span>
<span id="cb123-140"><a href="#cb123-140" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new),</span>
<span id="cb123-141"><a href="#cb123-141" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(cutoff) | is.integer(cutoff) is not TRUE&quot;</span>,</span>
<span id="cb123-142"><a href="#cb123-142" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-143"><a href="#cb123-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-144"><a href="#cb123-144" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb123-145"><a href="#cb123-145" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">cutoff=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">newX=</span>x_new),</span>
<span id="cb123-146"><a href="#cb123-146" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;!is.na(cutoff) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-147"><a href="#cb123-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-148"><a href="#cb123-148" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb123-149"><a href="#cb123-149" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">weighting=</span><span class="fu">c</span>(<span class="st">&quot;sparse&quot;</span>, <span class="st">&quot;simple_avg&quot;</span>),</span>
<span id="cb123-150"><a href="#cb123-150" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new),</span>
<span id="cb123-151"><a href="#cb123-151" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(weighting) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-152"><a href="#cb123-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-153"><a href="#cb123-153" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">weighting=</span><span class="dv">1</span>,</span>
<span id="cb123-154"><a href="#cb123-154" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new),</span>
<span id="cb123-155"><a href="#cb123-155" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-156"><a href="#cb123-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-157"><a href="#cb123-157" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">weighting=</span><span class="st">&quot;spasre&quot;</span>,</span>
<span id="cb123-158"><a href="#cb123-158" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new),</span>
<span id="cb123-159"><a href="#cb123-159" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character and one of sparse, simple_avg, or weighted_avg&quot;</span>,</span>
<span id="cb123-160"><a href="#cb123-160" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-161"><a href="#cb123-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-162"><a href="#cb123-162" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res,</span>
<span id="cb123-163"><a href="#cb123-163" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">min_num_clusts=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">newX=</span>x_new),</span>
<span id="cb123-164"><a href="#cb123-164" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(min_num_clusts) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-165"><a href="#cb123-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-166"><a href="#cb123-166" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">min_num_clusts=</span><span class="st">&quot;3&quot;</span>,</span>
<span id="cb123-167"><a href="#cb123-167" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new),</span>
<span id="cb123-168"><a href="#cb123-168" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(min_num_clusts) | is.integer(min_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb123-169"><a href="#cb123-169" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-170"><a href="#cb123-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-171"><a href="#cb123-171" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">min_num_clusts=</span><span class="dv">0</span>,</span>
<span id="cb123-172"><a href="#cb123-172" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new),</span>
<span id="cb123-173"><a href="#cb123-173" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-174"><a href="#cb123-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-175"><a href="#cb123-175" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">min_num_clusts=</span><span class="dv">6</span>,</span>
<span id="cb123-176"><a href="#cb123-176" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new),</span>
<span id="cb123-177"><a href="#cb123-177" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &lt;= n_clusters is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-178"><a href="#cb123-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-179"><a href="#cb123-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-180"><a href="#cb123-180" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">max_num_clusts=</span><span class="st">&quot;4&quot;</span>,</span>
<span id="cb123-181"><a href="#cb123-181" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new),</span>
<span id="cb123-182"><a href="#cb123-182" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(max_num_clusts) | is.integer(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb123-183"><a href="#cb123-183" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-184"><a href="#cb123-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-185"><a href="#cb123-185" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">max_num_clusts=</span><span class="fl">3.5</span>,</span>
<span id="cb123-186"><a href="#cb123-186" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new),</span>
<span id="cb123-187"><a href="#cb123-187" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts == round(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb123-188"><a href="#cb123-188" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-189"><a href="#cb123-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-190"><a href="#cb123-190" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">min_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb123-191"><a href="#cb123-191" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">max_num_clusts=</span><span class="dv">1</span>, <span class="at">newX=</span>x_new),</span>
<span id="cb123-192"><a href="#cb123-192" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &gt;= min_num_clusts is not TRUE&quot;</span>,</span>
<span id="cb123-193"><a href="#cb123-193" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-194"><a href="#cb123-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-195"><a href="#cb123-195" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssDesign</span>(<span class="at">css_results=</span>css_res, <span class="at">max_num_clusts=</span><span class="dv">8</span>,</span>
<span id="cb123-196"><a href="#cb123-196" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newX=</span>x_new),</span>
<span id="cb123-197"><a href="#cb123-197" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb123-198"><a href="#cb123-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-199"><a href="#cb123-199" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-200"><a href="#cb123-200" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## ── Warning (&#39;&lt;text&gt;:63&#39;): getCssDesign works ───────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. testthat::expect_warning(...)
##  7. litr (local) getCssDesign(...)
##  8. litr (local) checkXInputResults(newX, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:63&#39;): getCssDesign works ───────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##   1. testthat::expect_warning(...)
##   7. litr (local) getCssDesign(...)
##   8. litr (local) formCssDesign(...)
##   9. litr (local) checkFormCssDesignInputs(...)
##  10. litr (local) checkXInputResults(newx, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:80&#39;): getCssDesign works ───────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. litr (local) getCssDesign(...)
##  2. litr (local) checkXInputResults(newX, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:80&#39;): getCssDesign works ───────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. litr (local) getCssDesign(...)
##  2. litr (local) formCssDesign(...)
##  3. litr (local) checkFormCssDesignInputs(...)
##  4. litr (local) checkXInputResults(newx, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:101&#39;): getCssDesign works ──────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. litr (local) getCssDesign(...)
##  2. litr (local) checkXInputResults(newX, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:101&#39;): getCssDesign works ──────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. litr (local) getCssDesign(...)
##  2. litr (local) formCssDesign(...)
##  3. litr (local) checkFormCssDesignInputs(...)
##  4. litr (local) checkXInputResults(newx, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:121&#39;): getCssDesign works ──────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. litr (local) getCssDesign(...)
##  2. litr (local) checkXInputResults(newX, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:121&#39;): getCssDesign works ──────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. litr (local) getCssDesign(...)
##  2. litr (local) formCssDesign(...)
##  3. litr (local) checkFormCssDesignInputs(...)
##  4. litr (local) checkXInputResults(newx, css_results$X)</code></pre>
<p><code>getCssPreds()</code></p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Fit model and generate predictions from new data</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generate predictions on test data using cluster stability-selected model.</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param testX A numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the data that will be used to generate predictions. Must contain the same</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features (in the same number of columns) as the matrix provided to css, and</span></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; if the columns of testX are labeled, the names must match the variable names</span></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided to css.</span></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weighting Character; determines how to calculate the weights to</span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; combine features from the selected clusters into weighted averages, called</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster representatives. Must be one of &quot;sparse&quot;, &quot;weighted_avg&quot;, or</span></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&#39;. For &quot;sparse&quot;, all the weight is put on the most frequently</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected individual cluster member (or divided equally among all the clusters</span></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; that are tied for the top selection proportion if there is a tie). For</span></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;weighted_avg&quot;, the weight used for each cluster member is calculated in</span></span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; proportion to the individual selection proportions of each feature. For</span></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&quot;, each cluster member gets equal weight regardless of the</span></span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual feature selection proportions (that is, the cluster representative</span></span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; is just a simple average of all the cluster members). See Faletto and Bien</span></span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (2022) for details. Default is &quot;weighted_avg&quot;.</span></span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; getCssPreds will make use only of those clusters with</span></span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection proportions equal to at least cutoff. Must be between 0 and 1.</span></span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Default is 0 (in which case either all clusters are used, or max_num_clusts</span></span>
<span id="cb125-27"><a href="#cb125-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; are used, if max_num_clusts is specified).</span></span>
<span id="cb125-28"><a href="#cb125-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb125-29"><a href="#cb125-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb125-30"><a href="#cb125-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb125-31"><a href="#cb125-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.) Default is 1.</span></span>
<span id="cb125-32"><a href="#cb125-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb125-33"><a href="#cb125-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb125-34"><a href="#cb125-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb125-35"><a href="#cb125-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) Default is NA (in which case</span></span>
<span id="cb125-36"><a href="#cb125-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts is ignored).</span></span>
<span id="cb125-37"><a href="#cb125-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param trainX A numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb125-38"><a href="#cb125-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb125-39"><a href="#cb125-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the data that will be used to estimate the linear model from the selected</span></span>
<span id="cb125-40"><a href="#cb125-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters. trainX is only necessary to provide if no train_inds were</span></span>
<span id="cb125-41"><a href="#cb125-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; designated in the css function call to set aside observations for model</span></span>
<span id="cb125-42"><a href="#cb125-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; estimation (though even if train_inds was provided, trainX and trianY will be</span></span>
<span id="cb125-43"><a href="#cb125-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; used for model estimation if they are both provided to getCssPreds). Must </span></span>
<span id="cb125-44"><a href="#cb125-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; contain the same features (in the same number of columns) as the matrix </span></span>
<span id="cb125-45"><a href="#cb125-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided to css, and if the columns of trainX are labeled, the names must</span></span>
<span id="cb125-46"><a href="#cb125-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; match the variable names provided to css. Default is NA (in which case</span></span>
<span id="cb125-47"><a href="#cb125-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; getCssPreds uses the observations from the train_inds that were provided to</span></span>
<span id="cb125-48"><a href="#cb125-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css to estimate a linear model).</span></span>
<span id="cb125-49"><a href="#cb125-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param trainY The response corresponding to trainX. Must be a real-valued</span></span>
<span id="cb125-50"><a href="#cb125-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response (unlike in the general css setup) because predictions will be</span></span>
<span id="cb125-51"><a href="#cb125-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generated by an ordinary least squares model. Must have the same length as</span></span>
<span id="cb125-52"><a href="#cb125-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the number of rows of trainX. Like trainX, only needs to be provided if no</span></span>
<span id="cb125-53"><a href="#cb125-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; observations were set aside for model estimation by the parameter train_inds</span></span>
<span id="cb125-54"><a href="#cb125-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in the css function call. Default is NA (in which case getCssPreds uses the</span></span>
<span id="cb125-55"><a href="#cb125-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; observations from the train_inds that were provided to css).</span></span>
<span id="cb125-56"><a href="#cb125-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A vector of predictions corresponding to the observations from testX.</span></span>
<span id="cb125-57"><a href="#cb125-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb125-58"><a href="#cb125-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references </span></span>
<span id="cb125-59"><a href="#cb125-59" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>faletto2022<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb125-60"><a href="#cb125-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb125-61"><a href="#cb125-61" aria-hidden="true" tabindex="-1"></a>getCssPreds <span class="ot">&lt;-</span> <span class="cf">function</span>(css_results, testX, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb125-62"><a href="#cb125-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">trainX=</span><span class="cn">NA</span>, <span class="at">trainY=</span><span class="cn">NA</span>){</span>
<span id="cb125-63"><a href="#cb125-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">(gregfaletto) Consider adding an argument for a user-provided prediction</span></span>
<span id="cb125-64"><a href="#cb125-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># function in order to allow for more general kinds of predictions than</span></span>
<span id="cb125-65"><a href="#cb125-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># OLS.</span></span>
<span id="cb125-66"><a href="#cb125-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-67"><a href="#cb125-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb125-68"><a href="#cb125-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-69"><a href="#cb125-69" aria-hidden="true" tabindex="-1"></a>    check_list <span class="ot">&lt;-</span> <span class="fu">checkGetCssPredsInputs</span>(css_results, testX, weighting, cutoff,</span>
<span id="cb125-70"><a href="#cb125-70" aria-hidden="true" tabindex="-1"></a>        min_num_clusts, max_num_clusts, trainX, trainY)</span>
<span id="cb125-71"><a href="#cb125-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-72"><a href="#cb125-72" aria-hidden="true" tabindex="-1"></a>    trainXProvided <span class="ot">&lt;-</span> check_list<span class="sc">$</span>trainXProvided</span>
<span id="cb125-73"><a href="#cb125-73" aria-hidden="true" tabindex="-1"></a>    trainX <span class="ot">&lt;-</span> check_list<span class="sc">$</span>trainX</span>
<span id="cb125-74"><a href="#cb125-74" aria-hidden="true" tabindex="-1"></a>    testX <span class="ot">&lt;-</span> check_list<span class="sc">$</span>testX</span>
<span id="cb125-75"><a href="#cb125-75" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="ot">&lt;-</span> check_list<span class="sc">$</span>feat_names</span>
<span id="cb125-76"><a href="#cb125-76" aria-hidden="true" tabindex="-1"></a>    max_num_clusts <span class="ot">&lt;-</span> check_list<span class="sc">$</span>max_num_clusts</span>
<span id="cb125-77"><a href="#cb125-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-78"><a href="#cb125-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(check_list)</span>
<span id="cb125-79"><a href="#cb125-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-80"><a href="#cb125-80" aria-hidden="true" tabindex="-1"></a>    n_train <span class="ot">&lt;-</span> <span class="fu">nrow</span>(trainX)</span>
<span id="cb125-81"><a href="#cb125-81" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(testX)</span>
<span id="cb125-82"><a href="#cb125-82" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(testX)</span>
<span id="cb125-83"><a href="#cb125-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-84"><a href="#cb125-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Take provided training design matrix and testX and turn them into</span></span>
<span id="cb125-85"><a href="#cb125-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># matrices of cluster representatives using information from css_results</span></span>
<span id="cb125-86"><a href="#cb125-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(trainXProvided){</span>
<span id="cb125-87"><a href="#cb125-87" aria-hidden="true" tabindex="-1"></a>        train_X_clusters <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(css_results, weighting, cutoff,</span>
<span id="cb125-88"><a href="#cb125-88" aria-hidden="true" tabindex="-1"></a>            min_num_clusts, max_num_clusts, <span class="at">newx=</span>trainX)</span>
<span id="cb125-89"><a href="#cb125-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.numeric</span>(trainY) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.integer</span>(trainY)){</span>
<span id="cb125-90"><a href="#cb125-90" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stop</span>(<span class="st">&quot;The provided trainY must be real-valued, because predictions will be generated by ordinary least squares regression.&quot;</span>)</span>
<span id="cb125-91"><a href="#cb125-91" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb125-92"><a href="#cb125-92" aria-hidden="true" tabindex="-1"></a>        y_train <span class="ot">&lt;-</span> trainY</span>
<span id="cb125-93"><a href="#cb125-93" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb125-94"><a href="#cb125-94" aria-hidden="true" tabindex="-1"></a>        train_X_clusters <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(css_results, weighting, cutoff,</span>
<span id="cb125-95"><a href="#cb125-95" aria-hidden="true" tabindex="-1"></a>            min_num_clusts, max_num_clusts)</span>
<span id="cb125-96"><a href="#cb125-96" aria-hidden="true" tabindex="-1"></a>        y_train <span class="ot">&lt;-</span> css_results<span class="sc">$</span>y[css_results<span class="sc">$</span>train_inds]</span>
<span id="cb125-97"><a href="#cb125-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.numeric</span>(y_train) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.integer</span>(y_train)){</span>
<span id="cb125-98"><a href="#cb125-98" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stop</span>(<span class="st">&quot;Can&#39;t generated predictions from the data that was provided to css because the provided y was not real-valued (getCssPreds generated predictions using ordinary least squares regression).&quot;</span>)</span>
<span id="cb125-99"><a href="#cb125-99" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb125-100"><a href="#cb125-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb125-101"><a href="#cb125-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-102"><a href="#cb125-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(y_train) <span class="sc">==</span> <span class="fu">nrow</span>(train_X_clusters))</span>
<span id="cb125-103"><a href="#cb125-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-104"><a href="#cb125-104" aria-hidden="true" tabindex="-1"></a>    testX_clusters <span class="ot">&lt;-</span> <span class="fu">formCssDesign</span>(css_results, weighting, cutoff,</span>
<span id="cb125-105"><a href="#cb125-105" aria-hidden="true" tabindex="-1"></a>        min_num_clusts, max_num_clusts, <span class="at">newx=</span>testX)</span>
<span id="cb125-106"><a href="#cb125-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-107"><a href="#cb125-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(testX_clusters) <span class="sc">==</span> <span class="fu">ncol</span>(train_X_clusters))</span>
<span id="cb125-108"><a href="#cb125-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-109"><a href="#cb125-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get names for clusters</span></span>
<span id="cb125-110"><a href="#cb125-110" aria-hidden="true" tabindex="-1"></a>    clust_X_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;c_fit_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(testX_clusters), <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb125-111"><a href="#cb125-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(train_X_clusters))){</span>
<span id="cb125-112"><a href="#cb125-112" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">identical</span>(<span class="fu">colnames</span>(train_X_clusters), <span class="fu">colnames</span>(testX_clusters)))</span>
<span id="cb125-113"><a href="#cb125-113" aria-hidden="true" tabindex="-1"></a>        clust_X_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(train_X_clusters)</span>
<span id="cb125-114"><a href="#cb125-114" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb125-115"><a href="#cb125-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-116"><a href="#cb125-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit linear model on training data via OLS</span></span>
<span id="cb125-117"><a href="#cb125-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(train_X_clusters) <span class="sc">&lt;</span> <span class="fu">ncol</span>(train_X_clusters)){</span>
<span id="cb125-118"><a href="#cb125-118" aria-hidden="true" tabindex="-1"></a>        err_mess <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;css not provided with enough indices to fit OLS model for predictions (number of training indices: &quot;</span>,</span>
<span id="cb125-119"><a href="#cb125-119" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nrow</span>(train_X_clusters), <span class="st">&quot;, number of clusters: &quot;</span>,</span>
<span id="cb125-120"><a href="#cb125-120" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ncol</span>(train_X_clusters),</span>
<span id="cb125-121"><a href="#cb125-121" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;). Try reducing number of clusters by increasing cutoff, or re-run css with a larger number of training indices.&quot;</span>,</span>
<span id="cb125-122"><a href="#cb125-122" aria-hidden="true" tabindex="-1"></a>            <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb125-123"><a href="#cb125-123" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(err_mess)</span>
<span id="cb125-124"><a href="#cb125-124" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb125-125"><a href="#cb125-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-126"><a href="#cb125-126" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y=</span>y_train, train_X_clusters)</span>
<span id="cb125-127"><a href="#cb125-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(df)[<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(df)] <span class="ot">&lt;-</span> clust_X_names</span>
<span id="cb125-128"><a href="#cb125-128" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">lm</span>(y <span class="sc">~</span>., <span class="at">data=</span>df)</span>
<span id="cb125-129"><a href="#cb125-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-130"><a href="#cb125-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use fitted model to generate predictions on testX</span></span>
<span id="cb125-131"><a href="#cb125-131" aria-hidden="true" tabindex="-1"></a>    df_test <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(testX_clusters)</span>
<span id="cb125-132"><a href="#cb125-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(df_test) <span class="ot">&lt;-</span> clust_X_names</span>
<span id="cb125-133"><a href="#cb125-133" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">predict.lm</span>(model, <span class="at">newdata=</span>df_test)</span>
<span id="cb125-134"><a href="#cb125-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(predictions) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb125-135"><a href="#cb125-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-136"><a href="#cb125-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb125-137"><a href="#cb125-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(predictions) <span class="sc">|</span> <span class="fu">is.integer</span>(predictions))</span>
<span id="cb125-138"><a href="#cb125-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(predictions) <span class="sc">==</span> n)</span>
<span id="cb125-139"><a href="#cb125-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(predictions)))</span>
<span id="cb125-140"><a href="#cb125-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-141"><a href="#cb125-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(predictions)</span>
<span id="cb125-142"><a href="#cb125-142" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkGetCssPredsInputs()</code>:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Helper function to confirm that inputs to the function getCssPreds are as</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; expected, and modify inputs if needed.</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param testX A numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the data that will be used to generate predictions. Must contain the same</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features (in the same number of columns) as the matrix provided to css.</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param weighting Character; determines how to calculate the weights to</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; combine features from the selected clusters into weighted averages, called</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster representatives. Must be one of &quot;sparse&quot;, &quot;weighted_avg&quot;, or</span></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&#39;. For &quot;sparse&quot;, all the weight is put on the most frequently</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected individual cluster member (or divided equally among all the clusters</span></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; that are tied for the top selection proportion if there is a tie). For</span></span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;weighted_avg&quot;, the weight used for each cluster member is calculated in</span></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; proportion to the individual selection proportions of each feature. For</span></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;simple_avg&quot;, each cluster member gets equal weight regardless of the</span></span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; individual feature selection proportions (that is, the cluster representative</span></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; is just a simple average of all the cluster members). See Faletto and Bien</span></span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (2022) for details. Default is &quot;weighted_avg&quot;.</span></span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; getCssPreds will make use only of those clusters with</span></span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection proportions equal to at least cutoff. Must be between 0 and 1.</span></span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Default is 0 (in which case either all clusters are used, or max_num_clusts</span></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; are used, if max_num_clusts is specified).</span></span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.) Default is 1.</span></span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) Default is NA (in which case</span></span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts is ignored).</span></span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param trainX A numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb126-37"><a href="#cb126-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the data that will be used to estimate the linear model from the selected</span></span>
<span id="cb126-38"><a href="#cb126-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters. trainX is only necessary to provide if no train_inds were</span></span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; designated in the css function call to set aside observations for model</span></span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; estimation (though even if train_inds was provided, trainX and trianY will be</span></span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; used for model estimation if they are both provided to getCssPreds). Must </span></span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; contain the same features (in the same number of columns) as the matrix </span></span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided to css, and if the columns of trainX are labeled, the names must</span></span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; match the variable names provided to css. Default is NA (in which case</span></span>
<span id="cb126-45"><a href="#cb126-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; getCssPreds uses the observations from the train_inds that were provided to</span></span>
<span id="cb126-46"><a href="#cb126-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css to estimate a linear model).</span></span>
<span id="cb126-47"><a href="#cb126-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param trainY The response corresponding to trainX. Must be a real-valued</span></span>
<span id="cb126-48"><a href="#cb126-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response (unlike in the general css setup) because predictions will be</span></span>
<span id="cb126-49"><a href="#cb126-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generated by an ordinary least squares model. Must have the same length as</span></span>
<span id="cb126-50"><a href="#cb126-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the number of rows of trainX. Like trainX, only needs to be provided if no</span></span>
<span id="cb126-51"><a href="#cb126-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; observations were set aside for model estimation by the parameter train_inds</span></span>
<span id="cb126-52"><a href="#cb126-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in the css function call. Default is NA (in which case getCssPreds uses the</span></span>
<span id="cb126-53"><a href="#cb126-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; observations from the train_inds that were provided to css).</span></span>
<span id="cb126-54"><a href="#cb126-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with the following elements: \item{trainXProvided}{</span></span>
<span id="cb126-55"><a href="#cb126-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Logical; indicates whether a valid trainX input was provided.} \item{trainX}{</span></span>
<span id="cb126-56"><a href="#cb126-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; The provided trainX matrix, coerced from a data.frame to a matrix if the</span></span>
<span id="cb126-57"><a href="#cb126-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided trainX was a data.frame. (If a valid trainX was not provided, this</span></span>
<span id="cb126-58"><a href="#cb126-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; output simply passes whatever was provided as trainX.)} \item{testX}{The</span></span>
<span id="cb126-59"><a href="#cb126-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided testX matrix, coerced from a data.frame to a matrix if the provided</span></span>
<span id="cb126-60"><a href="#cb126-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; testX was a data.frame.} \item{feat_names}{A character vector containing the</span></span>
<span id="cb126-61"><a href="#cb126-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; column names of testX (if the provided testX had column names). If the</span></span>
<span id="cb126-62"><a href="#cb126-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided testX did not have column names, feat_names will be NA.}</span></span>
<span id="cb126-63"><a href="#cb126-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{max_num_clusts}{The provided max_num_clusts, coerced to an integer if</span></span>
<span id="cb126-64"><a href="#cb126-64" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; needed, and coerced to be less than or equal to the total number of clusters</span></span>
<span id="cb126-65"><a href="#cb126-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; from the output of css_results.}</span></span>
<span id="cb126-66"><a href="#cb126-66" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb126-67"><a href="#cb126-67" aria-hidden="true" tabindex="-1"></a>checkGetCssPredsInputs <span class="ot">&lt;-</span> <span class="cf">function</span>(css_results, testX, weighting, cutoff,</span>
<span id="cb126-68"><a href="#cb126-68" aria-hidden="true" tabindex="-1"></a>    min_num_clusts, max_num_clusts, trainX, trainY){</span>
<span id="cb126-69"><a href="#cb126-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb126-70"><a href="#cb126-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">class</span>(css_results) <span class="sc">==</span> <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb126-71"><a href="#cb126-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-72"><a href="#cb126-72" aria-hidden="true" tabindex="-1"></a>    check_results <span class="ot">&lt;-</span> <span class="fu">checkNewXProvided</span>(trainX, css_results)</span>
<span id="cb126-73"><a href="#cb126-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-74"><a href="#cb126-74" aria-hidden="true" tabindex="-1"></a>    trainX <span class="ot">&lt;-</span> check_results<span class="sc">$</span>newX</span>
<span id="cb126-75"><a href="#cb126-75" aria-hidden="true" tabindex="-1"></a>    trainXProvided <span class="ot">&lt;-</span> check_results<span class="sc">$</span>newXProvided</span>
<span id="cb126-76"><a href="#cb126-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-77"><a href="#cb126-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(check_results)</span>
<span id="cb126-78"><a href="#cb126-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-79"><a href="#cb126-79" aria-hidden="true" tabindex="-1"></a>    n_train <span class="ot">&lt;-</span> <span class="fu">nrow</span>(trainX)</span>
<span id="cb126-80"><a href="#cb126-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-81"><a href="#cb126-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(trainXProvided){</span>
<span id="cb126-82"><a href="#cb126-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(trainY)) <span class="sc">&amp;</span> <span class="fu">length</span>(trainY) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb126-83"><a href="#cb126-83" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(trainY))</span>
<span id="cb126-84"><a href="#cb126-84" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(n_train <span class="sc">==</span> <span class="fu">length</span>(trainY))</span>
<span id="cb126-85"><a href="#cb126-85" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span>{</span>
<span id="cb126-86"><a href="#cb126-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">length</span>(css_results<span class="sc">$</span>train_inds) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb126-87"><a href="#cb126-87" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stop</span>(<span class="st">&quot;css was not provided with indices to set aside for model training (train_inds), so must provide both trainX and trainY in order to generate predictions&quot;</span>)</span>
<span id="cb126-88"><a href="#cb126-88" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb126-89"><a href="#cb126-89" aria-hidden="true" tabindex="-1"></a>            trainXProvided <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb126-90"><a href="#cb126-90" aria-hidden="true" tabindex="-1"></a>            <span class="fu">warning</span>(<span class="st">&quot;trainX provided but no trainY provided; instead, training model using the train_inds observations provided to css to set aside for model training.&quot;</span>)</span>
<span id="cb126-91"><a href="#cb126-91" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-92"><a href="#cb126-92" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb126-93"><a href="#cb126-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(css_results<span class="sc">$</span>train_inds) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb126-94"><a href="#cb126-94" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stop</span>(<span class="st">&quot;css was not provided with indices to set aside for model training (train_inds), so must provide both trainX and trainY in order to generate predictions&quot;</span>)</span>
<span id="cb126-95"><a href="#cb126-95" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-96"><a href="#cb126-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(trainY)) <span class="sc">&amp;</span> <span class="fu">length</span>(trainY) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb126-97"><a href="#cb126-97" aria-hidden="true" tabindex="-1"></a>            <span class="fu">warning</span>(<span class="st">&quot;trainY provided but no trainX provided; instead, training model using the train_inds observations provided to css to set aside for model training.&quot;</span>)</span>
<span id="cb126-98"><a href="#cb126-98" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-99"><a href="#cb126-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-100"><a href="#cb126-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-101"><a href="#cb126-101" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">checkXInputResults</span>(testX, css_results<span class="sc">$</span>X)</span>
<span id="cb126-102"><a href="#cb126-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-103"><a href="#cb126-103" aria-hidden="true" tabindex="-1"></a>    testX <span class="ot">&lt;-</span> results<span class="sc">$</span>newx</span>
<span id="cb126-104"><a href="#cb126-104" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="ot">&lt;-</span> results<span class="sc">$</span>feat_names</span>
<span id="cb126-105"><a href="#cb126-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-106"><a href="#cb126-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(feat_names))){</span>
<span id="cb126-107"><a href="#cb126-107" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(feat_names) <span class="sc">==</span> <span class="fu">ncol</span>(testX))</span>
<span id="cb126-108"><a href="#cb126-108" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="sc">!</span>(<span class="st">&quot;(Intercept)&quot;</span> <span class="sc">%in%</span> feat_names))</span>
<span id="cb126-109"><a href="#cb126-109" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(testX) <span class="ot">&lt;-</span> feat_names</span>
<span id="cb126-110"><a href="#cb126-110" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-111"><a href="#cb126-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-112"><a href="#cb126-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(results)</span>
<span id="cb126-113"><a href="#cb126-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-114"><a href="#cb126-114" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(testX)</span>
<span id="cb126-115"><a href="#cb126-115" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(testX)</span>
<span id="cb126-116"><a href="#cb126-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-117"><a href="#cb126-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb126-118"><a href="#cb126-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">==</span> <span class="fu">ncol</span>(trainX))</span>
<span id="cb126-119"><a href="#cb126-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(trainX)) <span class="sc">&amp;</span> <span class="fu">is.null</span>(<span class="fu">colnames</span>(testX))){</span>
<span id="cb126-120"><a href="#cb126-120" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">&quot;Column names were provided for trainX but not for testX (are you sure they both contain identical features in the same order?)&quot;</span>)</span>
<span id="cb126-121"><a href="#cb126-121" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-122"><a href="#cb126-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(<span class="fu">colnames</span>(trainX)) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(testX))){</span>
<span id="cb126-123"><a href="#cb126-123" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">&quot;Column names were provided for testX but not for trainX (are you sure they both contain identical features in the same order?)&quot;</span>)</span>
<span id="cb126-124"><a href="#cb126-124" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-125"><a href="#cb126-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(trainX)) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(testX))){</span>
<span id="cb126-126"><a href="#cb126-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(trainX) <span class="sc">==</span> <span class="fu">colnames</span>(testX)))</span>
<span id="cb126-127"><a href="#cb126-127" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-128"><a href="#cb126-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-129"><a href="#cb126-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkCutoff</span>(cutoff)</span>
<span id="cb126-130"><a href="#cb126-130" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkWeighting</span>(weighting)</span>
<span id="cb126-131"><a href="#cb126-131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkMinNumClusts</span>(min_num_clusts, p, <span class="fu">length</span>(css_results<span class="sc">$</span>clusters))</span>
<span id="cb126-132"><a href="#cb126-132" aria-hidden="true" tabindex="-1"></a>    max_num_clusts <span class="ot">&lt;-</span> <span class="fu">checkMaxNumClusts</span>(max_num_clusts, min_num_clusts, p,</span>
<span id="cb126-133"><a href="#cb126-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(css_results<span class="sc">$</span>clusters))</span>
<span id="cb126-134"><a href="#cb126-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-135"><a href="#cb126-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">trainXProvided=</span>trainXProvided, <span class="at">trainX=</span>trainX, <span class="at">testX=</span>testX,</span>
<span id="cb126-136"><a href="#cb126-136" aria-hidden="true" tabindex="-1"></a>        <span class="at">feat_names=</span>feat_names, <span class="at">max_num_clusts=</span>max_num_clusts))</span>
<span id="cb126-137"><a href="#cb126-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-138"><a href="#cb126-138" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkGetCssPredsInputs()</code></p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkGetCssPredsInputs works&quot;</span>, {</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">17081</span>)</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  x_select <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  x_train <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">8</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  x_pred <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">7</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">7</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>  y_select <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>  y_train <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span>)</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;red&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="st">&quot;blue&quot;</span><span class="ot">=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">&quot;green&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>  css_res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>,</span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>                                <span class="at">cutoff=</span><span class="fl">0.05</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">trainX=</span>x_train,</span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>                                <span class="at">trainY=</span>y_train)</span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;trainXProvided&quot;</span>, <span class="st">&quot;trainX&quot;</span>, <span class="st">&quot;testX&quot;</span>,</span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;feat_names&quot;</span>, <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>trainXProvided))</span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>trainXProvided), <span class="dv">1</span>)</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.logical</span>(res<span class="sc">$</span>trainXProvided))</span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res<span class="sc">$</span>trainXProvided)</span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>trainX)))</span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>trainX))</span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>trainX))</span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>trainX), <span class="dv">8</span>)</span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>trainX), <span class="dv">6</span>)</span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_train <span class="sc">-</span> res<span class="sc">$</span>trainX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>testX)))</span>
<span id="cb127-37"><a href="#cb127-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>testX))</span>
<span id="cb127-38"><a href="#cb127-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>testX))</span>
<span id="cb127-39"><a href="#cb127-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>testX), <span class="dv">7</span>)</span>
<span id="cb127-40"><a href="#cb127-40" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>testX), <span class="dv">6</span>)</span>
<span id="cb127-41"><a href="#cb127-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_pred <span class="sc">-</span> res<span class="sc">$</span>testX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-42"><a href="#cb127-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-43"><a href="#cb127-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res<span class="sc">$</span>feat_names))</span>
<span id="cb127-44"><a href="#cb127-44" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(res<span class="sc">$</span>feat_names))</span>
<span id="cb127-45"><a href="#cb127-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-46"><a href="#cb127-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(res<span class="sc">$</span>max_num_clusts))</span>
<span id="cb127-47"><a href="#cb127-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>max_num_clusts) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb127-48"><a href="#cb127-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-49"><a href="#cb127-49" aria-hidden="true" tabindex="-1"></a>  <span class="do">##### Try other bad inputs</span></span>
<span id="cb127-50"><a href="#cb127-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-51"><a href="#cb127-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-52"><a href="#cb127-52" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb127-53"><a href="#cb127-53" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="sc">-</span><span class="fl">0.5</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-54"><a href="#cb127-54" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-55"><a href="#cb127-55" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-56"><a href="#cb127-56" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;cutoff &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-57"><a href="#cb127-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-58"><a href="#cb127-58" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-59"><a href="#cb127-59" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb127-60"><a href="#cb127-60" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="st">&quot;0.3&quot;</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-61"><a href="#cb127-61" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-62"><a href="#cb127-62" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-63"><a href="#cb127-63" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(cutoff) | is.integer(cutoff) is not TRUE&quot;</span>,</span>
<span id="cb127-64"><a href="#cb127-64" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-65"><a href="#cb127-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-66"><a href="#cb127-66" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-67"><a href="#cb127-67" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb127-68"><a href="#cb127-68" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb127-69"><a href="#cb127-69" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-70"><a href="#cb127-70" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-71"><a href="#cb127-71" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-72"><a href="#cb127-72" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;!is.na(cutoff) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-73"><a href="#cb127-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-74"><a href="#cb127-74" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-75"><a href="#cb127-75" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="fu">c</span>(<span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb127-76"><a href="#cb127-76" aria-hidden="true" tabindex="-1"></a>                                                            <span class="st">&quot;simple_avg&quot;</span>),</span>
<span id="cb127-77"><a href="#cb127-77" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="fl">0.1</span>,</span>
<span id="cb127-78"><a href="#cb127-78" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-79"><a href="#cb127-79" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-80"><a href="#cb127-80" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-81"><a href="#cb127-81" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(weighting) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-82"><a href="#cb127-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-83"><a href="#cb127-83" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-84"><a href="#cb127-84" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="dv">2</span>, <span class="at">cutoff=</span><span class="fl">0.1</span>,</span>
<span id="cb127-85"><a href="#cb127-85" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-86"><a href="#cb127-86" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-87"><a href="#cb127-87" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-88"><a href="#cb127-88" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-89"><a href="#cb127-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-90"><a href="#cb127-90" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-91"><a href="#cb127-91" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;spasre&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.1</span>,</span>
<span id="cb127-92"><a href="#cb127-92" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-93"><a href="#cb127-93" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-94"><a href="#cb127-94" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-95"><a href="#cb127-95" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character and one of sparse, simple_avg, or weighted_avg&quot;</span>,</span>
<span id="cb127-96"><a href="#cb127-96" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-97"><a href="#cb127-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-98"><a href="#cb127-98" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-99"><a href="#cb127-99" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.1</span>,</span>
<span id="cb127-100"><a href="#cb127-100" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">min_num_clusts=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb127-101"><a href="#cb127-101" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-102"><a href="#cb127-102" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-103"><a href="#cb127-103" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(min_num_clusts) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-104"><a href="#cb127-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-105"><a href="#cb127-105" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-106"><a href="#cb127-106" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb127-107"><a href="#cb127-107" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="fl">0.1</span>, <span class="at">min_num_clusts=</span><span class="st">&quot;2&quot;</span>,</span>
<span id="cb127-108"><a href="#cb127-108" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-109"><a href="#cb127-109" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-110"><a href="#cb127-110" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(min_num_clusts) | is.integer(min_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb127-111"><a href="#cb127-111" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-112"><a href="#cb127-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-113"><a href="#cb127-113" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-114"><a href="#cb127-114" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>,</span>
<span id="cb127-115"><a href="#cb127-115" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="fl">0.1</span>, <span class="at">min_num_clusts=</span><span class="dv">0</span>,</span>
<span id="cb127-116"><a href="#cb127-116" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-117"><a href="#cb127-117" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-118"><a href="#cb127-118" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-119"><a href="#cb127-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-120"><a href="#cb127-120" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-121"><a href="#cb127-121" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb127-122"><a href="#cb127-122" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="fl">0.1</span>, <span class="at">min_num_clusts=</span><span class="dv">10</span>,</span>
<span id="cb127-123"><a href="#cb127-123" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-124"><a href="#cb127-124" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-125"><a href="#cb127-125" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-126"><a href="#cb127-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-127"><a href="#cb127-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-128"><a href="#cb127-128" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-129"><a href="#cb127-129" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>,</span>
<span id="cb127-130"><a href="#cb127-130" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="fl">0.1</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-131"><a href="#cb127-131" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="st">&quot;5&quot;</span>,</span>
<span id="cb127-132"><a href="#cb127-132" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-133"><a href="#cb127-133" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(max_num_clusts) | is.integer(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb127-134"><a href="#cb127-134" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-135"><a href="#cb127-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-136"><a href="#cb127-136" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-137"><a href="#cb127-137" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb127-138"><a href="#cb127-138" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="fl">0.1</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-139"><a href="#cb127-139" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="fl">4.5</span>,</span>
<span id="cb127-140"><a href="#cb127-140" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-141"><a href="#cb127-141" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts == round(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb127-142"><a href="#cb127-142" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-143"><a href="#cb127-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-144"><a href="#cb127-144" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-145"><a href="#cb127-145" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb127-146"><a href="#cb127-146" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="fl">0.1</span>, <span class="at">min_num_clusts=</span><span class="dv">3</span>,</span>
<span id="cb127-147"><a href="#cb127-147" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="dv">2</span>,</span>
<span id="cb127-148"><a href="#cb127-148" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-149"><a href="#cb127-149" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &gt;= min_num_clusts is not TRUE&quot;</span>,</span>
<span id="cb127-150"><a href="#cb127-150" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-151"><a href="#cb127-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-152"><a href="#cb127-152" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-153"><a href="#cb127-153" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb127-154"><a href="#cb127-154" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">cutoff=</span><span class="fl">0.1</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-155"><a href="#cb127-155" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">max_num_clusts=</span><span class="dv">10</span>,</span>
<span id="cb127-156"><a href="#cb127-156" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-157"><a href="#cb127-157" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-158"><a href="#cb127-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-159"><a href="#cb127-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add training indices</span></span>
<span id="cb127-160"><a href="#cb127-160" aria-hidden="true" tabindex="-1"></a>  css_res_train <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb127-161"><a href="#cb127-161" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B=</span><span class="dv">10</span>, <span class="at">train_inds=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb127-162"><a href="#cb127-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-163"><a href="#cb127-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Training indices should be ignored if new x is provided</span></span>
<span id="cb127-164"><a href="#cb127-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-165"><a href="#cb127-165" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkGetCssPredsInputs</span>(css_res_train, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-166"><a href="#cb127-166" aria-hidden="true" tabindex="-1"></a>                                <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb127-167"><a href="#cb127-167" aria-hidden="true" tabindex="-1"></a>                                <span class="at">cutoff=</span><span class="dv">0</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-168"><a href="#cb127-168" aria-hidden="true" tabindex="-1"></a>                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">trainX=</span>x_train,</span>
<span id="cb127-169"><a href="#cb127-169" aria-hidden="true" tabindex="-1"></a>                                <span class="at">trainY=</span>y_train)</span>
<span id="cb127-170"><a href="#cb127-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-171"><a href="#cb127-171" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb127-172"><a href="#cb127-172" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;trainXProvided&quot;</span>, <span class="st">&quot;trainX&quot;</span>, <span class="st">&quot;testX&quot;</span>,</span>
<span id="cb127-173"><a href="#cb127-173" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;feat_names&quot;</span>, <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb127-174"><a href="#cb127-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-175"><a href="#cb127-175" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>trainXProvided))</span>
<span id="cb127-176"><a href="#cb127-176" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>trainXProvided), <span class="dv">1</span>)</span>
<span id="cb127-177"><a href="#cb127-177" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.logical</span>(res<span class="sc">$</span>trainXProvided))</span>
<span id="cb127-178"><a href="#cb127-178" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(res<span class="sc">$</span>trainXProvided)</span>
<span id="cb127-179"><a href="#cb127-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-180"><a href="#cb127-180" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>trainX)))</span>
<span id="cb127-181"><a href="#cb127-181" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>trainX))</span>
<span id="cb127-182"><a href="#cb127-182" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>trainX))</span>
<span id="cb127-183"><a href="#cb127-183" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>trainX), <span class="dv">8</span>)</span>
<span id="cb127-184"><a href="#cb127-184" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>trainX), <span class="dv">6</span>)</span>
<span id="cb127-185"><a href="#cb127-185" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_train <span class="sc">-</span> res<span class="sc">$</span>trainX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-186"><a href="#cb127-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-187"><a href="#cb127-187" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>testX)))</span>
<span id="cb127-188"><a href="#cb127-188" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>testX))</span>
<span id="cb127-189"><a href="#cb127-189" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>testX))</span>
<span id="cb127-190"><a href="#cb127-190" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>testX), <span class="dv">7</span>)</span>
<span id="cb127-191"><a href="#cb127-191" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>testX), <span class="dv">6</span>)</span>
<span id="cb127-192"><a href="#cb127-192" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_pred <span class="sc">-</span> res<span class="sc">$</span>testX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-193"><a href="#cb127-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-194"><a href="#cb127-194" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res<span class="sc">$</span>feat_names))</span>
<span id="cb127-195"><a href="#cb127-195" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(res<span class="sc">$</span>feat_names))</span>
<span id="cb127-196"><a href="#cb127-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-197"><a href="#cb127-197" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(res<span class="sc">$</span>max_num_clusts))</span>
<span id="cb127-198"><a href="#cb127-198" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>max_num_clusts) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb127-199"><a href="#cb127-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-200"><a href="#cb127-200" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Things should still work if new x is not provided</span></span>
<span id="cb127-201"><a href="#cb127-201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-202"><a href="#cb127-202" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">checkGetCssPredsInputs</span>(css_res_train, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-203"><a href="#cb127-203" aria-hidden="true" tabindex="-1"></a>                                <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb127-204"><a href="#cb127-204" aria-hidden="true" tabindex="-1"></a>                                <span class="at">cutoff=</span><span class="dv">0</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-205"><a href="#cb127-205" aria-hidden="true" tabindex="-1"></a>                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">trainX=</span><span class="cn">NA</span>, <span class="at">trainY=</span><span class="cn">NA</span>)</span>
<span id="cb127-206"><a href="#cb127-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-207"><a href="#cb127-207" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb127-208"><a href="#cb127-208" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;trainXProvided&quot;</span>, <span class="st">&quot;trainX&quot;</span>, <span class="st">&quot;testX&quot;</span>,</span>
<span id="cb127-209"><a href="#cb127-209" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;feat_names&quot;</span>, <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb127-210"><a href="#cb127-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-211"><a href="#cb127-211" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>trainXProvided))</span>
<span id="cb127-212"><a href="#cb127-212" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>trainXProvided), <span class="dv">1</span>)</span>
<span id="cb127-213"><a href="#cb127-213" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.logical</span>(res<span class="sc">$</span>trainXProvided))</span>
<span id="cb127-214"><a href="#cb127-214" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span>res<span class="sc">$</span>trainXProvided)</span>
<span id="cb127-215"><a href="#cb127-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-216"><a href="#cb127-216" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>trainX)))</span>
<span id="cb127-217"><a href="#cb127-217" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>trainX))</span>
<span id="cb127-218"><a href="#cb127-218" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>trainX))</span>
<span id="cb127-219"><a href="#cb127-219" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>trainX), <span class="dv">5</span>)</span>
<span id="cb127-220"><a href="#cb127-220" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>trainX), <span class="dv">6</span>)</span>
<span id="cb127-221"><a href="#cb127-221" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_select[<span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>, ] <span class="sc">-</span> res<span class="sc">$</span>trainX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-222"><a href="#cb127-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-223"><a href="#cb127-223" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>testX)))</span>
<span id="cb127-224"><a href="#cb127-224" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>testX))</span>
<span id="cb127-225"><a href="#cb127-225" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>testX))</span>
<span id="cb127-226"><a href="#cb127-226" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>testX), <span class="dv">7</span>)</span>
<span id="cb127-227"><a href="#cb127-227" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>testX), <span class="dv">6</span>)</span>
<span id="cb127-228"><a href="#cb127-228" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_pred <span class="sc">-</span> res<span class="sc">$</span>testX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-229"><a href="#cb127-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-230"><a href="#cb127-230" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res<span class="sc">$</span>feat_names))</span>
<span id="cb127-231"><a href="#cb127-231" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(res<span class="sc">$</span>feat_names))</span>
<span id="cb127-232"><a href="#cb127-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-233"><a href="#cb127-233" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(res<span class="sc">$</span>max_num_clusts))</span>
<span id="cb127-234"><a href="#cb127-234" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>max_num_clusts) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb127-235"><a href="#cb127-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-236"><a href="#cb127-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-237"><a href="#cb127-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try not providing training indices and omitting newX--should get error</span></span>
<span id="cb127-238"><a href="#cb127-238" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-239"><a href="#cb127-239" aria-hidden="true" tabindex="-1"></a>                                <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>,</span>
<span id="cb127-240"><a href="#cb127-240" aria-hidden="true" tabindex="-1"></a>                                <span class="at">cutoff=</span><span class="dv">0</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb127-241"><a href="#cb127-241" aria-hidden="true" tabindex="-1"></a>                                <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">trainX=</span><span class="cn">NA</span>, <span class="at">trainY=</span><span class="cn">NA</span>),</span>
<span id="cb127-242"><a href="#cb127-242" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;css was not provided with indices to set aside for model training (train_inds), so must provide new X in order to generate a design matrix&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-243"><a href="#cb127-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-244"><a href="#cb127-244" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try naming variables</span></span>
<span id="cb127-245"><a href="#cb127-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-246"><a href="#cb127-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_select) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb127-247"><a href="#cb127-247" aria-hidden="true" tabindex="-1"></a>  css_res_named <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb127-248"><a href="#cb127-248" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb127-249"><a href="#cb127-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-250"><a href="#cb127-250" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Named variables for css matrix but not new one--should get a warning</span></span>
<span id="cb127-251"><a href="#cb127-251" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res_named, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-252"><a href="#cb127-252" aria-hidden="true" tabindex="-1"></a>                                <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb127-253"><a href="#cb127-253" aria-hidden="true" tabindex="-1"></a>                                <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-254"><a href="#cb127-254" aria-hidden="true" tabindex="-1"></a>                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-255"><a href="#cb127-255" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;New X provided had no variable names (column names) even though the X provided to css did.&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-256"><a href="#cb127-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-257"><a href="#cb127-257" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try mismatching variable names</span></span>
<span id="cb127-258"><a href="#cb127-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_train) <span class="ot">&lt;-</span> LETTERS[<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>]</span>
<span id="cb127-259"><a href="#cb127-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_pred) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb127-260"><a href="#cb127-260" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res_named, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-261"><a href="#cb127-261" aria-hidden="true" tabindex="-1"></a>                                <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb127-262"><a href="#cb127-262" aria-hidden="true" tabindex="-1"></a>                                <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-263"><a href="#cb127-263" aria-hidden="true" tabindex="-1"></a>                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-264"><a href="#cb127-264" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;identical(feat_names, colnames(css_X)) is not TRUE&quot;</span>,</span>
<span id="cb127-265"><a href="#cb127-265" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-266"><a href="#cb127-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-267"><a href="#cb127-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_train) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb127-268"><a href="#cb127-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_pred) <span class="ot">&lt;-</span> LETTERS[<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>]</span>
<span id="cb127-269"><a href="#cb127-269" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetCssPredsInputs</span>(css_res_named, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-270"><a href="#cb127-270" aria-hidden="true" tabindex="-1"></a>                                <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb127-271"><a href="#cb127-271" aria-hidden="true" tabindex="-1"></a>                                <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-272"><a href="#cb127-272" aria-hidden="true" tabindex="-1"></a>                                <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb127-273"><a href="#cb127-273" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;identical(feat_names, colnames(css_X)) is not TRUE&quot;</span>,</span>
<span id="cb127-274"><a href="#cb127-274" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb127-275"><a href="#cb127-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-276"><a href="#cb127-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_pred) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb127-277"><a href="#cb127-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-278"><a href="#cb127-278" aria-hidden="true" tabindex="-1"></a>  res_named <span class="ot">&lt;-</span> <span class="fu">checkGetCssPredsInputs</span>(css_res_named, <span class="at">testX=</span>x_pred,</span>
<span id="cb127-279"><a href="#cb127-279" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb127-280"><a href="#cb127-280" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-281"><a href="#cb127-281" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train)</span>
<span id="cb127-282"><a href="#cb127-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-283"><a href="#cb127-283" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_named))</span>
<span id="cb127-284"><a href="#cb127-284" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_named), <span class="fu">c</span>(<span class="st">&quot;trainXProvided&quot;</span>, <span class="st">&quot;trainX&quot;</span>, <span class="st">&quot;testX&quot;</span>,</span>
<span id="cb127-285"><a href="#cb127-285" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;feat_names&quot;</span>, <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb127-286"><a href="#cb127-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-287"><a href="#cb127-287" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res_named<span class="sc">$</span>trainX)))</span>
<span id="cb127-288"><a href="#cb127-288" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_named<span class="sc">$</span>trainX))</span>
<span id="cb127-289"><a href="#cb127-289" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_named<span class="sc">$</span>trainX))</span>
<span id="cb127-290"><a href="#cb127-290" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_named<span class="sc">$</span>trainX), <span class="dv">8</span>)</span>
<span id="cb127-291"><a href="#cb127-291" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_named<span class="sc">$</span>trainX), <span class="dv">6</span>)</span>
<span id="cb127-292"><a href="#cb127-292" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(x_train <span class="sc">-</span> res_named<span class="sc">$</span>trainX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-293"><a href="#cb127-293" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-294"><a href="#cb127-294" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res_named<span class="sc">$</span>feat_names))</span>
<span id="cb127-295"><a href="#cb127-295" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res_named<span class="sc">$</span>feat_names, LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span>
<span id="cb127-296"><a href="#cb127-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-297"><a href="#cb127-297" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try data.frame input to css and checkGetCssPredsInputs</span></span>
<span id="cb127-298"><a href="#cb127-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-299"><a href="#cb127-299" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb127-300"><a href="#cb127-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-301"><a href="#cb127-301" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_df)</span>
<span id="cb127-302"><a href="#cb127-302" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(n)</span>
<span id="cb127-303"><a href="#cb127-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-304"><a href="#cb127-304" aria-hidden="true" tabindex="-1"></a>  selec_inds <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">round</span>(n<span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb127-305"><a href="#cb127-305" aria-hidden="true" tabindex="-1"></a>  train_inds <span class="ot">&lt;-</span> (<span class="fu">max</span>(selec_inds) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span><span class="fu">round</span>(n<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb127-306"><a href="#cb127-306" aria-hidden="true" tabindex="-1"></a>  test_inds <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="fu">c</span>(selec_inds, train_inds))</span>
<span id="cb127-307"><a href="#cb127-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-308"><a href="#cb127-308" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[<span class="fu">c</span>(selec_inds, train_inds), ],</span>
<span id="cb127-309"><a href="#cb127-309" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y=</span>y[<span class="fu">c</span>(selec_inds, train_inds)], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>,</span>
<span id="cb127-310"><a href="#cb127-310" aria-hidden="true" tabindex="-1"></a>                    <span class="at">train_inds=</span>train_inds)</span>
<span id="cb127-311"><a href="#cb127-311" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-312"><a href="#cb127-312" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">checkGetCssPredsInputs</span>(css_res_df, <span class="at">testX=</span>X_df[test_inds, ],</span>
<span id="cb127-313"><a href="#cb127-313" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span><span class="dv">0</span>,</span>
<span id="cb127-314"><a href="#cb127-314" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>,</span>
<span id="cb127-315"><a href="#cb127-315" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">trainX=</span><span class="cn">NA</span>, <span class="at">trainY=</span><span class="cn">NA</span>)</span>
<span id="cb127-316"><a href="#cb127-316" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-317"><a href="#cb127-317" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_df))</span>
<span id="cb127-318"><a href="#cb127-318" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_df), <span class="fu">c</span>(<span class="st">&quot;trainXProvided&quot;</span>, <span class="st">&quot;trainX&quot;</span>,</span>
<span id="cb127-319"><a href="#cb127-319" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;testX&quot;</span>,<span class="st">&quot;feat_names&quot;</span>,</span>
<span id="cb127-320"><a href="#cb127-320" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb127-321"><a href="#cb127-321" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-322"><a href="#cb127-322" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res_df<span class="sc">$</span>trainX)))</span>
<span id="cb127-323"><a href="#cb127-323" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df<span class="sc">$</span>trainX))</span>
<span id="cb127-324"><a href="#cb127-324" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df<span class="sc">$</span>trainX))</span>
<span id="cb127-325"><a href="#cb127-325" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df<span class="sc">$</span>trainX), <span class="fu">length</span>(train_inds))</span>
<span id="cb127-326"><a href="#cb127-326" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-327"><a href="#cb127-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(css_res_df<span class="sc">$</span>X) <span class="sc">&gt;=</span> <span class="fu">max</span>(train_inds))</span>
<span id="cb127-328"><a href="#cb127-328" aria-hidden="true" tabindex="-1"></a>  train_mat <span class="ot">&lt;-</span> css_res_df<span class="sc">$</span>X[train_inds, ]</span>
<span id="cb127-329"><a href="#cb127-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-330"><a href="#cb127-330" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_df<span class="sc">$</span>trainX), <span class="fu">ncol</span>(train_mat))</span>
<span id="cb127-331"><a href="#cb127-331" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(train_mat <span class="sc">-</span> res_df<span class="sc">$</span>trainX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-332"><a href="#cb127-332" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(res_df<span class="sc">$</span>trainX), <span class="fu">colnames</span>(train_mat))</span>
<span id="cb127-333"><a href="#cb127-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-334"><a href="#cb127-334" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res_df<span class="sc">$</span>testX)))</span>
<span id="cb127-335"><a href="#cb127-335" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df<span class="sc">$</span>testX))</span>
<span id="cb127-336"><a href="#cb127-336" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df<span class="sc">$</span>testX))</span>
<span id="cb127-337"><a href="#cb127-337" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df<span class="sc">$</span>testX), <span class="fu">length</span>(test_inds))</span>
<span id="cb127-338"><a href="#cb127-338" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-339"><a href="#cb127-339" aria-hidden="true" tabindex="-1"></a>  test_mat <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X_df[test_inds, ])</span>
<span id="cb127-340"><a href="#cb127-340" aria-hidden="true" tabindex="-1"></a>  test_mat <span class="ot">&lt;-</span> test_mat[, <span class="fu">colnames</span>(test_mat) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb127-341"><a href="#cb127-341" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-342"><a href="#cb127-342" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_df<span class="sc">$</span>testX), <span class="fu">ncol</span>(test_mat))</span>
<span id="cb127-343"><a href="#cb127-343" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(test_mat <span class="sc">-</span> res_df<span class="sc">$</span>testX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-344"><a href="#cb127-344" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(res_df<span class="sc">$</span>testX), <span class="fu">colnames</span>(test_mat))</span>
<span id="cb127-345"><a href="#cb127-345" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(res_df<span class="sc">$</span>testX), <span class="fu">colnames</span>(res_df<span class="sc">$</span>trainX))</span>
<span id="cb127-346"><a href="#cb127-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-347"><a href="#cb127-347" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try again with X as a dataframe with factors (number of columns of final</span></span>
<span id="cb127-348"><a href="#cb127-348" aria-hidden="true" tabindex="-1"></a>  <span class="co"># design matrix after one-hot encoding factors won&#39;t match number of columns</span></span>
<span id="cb127-349"><a href="#cb127-349" aria-hidden="true" tabindex="-1"></a>  <span class="co"># of X_df)</span></span>
<span id="cb127-350"><a href="#cb127-350" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>cyl)</span>
<span id="cb127-351"><a href="#cb127-351" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>vs)</span>
<span id="cb127-352"><a href="#cb127-352" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>am)</span>
<span id="cb127-353"><a href="#cb127-353" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>gear)</span>
<span id="cb127-354"><a href="#cb127-354" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>carb)</span>
<span id="cb127-355"><a href="#cb127-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-356"><a href="#cb127-356" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb127-357"><a href="#cb127-357" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">checkGetCssPredsInputs</span>(css_res_df, <span class="at">testX=</span>X_df[test_inds, ],</span>
<span id="cb127-358"><a href="#cb127-358" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">weighting=</span><span class="st">&quot;simple_avg&quot;</span>, <span class="at">cutoff=</span><span class="fl">0.3</span>,</span>
<span id="cb127-359"><a href="#cb127-359" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="dv">4</span>,</span>
<span id="cb127-360"><a href="#cb127-360" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">trainX=</span>X_df[train_inds, ],</span>
<span id="cb127-361"><a href="#cb127-361" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">trainY=</span>y[train_inds])</span>
<span id="cb127-362"><a href="#cb127-362" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-363"><a href="#cb127-363" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res_df))</span>
<span id="cb127-364"><a href="#cb127-364" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res_df), <span class="fu">c</span>(<span class="st">&quot;trainXProvided&quot;</span>, <span class="st">&quot;trainX&quot;</span>,</span>
<span id="cb127-365"><a href="#cb127-365" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;testX&quot;</span>,<span class="st">&quot;feat_names&quot;</span>,</span>
<span id="cb127-366"><a href="#cb127-366" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;max_num_clusts&quot;</span>))</span>
<span id="cb127-367"><a href="#cb127-367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-368"><a href="#cb127-368" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res_df<span class="sc">$</span>trainX)))</span>
<span id="cb127-369"><a href="#cb127-369" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df<span class="sc">$</span>trainX))</span>
<span id="cb127-370"><a href="#cb127-370" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df<span class="sc">$</span>trainX))</span>
<span id="cb127-371"><a href="#cb127-371" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df<span class="sc">$</span>trainX), <span class="fu">length</span>(train_inds))</span>
<span id="cb127-372"><a href="#cb127-372" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-373"><a href="#cb127-373" aria-hidden="true" tabindex="-1"></a>  train_mat <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X_df[train_inds, ])</span>
<span id="cb127-374"><a href="#cb127-374" aria-hidden="true" tabindex="-1"></a>  train_mat <span class="ot">&lt;-</span> train_mat[, <span class="fu">colnames</span>(train_mat) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb127-375"><a href="#cb127-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-376"><a href="#cb127-376" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_df<span class="sc">$</span>trainX), <span class="fu">ncol</span>(train_mat))</span>
<span id="cb127-377"><a href="#cb127-377" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(train_mat <span class="sc">-</span> res_df<span class="sc">$</span>trainX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-378"><a href="#cb127-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-379"><a href="#cb127-379" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res_df<span class="sc">$</span>testX)))</span>
<span id="cb127-380"><a href="#cb127-380" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res_df<span class="sc">$</span>testX))</span>
<span id="cb127-381"><a href="#cb127-381" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df<span class="sc">$</span>testX))</span>
<span id="cb127-382"><a href="#cb127-382" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res_df<span class="sc">$</span>testX), <span class="fu">length</span>(test_inds))</span>
<span id="cb127-383"><a href="#cb127-383" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-384"><a href="#cb127-384" aria-hidden="true" tabindex="-1"></a>  test_mat <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X_df[test_inds, ])</span>
<span id="cb127-385"><a href="#cb127-385" aria-hidden="true" tabindex="-1"></a>  test_mat <span class="ot">&lt;-</span> test_mat[, <span class="fu">colnames</span>(test_mat) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb127-386"><a href="#cb127-386" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-387"><a href="#cb127-387" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res_df<span class="sc">$</span>testX), <span class="fu">ncol</span>(test_mat))</span>
<span id="cb127-388"><a href="#cb127-388" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(test_mat <span class="sc">-</span> res_df<span class="sc">$</span>testX) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb127-389"><a href="#cb127-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-390"><a href="#cb127-390" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-391"><a href="#cb127-391" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## ── Warning (&#39;&lt;text&gt;:251&#39;): checkGetCssPredsInputs works ────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. testthat::expect_warning(...)
##  7. litr (local) checkGetCssPredsInputs(...)
##  8. litr (local) checkXInputResults(testX, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:278&#39;): checkGetCssPredsInputs works ────────────────────────
## Column names were provided for testX but not for trainX (are you sure they both contain identical features in the same order?)
## Backtrace:
##  1. litr (local) checkGetCssPredsInputs(...)
## 
## ── Warning (&#39;&lt;text&gt;:357&#39;): checkGetCssPredsInputs works ────────────────────────
## Column names were provided for testX but not for trainX (are you sure they both contain identical features in the same order?)
## Backtrace:
##  1. litr (local) checkGetCssPredsInputs(...)</code></pre>
<p>Finally, tests for <code>getCssPreds()</code></p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getCssPreds works&quot;</span>, {</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">70811</span>)</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>  x_select <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>  x_train <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">8</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>  x_pred <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">7</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">7</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>  y_select <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>  y_train <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">8</span>)</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;red&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="st">&quot;blue&quot;</span><span class="ot">=</span><span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>, <span class="st">&quot;green&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>  css_res <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train)</span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">7</span>)</span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">##### Try other bad inputs</span></span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">cutoff=</span><span class="sc">-</span><span class="fl">0.5</span>,</span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;cutoff &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">cutoff=</span><span class="st">&quot;0.3&quot;</span>,</span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(cutoff) | is.integer(cutoff) is not TRUE&quot;</span>,</span>
<span id="cb129-30"><a href="#cb129-30" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-31"><a href="#cb129-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-32"><a href="#cb129-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb129-33"><a href="#cb129-33" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">cutoff=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">trainX=</span>x_train,</span>
<span id="cb129-34"><a href="#cb129-34" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainY=</span>y_train),</span>
<span id="cb129-35"><a href="#cb129-35" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;!is.na(cutoff) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-36"><a href="#cb129-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-37"><a href="#cb129-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb129-38"><a href="#cb129-38" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">weighting=</span><span class="fu">c</span>(<span class="st">&quot;sparse&quot;</span>, <span class="st">&quot;simple_avg&quot;</span>),</span>
<span id="cb129-39"><a href="#cb129-39" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-40"><a href="#cb129-40" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(weighting) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-41"><a href="#cb129-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-42"><a href="#cb129-42" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">weighting=</span><span class="dv">2</span>,</span>
<span id="cb129-43"><a href="#cb129-43" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-44"><a href="#cb129-44" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-45"><a href="#cb129-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-46"><a href="#cb129-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">weighting=</span><span class="st">&quot;spasre&quot;</span>,</span>
<span id="cb129-47"><a href="#cb129-47" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-48"><a href="#cb129-48" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Weighting must be a character and one of sparse, simple_avg, or weighted_avg&quot;</span>,</span>
<span id="cb129-49"><a href="#cb129-49" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-50"><a href="#cb129-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-51"><a href="#cb129-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred,</span>
<span id="cb129-52"><a href="#cb129-52" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">min_num_clusts=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">trainX=</span>x_train,</span>
<span id="cb129-53"><a href="#cb129-53" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainY=</span>y_train),</span>
<span id="cb129-54"><a href="#cb129-54" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(min_num_clusts) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-55"><a href="#cb129-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-56"><a href="#cb129-56" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">min_num_clusts=</span><span class="st">&quot;2&quot;</span>,</span>
<span id="cb129-57"><a href="#cb129-57" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-58"><a href="#cb129-58" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(min_num_clusts) | is.integer(min_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb129-59"><a href="#cb129-59" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-60"><a href="#cb129-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-61"><a href="#cb129-61" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">min_num_clusts=</span><span class="dv">0</span>,</span>
<span id="cb129-62"><a href="#cb129-62" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-63"><a href="#cb129-63" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-64"><a href="#cb129-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-65"><a href="#cb129-65" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">min_num_clusts=</span><span class="dv">10</span>,</span>
<span id="cb129-66"><a href="#cb129-66" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-67"><a href="#cb129-67" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-68"><a href="#cb129-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-69"><a href="#cb129-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-70"><a href="#cb129-70" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">max_num_clusts=</span><span class="st">&quot;5&quot;</span>,</span>
<span id="cb129-71"><a href="#cb129-71" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-72"><a href="#cb129-72" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(max_num_clusts) | is.integer(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb129-73"><a href="#cb129-73" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-74"><a href="#cb129-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-75"><a href="#cb129-75" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">max_num_clusts=</span><span class="fl">4.5</span>,</span>
<span id="cb129-76"><a href="#cb129-76" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-77"><a href="#cb129-77" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts == round(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb129-78"><a href="#cb129-78" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-79"><a href="#cb129-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-80"><a href="#cb129-80" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">min_num_clusts=</span><span class="dv">3</span>,</span>
<span id="cb129-81"><a href="#cb129-81" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">max_num_clusts=</span><span class="dv">2</span>, <span class="at">trainX=</span>x_train,</span>
<span id="cb129-82"><a href="#cb129-82" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainY=</span>y_train),</span>
<span id="cb129-83"><a href="#cb129-83" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &gt;= min_num_clusts is not TRUE&quot;</span>,</span>
<span id="cb129-84"><a href="#cb129-84" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-85"><a href="#cb129-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-86"><a href="#cb129-86" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred, <span class="at">max_num_clusts=</span><span class="dv">10</span>,</span>
<span id="cb129-87"><a href="#cb129-87" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-88"><a href="#cb129-88" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-89"><a href="#cb129-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-90"><a href="#cb129-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add training indices</span></span>
<span id="cb129-91"><a href="#cb129-91" aria-hidden="true" tabindex="-1"></a>  css_res_train <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb129-92"><a href="#cb129-92" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B=</span><span class="dv">10</span>, <span class="at">train_inds=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb129-93"><a href="#cb129-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-94"><a href="#cb129-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Training indices should be ignored if new x is provided</span></span>
<span id="cb129-95"><a href="#cb129-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-96"><a href="#cb129-96" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getCssPreds</span>(css_res_train, <span class="at">testX=</span>x_pred, <span class="at">trainX=</span>x_train,</span>
<span id="cb129-97"><a href="#cb129-97" aria-hidden="true" tabindex="-1"></a>                     <span class="at">trainY=</span>y_train)</span>
<span id="cb129-98"><a href="#cb129-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-99"><a href="#cb129-99" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb129-100"><a href="#cb129-100" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb129-101"><a href="#cb129-101" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">7</span>)</span>
<span id="cb129-102"><a href="#cb129-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-103"><a href="#cb129-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Things should still work if new x is not provided</span></span>
<span id="cb129-104"><a href="#cb129-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-105"><a href="#cb129-105" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getCssPreds</span>(css_res_train, <span class="at">testX=</span>x_pred)</span>
<span id="cb129-106"><a href="#cb129-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-107"><a href="#cb129-107" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb129-108"><a href="#cb129-108" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb129-109"><a href="#cb129-109" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">7</span>)</span>
<span id="cb129-110"><a href="#cb129-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-111"><a href="#cb129-111" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try not providing training indices and omitting newX--should get error</span></span>
<span id="cb129-112"><a href="#cb129-112" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res, <span class="at">testX=</span>x_pred),</span>
<span id="cb129-113"><a href="#cb129-113" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;css was not provided with indices to set aside for model training (train_inds), so must provide new X in order to generate a design matrix&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-114"><a href="#cb129-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-115"><a href="#cb129-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try naming variables</span></span>
<span id="cb129-116"><a href="#cb129-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-117"><a href="#cb129-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_select) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb129-118"><a href="#cb129-118" aria-hidden="true" tabindex="-1"></a>  css_res_named <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_select, <span class="at">y=</span>y_select, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb129-119"><a href="#cb129-119" aria-hidden="true" tabindex="-1"></a>                       <span class="at">clusters=</span>good_clusters, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb129-120"><a href="#cb129-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-121"><a href="#cb129-121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Named variables for css matrix but not new one--should get a warning</span></span>
<span id="cb129-122"><a href="#cb129-122" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_warning</span>(<span class="fu">getCssPreds</span>(css_res_named, <span class="at">testX=</span>x_pred,</span>
<span id="cb129-123"><a href="#cb129-123" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-124"><a href="#cb129-124" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;New X provided had no variable names (column names) even though the X provided to css did.&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-125"><a href="#cb129-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-126"><a href="#cb129-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try mismatching variable names</span></span>
<span id="cb129-127"><a href="#cb129-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_train) <span class="ot">&lt;-</span> LETTERS[<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>]</span>
<span id="cb129-128"><a href="#cb129-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_pred) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb129-129"><a href="#cb129-129" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res_named, <span class="at">testX=</span>x_pred,</span>
<span id="cb129-130"><a href="#cb129-130" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-131"><a href="#cb129-131" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;identical(feat_names, colnames(css_X)) is not TRUE&quot;</span>,</span>
<span id="cb129-132"><a href="#cb129-132" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-133"><a href="#cb129-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-134"><a href="#cb129-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_train) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb129-135"><a href="#cb129-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_pred) <span class="ot">&lt;-</span> LETTERS[<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>]</span>
<span id="cb129-136"><a href="#cb129-136" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getCssPreds</span>(css_res_named, <span class="at">testX=</span>x_pred,</span>
<span id="cb129-137"><a href="#cb129-137" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">trainX=</span>x_train, <span class="at">trainY=</span>y_train),</span>
<span id="cb129-138"><a href="#cb129-138" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;identical(feat_names, colnames(css_X)) is not TRUE&quot;</span>,</span>
<span id="cb129-139"><a href="#cb129-139" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb129-140"><a href="#cb129-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-141"><a href="#cb129-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_pred) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb129-142"><a href="#cb129-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-143"><a href="#cb129-143" aria-hidden="true" tabindex="-1"></a>  res_named <span class="ot">&lt;-</span> <span class="fu">getCssPreds</span>(css_res_named, <span class="at">testX=</span>x_pred, <span class="at">trainX=</span>x_train,</span>
<span id="cb129-144"><a href="#cb129-144" aria-hidden="true" tabindex="-1"></a>                           <span class="at">trainY=</span>y_train)</span>
<span id="cb129-145"><a href="#cb129-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-146"><a href="#cb129-146" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb129-147"><a href="#cb129-147" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb129-148"><a href="#cb129-148" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">7</span>)</span>
<span id="cb129-149"><a href="#cb129-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-150"><a href="#cb129-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try data.frame input to css and getCssPreds</span></span>
<span id="cb129-151"><a href="#cb129-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-152"><a href="#cb129-152" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb129-153"><a href="#cb129-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-154"><a href="#cb129-154" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_df)</span>
<span id="cb129-155"><a href="#cb129-155" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(n)</span>
<span id="cb129-156"><a href="#cb129-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-157"><a href="#cb129-157" aria-hidden="true" tabindex="-1"></a>  selec_inds <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">round</span>(n<span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb129-158"><a href="#cb129-158" aria-hidden="true" tabindex="-1"></a>  train_inds <span class="ot">&lt;-</span> (<span class="fu">max</span>(selec_inds) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="fu">max</span>(selec_inds) <span class="sc">+</span> <span class="dv">17</span>)</span>
<span id="cb129-159"><a href="#cb129-159" aria-hidden="true" tabindex="-1"></a>  test_inds <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="fu">c</span>(selec_inds, train_inds))</span>
<span id="cb129-160"><a href="#cb129-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-161"><a href="#cb129-161" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[<span class="fu">c</span>(selec_inds, train_inds), ],</span>
<span id="cb129-162"><a href="#cb129-162" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y=</span>y[<span class="fu">c</span>(selec_inds, train_inds)], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>,</span>
<span id="cb129-163"><a href="#cb129-163" aria-hidden="true" tabindex="-1"></a>                    <span class="at">train_inds=</span>train_inds)</span>
<span id="cb129-164"><a href="#cb129-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-165"><a href="#cb129-165" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">getCssPreds</span>(css_res_df, <span class="at">testX=</span>X_df[test_inds, ])</span>
<span id="cb129-166"><a href="#cb129-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-167"><a href="#cb129-167" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res_df)))</span>
<span id="cb129-168"><a href="#cb129-168" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df))</span>
<span id="cb129-169"><a href="#cb129-169" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res_df), <span class="fu">length</span>(test_inds))</span>
<span id="cb129-170"><a href="#cb129-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-171"><a href="#cb129-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try again with X as a dataframe with factors (number of columns of final</span></span>
<span id="cb129-172"><a href="#cb129-172" aria-hidden="true" tabindex="-1"></a>  <span class="co"># design matrix after one-hot encoding factors won&#39;t match number of columns</span></span>
<span id="cb129-173"><a href="#cb129-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># of X_df)</span></span>
<span id="cb129-174"><a href="#cb129-174" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>cyl)</span>
<span id="cb129-175"><a href="#cb129-175" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>vs)</span>
<span id="cb129-176"><a href="#cb129-176" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>am)</span>
<span id="cb129-177"><a href="#cb129-177" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>gear)</span>
<span id="cb129-178"><a href="#cb129-178" aria-hidden="true" tabindex="-1"></a>  X_df<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(X_df<span class="sc">$</span>carb)</span>
<span id="cb129-179"><a href="#cb129-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-180"><a href="#cb129-180" aria-hidden="true" tabindex="-1"></a>  css_res_df <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_df[selec_inds, ], <span class="at">y=</span>y[selec_inds], <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">B =</span> <span class="dv">10</span>)</span>
<span id="cb129-181"><a href="#cb129-181" aria-hidden="true" tabindex="-1"></a>  res_df <span class="ot">&lt;-</span> <span class="fu">getCssPreds</span>(css_res_df, <span class="at">testX=</span>X_df[test_inds, ],</span>
<span id="cb129-182"><a href="#cb129-182" aria-hidden="true" tabindex="-1"></a>                        <span class="at">trainX=</span>X_df[train_inds, ], <span class="at">trainY=</span>y[train_inds])</span>
<span id="cb129-183"><a href="#cb129-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-184"><a href="#cb129-184" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span><span class="al">TODO</span><span class="co">(gregfaletto): known issue--the above code produces the following</span></span>
<span id="cb129-185"><a href="#cb129-185" aria-hidden="true" tabindex="-1"></a>  <span class="co"># undesired warnings:</span></span>
<span id="cb129-186"><a href="#cb129-186" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1: In checkGetCssPredsInputs(css_results, testX, weighting, cutoff,  :</span></span>
<span id="cb129-187"><a href="#cb129-187" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Column names were provided for testX but not for trainX (are you sure they both contain identical features in the same order?)</span></span>
<span id="cb129-188"><a href="#cb129-188" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2: In checkXInputResults(newx, css_results$X) :</span></span>
<span id="cb129-189"><a href="#cb129-189" aria-hidden="true" tabindex="-1"></a>  <span class="co"># New X provided had no variable names (column names) even though the X provided to css did.</span></span>
<span id="cb129-190"><a href="#cb129-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-191"><a href="#cb129-191" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res_df)))</span>
<span id="cb129-192"><a href="#cb129-192" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res_df))</span>
<span id="cb129-193"><a href="#cb129-193" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res_df), <span class="fu">length</span>(test_inds))</span>
<span id="cb129-194"><a href="#cb129-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-195"><a href="#cb129-195" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## ── Warning (&#39;&lt;text&gt;:122&#39;): getCssPreds works ───────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. testthat::expect_warning(...)
##  7. litr (local) getCssPreds(...)
##  8. litr (local) checkGetCssPredsInputs(...)
##  9. litr (local) checkXInputResults(testX, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:122&#39;): getCssPreds works ───────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##   1. testthat::expect_warning(...)
##   7. litr (local) getCssPreds(...)
##   8. litr (local) formCssDesign(...)
##   9. litr (local) checkFormCssDesignInputs(...)
##  10. litr (local) checkXInputResults(newx, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:122&#39;): getCssPreds works ───────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##   1. testthat::expect_warning(...)
##   7. litr (local) getCssPreds(...)
##   8. litr (local) formCssDesign(...)
##   9. litr (local) checkFormCssDesignInputs(...)
##  10. litr (local) checkXInputResults(newx, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:143&#39;): getCssPreds works ───────────────────────────────────
## Column names were provided for testX but not for trainX (are you sure they both contain identical features in the same order?)
## Backtrace:
##  1. litr (local) getCssPreds(...)
##  2. litr (local) checkGetCssPredsInputs(...)
## 
## ── Warning (&#39;&lt;text&gt;:143&#39;): getCssPreds works ───────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. litr (local) getCssPreds(...)
##  2. litr (local) formCssDesign(...)
##  3. litr (local) checkFormCssDesignInputs(...)
##  4. litr (local) checkXInputResults(newx, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:181&#39;): getCssPreds works ───────────────────────────────────
## Column names were provided for testX but not for trainX (are you sure they both contain identical features in the same order?)
## Backtrace:
##  1. litr (local) getCssPreds(...)
##  2. litr (local) checkGetCssPredsInputs(...)
## 
## ── Warning (&#39;&lt;text&gt;:181&#39;): getCssPreds works ───────────────────────────────────
## New X provided had no variable names (column names) even though the X provided to css did.
## Backtrace:
##  1. litr (local) getCssPreds(...)
##  2. litr (local) formCssDesign(...)
##  3. litr (local) checkFormCssDesignInputs(...)
##  4. litr (local) checkXInputResults(newx, css_results$X)
## 
## ── Warning (&#39;&lt;text&gt;:181&#39;): getCssPreds works ───────────────────────────────────
## prediction from a rank-deficient fit may be misleading
## Backtrace:
##  1. litr (local) getCssPreds(...)
##  2. stats::predict.lm(model, newdata = df_test)</code></pre>
</div>
<div id="other-useful" class="section level1 hasAnchor" number="6">
<h1 class="hasAnchor"><span class="header-section-number">6</span> Other useful functions<a href="#other-useful" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The following are some other functions that are useful for specific tasks.</p>
<ul>
<li><p><code>genClusteredData()</code> generates jointly Gaussian data sets that include clusters of features that are correlated with a latent feature (the latent features themselves are also provided).</p></li>
<li><p><code>getLassoLambda()</code> uses a data set to choose a good value of lambda for subsamples of size n/2 (as in cluster stability selection) by cross-validation.</p></li>
<li><p><code>getModelSize()</code> estimates the best size for a lasso model on a provided data set.</p></li>
<li><p><code>printCssDf()</code> converts the output of the <code>css()</code> function (an object of class cssr) to a data.frame that is ready to be printed. We provide end-user access to <code>printCssDf()</code> because this data.frame itself may be useful as an object that summarizes the output from <code>css()</code>.</p></li>
<li><p><code>print.cssr()</code> is the print function for objects of class cssr.</p></li>
<li><p><code>genClusteredData()</code></p>
<ul>
<li><code>checkGenClusteredDataInputs()</code> checks that the inputs to <code>genClusteredData()</code> are as expected.</li>
<li><code>makeCovarianceMatrix()</code> generates a covariance matrix for a jointly Gaussian random variable with distribution matching the provided inputs.</li>
<li><code>makeCoefficients()</code> generates a coefficient vector for the response according to the provided inputs.</li>
<li>Finally, <code>genMuXZSd()</code> draws a random Z (matrix of latent variables), X (observed matrix, containing, in general, features correlated with latent features, directly observed features that are associated with y, and noise features), conditional means mu, and observed responses y.</li>
</ul></li>
<li><p><code>getLassoLambda()</code></p></li>
<li><p><code>getModelSize()</code></p></li>
<li><p><code>printCssDf()</code></p>
<ul>
<li><code>getSelectionPrototypes()</code> identifies the prototypes from selected clusters (the feature in each cluster that is most correlated with the response)</li>
</ul></li>
<li><p><code>print.cssr()</code></p></li>
</ul>
<p><code>genClusteredData()</code></p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generate randomly sampled data including noisy observations of latent</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; variables</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span><span class="al">TODO</span><span class="co">(gregfaletto) change cluster_size into a vector of sizes (maybe also</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; deprecate n_clusters as an input, since this would be inferred by the length</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of cluster_sizes?)</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generate a data set including latent features Z, observed features X (which</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; may include noisy or noiseless observations of the latent features in Z),</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; an observed response y which is a linear model of features from Z and X as</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; well as independent mean zero noise, and mu (the responses from y without</span></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the added noise). Data is generated in the same way as in the simulations</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; from Faletto and Bien (2022).</span></span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n Integer or numeric; the number of observations to generate. (The</span></span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generated X and Z will have n rows, and the generated y and mu will have</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; length n.)</span></span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p Integer or numeric; the number of features to generate. The</span></span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generated X will have p columns.</span></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param k_unclustered Integer or numeric; the number of features in X that</span></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will have nonzero coefficients in the true model for y among those features </span></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; not generated from the n_clusters latent variables (called &quot;weak signal&quot; </span></span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features in the simulations from Faletto and Bien 2022). The coefficients on</span></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; these features will be determined by beta_unclustered.</span></span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cluster_size Integer or numeric; for each of the n_clusters latent</span></span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; variables, X will contain cluster_size noisy proxies that are correlated with</span></span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the latent variable.</span></span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n_clusters Integer or numeric; the number of latent variables to</span></span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generate, each of which will be associated with an observed cluster in X.</span></span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Must be at least 1. Default is 1.</span></span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sig_clusters Integer or numeric; the number of generated latent</span></span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features that will have nonzero coefficients in the true model for y (all of</span></span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; them will have coefficient beta_latent). Must be less than or equal to</span></span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; n_clusters. Default is 1.</span></span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param rho Integer or numeric; the covariance of the proxies in each cluster</span></span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; with the latent variable (and each other). Note that the correlation between</span></span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the features in the cluster will be rho/var. Can&#39;t equal 0. Default is 0.9.</span></span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param var Integer or numeric; the variance of all of the observed features</span></span>
<span id="cb131-37"><a href="#cb131-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in X (both the proxies for the latent variables and the k_unclustered other</span></span>
<span id="cb131-38"><a href="#cb131-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features). Can&#39;t equal 0. Default is 1.</span></span>
<span id="cb131-39"><a href="#cb131-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param beta_latent Integer or numeric; the coefficient used for all</span></span>
<span id="cb131-40"><a href="#cb131-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; sig_clusters latent variables that have nonzero coefficients in the true</span></span>
<span id="cb131-41"><a href="#cb131-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; model for y. Can&#39;t equal 0. Default is 1.5.</span></span>
<span id="cb131-42"><a href="#cb131-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param beta_unclustered Integer or numeric; the maximum coefficient in the</span></span>
<span id="cb131-43"><a href="#cb131-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; model for y among the k_unclustered features in X not generated from the</span></span>
<span id="cb131-44"><a href="#cb131-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; latent variables. The coefficients of the features will be</span></span>
<span id="cb131-45"><a href="#cb131-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; beta_unclustered/sqrt(1:k_unclustered). Can&#39;t equal 0. Default is 1.</span></span>
<span id="cb131-46"><a href="#cb131-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param snr Integer or numeric; the signal-to-noise ratio of the response</span></span>
<span id="cb131-47"><a href="#cb131-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; y. If sigma_eps_sq is not specified, the variance of the noise in y will be</span></span>
<span id="cb131-48"><a href="#cb131-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; calculated using the formula sigma_eps_sq = sum(mu^2)/(n * snr). Only one of</span></span>
<span id="cb131-49"><a href="#cb131-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; snr and sigma_eps_sq must be specified. Default is NA.</span></span>
<span id="cb131-50"><a href="#cb131-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sigma_eps_sq Integer or numeric; the variance on the noise added</span></span>
<span id="cb131-51"><a href="#cb131-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to y. Only one of snr and sigma_eps_sq must be specified. Default is NA.</span></span>
<span id="cb131-52"><a href="#cb131-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list of the following elements. \item{X}{An n x p numeric matrix of</span></span>
<span id="cb131-53"><a href="#cb131-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; n observations from a p-dimensional multivariate normal distribution</span></span>
<span id="cb131-54"><a href="#cb131-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generated using the specified parameters. The first n_clusters times</span></span>
<span id="cb131-55"><a href="#cb131-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster_size features will be the clusters of features correlated with the</span></span>
<span id="cb131-56"><a href="#cb131-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; n_clusters latent variables. The next k_unclustered features will be the</span></span>
<span id="cb131-57"><a href="#cb131-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;weak signal&quot; features, and the remaining p - n_clusters*cluster_size -</span></span>
<span id="cb131-58"><a href="#cb131-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; k_unclustered features will be the unclustered noise features.} \item{y}{A</span></span>
<span id="cb131-59"><a href="#cb131-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; length n numeric vector; the response generated from X, the latent features</span></span>
<span id="cb131-60"><a href="#cb131-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; from Z, and the coefficient vector, along with additive noise.} \item{Z}{The</span></span>
<span id="cb131-61"><a href="#cb131-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; latent features; either a numeric vector (if n_clusters &gt; 1) or a numeric</span></span>
<span id="cb131-62"><a href="#cb131-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; matrix (if n_clusters &gt; 1). Note that (X, Z) is multivariate Gaussian.}</span></span>
<span id="cb131-63"><a href="#cb131-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; item{mu}{A length `n` numeric vector; the expected response given X, Z, and</span></span>
<span id="cb131-64"><a href="#cb131-64" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the true coefficient vector (equal to y minus the added noise).}</span></span>
<span id="cb131-65"><a href="#cb131-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb131-66"><a href="#cb131-66" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references</span></span>
<span id="cb131-67"><a href="#cb131-67" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>faletto2022<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb131-68"><a href="#cb131-68" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb131-69"><a href="#cb131-69" aria-hidden="true" tabindex="-1"></a>genClusteredData <span class="ot">&lt;-</span> <span class="cf">function</span>(n, p, k_unclustered, cluster_size, <span class="at">n_clusters=</span><span class="dv">1</span>,</span>
<span id="cb131-70"><a href="#cb131-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">sig_clusters=</span><span class="dv">1</span>, <span class="at">rho=</span><span class="fl">0.9</span>, <span class="at">var=</span><span class="dv">1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>, <span class="at">beta_unclustered=</span><span class="dv">1</span>,</span>
<span id="cb131-71"><a href="#cb131-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">snr=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">sigma_eps_sq=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>)){</span>
<span id="cb131-72"><a href="#cb131-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-73"><a href="#cb131-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb131-74"><a href="#cb131-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkGenClusteredDataInputs</span>(p, k_unclustered, cluster_size, n_clusters,</span>
<span id="cb131-75"><a href="#cb131-75" aria-hidden="true" tabindex="-1"></a>        sig_clusters, rho, var, beta_latent, beta_unclustered, snr,</span>
<span id="cb131-76"><a href="#cb131-76" aria-hidden="true" tabindex="-1"></a>        sigma_eps_sq)</span>
<span id="cb131-77"><a href="#cb131-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-78"><a href="#cb131-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate covariance matrix (latent features are mixed in matrix, so each</span></span>
<span id="cb131-79"><a href="#cb131-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cluster will be of size cluster_size + 1)</span></span>
<span id="cb131-80"><a href="#cb131-80" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="ot">&lt;-</span> <span class="fu">makeCovarianceMatrix</span>(<span class="at">p=</span>p <span class="sc">+</span> n_clusters, <span class="at">nblocks=</span>n_clusters,</span>
<span id="cb131-81"><a href="#cb131-81" aria-hidden="true" tabindex="-1"></a>        <span class="at">block_size=</span>cluster_size <span class="sc">+</span> <span class="dv">1</span>, <span class="at">rho=</span>rho, <span class="at">var=</span>var)</span>
<span id="cb131-82"><a href="#cb131-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-83"><a href="#cb131-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate coefficients</span></span>
<span id="cb131-84"><a href="#cb131-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note that beta has length p + sig_clusters</span></span>
<span id="cb131-85"><a href="#cb131-85" aria-hidden="true" tabindex="-1"></a>    coefs <span class="ot">&lt;-</span> <span class="fu">makeCoefficients</span>(<span class="at">p=</span>p <span class="sc">+</span> n_clusters, <span class="at">k_unblocked=</span>k_unclustered,</span>
<span id="cb131-86"><a href="#cb131-86" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta_low=</span>beta_unclustered, <span class="at">beta_high=</span>beta_latent, <span class="at">nblocks=</span>n_clusters,</span>
<span id="cb131-87"><a href="#cb131-87" aria-hidden="true" tabindex="-1"></a>        <span class="at">sig_blocks=</span>sig_clusters, <span class="at">block_size=</span>cluster_size <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb131-88"><a href="#cb131-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-89"><a href="#cb131-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate mu, X, z, sd, y</span></span>
<span id="cb131-90"><a href="#cb131-90" aria-hidden="true" tabindex="-1"></a>    gen_mu_x_z_sd_res <span class="ot">&lt;-</span> <span class="fu">genMuXZSd</span>(<span class="at">n=</span>n, <span class="at">p=</span>p, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb131-91"><a href="#cb131-91" aria-hidden="true" tabindex="-1"></a>        <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars, <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, </span>
<span id="cb131-92"><a href="#cb131-92" aria-hidden="true" tabindex="-1"></a>        <span class="at">block_size=</span>cluster_size, <span class="at">n_blocks=</span>n_clusters, <span class="at">snr=</span>snr,</span>
<span id="cb131-93"><a href="#cb131-93" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma_eps_sq=</span>sigma_eps_sq)</span>
<span id="cb131-94"><a href="#cb131-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-95"><a href="#cb131-95" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> gen_mu_x_z_sd_res<span class="sc">$</span>mu</span>
<span id="cb131-96"><a href="#cb131-96" aria-hidden="true" tabindex="-1"></a>    sd <span class="ot">&lt;-</span> gen_mu_x_z_sd_res<span class="sc">$</span>sd</span>
<span id="cb131-97"><a href="#cb131-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-98"><a href="#cb131-98" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> mu <span class="sc">+</span> sd <span class="sc">*</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(n)</span>
<span id="cb131-99"><a href="#cb131-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-100"><a href="#cb131-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">X=</span>gen_mu_x_z_sd_res<span class="sc">$</span>X, <span class="at">y=</span>y, <span class="at">Z=</span>gen_mu_x_z_sd_res<span class="sc">$</span>z, <span class="at">mu=</span>mu))</span>
<span id="cb131-101"><a href="#cb131-101" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkGenClusteredDataInputs()</code> ## NEED TO START WITH ROXYGEN FORMATTING</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span><span class="al">TODO</span><span class="co">(gregfaletto) fix this description!!!</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Check inputs to genClusteredData</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generate a data set including latent features Z, observed features X (which</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; may include noisy or noiseless observations of the latent features in Z),</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; an observed response y which is a linear model of features from Z and X as</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; well as independent mean zero noise, and mu (the responses from y without</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the added noise). Data is generated in the same way as in the simulations</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; from Faletto and Bien (2022).</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p Integer or numeric; the number of features to generate. The</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generated X will have p columns.</span></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param k_unclustered Integer or numeric; the number of features in X that</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will have nonzero coefficients in the true model for y among those features </span></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; not generated from the n_clusters latent variables (called &quot;weak signal&quot; </span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features in the simulations from Faletto and Bien 2022). The coefficients on</span></span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; these features will be determined by beta_unclustered.</span></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cluster_size Integer or numeric; for each of the n_clusters latent</span></span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; variables, X will contain cluster_size noisy proxies that are correlated with</span></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the latent variable.</span></span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n_clusters Integer or numeric; the number of latent variables to</span></span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generate, each of which will be associated with an observed cluster in X.</span></span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Must be at least 1. Default is 1.</span></span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sig_clusters Integer or numeric; the number of generated latent</span></span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features that will have nonzero coefficients in the true model for y (all of</span></span>
<span id="cb132-25"><a href="#cb132-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; them will have coefficient beta_latent). Must be less than or equal to</span></span>
<span id="cb132-26"><a href="#cb132-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; n_clusters. Default is 1.</span></span>
<span id="cb132-27"><a href="#cb132-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param rho Integer or numeric; the covariance of the proxies in each cluster</span></span>
<span id="cb132-28"><a href="#cb132-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; with the latent variable (and each other). Note that the correlation between</span></span>
<span id="cb132-29"><a href="#cb132-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the features in the cluster will be rho/var. Can&#39;t equal 0. Default is 0.9.</span></span>
<span id="cb132-30"><a href="#cb132-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param var Integer or numeric; the variance of all of the observed features</span></span>
<span id="cb132-31"><a href="#cb132-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in X (both the proxies for the latent variables and the k_unclustered other</span></span>
<span id="cb132-32"><a href="#cb132-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features). Can&#39;t equal 0. Default is 1.</span></span>
<span id="cb132-33"><a href="#cb132-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param beta_latent Integer or numeric; the coefficient used for all</span></span>
<span id="cb132-34"><a href="#cb132-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; sig_clusters latent variables that have nonzero coefficients in the true</span></span>
<span id="cb132-35"><a href="#cb132-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; model for y. Can&#39;t equal 0. Default is 1.5.</span></span>
<span id="cb132-36"><a href="#cb132-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param beta_unclustered Integer or numeric; the maximum coefficient in the</span></span>
<span id="cb132-37"><a href="#cb132-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; model for y among the k_unclustered features in X not generated from the</span></span>
<span id="cb132-38"><a href="#cb132-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; latent variables. The coefficients of the features will be</span></span>
<span id="cb132-39"><a href="#cb132-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; beta_unclustered/sqrt(1:k_unclustered). Can&#39;t equal 0. Default is 1.</span></span>
<span id="cb132-40"><a href="#cb132-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param snr Integer or numeric; the signal-to-noise ratio of the response</span></span>
<span id="cb132-41"><a href="#cb132-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; y. If sigma_eps_sq is not specified, the variance of the noise in y will be</span></span>
<span id="cb132-42"><a href="#cb132-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; calculated using the formula sigma_eps_sq = sum(mu^2)/(n * snr). Only one of</span></span>
<span id="cb132-43"><a href="#cb132-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; snr and sigma_eps_sq must be specified. Default is NA.</span></span>
<span id="cb132-44"><a href="#cb132-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sigma_eps_sq Integer or numeric; the variance on the noise added</span></span>
<span id="cb132-45"><a href="#cb132-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to y. Only one of snr and sigma_eps_sq must be specified. Default is NA.</span></span>
<span id="cb132-46"><a href="#cb132-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list of the following elements. \item{X}{An n x p numeric matrix of</span></span>
<span id="cb132-47"><a href="#cb132-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; n observations from a p-dimensional multivariate normal distribution</span></span>
<span id="cb132-48"><a href="#cb132-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generated using the specified parameters. The first n_clusters times</span></span>
<span id="cb132-49"><a href="#cb132-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster_size features will be the clusters of features correlated with the</span></span>
<span id="cb132-50"><a href="#cb132-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; n_clusters latent variables. The next k_unclustered features will be the</span></span>
<span id="cb132-51"><a href="#cb132-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;weak signal&quot; features, and the remaining p - n_clusters*cluster_size -</span></span>
<span id="cb132-52"><a href="#cb132-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; k_unclustered features will be the unclustered noise features.} \item{y}{A</span></span>
<span id="cb132-53"><a href="#cb132-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; length n numeric vector; the response generated from X, the latent features</span></span>
<span id="cb132-54"><a href="#cb132-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; from Z, and the coefficient vector, along with additive noise.} \item{Z}{The</span></span>
<span id="cb132-55"><a href="#cb132-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; latent features; either a numeric vector (if n_clusters &gt; 1) or a numeric</span></span>
<span id="cb132-56"><a href="#cb132-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; matrix (if n_clusters &gt; 1). Note that (X, Z) is multivariate Gaussian.}</span></span>
<span id="cb132-57"><a href="#cb132-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; item{mu}{A length `n` numeric vector; the expected response given X, Z, and</span></span>
<span id="cb132-58"><a href="#cb132-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the true coefficient vector (equal to y minus the added noise).}</span></span>
<span id="cb132-59"><a href="#cb132-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb132-60"><a href="#cb132-60" aria-hidden="true" tabindex="-1"></a>checkGenClusteredDataInputs <span class="ot">&lt;-</span> <span class="cf">function</span>(p, k_unclustered, cluster_size,</span>
<span id="cb132-61"><a href="#cb132-61" aria-hidden="true" tabindex="-1"></a>    n_clusters, sig_clusters, rho, var, beta_latent, beta_unclustered, snr,</span>
<span id="cb132-62"><a href="#cb132-62" aria-hidden="true" tabindex="-1"></a>    sigma_eps_sq){</span>
<span id="cb132-63"><a href="#cb132-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-64"><a href="#cb132-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(sig_clusters) <span class="sc">|</span> <span class="fu">is.integer</span>(sig_clusters))</span>
<span id="cb132-65"><a href="#cb132-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(sig_clusters <span class="sc">&lt;=</span> n_clusters)</span>
<span id="cb132-66"><a href="#cb132-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(sig_clusters <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb132-67"><a href="#cb132-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(sig_clusters <span class="sc">==</span> <span class="fu">round</span>(sig_clusters))</span>
<span id="cb132-68"><a href="#cb132-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-69"><a href="#cb132-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(n_clusters) <span class="sc">|</span> <span class="fu">is.integer</span>(n_clusters))</span>
<span id="cb132-70"><a href="#cb132-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n_clusters <span class="sc">==</span> <span class="fu">round</span>(n_clusters))</span>
<span id="cb132-71"><a href="#cb132-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">(gregfaletto): is it easy to remove the requirement that n_clusters is</span></span>
<span id="cb132-72"><a href="#cb132-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># at least 1 (so that it&#39;s possible to generate data with no latent </span></span>
<span id="cb132-73"><a href="#cb132-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># features)? If so, should only check that cluster_size &gt;= 1 if n_clusters</span></span>
<span id="cb132-74"><a href="#cb132-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># &gt;= 1, and in makeCovarianceMatrix function only need block_size &gt;= 1</span></span>
<span id="cb132-75"><a href="#cb132-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rather than 2.</span></span>
<span id="cb132-76"><a href="#cb132-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n_clusters <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb132-77"><a href="#cb132-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-78"><a href="#cb132-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(cluster_size <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb132-79"><a href="#cb132-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-80"><a href="#cb132-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">abs</span>(rho) <span class="sc">&lt;=</span> <span class="fu">abs</span>(var))</span>
<span id="cb132-81"><a href="#cb132-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(rho <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb132-82"><a href="#cb132-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(var <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb132-83"><a href="#cb132-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-84"><a href="#cb132-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(beta_latent <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb132-85"><a href="#cb132-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(beta_unclustered <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb132-86"><a href="#cb132-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-87"><a href="#cb132-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(k_unclustered) <span class="sc">|</span> <span class="fu">is.integer</span>(k_unclustered))</span>
<span id="cb132-88"><a href="#cb132-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(k_unclustered <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb132-89"><a href="#cb132-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(k_unclustered <span class="sc">==</span> <span class="fu">round</span>(k_unclustered))</span>
<span id="cb132-90"><a href="#cb132-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-91"><a href="#cb132-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> n_clusters<span class="sc">*</span>cluster_size <span class="sc">+</span> k_unclustered)</span>
<span id="cb132-92"><a href="#cb132-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-93"><a href="#cb132-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Same as make_sparse_blocked_linear_model_random, but ith coefficient</span></span>
<span id="cb132-94"><a href="#cb132-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># of weak signal features is beta_unclustered/sqrt(i) in order to have</span></span>
<span id="cb132-95"><a href="#cb132-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a definitive ranking of weak signal features.</span></span>
<span id="cb132-96"><a href="#cb132-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(snr) <span class="sc">&amp;</span> <span class="fu">is.na</span>(sigma_eps_sq)){</span>
<span id="cb132-97"><a href="#cb132-97" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Must specify one of snr or sigma_eps_sq&quot;</span>)</span>
<span id="cb132-98"><a href="#cb132-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb132-99"><a href="#cb132-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-100"><a href="#cb132-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(snr)){</span>
<span id="cb132-101"><a href="#cb132-101" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(snr <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb132-102"><a href="#cb132-102" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb132-103"><a href="#cb132-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(sigma_eps_sq)){</span>
<span id="cb132-104"><a href="#cb132-104" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(sigma_eps_sq <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb132-105"><a href="#cb132-105" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb132-106"><a href="#cb132-106" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkGenClusteredDataInputs()</code></p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkGenClusteredDataInputs works&quot;</span>, {</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">7612</span>)</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Should get no error</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>, <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>, <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span>.<span class="dv">5</span>)</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>, <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>, <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>                           <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>)</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sig_clusters</span></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="st">&quot;2&quot;</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(sig_clusters) | is.integer(sig_clusters) is not TRUE&quot;</span>,</span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-22"><a href="#cb133-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-23"><a href="#cb133-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-24"><a href="#cb133-24" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-25"><a href="#cb133-25" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">4</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb133-26"><a href="#cb133-26" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-27"><a href="#cb133-27" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-28"><a href="#cb133-28" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-29"><a href="#cb133-29" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sig_clusters &lt;= n_clusters is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-30"><a href="#cb133-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-31"><a href="#cb133-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-32"><a href="#cb133-32" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-33"><a href="#cb133-33" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="sc">-</span><span class="dv">1</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb133-34"><a href="#cb133-34" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-35"><a href="#cb133-35" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-36"><a href="#cb133-36" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-37"><a href="#cb133-37" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sig_clusters &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-38"><a href="#cb133-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-39"><a href="#cb133-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-40"><a href="#cb133-40" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-41"><a href="#cb133-41" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span>.<span class="dv">6</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb133-42"><a href="#cb133-42" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-43"><a href="#cb133-43" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-44"><a href="#cb133-44" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-45"><a href="#cb133-45" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sig_clusters == round(sig_clusters) is not TRUE&quot;</span>,</span>
<span id="cb133-46"><a href="#cb133-46" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-47"><a href="#cb133-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-48"><a href="#cb133-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-49"><a href="#cb133-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># n_clusters</span></span>
<span id="cb133-50"><a href="#cb133-50" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-51"><a href="#cb133-51" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>,</span>
<span id="cb133-52"><a href="#cb133-52" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">n_clusters=</span><span class="st">&quot;3&quot;</span>,</span>
<span id="cb133-53"><a href="#cb133-53" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb133-54"><a href="#cb133-54" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-55"><a href="#cb133-55" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-56"><a href="#cb133-56" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-57"><a href="#cb133-57" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(n_clusters) | is.integer(n_clusters) is not TRUE&quot;</span>,</span>
<span id="cb133-58"><a href="#cb133-58" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-59"><a href="#cb133-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-60"><a href="#cb133-60" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-61"><a href="#cb133-61" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="fl">3.2</span>,</span>
<span id="cb133-62"><a href="#cb133-62" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb133-63"><a href="#cb133-63" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-64"><a href="#cb133-64" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-65"><a href="#cb133-65" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-66"><a href="#cb133-66" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n_clusters == round(n_clusters) is not TRUE&quot;</span>,</span>
<span id="cb133-67"><a href="#cb133-67" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-68"><a href="#cb133-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-69"><a href="#cb133-69" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-70"><a href="#cb133-70" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">0</span>,</span>
<span id="cb133-71"><a href="#cb133-71" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">0</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb133-72"><a href="#cb133-72" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-73"><a href="#cb133-73" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-74"><a href="#cb133-74" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-75"><a href="#cb133-75" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n_clusters &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-76"><a href="#cb133-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-77"><a href="#cb133-77" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-78"><a href="#cb133-78" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span>.<span class="dv">3</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-79"><a href="#cb133-79" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb133-80"><a href="#cb133-80" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-81"><a href="#cb133-81" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-82"><a href="#cb133-82" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-83"><a href="#cb133-83" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;cluster_size &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-84"><a href="#cb133-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-85"><a href="#cb133-85" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">16</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-86"><a href="#cb133-86" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-87"><a href="#cb133-87" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb133-88"><a href="#cb133-88" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-89"><a href="#cb133-89" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-90"><a href="#cb133-90" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-91"><a href="#cb133-91" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;p &gt;= n_clusters * cluster_size + k_unclustered is not TRUE&quot;</span>,</span>
<span id="cb133-92"><a href="#cb133-92" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-93"><a href="#cb133-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-94"><a href="#cb133-94" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-95"><a href="#cb133-95" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-96"><a href="#cb133-96" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="dv">8</span>,</span>
<span id="cb133-97"><a href="#cb133-97" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-98"><a href="#cb133-98" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-99"><a href="#cb133-99" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-100"><a href="#cb133-100" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;abs(rho) &lt;= abs(var) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-101"><a href="#cb133-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-102"><a href="#cb133-102" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-103"><a href="#cb133-103" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-104"><a href="#cb133-104" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="dv">0</span>,</span>
<span id="cb133-105"><a href="#cb133-105" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-106"><a href="#cb133-106" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-107"><a href="#cb133-107" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-108"><a href="#cb133-108" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;rho != 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-109"><a href="#cb133-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-110"><a href="#cb133-110" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-111"><a href="#cb133-111" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-112"><a href="#cb133-112" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb133-113"><a href="#cb133-113" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="sc">-</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-114"><a href="#cb133-114" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-115"><a href="#cb133-115" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-116"><a href="#cb133-116" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;var &gt; 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-117"><a href="#cb133-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-118"><a href="#cb133-118" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-119"><a href="#cb133-119" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-120"><a href="#cb133-120" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb133-121"><a href="#cb133-121" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="dv">0</span>,</span>
<span id="cb133-122"><a href="#cb133-122" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-123"><a href="#cb133-123" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-124"><a href="#cb133-124" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;beta_latent != 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-125"><a href="#cb133-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-126"><a href="#cb133-126" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-127"><a href="#cb133-127" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-128"><a href="#cb133-128" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb133-129"><a href="#cb133-129" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-130"><a href="#cb133-130" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="dv">0</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-131"><a href="#cb133-131" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-132"><a href="#cb133-132" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;beta_unclustered != 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-133"><a href="#cb133-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-134"><a href="#cb133-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># k_unclustered</span></span>
<span id="cb133-135"><a href="#cb133-135" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="st">&quot;2&quot;</span>,</span>
<span id="cb133-136"><a href="#cb133-136" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-137"><a href="#cb133-137" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb133-138"><a href="#cb133-138" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-139"><a href="#cb133-139" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-140"><a href="#cb133-140" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-141"><a href="#cb133-141" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(k_unclustered) | is.integer(k_unclustered) is not TRUE&quot;</span>,</span>
<span id="cb133-142"><a href="#cb133-142" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-143"><a href="#cb133-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-144"><a href="#cb133-144" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb133-145"><a href="#cb133-145" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-146"><a href="#cb133-146" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb133-147"><a href="#cb133-147" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-148"><a href="#cb133-148" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-149"><a href="#cb133-149" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-150"><a href="#cb133-150" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;k_unclustered &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-151"><a href="#cb133-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-152"><a href="#cb133-152" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span>.<span class="dv">2</span>,</span>
<span id="cb133-153"><a href="#cb133-153" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-154"><a href="#cb133-154" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb133-155"><a href="#cb133-155" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-156"><a href="#cb133-156" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb133-157"><a href="#cb133-157" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-158"><a href="#cb133-158" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;k_unclustered == round(k_unclustered) is not TRUE&quot;</span>,</span>
<span id="cb133-159"><a href="#cb133-159" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-160"><a href="#cb133-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-161"><a href="#cb133-161" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-162"><a href="#cb133-162" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-163"><a href="#cb133-163" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb133-164"><a href="#cb133-164" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-165"><a href="#cb133-165" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="cn">NA</span>,</span>
<span id="cb133-166"><a href="#cb133-166" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-167"><a href="#cb133-167" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Must specify one of snr or sigma_eps_sq&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-168"><a href="#cb133-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-169"><a href="#cb133-169" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-170"><a href="#cb133-170" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-171"><a href="#cb133-171" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb133-172"><a href="#cb133-172" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-173"><a href="#cb133-173" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="sc">-</span>.<span class="dv">2</span>,</span>
<span id="cb133-174"><a href="#cb133-174" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb133-175"><a href="#cb133-175" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;snr &gt; 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-176"><a href="#cb133-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-177"><a href="#cb133-177" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGenClusteredDataInputs</span>(<span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb133-178"><a href="#cb133-178" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb133-179"><a href="#cb133-179" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb133-180"><a href="#cb133-180" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb133-181"><a href="#cb133-181" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="cn">NA</span>,</span>
<span id="cb133-182"><a href="#cb133-182" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="sc">-</span>.<span class="dv">3</span>),</span>
<span id="cb133-183"><a href="#cb133-183" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sigma_eps_sq &gt; 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-184"><a href="#cb133-184" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-185"><a href="#cb133-185" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😀</code></pre>
<p><code>makeCovarianceMatrix()</code></p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generate covariance matrix for simulated clustered data</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p Integer or numeric; the total number of features in the covariance</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; matrix to be created, including latent features, the associated noisy proxies</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; with each latent feature, and other (weak signal and noise) features.</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n_blocks Integer or numeric; the number of latent variables in the</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; data, each of which is associated with an observed cluster in X. Must be at</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; least 1.</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param block_size Integer or numeric; for each of the n_blocks latent</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; variables, the covariance matrix will include the original latent feature</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; plus block_size - 1 noisy proxies that are correlated with the latent</span></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; variable.</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param rho Integer or numeric; the covariance of the proxies in each cluster</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; with the latent variable (and each other). Note that the correlation between</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the features in the cluster will be rho/var. rho cannot equal 0.</span></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param var Integer or numeric; the variance of all of the observed features</span></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in X (both the proxies for the latent variables and the k_unclustered other</span></span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features). var cannot equal 0.</span></span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A `p` x `p` numeric matrix representing the covariance matrix for</span></span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the latent features, the associated proxies, and the remaining features. All</span></span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features not in a block will be independent from each other and the blocks</span></span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; and have variance var.</span></span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb135-24"><a href="#cb135-24" aria-hidden="true" tabindex="-1"></a>makeCovarianceMatrix <span class="ot">&lt;-</span> <span class="cf">function</span>(p, nblocks, block_size, rho, var) {</span>
<span id="cb135-25"><a href="#cb135-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb135-26"><a href="#cb135-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-27"><a href="#cb135-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(nblocks <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb135-28"><a href="#cb135-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(rho <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb135-29"><a href="#cb135-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(var <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb135-30"><a href="#cb135-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">abs</span>(rho) <span class="sc">&lt;=</span> <span class="fu">abs</span>(var))</span>
<span id="cb135-31"><a href="#cb135-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(block_size <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb135-32"><a href="#cb135-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> nblocks<span class="sc">*</span>block_size)</span>
<span id="cb135-33"><a href="#cb135-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-34"><a href="#cb135-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># start with p x p identity matrix</span></span>
<span id="cb135-35"><a href="#cb135-35" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="ot">&lt;-</span> var<span class="sc">*</span><span class="fu">diag</span>(p)</span>
<span id="cb135-36"><a href="#cb135-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-37"><a href="#cb135-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create matrix with nblocks rows, each containing a vector of</span></span>
<span id="cb135-38"><a href="#cb135-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># indices of highly correlated features</span></span>
<span id="cb135-39"><a href="#cb135-39" aria-hidden="true" tabindex="-1"></a>    block_feats <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">seq</span>(nblocks<span class="sc">*</span>block_size), <span class="at">nrow=</span>nblocks, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb135-40"><a href="#cb135-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-41"><a href="#cb135-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">unique</span>(block_feats)) <span class="sc">==</span> <span class="fu">length</span>(block_feats))</span>
<span id="cb135-42"><a href="#cb135-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-43"><a href="#cb135-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add covariances of highly correlated features to sigma</span></span>
<span id="cb135-44"><a href="#cb135-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nblocks){</span>
<span id="cb135-45"><a href="#cb135-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(block_size <span class="sc">-</span> <span class="dv">1</span>)){</span>
<span id="cb135-46"><a href="#cb135-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span>(k <span class="cf">in</span> (j<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>block_size){</span>
<span id="cb135-47"><a href="#cb135-47" aria-hidden="true" tabindex="-1"></a>                feat_1 <span class="ot">&lt;-</span> block_feats[i, j]</span>
<span id="cb135-48"><a href="#cb135-48" aria-hidden="true" tabindex="-1"></a>                feat_2 <span class="ot">&lt;-</span> block_feats[i, k]</span>
<span id="cb135-49"><a href="#cb135-49" aria-hidden="true" tabindex="-1"></a>                Sigma[feat_1, feat_2] <span class="ot">&lt;-</span> rho</span>
<span id="cb135-50"><a href="#cb135-50" aria-hidden="true" tabindex="-1"></a>                Sigma[feat_2, feat_1] <span class="ot">&lt;-</span> rho</span>
<span id="cb135-51"><a href="#cb135-51" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb135-52"><a href="#cb135-52" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb135-53"><a href="#cb135-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb135-54"><a href="#cb135-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(Sigma))</span>
<span id="cb135-55"><a href="#cb135-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(Sigma))</span>
<span id="cb135-56"><a href="#cb135-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(Sigma) <span class="sc">==</span> p <span class="sc">&amp;</span> <span class="fu">ncol</span>(Sigma) <span class="sc">==</span> p)</span>
<span id="cb135-57"><a href="#cb135-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(Sigma <span class="sc">==</span> <span class="fu">t</span>(Sigma)))</span>
<span id="cb135-58"><a href="#cb135-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-59"><a href="#cb135-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(Sigma)</span>
<span id="cb135-60"><a href="#cb135-60" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>makeCovarianceMatrix()</code></p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;makeCovarianceMatrix works&quot;</span>, {</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">7612</span>)</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">makeCovarianceMatrix</span>(<span class="at">p=</span><span class="dv">8</span>, <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">rho=</span><span class="fl">0.8</span>, <span class="at">var=</span><span class="dv">2</span>)</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret))</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret))</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret), <span class="dv">8</span>)</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret), <span class="dv">8</span>)</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret <span class="sc">==</span> <span class="fu">t</span>(ret)))</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test on-diagonal and off-diagonal entries to see if they are as expected</span></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (only need to check top half of matrix; we already confirmed the matrix is</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># symmetric)</span></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">diag</span>(ret) <span class="sc">==</span> <span class="dv">2</span>))</span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[<span class="dv">1</span>, <span class="dv">2</span>], <span class="fl">0.8</span>)</span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[<span class="dv">1</span>, <span class="dv">3</span>], <span class="fl">0.8</span>)</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[<span class="dv">2</span>, <span class="dv">3</span>], <span class="fl">0.8</span>)</span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[<span class="dv">4</span>, <span class="dv">5</span>], <span class="fl">0.8</span>)</span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[<span class="dv">4</span>, <span class="dv">6</span>], <span class="fl">0.8</span>)</span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[<span class="dv">5</span>, <span class="dv">6</span>], <span class="fl">0.8</span>)</span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">8</span>] <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">7</span><span class="sc">:</span><span class="dv">8</span>)] <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[<span class="dv">7</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="dv">8</span>)] <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[<span class="dv">8</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>] <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad inputs</span></span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">makeCovarianceMatrix</span>(<span class="at">p=</span><span class="dv">8</span>, <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">block_size=</span><span class="dv">3</span>,</span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">rho=</span><span class="fl">0.8</span>, <span class="at">var=</span>.<span class="dv">2</span>),</span>
<span id="cb136-29"><a href="#cb136-29" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;abs(rho) &lt;= abs(var) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb136-30"><a href="#cb136-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-31"><a href="#cb136-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">makeCovarianceMatrix</span>(<span class="at">p=</span><span class="dv">8</span>, <span class="at">nblocks=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">block_size=</span><span class="dv">3</span>,</span>
<span id="cb136-32"><a href="#cb136-32" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">rho=</span><span class="fl">0.8</span>, <span class="at">var=</span><span class="dv">2</span>),</span>
<span id="cb136-33"><a href="#cb136-33" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;nblocks &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb136-34"><a href="#cb136-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-35"><a href="#cb136-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">makeCovarianceMatrix</span>(<span class="at">p=</span><span class="dv">8</span>, <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">block_size=</span><span class="dv">3</span>,</span>
<span id="cb136-36"><a href="#cb136-36" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">rho=</span><span class="dv">0</span>, <span class="at">var=</span><span class="dv">2</span>),</span>
<span id="cb136-37"><a href="#cb136-37" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;rho != 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb136-38"><a href="#cb136-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-39"><a href="#cb136-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">makeCovarianceMatrix</span>(<span class="at">p=</span><span class="dv">8</span>, <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">block_size=</span><span class="dv">3</span>,</span>
<span id="cb136-40"><a href="#cb136-40" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">rho=</span><span class="fl">0.9</span>, <span class="at">var=</span><span class="dv">0</span>),</span>
<span id="cb136-41"><a href="#cb136-41" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;var != 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb136-42"><a href="#cb136-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-43"><a href="#cb136-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">makeCovarianceMatrix</span>(<span class="at">p=</span><span class="dv">5</span>, <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">block_size=</span><span class="dv">3</span>,</span>
<span id="cb136-44"><a href="#cb136-44" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">rho=</span><span class="fl">0.8</span>, <span class="at">var=</span><span class="dv">2</span>),</span>
<span id="cb136-45"><a href="#cb136-45" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;p &gt;= nblocks * block_size is not TRUE&quot;</span>,</span>
<span id="cb136-46"><a href="#cb136-46" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb136-47"><a href="#cb136-47" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😀</code></pre>
<p><code>makeCoefficients()</code>:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generated coefficients for y in latent variable model</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p Integer or numeric; the number of features that will be observed in</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; x plus the number of latent variables (each corresponding to a cluster).</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param k_unblocked Integer or numeric; the number of features in X that</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will have nonzero coefficients in the true model for y among those features </span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; not generated from the n_clusters latent variables (called &quot;weak signal&quot; </span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features in the simulations from Faletto and Bien 2022). The coefficients on</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; these features will be determined by beta_low.</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param beta_low Integer or numeric; the maximum coefficient in the</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; model for y among the k_unblocked features in X not generated from the</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; latent variables. The coefficients of the features will be</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; beta_low/sqrt(1:k_unblocked).</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param beta_high Integer or numeric; the coefficient used for all</span></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; sig_blocks latent variables that have nonzero coefficients in the true</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; model for y.</span></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param nblocks Integer or numeric; the number of latent variables that were</span></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generated, each of which will be associated with an observed cluster in X.</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sig_blocks Integer or numeric; the number of generated latent</span></span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features that will have nonzero coefficients in the true model for y (all of</span></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; them will have coefficient beta_latent). In particular, the first sig_blocks</span></span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; latent variables will have coefficient beta_latent, and the remaining nblocks</span></span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; - sig_blocks features will have coefficient 0. Must be less than or equal to</span></span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; n_clusters.</span></span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param block_size Integer or numeric; for each of the n_blocks latent</span></span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; variables, the covariance matrix will include the original latent feature</span></span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; plus block_size - 1 noisy proxies that are correlated with the latent</span></span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; variable.</span></span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with the following elements: \item{beta}{A vector of</span></span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; length `p` containing the coefficients for the true model for y. All entries</span></span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will equal 0 except for the sig_blocks latent variables that will have</span></span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; coefficient beta_high and the k_unblocked independent features with</span></span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; coefficient determined by beta_low.} \item{blocked_dgp_vars}{An integer</span></span>
<span id="cb138-34"><a href="#cb138-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vector of length sig_blocks containing the indices of the features</span></span>
<span id="cb138-35"><a href="#cb138-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; corresponding to the latent features that will have nonzero coefficient</span></span>
<span id="cb138-36"><a href="#cb138-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; beta_high in the true model for y.} \item{sig_unblocked_vars}{An integer</span></span>
<span id="cb138-37"><a href="#cb138-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vector of length k_unblocked containing the indices of the observed features</span></span>
<span id="cb138-38"><a href="#cb138-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; that are independent of the blocked features and have coefficient beta_low in</span></span>
<span id="cb138-39"><a href="#cb138-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the true model for y. If k_unblocked = 0, this will just be NA.}</span></span>
<span id="cb138-40"><a href="#cb138-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{insig_blocked_vars}{An integer vector containing the indices of the</span></span>
<span id="cb138-41"><a href="#cb138-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features corresponding to the latent features that will have coefficient 0 in</span></span>
<span id="cb138-42"><a href="#cb138-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the true model for y. If nblocks=0, this will just be NA.}</span></span>
<span id="cb138-43"><a href="#cb138-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{latent_vars}{An integer vector of length nblocks containing the indices</span></span>
<span id="cb138-44"><a href="#cb138-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of all of the latent features.}</span></span>
<span id="cb138-45"><a href="#cb138-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb138-46"><a href="#cb138-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references</span></span>
<span id="cb138-47"><a href="#cb138-47" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span><span class="er">&lt;</span>faletto2022<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb138-48"><a href="#cb138-48" aria-hidden="true" tabindex="-1"></a>makeCoefficients <span class="ot">&lt;-</span> <span class="cf">function</span>(p, k_unblocked, beta_low, beta_high, nblocks,</span>
<span id="cb138-49"><a href="#cb138-49" aria-hidden="true" tabindex="-1"></a>    sig_blocks, block_size){</span>
<span id="cb138-50"><a href="#cb138-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-51"><a href="#cb138-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb138-52"><a href="#cb138-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(k_unblocked <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb138-53"><a href="#cb138-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(sig_blocks <span class="sc">&lt;=</span> nblocks)</span>
<span id="cb138-54"><a href="#cb138-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> nblocks<span class="sc">*</span>block_size <span class="sc">+</span> k_unblocked)</span>
<span id="cb138-55"><a href="#cb138-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(sig_blocks <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb138-56"><a href="#cb138-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-57"><a href="#cb138-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize beta</span></span>
<span id="cb138-58"><a href="#cb138-58" aria-hidden="true" tabindex="-1"></a>    beta <span class="ot">&lt;-</span> <span class="fu">numeric</span>(p)</span>
<span id="cb138-59"><a href="#cb138-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-60"><a href="#cb138-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identify indices of first coefficient in each significant block (these</span></span>
<span id="cb138-61"><a href="#cb138-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># features will have coefficient beta_high)</span></span>
<span id="cb138-62"><a href="#cb138-62" aria-hidden="true" tabindex="-1"></a>    latent_vars <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb138-63"><a href="#cb138-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(nblocks <span class="sc">&gt;=</span> <span class="dv">1</span>){</span>
<span id="cb138-64"><a href="#cb138-64" aria-hidden="true" tabindex="-1"></a>        latent_vars <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(((<span class="dv">0</span><span class="sc">:</span>(nblocks <span class="sc">-</span> <span class="dv">1</span>))<span class="sc">*</span>block_size <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb138-65"><a href="#cb138-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-66"><a href="#cb138-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(latent_vars) <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span>p)</span>
<span id="cb138-67"><a href="#cb138-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(latent_vars) <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span>(block_size<span class="sc">*</span>nblocks))</span>
<span id="cb138-68"><a href="#cb138-68" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">unique</span>(latent_vars)) <span class="sc">==</span> nblocks)</span>
<span id="cb138-69"><a href="#cb138-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(latent_vars) <span class="sc">==</span> nblocks)</span>
<span id="cb138-70"><a href="#cb138-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb138-71"><a href="#cb138-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-72"><a href="#cb138-72" aria-hidden="true" tabindex="-1"></a>    blocked_dgp_vars <span class="ot">&lt;-</span> latent_vars[<span class="dv">1</span><span class="sc">:</span>sig_blocks]</span>
<span id="cb138-73"><a href="#cb138-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-74"><a href="#cb138-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(sig_blocks <span class="sc">==</span> <span class="fu">length</span>(blocked_dgp_vars))</span>
<span id="cb138-75"><a href="#cb138-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-76"><a href="#cb138-76" aria-hidden="true" tabindex="-1"></a>    beta[blocked_dgp_vars] <span class="ot">&lt;-</span> beta_high</span>
<span id="cb138-77"><a href="#cb138-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-78"><a href="#cb138-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identify remaining coefficients in blocks (which ought to be set to 0)</span></span>
<span id="cb138-79"><a href="#cb138-79" aria-hidden="true" tabindex="-1"></a>    insig_blocked_vars <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb138-80"><a href="#cb138-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-81"><a href="#cb138-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(nblocks <span class="sc">&gt;=</span> <span class="dv">1</span>){</span>
<span id="cb138-82"><a href="#cb138-82" aria-hidden="true" tabindex="-1"></a>        insig_blocked_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>(block_size<span class="sc">*</span>nblocks), blocked_dgp_vars)</span>
<span id="cb138-83"><a href="#cb138-83" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(beta[insig_blocked_vars] <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb138-84"><a href="#cb138-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb138-85"><a href="#cb138-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># find significant unblocked variables (if applicable) and fill in</span></span>
<span id="cb138-86"><a href="#cb138-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># coefficients</span></span>
<span id="cb138-87"><a href="#cb138-87" aria-hidden="true" tabindex="-1"></a>    sig_unblocked_vars <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb138-88"><a href="#cb138-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-89"><a href="#cb138-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(k_unblocked <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb138-90"><a href="#cb138-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Range of weak signal coefficients</span></span>
<span id="cb138-91"><a href="#cb138-91" aria-hidden="true" tabindex="-1"></a>        beta_lows <span class="ot">&lt;-</span> beta_low<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">:</span>k_unblocked)</span>
<span id="cb138-92"><a href="#cb138-92" aria-hidden="true" tabindex="-1"></a>        sig_unblocked_vars <span class="ot">&lt;-</span> (nblocks<span class="sc">*</span>block_size <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span></span>
<span id="cb138-93"><a href="#cb138-93" aria-hidden="true" tabindex="-1"></a>            (nblocks<span class="sc">*</span>block_size <span class="sc">+</span> k_unblocked)</span>
<span id="cb138-94"><a href="#cb138-94" aria-hidden="true" tabindex="-1"></a>        sig_unblocked_vars <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(sig_unblocked_vars)</span>
<span id="cb138-95"><a href="#cb138-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-96"><a href="#cb138-96" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(sig_unblocked_vars) <span class="sc">==</span> k_unblocked)</span>
<span id="cb138-97"><a href="#cb138-97" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">unique</span>(sig_unblocked_vars)) <span class="sc">==</span> k_unblocked)</span>
<span id="cb138-98"><a href="#cb138-98" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(sig_unblocked_vars) <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span>p)</span>
<span id="cb138-99"><a href="#cb138-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-100"><a href="#cb138-100" aria-hidden="true" tabindex="-1"></a>        beta[sig_unblocked_vars] <span class="ot">&lt;-</span> beta_lows</span>
<span id="cb138-101"><a href="#cb138-101" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb138-102"><a href="#cb138-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-103"><a href="#cb138-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(blocked_dgp_vars, sig_unblocked_vars)) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb138-104"><a href="#cb138-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(sig_unblocked_vars, insig_blocked_vars)) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb138-105"><a href="#cb138-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(blocked_dgp_vars, insig_blocked_vars)) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb138-106"><a href="#cb138-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-107"><a href="#cb138-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(insig_blocked_vars) <span class="sc">+</span> <span class="fu">length</span>(blocked_dgp_vars) <span class="sc">==</span></span>
<span id="cb138-108"><a href="#cb138-108" aria-hidden="true" tabindex="-1"></a>        nblocks<span class="sc">*</span>block_size)</span>
<span id="cb138-109"><a href="#cb138-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-110"><a href="#cb138-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(sig_blocks <span class="sc">+</span> <span class="fu">length</span>(insig_blocked_vars) <span class="sc">+</span> k_unblocked <span class="sc">&lt;=</span> p)</span>
<span id="cb138-111"><a href="#cb138-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-112"><a href="#cb138-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">sum</span>(beta <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">==</span> sig_blocks <span class="sc">+</span> k_unblocked)</span>
<span id="cb138-113"><a href="#cb138-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(beta) <span class="sc">|</span> <span class="fu">is.integer</span>(beta))</span>
<span id="cb138-114"><a href="#cb138-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-115"><a href="#cb138-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">beta=</span>beta, <span class="at">blocked_dgp_vars=</span>blocked_dgp_vars,</span>
<span id="cb138-116"><a href="#cb138-116" aria-hidden="true" tabindex="-1"></a>        <span class="at">sig_unblocked_vars=</span>sig_unblocked_vars,</span>
<span id="cb138-117"><a href="#cb138-117" aria-hidden="true" tabindex="-1"></a>        <span class="at">insig_blocked_vars=</span>insig_blocked_vars, <span class="at">latent_vars=</span>latent_vars))</span>
<span id="cb138-118"><a href="#cb138-118" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>makeCoefficients()</code></p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;makeCoefficients works&quot;</span>, {</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">5722</span>)</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">makeCoefficients</span>(<span class="at">p=</span><span class="dv">9</span><span class="sc">+</span><span class="dv">2</span>, <span class="at">k_unblocked=</span><span class="dv">2</span>, <span class="at">beta_low=</span>.<span class="dv">9</span>, <span class="at">beta_high=</span><span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">sig_blocks=</span><span class="dv">1</span>, <span class="at">block_size=</span><span class="dv">3</span>)</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret))</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(ret), <span class="fu">c</span>(<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;blocked_dgp_vars&quot;</span>,</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;sig_unblocked_vars&quot;</span>,</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;insig_blocked_vars&quot;</span>, <span class="st">&quot;latent_vars&quot;</span>))</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>beta))</span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>beta), <span class="dv">9</span> <span class="sc">+</span> <span class="dv">2</span>)</span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">sum</span>(ret<span class="sc">$</span>beta <span class="sc">==</span> <span class="dv">0</span>), <span class="dv">9</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">-</span> <span class="dv">3</span>)</span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Checking structure</span></span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret<span class="sc">$</span>beta[<span class="dv">1</span>], <span class="sc">-</span><span class="dv">2</span>)</span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret<span class="sc">$</span>beta[<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>] <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret<span class="sc">$</span>beta[<span class="dv">7</span><span class="sc">:</span><span class="dv">8</span>] <span class="sc">==</span> <span class="fu">c</span>(.<span class="dv">9</span>, .<span class="dv">9</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>))))</span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret<span class="sc">$</span>beta[<span class="dv">9</span><span class="sc">:</span><span class="dv">11</span>] <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>blocked_dgp_vars) <span class="sc">|</span> <span class="fu">is.numeric</span>(ret<span class="sc">$</span>blocked_dgp_vars))</span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret<span class="sc">$</span>blocked_dgp_vars, <span class="dv">1</span>)</span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(ret<span class="sc">$</span>sig_unblocked_vars, <span class="dv">7</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(ret<span class="sc">$</span>insig_blocked_vars, <span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(ret<span class="sc">$</span>latent_vars, <span class="fu">c</span>(1L, 4L))</span>
<span id="cb139-29"><a href="#cb139-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-30"><a href="#cb139-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad inputs</span></span>
<span id="cb139-31"><a href="#cb139-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">makeCoefficients</span>(<span class="at">p=</span><span class="dv">9</span><span class="sc">+</span><span class="dv">2</span>, <span class="at">k_unblocked=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">beta_low=</span>.<span class="dv">9</span>,</span>
<span id="cb139-32"><a href="#cb139-32" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">beta_high=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">sig_blocks=</span><span class="dv">1</span>,</span>
<span id="cb139-33"><a href="#cb139-33" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">block_size=</span><span class="dv">3</span>),</span>
<span id="cb139-34"><a href="#cb139-34" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;k_unblocked &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb139-35"><a href="#cb139-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-36"><a href="#cb139-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">makeCoefficients</span>(<span class="at">p=</span><span class="dv">9</span><span class="sc">+</span><span class="dv">2</span>, <span class="at">k_unblocked=</span><span class="dv">2</span>, <span class="at">beta_low=</span>.<span class="dv">9</span>,</span>
<span id="cb139-37"><a href="#cb139-37" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">beta_high=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">sig_blocks=</span><span class="dv">3</span>,</span>
<span id="cb139-38"><a href="#cb139-38" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">block_size=</span><span class="dv">3</span>),</span>
<span id="cb139-39"><a href="#cb139-39" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sig_blocks &lt;= nblocks is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb139-40"><a href="#cb139-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-41"><a href="#cb139-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">makeCoefficients</span>(<span class="at">p=</span><span class="dv">7</span>, <span class="at">k_unblocked=</span><span class="dv">2</span>, <span class="at">beta_low=</span>.<span class="dv">9</span>,</span>
<span id="cb139-42"><a href="#cb139-42" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">beta_high=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">sig_blocks=</span><span class="dv">1</span>,</span>
<span id="cb139-43"><a href="#cb139-43" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">block_size=</span><span class="dv">3</span>),</span>
<span id="cb139-44"><a href="#cb139-44" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;p &gt;= nblocks * block_size + k_unblocked is not TRUE&quot;</span>,</span>
<span id="cb139-45"><a href="#cb139-45" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb139-46"><a href="#cb139-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-47"><a href="#cb139-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">makeCoefficients</span>(<span class="at">p=</span><span class="dv">9</span><span class="sc">+</span><span class="dv">2</span>, <span class="at">k_unblocked=</span><span class="dv">2</span>, <span class="at">beta_low=</span>.<span class="dv">9</span>,</span>
<span id="cb139-48"><a href="#cb139-48" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">beta_high=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">nblocks=</span><span class="dv">2</span>,</span>
<span id="cb139-49"><a href="#cb139-49" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">sig_blocks=</span><span class="sc">-</span><span class="dv">1</span>, <span class="at">block_size=</span><span class="dv">3</span>),</span>
<span id="cb139-50"><a href="#cb139-50" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sig_blocks &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb139-51"><a href="#cb139-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-52"><a href="#cb139-52" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😸</code></pre>
<p><code>genMuXZSd()</code></p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generate observed and latent variables along with conditional mean</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n Integer or numeric; the number of observations to generate. (The</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generated X and Z will have n rows, and the generated y and mu will have</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; length n.)</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param p Integer or numeric; the number of observed features (the generated X</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will have p columns).</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param beta A numeric or integer vector of length `p` + sig_blocks containing</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the coefficients for the true model for y.</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param Sigma A (`p` + n_blocks) x (`p` + n_blocks) numeric matrix</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; representing the covariance matrix for the latent features, the associated</span></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; proxies, and the remaining features.</span></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param blocked_dgp_vars An integer vector of length sig_blocks containing the</span></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of the features corresponding to the latent features that have</span></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; nonzero coefficient beta_high in the true model for y.</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param latent_vars An integer vector of length n_blocks containing the</span></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of all of the latent features.</span></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param block_size Integer or numeric; for each of the n_blocks latent</span></span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; variables, X will contain block_size noisy proxies that are correlated with</span></span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the latent variable.</span></span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n_blocks Integer or numeric; the number of latent variables to</span></span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; generate, each of which will be associated with an observed cluster in X.</span></span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Must be at least 1. Default is 1.</span></span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param snr Integer or numeric; the signal-to-noise ratio of the response</span></span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; y. If sigma_eps_sq is not specified, the variance of the noise in y will be</span></span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; calculated using the formula sigma_eps_sq = sum(mu^2)/(n * snr). Only one of</span></span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; snr and sigma_eps_sq must be specified. Default is NA.</span></span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param sigma_eps_sq Integer or numeric; the variance on the noise added</span></span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to y. Only one of snr and sigma_eps_sq must be specified. Default is NA.</span></span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with the following elements: \item{X}{An `n` x `p`</span></span>
<span id="cb141-31"><a href="#cb141-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; numeric matrix containing the observed proxies for the latent variables as</span></span>
<span id="cb141-32"><a href="#cb141-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; well as the observed unblocked (iid) variables.} \item{mu}{A length `n`</span></span>
<span id="cb141-33"><a href="#cb141-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; numeric vector; the expected response given X, Z, and the true</span></span>
<span id="cb141-34"><a href="#cb141-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; coefficient vector (equal to y minus the added noise).} \item{z}{An `n` x</span></span>
<span id="cb141-35"><a href="#cb141-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; n_blocks numeric matrix containing the n_blocks latent variables. Note that</span></span>
<span id="cb141-36"><a href="#cb141-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (X, z) is multivariate Gaussian.} \item{sd}{Numeric; the standard deviation</span></span>
<span id="cb141-37"><a href="#cb141-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of the noise added to mu to get y (calculated either from snr or</span></span>
<span id="cb141-38"><a href="#cb141-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; sigma_eps_sq).}</span></span>
<span id="cb141-39"><a href="#cb141-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb141-40"><a href="#cb141-40" aria-hidden="true" tabindex="-1"></a>genMuXZSd <span class="ot">&lt;-</span> <span class="cf">function</span>(n, p, beta, Sigma, blocked_dgp_vars,</span>
<span id="cb141-41"><a href="#cb141-41" aria-hidden="true" tabindex="-1"></a>    latent_vars, block_size, <span class="at">n_blocks=</span><span class="dv">1</span>, <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>){</span>
<span id="cb141-42"><a href="#cb141-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb141-43"><a href="#cb141-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-44"><a href="#cb141-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(blocked_dgp_vars) <span class="sc">&lt;=</span> n_blocks)</span>
<span id="cb141-45"><a href="#cb141-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(Sigma) <span class="sc">==</span> p <span class="sc">+</span> n_blocks)</span>
<span id="cb141-46"><a href="#cb141-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(Sigma) <span class="sc">==</span> p <span class="sc">+</span> n_blocks)</span>
<span id="cb141-47"><a href="#cb141-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-48"><a href="#cb141-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="sc">!</span><span class="fu">is.na</span>(sigma_eps_sq))){</span>
<span id="cb141-49"><a href="#cb141-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(sigma_eps_sq) <span class="sc">|</span> <span class="fu">is.integer</span>(sigma_eps_sq))</span>
<span id="cb141-50"><a href="#cb141-50" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(sigma_eps_sq) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb141-51"><a href="#cb141-51" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(sigma_eps_sq <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb141-52"><a href="#cb141-52" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb141-53"><a href="#cb141-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(snr))){</span>
<span id="cb141-54"><a href="#cb141-54" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stop</span>(<span class="st">&quot;Must provide one of snr or sigma_eps_sq&quot;</span>)</span>
<span id="cb141-55"><a href="#cb141-55" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb141-56"><a href="#cb141-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(snr) <span class="sc">|</span> <span class="fu">is.integer</span>(snr))</span>
<span id="cb141-57"><a href="#cb141-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(snr) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb141-58"><a href="#cb141-58" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(snr <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb141-59"><a href="#cb141-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-60"><a href="#cb141-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-61"><a href="#cb141-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(beta) <span class="sc">==</span> p <span class="sc">+</span> n_blocks)</span>
<span id="cb141-62"><a href="#cb141-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(beta[blocked_dgp_vars] <span class="sc">!=</span> <span class="dv">0</span>))</span>
<span id="cb141-63"><a href="#cb141-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-64"><a href="#cb141-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(latent_vars) <span class="sc">==</span> n_blocks)</span>
<span id="cb141-65"><a href="#cb141-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-66"><a href="#cb141-66" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n=</span>n, <span class="at">mu=</span><span class="fu">rep</span>(<span class="dv">0</span>, p <span class="sc">+</span> n_blocks), <span class="at">Sigma=</span>Sigma)</span>
<span id="cb141-67"><a href="#cb141-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-68"><a href="#cb141-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(beta) <span class="sc">==</span> <span class="fu">ncol</span>(x))</span>
<span id="cb141-69"><a href="#cb141-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-70"><a href="#cb141-70" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(x <span class="sc">%*%</span> beta)</span>
<span id="cb141-71"><a href="#cb141-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-72"><a href="#cb141-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove true blocked signal feature from each block from x now that I&#39;ve</span></span>
<span id="cb141-73"><a href="#cb141-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># generated mu</span></span>
<span id="cb141-74"><a href="#cb141-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(n_blocks <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb141-75"><a href="#cb141-75" aria-hidden="true" tabindex="-1"></a>        z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">nrow=</span>n, <span class="at">ncol=</span>n_blocks)</span>
<span id="cb141-76"><a href="#cb141-76" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(latent_vars) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb141-77"><a href="#cb141-77" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb141-78"><a href="#cb141-78" aria-hidden="true" tabindex="-1"></a>        z <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb141-79"><a href="#cb141-79" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(latent_vars) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb141-80"><a href="#cb141-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-81"><a href="#cb141-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-82"><a href="#cb141-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(latent_vars) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb141-83"><a href="#cb141-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(latent_vars) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb141-84"><a href="#cb141-84" aria-hidden="true" tabindex="-1"></a>        z[, <span class="dv">1</span><span class="sc">:</span>n_blocks] <span class="ot">&lt;-</span> x[, latent_vars]</span>
<span id="cb141-85"><a href="#cb141-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-86"><a href="#cb141-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-87"><a href="#cb141-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-88"><a href="#cb141-88" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x[, <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>(p <span class="sc">+</span> n_blocks), latent_vars)]</span>
<span id="cb141-89"><a href="#cb141-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-90"><a href="#cb141-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If SNR is null, use sigma_eps_sq</span></span>
<span id="cb141-91"><a href="#cb141-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(sigma_eps_sq)){</span>
<span id="cb141-92"><a href="#cb141-92" aria-hidden="true" tabindex="-1"></a>        sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(sigma_eps_sq)</span>
<span id="cb141-93"><a href="#cb141-93" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb141-94"><a href="#cb141-94" aria-hidden="true" tabindex="-1"></a>        sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(mu<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (n <span class="sc">*</span> snr)) <span class="co"># taking snr = ||mu||^2 /(n * sigma^2)</span></span>
<span id="cb141-95"><a href="#cb141-95" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-96"><a href="#cb141-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-97"><a href="#cb141-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb141-98"><a href="#cb141-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-99"><a href="#cb141-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(mu) <span class="sc">==</span> n)</span>
<span id="cb141-100"><a href="#cb141-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-101"><a href="#cb141-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(x) <span class="sc">==</span> n)</span>
<span id="cb141-102"><a href="#cb141-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(x) <span class="sc">==</span> p)</span>
<span id="cb141-103"><a href="#cb141-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-104"><a href="#cb141-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="sc">!</span><span class="fu">is.na</span>(z))){</span>
<span id="cb141-105"><a href="#cb141-105" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(z) <span class="sc">==</span> n)</span>
<span id="cb141-106"><a href="#cb141-106" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(z) <span class="sc">==</span> n_blocks)</span>
<span id="cb141-107"><a href="#cb141-107" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-108"><a href="#cb141-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-109"><a href="#cb141-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(sd) <span class="sc">|</span> <span class="fu">is.integer</span>(sd))</span>
<span id="cb141-110"><a href="#cb141-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(sd) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb141-111"><a href="#cb141-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(sd))</span>
<span id="cb141-112"><a href="#cb141-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(sd <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb141-113"><a href="#cb141-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-114"><a href="#cb141-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">X=</span>x, <span class="at">mu=</span>mu, <span class="at">z=</span>z, <span class="at">sd=</span>sd))</span>
<span id="cb141-115"><a href="#cb141-115" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>genMuXZSd()</code></p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;genMuXZSd works&quot;</span>, {</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">61232</span>)</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  Sigma <span class="ot">&lt;-</span> <span class="fu">makeCovarianceMatrix</span>(<span class="at">p=</span><span class="dv">9</span><span class="sc">+</span><span class="dv">2</span>, <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">block_size=</span><span class="dv">3</span><span class="sc">+</span><span class="dv">1</span>, <span class="at">rho=</span><span class="fl">0.2499</span>,</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">var=</span>.<span class="dv">25</span>)</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>  coefs <span class="ot">&lt;-</span> <span class="fu">makeCoefficients</span>(<span class="at">p=</span><span class="dv">9</span><span class="sc">+</span><span class="dv">2</span>, <span class="at">k_unblocked=</span><span class="dv">2</span>, <span class="at">beta_low=</span>.<span class="dv">9</span>, <span class="at">beta_high=</span><span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">sig_blocks=</span><span class="dv">1</span>, <span class="at">block_size=</span><span class="dv">3</span><span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">25</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>, <span class="at">block_size=</span><span class="dv">3</span>,</span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span><span class="fl">1.2</span>)</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret))</span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(ret), <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;mu&quot;</span>, <span class="st">&quot;z&quot;</span>, <span class="st">&quot;sd&quot;</span>))</span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>X))</span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret<span class="sc">$</span>X))</span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret<span class="sc">$</span>X), <span class="dv">25</span>)</span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret<span class="sc">$</span>X), <span class="dv">9</span>)</span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X is Gaussian with mean 0 and variance 1/4; expect all observations to lie</span></span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># within 5 standard deviations of mean</span></span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret<span class="sc">$</span>X) <span class="sc">&lt;</span> <span class="dv">5</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="fl">0.25</span>)))</span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test that clusters are correlated--within-cluster correlation should be</span></span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># high, correlation with other features should be low</span></span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">min</span>(<span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])) <span class="sc">&gt;</span> .<span class="dv">9</span>)</span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], ret<span class="sc">$</span>X[, <span class="dv">4</span><span class="sc">:</span><span class="dv">9</span>]))) <span class="sc">&lt;</span> .<span class="dv">6</span>)</span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">min</span>(<span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>])) <span class="sc">&gt;</span> .<span class="dv">9</span>)</span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>],</span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true" tabindex="-1"></a>                                    ret<span class="sc">$</span>X[, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>)]))) <span class="sc">&lt;</span> .<span class="dv">6</span>)</span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true" tabindex="-1"></a>  cor_indeps <span class="ot">&lt;-</span> <span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>])</span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">max</span>(<span class="fu">abs</span>(cor_indeps[<span class="fu">lower.tri</span>(cor_indeps)])) <span class="sc">&lt;</span> .<span class="dv">6</span>)</span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>mu))</span>
<span id="cb142-40"><a href="#cb142-40" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>mu), <span class="dv">25</span>)</span>
<span id="cb142-41"><a href="#cb142-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-42"><a href="#cb142-42" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>z))</span>
<span id="cb142-43"><a href="#cb142-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret<span class="sc">$</span>z))</span>
<span id="cb142-44"><a href="#cb142-44" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret<span class="sc">$</span>z), <span class="dv">25</span>)</span>
<span id="cb142-45"><a href="#cb142-45" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret<span class="sc">$</span>z), <span class="dv">2</span>)</span>
<span id="cb142-46"><a href="#cb142-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-47"><a href="#cb142-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>sd))</span>
<span id="cb142-48"><a href="#cb142-48" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret<span class="sc">$</span>sd, <span class="fu">sqrt</span>(<span class="fl">1.2</span>))</span>
<span id="cb142-49"><a href="#cb142-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-50"><a href="#cb142-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Specify SNR instead of sd</span></span>
<span id="cb142-51"><a href="#cb142-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-52"><a href="#cb142-52" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-53"><a href="#cb142-53" aria-hidden="true" tabindex="-1"></a>                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-54"><a href="#cb142-54" aria-hidden="true" tabindex="-1"></a>                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>, <span class="at">block_size=</span><span class="dv">3</span>,</span>
<span id="cb142-55"><a href="#cb142-55" aria-hidden="true" tabindex="-1"></a>                   <span class="at">snr=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>)</span>
<span id="cb142-56"><a href="#cb142-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-57"><a href="#cb142-57" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret))</span>
<span id="cb142-58"><a href="#cb142-58" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(ret), <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;mu&quot;</span>, <span class="st">&quot;z&quot;</span>, <span class="st">&quot;sd&quot;</span>))</span>
<span id="cb142-59"><a href="#cb142-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-60"><a href="#cb142-60" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>X))</span>
<span id="cb142-61"><a href="#cb142-61" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret<span class="sc">$</span>X))</span>
<span id="cb142-62"><a href="#cb142-62" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret<span class="sc">$</span>X), <span class="dv">5</span>)</span>
<span id="cb142-63"><a href="#cb142-63" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret<span class="sc">$</span>X), <span class="dv">9</span>)</span>
<span id="cb142-64"><a href="#cb142-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-65"><a href="#cb142-65" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>mu))</span>
<span id="cb142-66"><a href="#cb142-66" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>mu), <span class="dv">5</span>)</span>
<span id="cb142-67"><a href="#cb142-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-68"><a href="#cb142-68" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>z))</span>
<span id="cb142-69"><a href="#cb142-69" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret<span class="sc">$</span>z))</span>
<span id="cb142-70"><a href="#cb142-70" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret<span class="sc">$</span>z), <span class="dv">5</span>)</span>
<span id="cb142-71"><a href="#cb142-71" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret<span class="sc">$</span>z), <span class="dv">2</span>)</span>
<span id="cb142-72"><a href="#cb142-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-73"><a href="#cb142-73" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>sd))</span>
<span id="cb142-74"><a href="#cb142-74" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret<span class="sc">$</span>sd <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb142-75"><a href="#cb142-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-76"><a href="#cb142-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try a single latent variable (z should be a one-column matrix)</span></span>
<span id="cb142-77"><a href="#cb142-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-78"><a href="#cb142-78" aria-hidden="true" tabindex="-1"></a>  Sigma <span class="ot">&lt;-</span> <span class="fu">makeCovarianceMatrix</span>(<span class="at">p=</span><span class="dv">9</span><span class="sc">+</span><span class="dv">1</span>, <span class="at">nblocks=</span><span class="dv">1</span>, <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">rho=</span><span class="fl">0.8</span>, <span class="at">var=</span><span class="dv">2</span>)</span>
<span id="cb142-79"><a href="#cb142-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-80"><a href="#cb142-80" aria-hidden="true" tabindex="-1"></a>  coefs <span class="ot">&lt;-</span> <span class="fu">makeCoefficients</span>(<span class="at">p=</span><span class="dv">9</span><span class="sc">+</span><span class="dv">1</span>, <span class="at">k_unblocked=</span><span class="dv">2</span>, <span class="at">beta_low=</span>.<span class="dv">9</span>, <span class="at">beta_high=</span><span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb142-81"><a href="#cb142-81" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nblocks=</span><span class="dv">1</span>, <span class="at">sig_blocks=</span><span class="dv">1</span>, <span class="at">block_size=</span><span class="dv">3</span>)</span>
<span id="cb142-82"><a href="#cb142-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-83"><a href="#cb142-83" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-84"><a href="#cb142-84" aria-hidden="true" tabindex="-1"></a>                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-85"><a href="#cb142-85" aria-hidden="true" tabindex="-1"></a>                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">1</span>, <span class="at">block_size=</span><span class="dv">3</span>,</span>
<span id="cb142-86"><a href="#cb142-86" aria-hidden="true" tabindex="-1"></a>                   <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span><span class="fl">1.2</span>)</span>
<span id="cb142-87"><a href="#cb142-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-88"><a href="#cb142-88" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret))</span>
<span id="cb142-89"><a href="#cb142-89" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(ret), <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;mu&quot;</span>, <span class="st">&quot;z&quot;</span>, <span class="st">&quot;sd&quot;</span>))</span>
<span id="cb142-90"><a href="#cb142-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-91"><a href="#cb142-91" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>z))</span>
<span id="cb142-92"><a href="#cb142-92" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret<span class="sc">$</span>z))</span>
<span id="cb142-93"><a href="#cb142-93" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret<span class="sc">$</span>z), <span class="dv">5</span>)</span>
<span id="cb142-94"><a href="#cb142-94" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret<span class="sc">$</span>z), <span class="dv">1</span>)</span>
<span id="cb142-95"><a href="#cb142-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-96"><a href="#cb142-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad inputs</span></span>
<span id="cb142-97"><a href="#cb142-97" aria-hidden="true" tabindex="-1"></a>  Sigma <span class="ot">&lt;-</span> <span class="fu">makeCovarianceMatrix</span>(<span class="at">p=</span><span class="dv">9</span><span class="sc">+</span><span class="dv">2</span>, <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">rho=</span><span class="fl">0.8</span>, <span class="at">var=</span><span class="dv">2</span>)</span>
<span id="cb142-98"><a href="#cb142-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-99"><a href="#cb142-99" aria-hidden="true" tabindex="-1"></a>  coefs <span class="ot">&lt;-</span> <span class="fu">makeCoefficients</span>(<span class="at">p=</span><span class="dv">9</span><span class="sc">+</span><span class="dv">2</span>, <span class="at">k_unblocked=</span><span class="dv">2</span>, <span class="at">beta_low=</span>.<span class="dv">9</span>, <span class="at">beta_high=</span><span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb142-100"><a href="#cb142-100" aria-hidden="true" tabindex="-1"></a>                            <span class="at">nblocks=</span><span class="dv">2</span>, <span class="at">sig_blocks=</span><span class="dv">1</span>, <span class="at">block_size=</span><span class="dv">3</span>)</span>
<span id="cb142-101"><a href="#cb142-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-102"><a href="#cb142-102" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-103"><a href="#cb142-103" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-104"><a href="#cb142-104" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">0</span>,</span>
<span id="cb142-105"><a href="#cb142-105" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span><span class="fl">1.2</span>),</span>
<span id="cb142-106"><a href="#cb142-106" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(blocked_dgp_vars) &lt;= n_blocks is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-107"><a href="#cb142-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-108"><a href="#cb142-108" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-109"><a href="#cb142-109" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-110"><a href="#cb142-110" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">1</span>,</span>
<span id="cb142-111"><a href="#cb142-111" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span><span class="fl">1.2</span>),</span>
<span id="cb142-112"><a href="#cb142-112" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;nrow(Sigma) == p + n_blocks is not TRUE&quot;</span>,</span>
<span id="cb142-113"><a href="#cb142-113" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-114"><a href="#cb142-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-115"><a href="#cb142-115" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-116"><a href="#cb142-116" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-117"><a href="#cb142-117" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>,</span>
<span id="cb142-118"><a href="#cb142-118" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span><span class="st">&quot;1.2&quot;</span>),</span>
<span id="cb142-119"><a href="#cb142-119" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(sigma_eps_sq) | is.integer(sigma_eps_sq) is not TRUE&quot;</span>,</span>
<span id="cb142-120"><a href="#cb142-120" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-121"><a href="#cb142-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-122"><a href="#cb142-122" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-123"><a href="#cb142-123" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-124"><a href="#cb142-124" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>,</span>
<span id="cb142-125"><a href="#cb142-125" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>),</span>
<span id="cb142-126"><a href="#cb142-126" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(sigma_eps_sq) == 1 is not TRUE&quot;</span>,</span>
<span id="cb142-127"><a href="#cb142-127" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-128"><a href="#cb142-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-129"><a href="#cb142-129" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-130"><a href="#cb142-130" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-131"><a href="#cb142-131" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>,</span>
<span id="cb142-132"><a href="#cb142-132" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span><span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb142-133"><a href="#cb142-133" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sigma_eps_sq &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-134"><a href="#cb142-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-135"><a href="#cb142-135" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-136"><a href="#cb142-136" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-137"><a href="#cb142-137" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>,</span>
<span id="cb142-138"><a href="#cb142-138" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb142-139"><a href="#cb142-139" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Must provide one of snr or sigma_eps_sq&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-140"><a href="#cb142-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-141"><a href="#cb142-141" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-142"><a href="#cb142-142" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-143"><a href="#cb142-143" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>,</span>
<span id="cb142-144"><a href="#cb142-144" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="st">&quot;1&quot;</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb142-145"><a href="#cb142-145" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(snr) | is.integer(snr) is not TRUE&quot;</span>,</span>
<span id="cb142-146"><a href="#cb142-146" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-147"><a href="#cb142-147" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-148"><a href="#cb142-148" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-149"><a href="#cb142-149" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-150"><a href="#cb142-150" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>,</span>
<span id="cb142-151"><a href="#cb142-151" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb142-152"><a href="#cb142-152" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(snr) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-153"><a href="#cb142-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-154"><a href="#cb142-154" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-155"><a href="#cb142-155" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-156"><a href="#cb142-156" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>,</span>
<span id="cb142-157"><a href="#cb142-157" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="sc">-</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb142-158"><a href="#cb142-158" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;snr &gt; 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-159"><a href="#cb142-159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-160"><a href="#cb142-160" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-161"><a href="#cb142-161" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-162"><a href="#cb142-162" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>,</span>
<span id="cb142-163"><a href="#cb142-163" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb142-164"><a href="#cb142-164" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(beta) == p + n_blocks is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-165"><a href="#cb142-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-166"><a href="#cb142-166" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span><span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">9</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-167"><a href="#cb142-167" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-168"><a href="#cb142-168" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span>coefs<span class="sc">$</span>latent_vars, <span class="at">n_blocks=</span><span class="dv">2</span>,</span>
<span id="cb142-169"><a href="#cb142-169" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb142-170"><a href="#cb142-170" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(beta[blocked_dgp_vars] != 0) is not TRUE&quot;</span>,</span>
<span id="cb142-171"><a href="#cb142-171" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-172"><a href="#cb142-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-173"><a href="#cb142-173" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genMuXZSd</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">9</span>, <span class="at">beta=</span>coefs<span class="sc">$</span>beta, <span class="at">Sigma=</span>Sigma,</span>
<span id="cb142-174"><a href="#cb142-174" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">blocked_dgp_vars=</span>coefs<span class="sc">$</span>blocked_dgp_vars,</span>
<span id="cb142-175"><a href="#cb142-175" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">latent_vars=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">n_blocks=</span><span class="dv">2</span>,</span>
<span id="cb142-176"><a href="#cb142-176" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">block_size=</span><span class="dv">3</span>, <span class="at">snr=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb142-177"><a href="#cb142-177" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(latent_vars) == n_blocks is not TRUE&quot;</span>,</span>
<span id="cb142-178"><a href="#cb142-178" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb142-179"><a href="#cb142-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-180"><a href="#cb142-180" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p>Finally, tests for <code>genClusteredData()</code></p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;genClusteredData works&quot;</span>, {</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">23478</span>)</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">25</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>, <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">3.99</span>, <span class="at">var=</span><span class="dv">4</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span>.<span class="dv">5</span>)</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret))</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(ret), <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;Z&quot;</span>, <span class="st">&quot;mu&quot;</span>))</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>X))</span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret<span class="sc">$</span>X))</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret<span class="sc">$</span>X), <span class="dv">19</span>)</span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret<span class="sc">$</span>X), <span class="dv">25</span>)</span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X is Gaussian with mean 0 and variance 4; expect all observations to lie</span></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># within 5 standard deviations of mean</span></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret<span class="sc">$</span>X) <span class="sc">&lt;</span> <span class="dv">5</span><span class="sc">*</span><span class="dv">2</span>))</span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test that clusters are correlated--within-cluster correlation should be</span></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># high, correlation with other features should be low</span></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">min</span>(<span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])) <span class="sc">&gt;</span> .<span class="dv">9</span>)</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], ret<span class="sc">$</span>X[, <span class="dv">6</span><span class="sc">:</span><span class="dv">19</span>]))) <span class="sc">&lt;</span> .<span class="dv">6</span>)</span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">min</span>(<span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>])) <span class="sc">&gt;</span> .<span class="dv">9</span>)</span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>                                    ret<span class="sc">$</span>X[, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">11</span><span class="sc">:</span><span class="dv">19</span>)]))) <span class="sc">&lt;</span> .<span class="dv">6</span>)</span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">min</span>(<span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">11</span><span class="sc">:</span><span class="dv">15</span>])) <span class="sc">&gt;</span> .<span class="dv">9</span>)</span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">11</span><span class="sc">:</span><span class="dv">15</span>],</span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a>                                    ret<span class="sc">$</span>X[, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">16</span><span class="sc">:</span><span class="dv">19</span>)]))) <span class="sc">&lt;</span> .<span class="dv">6</span>)</span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a>  cor_indeps <span class="ot">&lt;-</span> <span class="fu">cor</span>(ret<span class="sc">$</span>X[, <span class="dv">16</span><span class="sc">:</span><span class="dv">19</span>])</span>
<span id="cb144-32"><a href="#cb144-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">max</span>(<span class="fu">abs</span>(cor_indeps[<span class="fu">lower.tri</span>(cor_indeps)])) <span class="sc">&lt;</span> .<span class="dv">6</span>)</span>
<span id="cb144-33"><a href="#cb144-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-34"><a href="#cb144-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>y))</span>
<span id="cb144-35"><a href="#cb144-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>y), <span class="dv">25</span>)</span>
<span id="cb144-36"><a href="#cb144-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-37"><a href="#cb144-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>Z))</span>
<span id="cb144-38"><a href="#cb144-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret<span class="sc">$</span>Z))</span>
<span id="cb144-39"><a href="#cb144-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret<span class="sc">$</span>Z), <span class="dv">25</span>)</span>
<span id="cb144-40"><a href="#cb144-40" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret<span class="sc">$</span>Z), <span class="dv">3</span>)</span>
<span id="cb144-41"><a href="#cb144-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-42"><a href="#cb144-42" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>mu))</span>
<span id="cb144-43"><a href="#cb144-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>mu), <span class="dv">25</span>)</span>
<span id="cb144-44"><a href="#cb144-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Because y is Gaussian with mean mu and standard deviation .5 conditional on</span></span>
<span id="cb144-45"><a href="#cb144-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mu, expect all observations to lie within 5 sds of mu</span></span>
<span id="cb144-46"><a href="#cb144-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret<span class="sc">$</span>y <span class="sc">-</span> ret<span class="sc">$</span>mu) <span class="sc">&lt;</span> <span class="dv">5</span><span class="sc">*</span>.<span class="dv">5</span>))</span>
<span id="cb144-47"><a href="#cb144-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-48"><a href="#cb144-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Specify SNR instead of sigma_eps_sq</span></span>
<span id="cb144-49"><a href="#cb144-49" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>, <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-50"><a href="#cb144-50" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>, <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-51"><a href="#cb144-51" aria-hidden="true" tabindex="-1"></a>                       <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>)</span>
<span id="cb144-52"><a href="#cb144-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-53"><a href="#cb144-53" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret))</span>
<span id="cb144-54"><a href="#cb144-54" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(ret), <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;Z&quot;</span>, <span class="st">&quot;mu&quot;</span>))</span>
<span id="cb144-55"><a href="#cb144-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-56"><a href="#cb144-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If sigma_eps_sq is specified, snr should be ignored. (Set an SNR that</span></span>
<span id="cb144-57"><a href="#cb144-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># implies a very large noise variance to test this)</span></span>
<span id="cb144-58"><a href="#cb144-58" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>, <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-59"><a href="#cb144-59" aria-hidden="true" tabindex="-1"></a>                <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>, <span class="at">var=</span><span class="dv">4</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-60"><a href="#cb144-60" aria-hidden="true" tabindex="-1"></a>                <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span>.<span class="dv">01</span>, <span class="at">sigma_eps_sq=</span>.<span class="dv">25</span>)</span>
<span id="cb144-61"><a href="#cb144-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-62"><a href="#cb144-62" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret))</span>
<span id="cb144-63"><a href="#cb144-63" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(ret), <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;Z&quot;</span>, <span class="st">&quot;mu&quot;</span>))</span>
<span id="cb144-64"><a href="#cb144-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-65"><a href="#cb144-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Because y is Gaussian with mean mu and standard deviation .5 conditional on</span></span>
<span id="cb144-66"><a href="#cb144-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mu, expect all observations to lie within 5 sds of mu</span></span>
<span id="cb144-67"><a href="#cb144-67" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret<span class="sc">$</span>y <span class="sc">-</span> ret<span class="sc">$</span>mu) <span class="sc">&lt;</span> <span class="dv">5</span><span class="sc">*</span>.<span class="dv">25</span>))</span>
<span id="cb144-68"><a href="#cb144-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-69"><a href="#cb144-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try a single latent variable (z should be a one-column matrix)</span></span>
<span id="cb144-70"><a href="#cb144-70" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>, <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">1</span>,</span>
<span id="cb144-71"><a href="#cb144-71" aria-hidden="true" tabindex="-1"></a>                <span class="at">sig_clusters=</span><span class="dv">1</span>, <span class="at">rho=</span>.<span class="dv">8</span>, <span class="at">var=</span><span class="dv">4</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-72"><a href="#cb144-72" aria-hidden="true" tabindex="-1"></a>                <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="cn">NA</span>, <span class="at">sigma_eps_sq=</span>.<span class="dv">5</span>)</span>
<span id="cb144-73"><a href="#cb144-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-74"><a href="#cb144-74" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret))</span>
<span id="cb144-75"><a href="#cb144-75" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(ret), <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;Z&quot;</span>, <span class="st">&quot;mu&quot;</span>))</span>
<span id="cb144-76"><a href="#cb144-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-77"><a href="#cb144-77" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>Z))</span>
<span id="cb144-78"><a href="#cb144-78" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret<span class="sc">$</span>Z))</span>
<span id="cb144-79"><a href="#cb144-79" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret<span class="sc">$</span>Z), <span class="dv">5</span>)</span>
<span id="cb144-80"><a href="#cb144-80" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret<span class="sc">$</span>Z), <span class="dv">1</span>)</span>
<span id="cb144-81"><a href="#cb144-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-82"><a href="#cb144-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad inputs</span></span>
<span id="cb144-83"><a href="#cb144-83" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-84"><a href="#cb144-84" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-85"><a href="#cb144-85" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">sig_clusters=</span><span class="st">&quot;2&quot;</span>, <span class="at">rho=</span>.<span class="dv">8</span>, <span class="at">var=</span><span class="fl">1.1</span>,</span>
<span id="cb144-86"><a href="#cb144-86" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">beta_latent=</span><span class="fl">1.5</span>, <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb144-87"><a href="#cb144-87" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">snr=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-88"><a href="#cb144-88" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(sig_clusters) | is.integer(sig_clusters) is not TRUE&quot;</span>,</span>
<span id="cb144-89"><a href="#cb144-89" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-90"><a href="#cb144-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-91"><a href="#cb144-91" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-92"><a href="#cb144-92" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-93"><a href="#cb144-93" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">4</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb144-94"><a href="#cb144-94" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-95"><a href="#cb144-95" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-96"><a href="#cb144-96" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-97"><a href="#cb144-97" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sig_clusters &lt;= n_clusters is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-98"><a href="#cb144-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-99"><a href="#cb144-99" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-100"><a href="#cb144-100" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-101"><a href="#cb144-101" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="sc">-</span><span class="dv">1</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb144-102"><a href="#cb144-102" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-103"><a href="#cb144-103" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-104"><a href="#cb144-104" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-105"><a href="#cb144-105" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sig_clusters &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-106"><a href="#cb144-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-107"><a href="#cb144-107" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-108"><a href="#cb144-108" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-109"><a href="#cb144-109" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span>.<span class="dv">6</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb144-110"><a href="#cb144-110" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-111"><a href="#cb144-111" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-112"><a href="#cb144-112" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-113"><a href="#cb144-113" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sig_clusters == round(sig_clusters) is not TRUE&quot;</span>,</span>
<span id="cb144-114"><a href="#cb144-114" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-115"><a href="#cb144-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-116"><a href="#cb144-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-117"><a href="#cb144-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># n_clusters</span></span>
<span id="cb144-118"><a href="#cb144-118" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-119"><a href="#cb144-119" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>,</span>
<span id="cb144-120"><a href="#cb144-120" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">n_clusters=</span><span class="st">&quot;3&quot;</span>,</span>
<span id="cb144-121"><a href="#cb144-121" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb144-122"><a href="#cb144-122" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-123"><a href="#cb144-123" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-124"><a href="#cb144-124" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-125"><a href="#cb144-125" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(n_clusters) | is.integer(n_clusters) is not TRUE&quot;</span>,</span>
<span id="cb144-126"><a href="#cb144-126" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-127"><a href="#cb144-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-128"><a href="#cb144-128" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-129"><a href="#cb144-129" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="fl">3.2</span>,</span>
<span id="cb144-130"><a href="#cb144-130" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb144-131"><a href="#cb144-131" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-132"><a href="#cb144-132" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-133"><a href="#cb144-133" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-134"><a href="#cb144-134" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n_clusters == round(n_clusters) is not TRUE&quot;</span>,</span>
<span id="cb144-135"><a href="#cb144-135" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-136"><a href="#cb144-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-137"><a href="#cb144-137" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-138"><a href="#cb144-138" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">0</span>,</span>
<span id="cb144-139"><a href="#cb144-139" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">0</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb144-140"><a href="#cb144-140" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-141"><a href="#cb144-141" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-142"><a href="#cb144-142" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-143"><a href="#cb144-143" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n_clusters &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-144"><a href="#cb144-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-145"><a href="#cb144-145" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-146"><a href="#cb144-146" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span>.<span class="dv">3</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-147"><a href="#cb144-147" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb144-148"><a href="#cb144-148" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-149"><a href="#cb144-149" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-150"><a href="#cb144-150" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-151"><a href="#cb144-151" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;cluster_size &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-152"><a href="#cb144-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-153"><a href="#cb144-153" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">p=</span><span class="dv">16</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-154"><a href="#cb144-154" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-155"><a href="#cb144-155" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span>.<span class="dv">8</span>,</span>
<span id="cb144-156"><a href="#cb144-156" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-157"><a href="#cb144-157" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-158"><a href="#cb144-158" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-159"><a href="#cb144-159" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;p &gt;= n_clusters * cluster_size + k_unclustered is not TRUE&quot;</span>,</span>
<span id="cb144-160"><a href="#cb144-160" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-161"><a href="#cb144-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-162"><a href="#cb144-162" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-163"><a href="#cb144-163" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-164"><a href="#cb144-164" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="dv">8</span>,</span>
<span id="cb144-165"><a href="#cb144-165" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-166"><a href="#cb144-166" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-167"><a href="#cb144-167" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-168"><a href="#cb144-168" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;abs(rho) &lt;= abs(var) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-169"><a href="#cb144-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-170"><a href="#cb144-170" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-171"><a href="#cb144-171" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-172"><a href="#cb144-172" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="dv">0</span>,</span>
<span id="cb144-173"><a href="#cb144-173" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-174"><a href="#cb144-174" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-175"><a href="#cb144-175" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-176"><a href="#cb144-176" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;rho != 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-177"><a href="#cb144-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-178"><a href="#cb144-178" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-179"><a href="#cb144-179" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-180"><a href="#cb144-180" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb144-181"><a href="#cb144-181" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="sc">-</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-182"><a href="#cb144-182" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-183"><a href="#cb144-183" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-184"><a href="#cb144-184" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;var &gt; 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-185"><a href="#cb144-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-186"><a href="#cb144-186" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-187"><a href="#cb144-187" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-188"><a href="#cb144-188" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb144-189"><a href="#cb144-189" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="dv">0</span>,</span>
<span id="cb144-190"><a href="#cb144-190" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-191"><a href="#cb144-191" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-192"><a href="#cb144-192" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;beta_latent != 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-193"><a href="#cb144-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-194"><a href="#cb144-194" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-195"><a href="#cb144-195" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-196"><a href="#cb144-196" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb144-197"><a href="#cb144-197" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-198"><a href="#cb144-198" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="dv">0</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-199"><a href="#cb144-199" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-200"><a href="#cb144-200" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;beta_unclustered != 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-201"><a href="#cb144-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-202"><a href="#cb144-202" aria-hidden="true" tabindex="-1"></a>  <span class="co"># k_unclustered</span></span>
<span id="cb144-203"><a href="#cb144-203" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="st">&quot;2&quot;</span>,</span>
<span id="cb144-204"><a href="#cb144-204" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-205"><a href="#cb144-205" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb144-206"><a href="#cb144-206" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-207"><a href="#cb144-207" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-208"><a href="#cb144-208" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-209"><a href="#cb144-209" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(k_unclustered) | is.integer(k_unclustered) is not TRUE&quot;</span>,</span>
<span id="cb144-210"><a href="#cb144-210" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-211"><a href="#cb144-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-212"><a href="#cb144-212" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb144-213"><a href="#cb144-213" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-214"><a href="#cb144-214" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb144-215"><a href="#cb144-215" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-216"><a href="#cb144-216" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-217"><a href="#cb144-217" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-218"><a href="#cb144-218" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;k_unclustered &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-219"><a href="#cb144-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-220"><a href="#cb144-220" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span>.<span class="dv">2</span>,</span>
<span id="cb144-221"><a href="#cb144-221" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-222"><a href="#cb144-222" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb144-223"><a href="#cb144-223" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-224"><a href="#cb144-224" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="dv">1</span>,</span>
<span id="cb144-225"><a href="#cb144-225" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-226"><a href="#cb144-226" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;k_unclustered == round(k_unclustered) is not TRUE&quot;</span>,</span>
<span id="cb144-227"><a href="#cb144-227" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-228"><a href="#cb144-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-229"><a href="#cb144-229" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-230"><a href="#cb144-230" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-231"><a href="#cb144-231" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb144-232"><a href="#cb144-232" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-233"><a href="#cb144-233" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="cn">NA</span>,</span>
<span id="cb144-234"><a href="#cb144-234" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-235"><a href="#cb144-235" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Must specify one of snr or sigma_eps_sq&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-236"><a href="#cb144-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-237"><a href="#cb144-237" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-238"><a href="#cb144-238" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-239"><a href="#cb144-239" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb144-240"><a href="#cb144-240" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-241"><a href="#cb144-241" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="sc">-</span>.<span class="dv">2</span>,</span>
<span id="cb144-242"><a href="#cb144-242" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="cn">NA</span>),</span>
<span id="cb144-243"><a href="#cb144-243" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;snr &gt; 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-244"><a href="#cb144-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-245"><a href="#cb144-245" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">19</span>, <span class="at">k_unclustered=</span><span class="dv">2</span>,</span>
<span id="cb144-246"><a href="#cb144-246" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">cluster_size=</span><span class="dv">5</span>, <span class="at">n_clusters=</span><span class="dv">3</span>,</span>
<span id="cb144-247"><a href="#cb144-247" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sig_clusters=</span><span class="dv">2</span>, <span class="at">rho=</span><span class="fl">0.8</span>,</span>
<span id="cb144-248"><a href="#cb144-248" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">var=</span><span class="fl">1.1</span>, <span class="at">beta_latent=</span><span class="fl">1.5</span>,</span>
<span id="cb144-249"><a href="#cb144-249" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">beta_unclustered=</span><span class="sc">-</span><span class="dv">2</span>, <span class="at">snr=</span><span class="cn">NA</span>,</span>
<span id="cb144-250"><a href="#cb144-250" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sigma_eps_sq=</span><span class="sc">-</span>.<span class="dv">3</span>),</span>
<span id="cb144-251"><a href="#cb144-251" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;sigma_eps_sq &gt; 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-252"><a href="#cb144-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-253"><a href="#cb144-253" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😀</code></pre>
<p><code>getLassoLambda()</code>:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Get lambda value for lasso</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Chooses a lambda value for the lasso used on a subsample of size n/2 (as in</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster stability selection) by cross-validation.</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X An n x p numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the p &gt;= 2 features/predictors that will be used by cluster stability</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection.</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y The response; an n-dimensional numeric or integer vector. (Unlike</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in the more general css setup, this response must be real-valued since</span></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; lambda will be determined using the lasso with cross-validation.)</span></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda_choice Character; either &quot;min&quot; or &quot;1se&quot;. If &quot;min&quot;, chooses</span></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the lambda that minimizes the cross-validated error; if &quot;1se&quot;, chooses the</span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; largest lambda within one standard error of the minimum error lambda</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (resulting in a smaller selected set, which may be desirable because the</span></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; model size corresponding to the minimum error lambda tends to be larger</span></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; than optimal. See, for example, Bühlmann and Meinshausen 2006, Prop. 1 and</span></span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Bühlmann and van de Geer 2011, Section 2.5.1.). Default is &quot;1se&quot;.</span></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param nfolds Numeric or integer; the number of folds for cross-validation.</span></span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Must be at least 4 (as specified by cv.glmnet). Default is 10.</span></span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A numeric; the selected value of lambda.</span></span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references Bühlmann, P., &amp; Meinshausen, N. (2006). High-Dimensional Graphs</span></span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; and Variable Selection With the Lasso. \emph{The Annals of Statistics},</span></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 34(3), 1436–1462. \url{https://doi.org/10.1214/009053606000000281}.</span></span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \cr Peter Bühlmann and Sara van de Geer. Statistics for High-Dimensional</span></span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Data. \emph{Springer Series in Statistics}. Springer, Heidelberg, 2011. ISBN</span></span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 978-3-642-20191-2. \url{http://dx.doi.org/10.1007/978-3-642-20192-9}. \cr</span></span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Jerome Friedman, Trevor Hastie, Robert Tibshirani (2010). Regularization</span></span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Paths for Generalized Linear Models via Coordinate Descent. \emph{Journal of</span></span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Statistical Software}, 33(1), 1-22. URL \url{https://www.jstatsoft.org/v33/i01/}.</span></span>
<span id="cb146-32"><a href="#cb146-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb146-33"><a href="#cb146-33" aria-hidden="true" tabindex="-1"></a>getLassoLambda <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, <span class="at">lambda_choice=</span><span class="st">&quot;1se&quot;</span>, <span class="at">nfolds=</span><span class="dv">10</span>){</span>
<span id="cb146-34"><a href="#cb146-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(lambda_choice))</span>
<span id="cb146-35"><a href="#cb146-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(lambda_choice) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb146-36"><a href="#cb146-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(lambda_choice))</span>
<span id="cb146-37"><a href="#cb146-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(lambda_choice <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;min&quot;</span>, <span class="st">&quot;1se&quot;</span>))</span>
<span id="cb146-38"><a href="#cb146-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-39"><a href="#cb146-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X))</span>
<span id="cb146-40"><a href="#cb146-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(X) <span class="sc">|</span> <span class="fu">is.integer</span>(X))</span>
<span id="cb146-41"><a href="#cb146-41" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb146-42"><a href="#cb146-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-43"><a href="#cb146-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(nfolds) <span class="sc">|</span> <span class="fu">is.integer</span>(nfolds))</span>
<span id="cb146-44"><a href="#cb146-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(nfolds) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb146-45"><a href="#cb146-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(nfolds <span class="sc">==</span> <span class="fu">round</span>(nfolds))</span>
<span id="cb146-46"><a href="#cb146-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(nfolds <span class="sc">&gt;</span> <span class="dv">3</span>)</span>
<span id="cb146-47"><a href="#cb146-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-48"><a href="#cb146-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Since we are using the lasso, we require y to be a real-valued response</span></span>
<span id="cb146-49"><a href="#cb146-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (unlike for the general cluster stability selection procedure, where y</span></span>
<span id="cb146-50"><a href="#cb146-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># can have a more general format as long as a suitable feature selection</span></span>
<span id="cb146-51"><a href="#cb146-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># function is provided by the user)</span></span>
<span id="cb146-52"><a href="#cb146-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(y) <span class="sc">|</span> <span class="fu">is.integer</span>(y))</span>
<span id="cb146-53"><a href="#cb146-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n <span class="sc">==</span> <span class="fu">length</span>(y))</span>
<span id="cb146-54"><a href="#cb146-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-55"><a href="#cb146-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample size to use: inflate n/2 by a factor of nfolds/(nfolds - 1),</span></span>
<span id="cb146-56"><a href="#cb146-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># so that each individual lasso fit is of size floor(n/2)</span></span>
<span id="cb146-57"><a href="#cb146-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-58"><a href="#cb146-58" aria-hidden="true" tabindex="-1"></a>    n_sample <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">round</span>(n<span class="sc">/</span><span class="dv">2</span><span class="sc">*</span>nfolds<span class="sc">/</span>(nfolds <span class="sc">-</span> <span class="dv">1</span>)), n)</span>
<span id="cb146-59"><a href="#cb146-59" aria-hidden="true" tabindex="-1"></a>    nfolds <span class="ot">&lt;-</span> <span class="fu">min</span>(nfolds, n_sample)</span>
<span id="cb146-60"><a href="#cb146-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-61"><a href="#cb146-61" aria-hidden="true" tabindex="-1"></a>    inds_size <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n, n_sample)</span>
<span id="cb146-62"><a href="#cb146-62" aria-hidden="true" tabindex="-1"></a>    size_results <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">cv.glmnet</span>(<span class="at">x=</span>X[inds_size, ], <span class="at">y=</span>y[inds_size],</span>
<span id="cb146-63"><a href="#cb146-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">nfolds=</span>nfolds)</span>
<span id="cb146-64"><a href="#cb146-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-65"><a href="#cb146-65" aria-hidden="true" tabindex="-1"></a>    lambda_ret <span class="ot">&lt;-</span> size_results[[<span class="fu">paste</span>(<span class="st">&quot;lambda.&quot;</span>, lambda_choice, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)]]</span>
<span id="cb146-66"><a href="#cb146-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-67"><a href="#cb146-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb146-68"><a href="#cb146-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(lambda_ret) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb146-69"><a href="#cb146-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(lambda_ret) <span class="sc">|</span> <span class="fu">is.integer</span>(lambda_ret))</span>
<span id="cb146-70"><a href="#cb146-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(lambda_ret <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb146-71"><a href="#cb146-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-72"><a href="#cb146-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(lambda_ret)</span>
<span id="cb146-73"><a href="#cb146-73" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>getLassoLambda()</code>:</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getLassoLambda works&quot;</span>, {</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">7252</span>)</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">6</span>), <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">getLassoLambda</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda_choice=</span><span class="st">&quot;1se&quot;</span>, <span class="at">nfolds=</span><span class="dv">4</span>)</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret) <span class="sc">|</span> <span class="fu">is.integer</span>(ret))</span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(ret))</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret), <span class="dv">1</span>)</span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">getLassoLambda</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda_choice=</span><span class="st">&quot;min&quot;</span>, <span class="at">nfolds=</span><span class="dv">5</span>)</span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret) <span class="sc">|</span> <span class="fu">is.integer</span>(ret))</span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(ret))</span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret), <span class="dv">1</span>)</span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad inputs</span></span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getLassoLambda</span>(<span class="at">X=</span><span class="st">&quot;x&quot;</span>, <span class="at">y=</span>y), <span class="st">&quot;is.matrix(X) is not TRUE&quot;</span>,</span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getLassoLambda</span>(<span class="at">X=</span>x[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, ], <span class="at">y=</span>y),</span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n == length(y) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-28"><a href="#cb147-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getLassoLambda</span>(<span class="at">X=</span>x, <span class="at">y=</span><span class="cn">TRUE</span>),</span>
<span id="cb147-29"><a href="#cb147-29" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(y) | is.integer(y) is not TRUE&quot;</span>,</span>
<span id="cb147-30"><a href="#cb147-30" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb147-31"><a href="#cb147-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-32"><a href="#cb147-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Error has quotation marks in it</span></span>
<span id="cb147-33"><a href="#cb147-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getLassoLambda</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda_choice=</span><span class="st">&quot;mni&quot;</span>))</span>
<span id="cb147-34"><a href="#cb147-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-35"><a href="#cb147-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getLassoLambda</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb147-36"><a href="#cb147-36" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">lambda_choice=</span><span class="fu">c</span>(<span class="st">&quot;min&quot;</span>, <span class="st">&quot;1se&quot;</span>)),</span>
<span id="cb147-37"><a href="#cb147-37" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(lambda_choice) == 1 is not TRUE&quot;</span>,</span>
<span id="cb147-38"><a href="#cb147-38" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb147-39"><a href="#cb147-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-40"><a href="#cb147-40" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getLassoLambda</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda_choice=</span><span class="dv">1</span>),</span>
<span id="cb147-41"><a href="#cb147-41" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.character(lambda_choice) is not TRUE&quot;</span>,</span>
<span id="cb147-42"><a href="#cb147-42" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb147-43"><a href="#cb147-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-44"><a href="#cb147-44" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getLassoLambda</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">nfolds=</span><span class="st">&quot;5&quot;</span>),</span>
<span id="cb147-45"><a href="#cb147-45" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(nfolds) | is.integer(nfolds) is not TRUE&quot;</span>,</span>
<span id="cb147-46"><a href="#cb147-46" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb147-47"><a href="#cb147-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-48"><a href="#cb147-48" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getLassoLambda</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">nfolds=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>),</span>
<span id="cb147-49"><a href="#cb147-49" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(nfolds) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb147-50"><a href="#cb147-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-51"><a href="#cb147-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getLassoLambda</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">nfolds=</span><span class="fl">3.2</span>),</span>
<span id="cb147-52"><a href="#cb147-52" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;nfolds == round(nfolds) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb147-53"><a href="#cb147-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-54"><a href="#cb147-54" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getLassoLambda</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">nfolds=</span><span class="dv">3</span>),</span>
<span id="cb147-55"><a href="#cb147-55" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;nfolds &gt; 3 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb147-56"><a href="#cb147-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-57"><a href="#cb147-57" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## ── Warning (&#39;&lt;text&gt;:7&#39;): getLassoLambda works ──────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) getLassoLambda(X = x, y = y, lambda_choice = &quot;1se&quot;, nfolds = 4)
##  2. glmnet::cv.glmnet(...)
##  3. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:14&#39;): getLassoLambda works ─────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) getLassoLambda(X = x, y = y, lambda_choice = &quot;min&quot;, nfolds = 5)
##  2. glmnet::cv.glmnet(...)
##  3. glmnet:::cv.glmnet.raw(...)</code></pre>
<p><code>getModelSize()</code>:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Automated estimation of model size</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; This function is uses the lasso with cross-validation to estimate the</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; model size. Before using the lasso, in each cluster all features will be</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; dropped from X except the one feature with the highest marginal correlation</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; with y, as in the protolasso (Reid and Tibshirani 2016).</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X An n x p numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the p &gt;= 2 features/predictors.</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y A length-n numeric vector containing the responses; `y[i]` is the</span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response corresponding to observation `X[i, ]`. (Note that for the css</span></span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; function, y does not have to be a numeric response, but for this function,</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the underlying selection procedure is the lasso, so y must be a real-valued</span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response.)</span></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A named list where each entry is an integer vector of indices</span></span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of features that are in a common cluster, as in the output of css.</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (The length of list clusters is equal to the number of clusters.) All</span></span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; identified clusters must be non-overlapping, and all features must appear in</span></span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; exactly one cluster (any unclustered features should be in their own</span></span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;cluster&quot; of size 1).</span></span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return An integer; the estimated size of the model. The minimum returned</span></span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; value is 1, even if the lasso with cross-validation chose no features.</span></span>
<span id="cb149-24"><a href="#cb149-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb149-25"><a href="#cb149-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references Reid, S., &amp; Tibshirani, R. (2016). Sparse regression and marginal</span></span>
<span id="cb149-26"><a href="#cb149-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; testing using cluster prototypes. \emph{Biostatistics}, 17(2), 364–376.</span></span>
<span id="cb149-27"><a href="#cb149-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://doi.org/10.1093/biostatistics/kxv049}.</span></span>
<span id="cb149-28"><a href="#cb149-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb149-29"><a href="#cb149-29" aria-hidden="true" tabindex="-1"></a>getModelSize <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, clusters){</span>
<span id="cb149-30"><a href="#cb149-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X) <span class="sc">|</span> <span class="fu">is.data.frame</span>(X))</span>
<span id="cb149-31"><a href="#cb149-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-32"><a href="#cb149-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if x is a matrix; if it&#39;s a data.frame, convert to matrix.</span></span>
<span id="cb149-33"><a href="#cb149-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.data.frame</span>(X)){</span>
<span id="cb149-34"><a href="#cb149-34" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X)</span>
<span id="cb149-35"><a href="#cb149-35" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> X[, <span class="fu">colnames</span>(X) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb149-36"><a href="#cb149-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-37"><a href="#cb149-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-38"><a href="#cb149-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X))</span>
<span id="cb149-39"><a href="#cb149-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(X)))</span>
<span id="cb149-40"><a href="#cb149-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(X) <span class="sc">|</span> <span class="fu">is.integer</span>(X))</span>
<span id="cb149-41"><a href="#cb149-41" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb149-42"><a href="#cb149-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-43"><a href="#cb149-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Since the model size will be determined by cross-validation, the provided</span></span>
<span id="cb149-44"><a href="#cb149-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y must be real-valued (this should be checked internally in other</span></span>
<span id="cb149-45"><a href="#cb149-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># functions before getModelSize is called, but this check is here just in</span></span>
<span id="cb149-46"><a href="#cb149-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># case).</span></span>
<span id="cb149-47"><a href="#cb149-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.numeric</span>(y) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.integer</span>(y)){</span>
<span id="cb149-48"><a href="#cb149-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;getModelSize is trying to determine max_num_clusts using the lasso with cross-validation, but the y provided to getModelSize was not real-valued.&quot;</span>)</span>
<span id="cb149-49"><a href="#cb149-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-50"><a href="#cb149-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(y) <span class="sc">==</span> n)</span>
<span id="cb149-51"><a href="#cb149-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-52"><a href="#cb149-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check clusters argument</span></span>
<span id="cb149-53"><a href="#cb149-53" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> <span class="fu">checkCssClustersInput</span>(clusters)</span>
<span id="cb149-54"><a href="#cb149-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-55"><a href="#cb149-55" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Format clusters into a list where all features are in exactly one</span></span>
<span id="cb149-56"><a href="#cb149-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cluster (any unclustered features are put in their own &quot;cluster&quot; of size</span></span>
<span id="cb149-57"><a href="#cb149-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1).</span></span>
<span id="cb149-58"><a href="#cb149-58" aria-hidden="true" tabindex="-1"></a>    clust_names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)</span>
<span id="cb149-59"><a href="#cb149-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(clusters)) <span class="sc">&amp;</span> <span class="fu">is.list</span>(clusters)){</span>
<span id="cb149-60"><a href="#cb149-60" aria-hidden="true" tabindex="-1"></a>        clust_names <span class="ot">&lt;-</span> <span class="fu">names</span>(clusters)</span>
<span id="cb149-61"><a href="#cb149-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-62"><a href="#cb149-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-63"><a href="#cb149-63" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> <span class="fu">formatClusters</span>(clusters, <span class="at">p=</span><span class="fu">ncol</span>(X),</span>
<span id="cb149-64"><a href="#cb149-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">clust_names=</span>clust_names)<span class="sc">$</span>clusters</span>
<span id="cb149-65"><a href="#cb149-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-66"><a href="#cb149-66" aria-hidden="true" tabindex="-1"></a>    X_size <span class="ot">&lt;-</span> X</span>
<span id="cb149-67"><a href="#cb149-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-68"><a href="#cb149-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(clusters) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb149-69"><a href="#cb149-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create modified design matrix by dropping all but one feature from</span></span>
<span id="cb149-70"><a href="#cb149-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># each cluster</span></span>
<span id="cb149-71"><a href="#cb149-71" aria-hidden="true" tabindex="-1"></a>        feats_to_drop <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb149-72"><a href="#cb149-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(clusters)){</span>
<span id="cb149-73"><a href="#cb149-73" aria-hidden="true" tabindex="-1"></a>            cluster_i <span class="ot">&lt;-</span> clusters[[i]]</span>
<span id="cb149-74"><a href="#cb149-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">length</span>(cluster_i) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb149-75"><a href="#cb149-75" aria-hidden="true" tabindex="-1"></a>                feat_to_keep <span class="ot">&lt;-</span> <span class="fu">identifyPrototype</span>(cluster_i, X, y)</span>
<span id="cb149-76"><a href="#cb149-76" aria-hidden="true" tabindex="-1"></a>                feats_to_drop <span class="ot">&lt;-</span> <span class="fu">c</span>(feats_to_drop, <span class="fu">setdiff</span>(cluster_i,</span>
<span id="cb149-77"><a href="#cb149-77" aria-hidden="true" tabindex="-1"></a>                    feat_to_keep))</span>
<span id="cb149-78"><a href="#cb149-78" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb149-79"><a href="#cb149-79" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb149-80"><a href="#cb149-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(feats_to_drop) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb149-81"><a href="#cb149-81" aria-hidden="true" tabindex="-1"></a>            X_size <span class="ot">&lt;-</span> X_size[, <span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>feats_to_drop]</span>
<span id="cb149-82"><a href="#cb149-82" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb149-83"><a href="#cb149-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-84"><a href="#cb149-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-85"><a href="#cb149-85" aria-hidden="true" tabindex="-1"></a>    size_results <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">cv.glmnet</span>(<span class="at">x=</span>X_size, <span class="at">y=</span>y, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>)</span>
<span id="cb149-86"><a href="#cb149-86" aria-hidden="true" tabindex="-1"></a>    coefs <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(glmnet<span class="sc">::</span><span class="fu">coef.glmnet</span>(size_results, <span class="at">s=</span><span class="st">&quot;lambda.1se&quot;</span>))</span>
<span id="cb149-87"><a href="#cb149-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-88"><a href="#cb149-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of nonzero coefficients (subtract one in order to ignore intercept)</span></span>
<span id="cb149-89"><a href="#cb149-89" aria-hidden="true" tabindex="-1"></a>    size <span class="ot">&lt;-</span> <span class="fu">length</span>(coefs[coefs <span class="sc">!=</span> <span class="dv">0</span>]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb149-90"><a href="#cb149-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-91"><a href="#cb149-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb149-92"><a href="#cb149-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(size) <span class="sc">|</span> <span class="fu">is.integer</span>(size))</span>
<span id="cb149-93"><a href="#cb149-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(size))</span>
<span id="cb149-94"><a href="#cb149-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(size) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb149-95"><a href="#cb149-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(size <span class="sc">==</span> <span class="fu">round</span>(size))</span>
<span id="cb149-96"><a href="#cb149-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-97"><a href="#cb149-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">as.integer</span>(<span class="fu">max</span>(size, <span class="dv">1</span>)))</span>
<span id="cb149-98"><a href="#cb149-98" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>getModelSize()</code>:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getModelSize works&quot;</span>, {</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1723</span>)</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">15</span>, <span class="at">p=</span><span class="dv">11</span>, <span class="at">k_unclustered=</span><span class="dv">1</span>, <span class="at">cluster_size=</span><span class="dv">3</span>,</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">n_clusters=</span><span class="dv">2</span>, <span class="at">sigma_eps_sq=</span><span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">6</span>))</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> data<span class="sc">$</span>X</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data<span class="sc">$</span>y</span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>3L, <span class="at">green_cluster=</span>4L<span class="sc">:</span>6L)</span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters)</span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret) <span class="sc">|</span> <span class="fu">is.integer</span>(ret))</span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(ret))</span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret), <span class="dv">1</span>)</span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret, <span class="fu">round</span>(ret))</span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 11 features, but two clusters of size 3, so maximum size should</span></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># be 11 - 2 - 2 = 7</span></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">&lt;=</span> <span class="dv">7</span>)</span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying other inputs</span></span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a>  unnamed_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(1L<span class="sc">:</span>3L, 5L<span class="sc">:</span>8L)</span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>unnamed_clusters)</span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret) <span class="sc">|</span> <span class="fu">is.integer</span>(ret))</span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(ret))</span>
<span id="cb150-31"><a href="#cb150-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret), <span class="dv">1</span>)</span>
<span id="cb150-32"><a href="#cb150-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret, <span class="fu">round</span>(ret))</span>
<span id="cb150-33"><a href="#cb150-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb150-34"><a href="#cb150-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 11 features, but 3 in one cluster and 4 in another, so maximum size should</span></span>
<span id="cb150-35"><a href="#cb150-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># be 11 - 2 - 3 = 6</span></span>
<span id="cb150-36"><a href="#cb150-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">&lt;=</span> <span class="dv">6</span>)</span>
<span id="cb150-37"><a href="#cb150-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-38"><a href="#cb150-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Single cluster</span></span>
<span id="cb150-39"><a href="#cb150-39" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span><span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb150-40"><a href="#cb150-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-41"><a href="#cb150-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret) <span class="sc">|</span> <span class="fu">is.integer</span>(ret))</span>
<span id="cb150-42"><a href="#cb150-42" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(ret))</span>
<span id="cb150-43"><a href="#cb150-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret), <span class="dv">1</span>)</span>
<span id="cb150-44"><a href="#cb150-44" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret, <span class="fu">round</span>(ret))</span>
<span id="cb150-45"><a href="#cb150-45" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb150-46"><a href="#cb150-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 11 features, but 4 in one cluster, so maximum size should be 11 - 3 = 8</span></span>
<span id="cb150-47"><a href="#cb150-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">&lt;=</span> <span class="dv">8</span>)</span>
<span id="cb150-48"><a href="#cb150-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-49"><a href="#cb150-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-50"><a href="#cb150-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Intentionally don&#39;t provide clusters for all feature, mix up formatting,</span></span>
<span id="cb150-51"><a href="#cb150-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># etc.</span></span>
<span id="cb150-52"><a href="#cb150-52" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb150-53"><a href="#cb150-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-54"><a href="#cb150-54" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters)</span>
<span id="cb150-55"><a href="#cb150-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-56"><a href="#cb150-56" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret) <span class="sc">|</span> <span class="fu">is.integer</span>(ret))</span>
<span id="cb150-57"><a href="#cb150-57" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(ret))</span>
<span id="cb150-58"><a href="#cb150-58" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret), <span class="dv">1</span>)</span>
<span id="cb150-59"><a href="#cb150-59" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret, <span class="fu">round</span>(ret))</span>
<span id="cb150-60"><a href="#cb150-60" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb150-61"><a href="#cb150-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 11 features, but 3 in one cluster and 4 in another, so maximum size should</span></span>
<span id="cb150-62"><a href="#cb150-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># be 11 - 2 - 3 = 6</span></span>
<span id="cb150-63"><a href="#cb150-63" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">&lt;=</span> <span class="dv">6</span>)</span>
<span id="cb150-64"><a href="#cb150-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-65"><a href="#cb150-65" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying bad inputs</span></span>
<span id="cb150-66"><a href="#cb150-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-67"><a href="#cb150-67" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getModelSize</span>(<span class="at">X=</span><span class="st">&quot;x&quot;</span>, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters),</span>
<span id="cb150-68"><a href="#cb150-68" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.matrix(X) | is.data.frame(X) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-69"><a href="#cb150-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-70"><a href="#cb150-70" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getModelSize</span>(<span class="at">X=</span>x[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, ], <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters),</span>
<span id="cb150-71"><a href="#cb150-71" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(y) == n is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-72"><a href="#cb150-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-73"><a href="#cb150-73" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span><span class="cn">FALSE</span>, <span class="at">clusters=</span>good_clusters),</span>
<span id="cb150-74"><a href="#cb150-74" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;getModelSize is trying to determine max_num_clusts using the lasso with cross-validation, but the y provided to getModelSize was not real-valued.&quot;</span>,</span>
<span id="cb150-75"><a href="#cb150-75" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-76"><a href="#cb150-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-77"><a href="#cb150-77" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">7</span>, <span class="dv">7</span><span class="sc">:</span><span class="dv">10</span>)),</span>
<span id="cb150-78"><a href="#cb150-78" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Overlapping clusters detected; clusters must be non-overlapping. Overlapping clusters: 1, 2.&quot;</span>,</span>
<span id="cb150-79"><a href="#cb150-79" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-80"><a href="#cb150-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-81"><a href="#cb150-81" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>)),</span>
<span id="cb150-82"><a href="#cb150-82" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(clusters) == length(unique(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb150-83"><a href="#cb150-83" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-84"><a href="#cb150-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-85"><a href="#cb150-85" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span><span class="dv">6</span><span class="sc">:</span><span class="dv">50</span>),</span>
<span id="cb150-86"><a href="#cb150-86" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(all_clustered_feats) == p is not TRUE&quot;</span>,</span>
<span id="cb150-87"><a href="#cb150-87" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-88"><a href="#cb150-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-89"><a href="#cb150-89" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb150-90"><a href="#cb150-90" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">as.integer</span>(<span class="cn">NA</span>))),</span>
<span id="cb150-91"><a href="#cb150-91" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.na(clusters) are not all TRUE&quot;</span>,</span>
<span id="cb150-92"><a href="#cb150-92" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-93"><a href="#cb150-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-94"><a href="#cb150-94" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">5</span>))),</span>
<span id="cb150-95"><a href="#cb150-95" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(clusters[[i]]) == length(unique(clusters[[i]])) is not TRUE&quot;</span>,</span>
<span id="cb150-96"><a href="#cb150-96" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-97"><a href="#cb150-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-98"><a href="#cb150-98" aria-hidden="true" tabindex="-1"></a>   testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="sc">-</span><span class="dv">1</span>)),</span>
<span id="cb150-99"><a href="#cb150-99" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(clusters[[i]] &gt;= 1) is not TRUE&quot;</span>,</span>
<span id="cb150-100"><a href="#cb150-100" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-101"><a href="#cb150-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-102"><a href="#cb150-102" aria-hidden="true" tabindex="-1"></a>   testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getModelSize</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb150-103"><a href="#cb150-103" aria-hidden="true" tabindex="-1"></a>                                                               <span class="fu">c</span>(<span class="fl">2.3</span>, <span class="fl">1.2</span>))),</span>
<span id="cb150-104"><a href="#cb150-104" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(clusters[[i]] == round(clusters[[i]])) is not TRUE&quot;</span>,</span>
<span id="cb150-105"><a href="#cb150-105" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-106"><a href="#cb150-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-107"><a href="#cb150-107" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## ── Warning (&#39;&lt;text&gt;:12&#39;): getModelSize works ───────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) getModelSize(X = x, y = y, clusters = good_clusters)
##  2. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  3. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:27&#39;): getModelSize works ───────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) getModelSize(X = x, y = y, clusters = unnamed_clusters)
##  2. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  3. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:39&#39;): getModelSize works ───────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) getModelSize(X = x, y = y, clusters = 2:5)
##  2. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  3. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:54&#39;): getModelSize works ───────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) getModelSize(X = x, y = y, clusters = good_clusters)
##  2. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  3. glmnet:::cv.glmnet.raw(...)</code></pre>
<p><code>printCssDf()</code>:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Prepares a data.frame summarazing cluster stability selection output to print</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Print a summary of the information from the css function.</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; the outputted data.frame will display only those</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters with selection proportions equal to at least cutoff. Must be between</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 0 and 1. Default is 0 (in which case either all clusters are displayed, or</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts are, if max_num_clusts is specified).</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.) Default is 1.</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) Default is NA (in which case</span></span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts is ignored).</span></span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A data.frame; each row contains a cluster, arranged in decreasing</span></span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; order of cluster selection proportion from top to bottom. The columns are</span></span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; ClustName (the name of the cluster that was either provided to css or made by</span></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css if no name was provided); ClustProtoName (the name of the selection</span></span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; prototype from the cluster, which is the feature with the greatest individual</span></span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection proportion among all the cluster members, with ties broken by</span></span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; choosing the feature with the highest correlation with the response if the</span></span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response is real-valued; only returned if the features are named),</span></span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; ClustProtoNum (the column number of the prototype in the X matrix provided to</span></span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css), and ClustSize (the size of the cluster).</span></span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a>printCssDf <span class="ot">&lt;-</span> <span class="cf">function</span>(css_results, <span class="at">cutoff=</span><span class="dv">0</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>,</span>
<span id="cb152-32"><a href="#cb152-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_num_clusts=</span><span class="cn">NA</span>){</span>
<span id="cb152-33"><a href="#cb152-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb152-34"><a href="#cb152-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">class</span>(css_results) <span class="sc">==</span> <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb152-35"><a href="#cb152-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkCutoff</span>(cutoff)</span>
<span id="cb152-36"><a href="#cb152-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-37"><a href="#cb152-37" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(css_results<span class="sc">$</span>feat_sel_mat)</span>
<span id="cb152-38"><a href="#cb152-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-39"><a href="#cb152-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkMinNumClusts</span>(min_num_clusts, p, <span class="fu">length</span>(css_results<span class="sc">$</span>clusters))</span>
<span id="cb152-40"><a href="#cb152-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-41"><a href="#cb152-41" aria-hidden="true" tabindex="-1"></a>    max_num_clusts <span class="ot">&lt;-</span> <span class="fu">checkMaxNumClusts</span>(max_num_clusts, min_num_clusts, p,</span>
<span id="cb152-42"><a href="#cb152-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(css_results<span class="sc">$</span>clusters))</span>
<span id="cb152-43"><a href="#cb152-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-44"><a href="#cb152-44" aria-hidden="true" tabindex="-1"></a>    sel_clusts <span class="ot">&lt;-</span> <span class="fu">getCssSelections</span>(css_results, <span class="at">cutoff=</span>cutoff,</span>
<span id="cb152-45"><a href="#cb152-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_num_clusts=</span>min_num_clusts,</span>
<span id="cb152-46"><a href="#cb152-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">max_num_clusts=</span>max_num_clusts)<span class="sc">$</span>selected_clusts</span>
<span id="cb152-47"><a href="#cb152-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-48"><a href="#cb152-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sel_clusts is guaranteed to have length at least 1 by</span></span>
<span id="cb152-49"><a href="#cb152-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># getCssSelections </span></span>
<span id="cb152-50"><a href="#cb152-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-51"><a href="#cb152-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get prototypes (feature from each cluster with highest selection</span></span>
<span id="cb152-52"><a href="#cb152-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># proportion, breaking ties by using marginal correlations of features with</span></span>
<span id="cb152-53"><a href="#cb152-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y from data provided to css if y is real-valued)</span></span>
<span id="cb152-54"><a href="#cb152-54" aria-hidden="true" tabindex="-1"></a>    prototypes <span class="ot">&lt;-</span> <span class="fu">getSelectionPrototypes</span>(css_results, sel_clusts)</span>
<span id="cb152-55"><a href="#cb152-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-56"><a href="#cb152-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cluster selection proportions</span></span>
<span id="cb152-57"><a href="#cb152-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(sel_clusts) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb152-58"><a href="#cb152-58" aria-hidden="true" tabindex="-1"></a>        sel_clust_sel_props <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(css_results<span class="sc">$</span>clus_sel_mat[,</span>
<span id="cb152-59"><a href="#cb152-59" aria-hidden="true" tabindex="-1"></a>            <span class="fu">names</span>(sel_clusts)])</span>
<span id="cb152-60"><a href="#cb152-60" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb152-61"><a href="#cb152-61" aria-hidden="true" tabindex="-1"></a>        sel_clust_sel_props <span class="ot">&lt;-</span> <span class="fu">mean</span>(css_results<span class="sc">$</span>clus_sel_mat[,</span>
<span id="cb152-62"><a href="#cb152-62" aria-hidden="true" tabindex="-1"></a>            <span class="fu">names</span>(sel_clusts)])</span>
<span id="cb152-63"><a href="#cb152-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb152-64"><a href="#cb152-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-65"><a href="#cb152-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data.frame: name of cluster, cluster prototype, selection proportion,</span></span>
<span id="cb152-66"><a href="#cb152-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cluster size</span></span>
<span id="cb152-67"><a href="#cb152-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-68"><a href="#cb152-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(prototypes))){</span>
<span id="cb152-69"><a href="#cb152-69" aria-hidden="true" tabindex="-1"></a>        print_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ClustName=</span><span class="fu">names</span>(sel_clusts),</span>
<span id="cb152-70"><a href="#cb152-70" aria-hidden="true" tabindex="-1"></a>            <span class="at">ClustProtoName=</span><span class="fu">names</span>(prototypes), <span class="at">ClustProtoNum=</span><span class="fu">unname</span>(prototypes),</span>
<span id="cb152-71"><a href="#cb152-71" aria-hidden="true" tabindex="-1"></a>            <span class="at">ClustSelProp=</span>sel_clust_sel_props, <span class="at">ClustSize=</span><span class="fu">lengths</span>(sel_clusts))</span>
<span id="cb152-72"><a href="#cb152-72" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb152-73"><a href="#cb152-73" aria-hidden="true" tabindex="-1"></a>        print_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ClustName=</span><span class="fu">names</span>(sel_clusts),</span>
<span id="cb152-74"><a href="#cb152-74" aria-hidden="true" tabindex="-1"></a>            <span class="at">ClustProtoNum=</span><span class="fu">unname</span>(prototypes), <span class="at">ClustSelProp=</span>sel_clust_sel_props,</span>
<span id="cb152-75"><a href="#cb152-75" aria-hidden="true" tabindex="-1"></a>            <span class="at">ClustSize=</span><span class="fu">lengths</span>(sel_clusts))</span>
<span id="cb152-76"><a href="#cb152-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb152-77"><a href="#cb152-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-78"><a href="#cb152-78" aria-hidden="true" tabindex="-1"></a>    print_df <span class="ot">&lt;-</span> print_df[<span class="fu">order</span>(print_df<span class="sc">$</span>ClustSelProp, <span class="at">decreasing=</span><span class="cn">TRUE</span>), ]</span>
<span id="cb152-79"><a href="#cb152-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-80"><a href="#cb152-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(print_df) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb152-81"><a href="#cb152-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-82"><a href="#cb152-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.data.frame</span>(print_df))</span>
<span id="cb152-83"><a href="#cb152-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(print_df) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb152-84"><a href="#cb152-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-85"><a href="#cb152-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(print_df)</span>
<span id="cb152-86"><a href="#cb152-86" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>getSelectionPrototypes()</code></p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Identify selection prototypes from selected clusters</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Takes in list of selected clusters and returns an integer vector of the</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of the features that were most frequently selected from each cluster</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param css_results An object of class &quot;cssr&quot; (the output of the function</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css).</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param selected_clusts A list of integer vectors; each vector must contain</span></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the indices of features in a cluster.</span></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return An integer vector (of length equal to the number of clusters) of the</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of the feature prototypes (the features from each cluster that were</span></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selected the most often individually by the base method in cluster stability</span></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection). In the case of a tie, the tie is broken by choosing the feature</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; most correlated with the response in the full data set provided to css.</span></span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>getSelectionPrototypes <span class="ot">&lt;-</span> <span class="cf">function</span>(css_results, selected_clusts){</span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">class</span>(css_results) <span class="sc">==</span> <span class="st">&quot;cssr&quot;</span>)</span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.list</span>(selected_clusts))</span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a>    n_selected_clusts <span class="ot">&lt;-</span> <span class="fu">length</span>(selected_clusts)</span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n_selected_clusts <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">lengths</span>(selected_clusts) <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-26"><a href="#cb153-26" aria-hidden="true" tabindex="-1"></a>    prototypes <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">as.integer</span>(<span class="cn">NA</span>), n_selected_clusts)</span>
<span id="cb153-27"><a href="#cb153-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_selected_clusts){</span>
<span id="cb153-28"><a href="#cb153-28" aria-hidden="true" tabindex="-1"></a>        clust_i <span class="ot">&lt;-</span> selected_clusts[[i]]</span>
<span id="cb153-29"><a href="#cb153-29" aria-hidden="true" tabindex="-1"></a>        sel_props_i <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(css_results<span class="sc">$</span>feat_sel_mat)[clust_i]</span>
<span id="cb153-30"><a href="#cb153-30" aria-hidden="true" tabindex="-1"></a>        proto_i <span class="ot">&lt;-</span> clust_i[sel_props_i <span class="sc">==</span> <span class="fu">max</span>(sel_props_i)]</span>
<span id="cb153-31"><a href="#cb153-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(proto_i) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb153-32"><a href="#cb153-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(proto_i) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb153-33"><a href="#cb153-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">is.numeric</span>(css_results<span class="sc">$</span>y) <span class="sc">|</span> <span class="fu">is.integer</span>(css_results<span class="sc">$</span>y)){</span>
<span id="cb153-34"><a href="#cb153-34" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Break tie by looking at marginal correlations</span></span>
<span id="cb153-35"><a href="#cb153-35" aria-hidden="true" tabindex="-1"></a>                corrs_i <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">cor</span>(css_results<span class="sc">$</span>X[, proto_i], css_results<span class="sc">$</span>y)[, <span class="dv">1</span>]</span>
<span id="cb153-36"><a href="#cb153-36" aria-hidden="true" tabindex="-1"></a>                corrs_i <span class="ot">&lt;-</span> <span class="fu">abs</span>(corrs_i)</span>
<span id="cb153-37"><a href="#cb153-37" aria-hidden="true" tabindex="-1"></a>                proto_i <span class="ot">&lt;-</span> proto_i[corrs_i <span class="sc">==</span> <span class="fu">max</span>(corrs_i)]</span>
<span id="cb153-38"><a href="#cb153-38" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb153-39"><a href="#cb153-39" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb153-40"><a href="#cb153-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If there is still a tie, break by choosing the first feature of those</span></span>
<span id="cb153-41"><a href="#cb153-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># remaining</span></span>
<span id="cb153-42"><a href="#cb153-42" aria-hidden="true" tabindex="-1"></a>        prototypes[i] <span class="ot">&lt;-</span> proto_i[<span class="dv">1</span>]</span>
<span id="cb153-43"><a href="#cb153-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(prototypes)[i] <span class="ot">&lt;-</span> <span class="fu">colnames</span>(css_results<span class="sc">$</span>X)[proto_i]</span>
<span id="cb153-44"><a href="#cb153-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb153-45"><a href="#cb153-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-46"><a href="#cb153-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb153-47"><a href="#cb153-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-48"><a href="#cb153-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(prototypes))</span>
<span id="cb153-49"><a href="#cb153-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(prototypes)))</span>
<span id="cb153-50"><a href="#cb153-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(prototypes) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(prototypes)))</span>
<span id="cb153-51"><a href="#cb153-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-52"><a href="#cb153-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(prototypes)</span>
<span id="cb153-53"><a href="#cb153-53" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>getSelectionPrototypes()</code>:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getSelectionPrototypes works&quot;</span>, {</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">67234</span>)</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">15</span>, <span class="at">p=</span><span class="dv">11</span>, <span class="at">k_unclustered=</span><span class="dv">1</span>, <span class="at">cluster_size=</span><span class="dv">3</span>,</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">n_clusters=</span><span class="dv">2</span>, <span class="at">sig_clusters=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">6</span>))</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> data<span class="sc">$</span>X</span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data<span class="sc">$</span>y</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>3L, <span class="at">green_cluster=</span>4L<span class="sc">:</span>6L)</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>  css_results <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters)</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">getSelectionPrototypes</span>(css_results, <span class="at">selected_clusts=</span>good_clusters)</span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret))</span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(ret)))</span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret), <span class="fu">length</span>(good_clusters))</span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret), <span class="fu">length</span>(<span class="fu">unique</span>(ret)))</span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ret)){</span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[i] <span class="sc">%in%</span> good_clusters[[i]])</span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find the largest selection proportion of any feature in cluster i</span></span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>    max_prop <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">colMeans</span>(css_results<span class="sc">$</span>feat_sel_mat[, good_clusters[[i]]]))</span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find the selection proportion of the identified prototype</span></span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a>    proto_prop <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(css_results<span class="sc">$</span>feat_sel_mat)[ret[i]]</span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(max_prop, proto_prop)</span>
<span id="cb154-27"><a href="#cb154-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb154-28"><a href="#cb154-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-29"><a href="#cb154-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try with only one selected cluster (still should be in a list)</span></span>
<span id="cb154-30"><a href="#cb154-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-31"><a href="#cb154-31" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">getSelectionPrototypes</span>(css_results,</span>
<span id="cb154-32"><a href="#cb154-32" aria-hidden="true" tabindex="-1"></a>                                <span class="at">selected_clusts=</span><span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>3L))</span>
<span id="cb154-33"><a href="#cb154-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-34"><a href="#cb154-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret))</span>
<span id="cb154-35"><a href="#cb154-35" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.na</span>(ret))</span>
<span id="cb154-36"><a href="#cb154-36" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret), <span class="dv">1</span>)</span>
<span id="cb154-37"><a href="#cb154-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret <span class="sc">%in%</span> 1L<span class="sc">:</span>3L)</span>
<span id="cb154-38"><a href="#cb154-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the largest selection proportion of any feature in the cluster</span></span>
<span id="cb154-39"><a href="#cb154-39" aria-hidden="true" tabindex="-1"></a>  max_prop <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">colMeans</span>(css_results<span class="sc">$</span>feat_sel_mat[, 1L<span class="sc">:</span>3L]))</span>
<span id="cb154-40"><a href="#cb154-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the selection proportion of the identified prototype</span></span>
<span id="cb154-41"><a href="#cb154-41" aria-hidden="true" tabindex="-1"></a>  proto_prop <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(css_results<span class="sc">$</span>feat_sel_mat)[ret]</span>
<span id="cb154-42"><a href="#cb154-42" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(max_prop, proto_prop)</span>
<span id="cb154-43"><a href="#cb154-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-44"><a href="#cb154-44" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying bad inputs</span></span>
<span id="cb154-45"><a href="#cb154-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-46"><a href="#cb154-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Error contains quotation marks</span></span>
<span id="cb154-47"><a href="#cb154-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getSelectionPrototypes</span>(x, good_clusters))</span>
<span id="cb154-48"><a href="#cb154-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-49"><a href="#cb154-49" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getSelectionPrototypes</span>(css_results, 1L<span class="sc">:</span>3L),</span>
<span id="cb154-50"><a href="#cb154-50" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.list(selected_clusts) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb154-51"><a href="#cb154-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-52"><a href="#cb154-52" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getSelectionPrototypes</span>(css_results, <span class="fu">list</span>()),</span>
<span id="cb154-53"><a href="#cb154-53" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n_selected_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb154-54"><a href="#cb154-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-55"><a href="#cb154-55" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getSelectionPrototypes</span>(css_results,</span>
<span id="cb154-56"><a href="#cb154-56" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>3L,</span>
<span id="cb154-57"><a href="#cb154-57" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">green_cluster=</span>4L<span class="sc">:</span>6L,</span>
<span id="cb154-58"><a href="#cb154-58" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">bad_cluster=</span><span class="fu">integer</span>())),</span>
<span id="cb154-59"><a href="#cb154-59" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;all(lengths(selected_clusts) &gt;= 1) is not TRUE&quot;</span>,</span>
<span id="cb154-60"><a href="#cb154-60" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb154-61"><a href="#cb154-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-62"><a href="#cb154-62" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😸</code></pre>
<p>Tests for <code>printCssDf()</code>:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;printCssDf works&quot;</span>, {</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">67234</span>)</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">15</span>, <span class="at">p=</span><span class="dv">11</span>, <span class="at">k_unclustered=</span><span class="dv">1</span>, <span class="at">cluster_size=</span><span class="dv">3</span>,</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">n_clusters=</span><span class="dv">2</span>, <span class="at">sig_clusters=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">6</span>))</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> data<span class="sc">$</span>X</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data<span class="sc">$</span>y</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>3L, <span class="at">green_cluster=</span>4L<span class="sc">:</span>6L)</span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>  css_results <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>good_clusters, <span class="at">B=</span><span class="dv">10</span>)</span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">printCssDf</span>(css_results)</span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.data.frame</span>(ret))</span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(ret), <span class="fu">c</span>(<span class="st">&quot;ClustName&quot;</span>, <span class="st">&quot;ClustProtoNum&quot;</span>,</span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;ClustSelProp&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>))</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total number of clusters is 11 - (3 - 1) - (3 - 1) = 7</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret), <span class="dv">7</span>)</span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(ret<span class="sc">$</span>ClustName))</span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">names</span>(good_clusters) <span class="sc">%in%</span> ret<span class="sc">$</span>ClustName))</span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>ClustName), <span class="fu">length</span>(<span class="fu">unique</span>(ret<span class="sc">$</span>ClustName)))</span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustProtoNum))</span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>,</span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 1L<span class="sc">:</span>3L)</span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>,</span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 4L<span class="sc">:</span>6L)</span>
<span id="cb156-32"><a href="#cb156-32" aria-hidden="true" tabindex="-1"></a>  other_rows <span class="ot">&lt;-</span> <span class="sc">!</span>(ret<span class="sc">$</span>ClustName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;green_cluster&quot;</span>))</span>
<span id="cb156-33"><a href="#cb156-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 7L<span class="sc">:</span>11L))</span>
<span id="cb156-34"><a href="#cb156-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>]) <span class="sc">==</span></span>
<span id="cb156-35"><a href="#cb156-35" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(<span class="fu">unique</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>])))</span>
<span id="cb156-36"><a href="#cb156-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-37"><a href="#cb156-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>ClustSelProp))</span>
<span id="cb156-38"><a href="#cb156-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(ret<span class="sc">$</span>ClustSelProp, <span class="fu">sort</span>(ret<span class="sc">$</span>ClustSelProp,</span>
<span id="cb156-39"><a href="#cb156-39" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">decreasing=</span><span class="cn">TRUE</span>))</span>
<span id="cb156-40"><a href="#cb156-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-41"><a href="#cb156-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustSize))</span>
<span id="cb156-42"><a href="#cb156-42" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>], <span class="dv">3</span>)</span>
<span id="cb156-43"><a href="#cb156-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>], <span class="dv">3</span>)</span>
<span id="cb156-44"><a href="#cb156-44" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustSize&quot;</span>] <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb156-45"><a href="#cb156-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-46"><a href="#cb156-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try again naming features</span></span>
<span id="cb156-47"><a href="#cb156-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-48"><a href="#cb156-48" aria-hidden="true" tabindex="-1"></a>  x_named <span class="ot">&lt;-</span> x</span>
<span id="cb156-49"><a href="#cb156-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x_named) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb156-50"><a href="#cb156-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-51"><a href="#cb156-51" aria-hidden="true" tabindex="-1"></a>  css_results_name_feats <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x_named, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>,</span>
<span id="cb156-52"><a href="#cb156-52" aria-hidden="true" tabindex="-1"></a>                                <span class="at">clusters=</span>good_clusters, <span class="at">B=</span><span class="dv">10</span>)</span>
<span id="cb156-53"><a href="#cb156-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-54"><a href="#cb156-54" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">printCssDf</span>(css_results_name_feats)</span>
<span id="cb156-55"><a href="#cb156-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-56"><a href="#cb156-56" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.data.frame</span>(ret))</span>
<span id="cb156-57"><a href="#cb156-57" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(ret), <span class="fu">c</span>(<span class="st">&quot;ClustName&quot;</span>, <span class="st">&quot;ClustProtoName&quot;</span>,</span>
<span id="cb156-58"><a href="#cb156-58" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;ClustProtoNum&quot;</span>, <span class="st">&quot;ClustSelProp&quot;</span>,</span>
<span id="cb156-59"><a href="#cb156-59" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;ClustSize&quot;</span>))</span>
<span id="cb156-60"><a href="#cb156-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-61"><a href="#cb156-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total number of clusters is 11 - (3 - 1) - (3 - 1) = 7</span></span>
<span id="cb156-62"><a href="#cb156-62" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret), <span class="dv">7</span>)</span>
<span id="cb156-63"><a href="#cb156-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-64"><a href="#cb156-64" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(ret<span class="sc">$</span>ClustName))</span>
<span id="cb156-65"><a href="#cb156-65" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">names</span>(good_clusters) <span class="sc">%in%</span> ret<span class="sc">$</span>ClustName))</span>
<span id="cb156-66"><a href="#cb156-66" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>ClustName), <span class="fu">length</span>(<span class="fu">unique</span>(ret<span class="sc">$</span>ClustName)))</span>
<span id="cb156-67"><a href="#cb156-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-68"><a href="#cb156-68" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(ret<span class="sc">$</span>ClustProtoName))</span>
<span id="cb156-69"><a href="#cb156-69" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>,</span>
<span id="cb156-70"><a href="#cb156-70" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;ClustProtoName&quot;</span>] <span class="sc">%in%</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb156-71"><a href="#cb156-71" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>,</span>
<span id="cb156-72"><a href="#cb156-72" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;ClustProtoName&quot;</span>] <span class="sc">%in%</span> LETTERS[<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>])</span>
<span id="cb156-73"><a href="#cb156-73" aria-hidden="true" tabindex="-1"></a>  other_rows <span class="ot">&lt;-</span> <span class="sc">!</span>(ret<span class="sc">$</span>ClustName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;green_cluster&quot;</span>))</span>
<span id="cb156-74"><a href="#cb156-74" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustProtoName&quot;</span>] <span class="sc">%in%</span> LETTERS[<span class="dv">7</span><span class="sc">:</span><span class="dv">11</span>]))</span>
<span id="cb156-75"><a href="#cb156-75" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(ret[other_rows, <span class="st">&quot;ClustProtoName&quot;</span>]) <span class="sc">==</span></span>
<span id="cb156-76"><a href="#cb156-76" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(<span class="fu">unique</span>(ret[other_rows, <span class="st">&quot;ClustProtoName&quot;</span>])))</span>
<span id="cb156-77"><a href="#cb156-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-78"><a href="#cb156-78" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustProtoNum))</span>
<span id="cb156-79"><a href="#cb156-79" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>,</span>
<span id="cb156-80"><a href="#cb156-80" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 1L<span class="sc">:</span>3L)</span>
<span id="cb156-81"><a href="#cb156-81" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>,</span>
<span id="cb156-82"><a href="#cb156-82" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 4L<span class="sc">:</span>6L)</span>
<span id="cb156-83"><a href="#cb156-83" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 7L<span class="sc">:</span>11L))</span>
<span id="cb156-84"><a href="#cb156-84" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>]) <span class="sc">==</span></span>
<span id="cb156-85"><a href="#cb156-85" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(<span class="fu">unique</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>])))</span>
<span id="cb156-86"><a href="#cb156-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-87"><a href="#cb156-87" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>ClustSelProp))</span>
<span id="cb156-88"><a href="#cb156-88" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(ret<span class="sc">$</span>ClustSelProp, <span class="fu">sort</span>(ret<span class="sc">$</span>ClustSelProp,</span>
<span id="cb156-89"><a href="#cb156-89" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">decreasing=</span><span class="cn">TRUE</span>))</span>
<span id="cb156-90"><a href="#cb156-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-91"><a href="#cb156-91" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustSize))</span>
<span id="cb156-92"><a href="#cb156-92" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>], <span class="dv">3</span>)</span>
<span id="cb156-93"><a href="#cb156-93" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>], <span class="dv">3</span>)</span>
<span id="cb156-94"><a href="#cb156-94" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustSize&quot;</span>] <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb156-95"><a href="#cb156-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-96"><a href="#cb156-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unnamed clusters</span></span>
<span id="cb156-97"><a href="#cb156-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-98"><a href="#cb156-98" aria-hidden="true" tabindex="-1"></a>  unnamed_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb156-99"><a href="#cb156-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-100"><a href="#cb156-100" aria-hidden="true" tabindex="-1"></a>  css_results_unnamed <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="fl">0.01</span>, <span class="at">clusters=</span>unnamed_clusters,</span>
<span id="cb156-101"><a href="#cb156-101" aria-hidden="true" tabindex="-1"></a>                             <span class="at">B=</span><span class="dv">10</span>)</span>
<span id="cb156-102"><a href="#cb156-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-103"><a href="#cb156-103" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">printCssDf</span>(css_results_unnamed)</span>
<span id="cb156-104"><a href="#cb156-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-105"><a href="#cb156-105" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.data.frame</span>(ret))</span>
<span id="cb156-106"><a href="#cb156-106" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(ret), <span class="fu">c</span>(<span class="st">&quot;ClustName&quot;</span>, <span class="st">&quot;ClustProtoNum&quot;</span>,</span>
<span id="cb156-107"><a href="#cb156-107" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;ClustSelProp&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>))</span>
<span id="cb156-108"><a href="#cb156-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-109"><a href="#cb156-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total number of clusters is 11 - (3 - 1) - (3 - 1) = 7</span></span>
<span id="cb156-110"><a href="#cb156-110" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret), <span class="dv">7</span>)</span>
<span id="cb156-111"><a href="#cb156-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-112"><a href="#cb156-112" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(ret<span class="sc">$</span>ClustName))</span>
<span id="cb156-113"><a href="#cb156-113" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>ClustName), <span class="fu">length</span>(<span class="fu">unique</span>(ret<span class="sc">$</span>ClustName)))</span>
<span id="cb156-114"><a href="#cb156-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-115"><a href="#cb156-115" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustProtoNum))</span>
<span id="cb156-116"><a href="#cb156-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-117"><a href="#cb156-117" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>ClustSelProp))</span>
<span id="cb156-118"><a href="#cb156-118" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(ret<span class="sc">$</span>ClustSelProp, <span class="fu">sort</span>(ret<span class="sc">$</span>ClustSelProp,</span>
<span id="cb156-119"><a href="#cb156-119" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">decreasing=</span><span class="cn">TRUE</span>))</span>
<span id="cb156-120"><a href="#cb156-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-121"><a href="#cb156-121" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustSize))</span>
<span id="cb156-122"><a href="#cb156-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-123"><a href="#cb156-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try other settings for cutoff, min_num_clusts, max_num_clusts, etc.</span></span>
<span id="cb156-124"><a href="#cb156-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-125"><a href="#cb156-125" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">printCssDf</span>(css_results, <span class="at">max_num_clusts=</span><span class="dv">3</span>)</span>
<span id="cb156-126"><a href="#cb156-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-127"><a href="#cb156-127" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.data.frame</span>(ret))</span>
<span id="cb156-128"><a href="#cb156-128" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(ret), <span class="fu">c</span>(<span class="st">&quot;ClustName&quot;</span>, <span class="st">&quot;ClustProtoNum&quot;</span>,</span>
<span id="cb156-129"><a href="#cb156-129" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;ClustSelProp&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>))</span>
<span id="cb156-130"><a href="#cb156-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-131"><a href="#cb156-131" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(ret) <span class="sc">&lt;=</span> <span class="dv">3</span>)</span>
<span id="cb156-132"><a href="#cb156-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-133"><a href="#cb156-133" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(ret<span class="sc">$</span>ClustName))</span>
<span id="cb156-134"><a href="#cb156-134" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>ClustName), <span class="fu">length</span>(<span class="fu">unique</span>(ret<span class="sc">$</span>ClustName)))</span>
<span id="cb156-135"><a href="#cb156-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-136"><a href="#cb156-136" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustProtoNum))</span>
<span id="cb156-137"><a href="#cb156-137" aria-hidden="true" tabindex="-1"></a>  other_rows <span class="ot">&lt;-</span> <span class="sc">!</span>(ret<span class="sc">$</span>ClustName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;green_cluster&quot;</span>))</span>
<span id="cb156-138"><a href="#cb156-138" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 7L<span class="sc">:</span>11L))</span>
<span id="cb156-139"><a href="#cb156-139" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>]) <span class="sc">==</span></span>
<span id="cb156-140"><a href="#cb156-140" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(<span class="fu">unique</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>])))</span>
<span id="cb156-141"><a href="#cb156-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-142"><a href="#cb156-142" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>ClustSelProp))</span>
<span id="cb156-143"><a href="#cb156-143" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(ret<span class="sc">$</span>ClustSelProp, <span class="fu">sort</span>(ret<span class="sc">$</span>ClustSelProp,</span>
<span id="cb156-144"><a href="#cb156-144" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">decreasing=</span><span class="cn">TRUE</span>))</span>
<span id="cb156-145"><a href="#cb156-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-146"><a href="#cb156-146" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustSize))</span>
<span id="cb156-147"><a href="#cb156-147" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustSize&quot;</span>] <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb156-148"><a href="#cb156-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-149"><a href="#cb156-149" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;red_cluster&quot;</span> <span class="sc">%in%</span> ret<span class="sc">$</span>ClustName){</span>
<span id="cb156-150"><a href="#cb156-150" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>,</span>
<span id="cb156-151"><a href="#cb156-151" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 1L<span class="sc">:</span>3L)</span>
<span id="cb156-152"><a href="#cb156-152" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>], <span class="dv">3</span>)</span>
<span id="cb156-153"><a href="#cb156-153" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb156-154"><a href="#cb156-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-155"><a href="#cb156-155" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;green_cluster&quot;</span> <span class="sc">%in%</span> ret<span class="sc">$</span>ClustName){</span>
<span id="cb156-156"><a href="#cb156-156" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>,</span>
<span id="cb156-157"><a href="#cb156-157" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 4L<span class="sc">:</span>6L)</span>
<span id="cb156-158"><a href="#cb156-158" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>], <span class="dv">3</span>)</span>
<span id="cb156-159"><a href="#cb156-159" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb156-160"><a href="#cb156-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-161"><a href="#cb156-161" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">printCssDf</span>(css_results, <span class="at">min_num_clusts=</span><span class="dv">2</span>, <span class="at">cutoff=</span><span class="dv">1</span>)</span>
<span id="cb156-162"><a href="#cb156-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-163"><a href="#cb156-163" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.data.frame</span>(ret))</span>
<span id="cb156-164"><a href="#cb156-164" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(ret), <span class="fu">c</span>(<span class="st">&quot;ClustName&quot;</span>, <span class="st">&quot;ClustProtoNum&quot;</span>,</span>
<span id="cb156-165"><a href="#cb156-165" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;ClustSelProp&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>))</span>
<span id="cb156-166"><a href="#cb156-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-167"><a href="#cb156-167" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total number of clusters is 11 - (3 - 1) - (3 - 1) = 7</span></span>
<span id="cb156-168"><a href="#cb156-168" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(ret) <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb156-169"><a href="#cb156-169" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(ret) <span class="sc">&lt;=</span> <span class="dv">7</span>)</span>
<span id="cb156-170"><a href="#cb156-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-171"><a href="#cb156-171" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(ret<span class="sc">$</span>ClustName))</span>
<span id="cb156-172"><a href="#cb156-172" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>ClustName), <span class="fu">length</span>(<span class="fu">unique</span>(ret<span class="sc">$</span>ClustName)))</span>
<span id="cb156-173"><a href="#cb156-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-174"><a href="#cb156-174" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustProtoNum))</span>
<span id="cb156-175"><a href="#cb156-175" aria-hidden="true" tabindex="-1"></a>  other_rows <span class="ot">&lt;-</span> <span class="sc">!</span>(ret<span class="sc">$</span>ClustName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;green_cluster&quot;</span>))</span>
<span id="cb156-176"><a href="#cb156-176" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 7L<span class="sc">:</span>11L))</span>
<span id="cb156-177"><a href="#cb156-177" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>]) <span class="sc">==</span></span>
<span id="cb156-178"><a href="#cb156-178" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(<span class="fu">unique</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>])))</span>
<span id="cb156-179"><a href="#cb156-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-180"><a href="#cb156-180" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>ClustSelProp))</span>
<span id="cb156-181"><a href="#cb156-181" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(ret<span class="sc">$</span>ClustSelProp, <span class="fu">sort</span>(ret<span class="sc">$</span>ClustSelProp,</span>
<span id="cb156-182"><a href="#cb156-182" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">decreasing=</span><span class="cn">TRUE</span>))</span>
<span id="cb156-183"><a href="#cb156-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-184"><a href="#cb156-184" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustSize))</span>
<span id="cb156-185"><a href="#cb156-185" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustSize&quot;</span>] <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb156-186"><a href="#cb156-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-187"><a href="#cb156-187" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;red_cluster&quot;</span> <span class="sc">%in%</span> ret<span class="sc">$</span>ClustName){</span>
<span id="cb156-188"><a href="#cb156-188" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>,</span>
<span id="cb156-189"><a href="#cb156-189" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 1L<span class="sc">:</span>3L)</span>
<span id="cb156-190"><a href="#cb156-190" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>], <span class="dv">3</span>)</span>
<span id="cb156-191"><a href="#cb156-191" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb156-192"><a href="#cb156-192" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-193"><a href="#cb156-193" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;green_cluster&quot;</span> <span class="sc">%in%</span> ret<span class="sc">$</span>ClustName){</span>
<span id="cb156-194"><a href="#cb156-194" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>,</span>
<span id="cb156-195"><a href="#cb156-195" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 4L<span class="sc">:</span>6L)</span>
<span id="cb156-196"><a href="#cb156-196" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>], <span class="dv">3</span>)</span>
<span id="cb156-197"><a href="#cb156-197" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb156-198"><a href="#cb156-198" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-199"><a href="#cb156-199" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb156-200"><a href="#cb156-200" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">printCssDf</span>(css_results, <span class="at">cutoff=</span><span class="dv">1</span>)</span>
<span id="cb156-201"><a href="#cb156-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-202"><a href="#cb156-202" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.data.frame</span>(ret))</span>
<span id="cb156-203"><a href="#cb156-203" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">colnames</span>(ret), <span class="fu">c</span>(<span class="st">&quot;ClustName&quot;</span>, <span class="st">&quot;ClustProtoNum&quot;</span>,</span>
<span id="cb156-204"><a href="#cb156-204" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;ClustSelProp&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>))</span>
<span id="cb156-205"><a href="#cb156-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-206"><a href="#cb156-206" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(ret) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb156-207"><a href="#cb156-207" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(ret) <span class="sc">&lt;=</span> <span class="dv">7</span>)</span>
<span id="cb156-208"><a href="#cb156-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-209"><a href="#cb156-209" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(ret<span class="sc">$</span>ClustName))</span>
<span id="cb156-210"><a href="#cb156-210" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>ClustName), <span class="fu">length</span>(<span class="fu">unique</span>(ret<span class="sc">$</span>ClustName)))</span>
<span id="cb156-211"><a href="#cb156-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-212"><a href="#cb156-212" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustProtoNum))</span>
<span id="cb156-213"><a href="#cb156-213" aria-hidden="true" tabindex="-1"></a>  other_rows <span class="ot">&lt;-</span> <span class="sc">!</span>(ret<span class="sc">$</span>ClustName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;green_cluster&quot;</span>))</span>
<span id="cb156-214"><a href="#cb156-214" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 7L<span class="sc">:</span>11L))</span>
<span id="cb156-215"><a href="#cb156-215" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>]) <span class="sc">==</span></span>
<span id="cb156-216"><a href="#cb156-216" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(<span class="fu">unique</span>(ret[other_rows, <span class="st">&quot;ClustProtoNum&quot;</span>])))</span>
<span id="cb156-217"><a href="#cb156-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-218"><a href="#cb156-218" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>ClustSelProp))</span>
<span id="cb156-219"><a href="#cb156-219" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(ret<span class="sc">$</span>ClustSelProp, <span class="fu">sort</span>(ret<span class="sc">$</span>ClustSelProp,</span>
<span id="cb156-220"><a href="#cb156-220" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">decreasing=</span><span class="cn">TRUE</span>))</span>
<span id="cb156-221"><a href="#cb156-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-222"><a href="#cb156-222" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>ClustSize))</span>
<span id="cb156-223"><a href="#cb156-223" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret[other_rows, <span class="st">&quot;ClustSize&quot;</span>] <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb156-224"><a href="#cb156-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-225"><a href="#cb156-225" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;red_cluster&quot;</span> <span class="sc">%in%</span> ret<span class="sc">$</span>ClustName){</span>
<span id="cb156-226"><a href="#cb156-226" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>,</span>
<span id="cb156-227"><a href="#cb156-227" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 1L<span class="sc">:</span>3L)</span>
<span id="cb156-228"><a href="#cb156-228" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;red_cluster&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>], <span class="dv">3</span>)</span>
<span id="cb156-229"><a href="#cb156-229" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb156-230"><a href="#cb156-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-231"><a href="#cb156-231" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;green_cluster&quot;</span> <span class="sc">%in%</span> ret<span class="sc">$</span>ClustName){</span>
<span id="cb156-232"><a href="#cb156-232" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>,</span>
<span id="cb156-233"><a href="#cb156-233" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&quot;ClustProtoNum&quot;</span>] <span class="sc">%in%</span> 4L<span class="sc">:</span>6L)</span>
<span id="cb156-234"><a href="#cb156-234" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret[ret<span class="sc">$</span>ClustName<span class="sc">==</span><span class="st">&quot;green_cluster&quot;</span>, <span class="st">&quot;ClustSize&quot;</span>], <span class="dv">3</span>)</span>
<span id="cb156-235"><a href="#cb156-235" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb156-236"><a href="#cb156-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-237"><a href="#cb156-237" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying bad inputs</span></span>
<span id="cb156-238"><a href="#cb156-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-239"><a href="#cb156-239" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Error has quotation marks in it</span></span>
<span id="cb156-240"><a href="#cb156-240" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">printCssDf</span>(<span class="st">&quot;css_results&quot;</span>))</span>
<span id="cb156-241"><a href="#cb156-241" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-242"><a href="#cb156-242" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">printCssDf</span>(css_results, <span class="at">cutoff=</span><span class="sc">-</span>.<span class="dv">1</span>),</span>
<span id="cb156-243"><a href="#cb156-243" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;cutoff &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb156-244"><a href="#cb156-244" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-245"><a href="#cb156-245" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">printCssDf</span>(css_results, <span class="at">min_num_clusts=</span><span class="fl">3.2</span>),</span>
<span id="cb156-246"><a href="#cb156-246" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;min_num_clusts == round(min_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb156-247"><a href="#cb156-247" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb156-248"><a href="#cb156-248" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-249"><a href="#cb156-249" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">printCssDf</span>(css_results, <span class="at">max_num_clusts=</span><span class="st">&quot;5&quot;</span>),</span>
<span id="cb156-250"><a href="#cb156-250" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(max_num_clusts) | is.integer(max_num_clusts) is not TRUE&quot;</span>,</span>
<span id="cb156-251"><a href="#cb156-251" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb156-252"><a href="#cb156-252" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🎉</code></pre>
<p><code>print.cssr()</code></p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Print cluster stability selection output</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Print a summary of the information from the css function (using output from</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; printCssDf function).</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x An object of class &quot;cssr&quot; (the output of the function css).</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; print.cssr will display only those</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters with selection proportions equal to at least cutoff. Must be between</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; 0 and 1. Default is 0 (in which case either all clusters are displayed, or</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts are, if max_num_clusts is specified).</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param min_num_clusts Integer or numeric; the minimum number of clusters to</span></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns fewer than</span></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters, the cutoff will be increased until at least</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; min_num_clusts clusters are selected.) Default is 1.</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) Default is NA (in which case</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts is ignored).</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param ... Additional arguments to generic print.data.frame function</span></span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A data.frame; each row contains a cluster, arranged in decreasing</span></span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; order of cluster selection proportion from top to bottom. The columns are</span></span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; ClustName (the name of the cluster that was either provided to css or made by</span></span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css if no name was provided); ClustProtoName (the name of the selection</span></span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; prototype from the cluster, which is the feature with the greatest individual</span></span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection proportion among all the cluster members, with ties broken by</span></span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; choosing the feature with the highest correlation with the response if the</span></span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response is real-valued; only returned if the features are named),</span></span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; ClustProtoNum (the column number of the prototype in the X matrix provided to</span></span>
<span id="cb158-29"><a href="#cb158-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css), and ClustSize (the size of the cluster).</span></span>
<span id="cb158-30"><a href="#cb158-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb158-31"><a href="#cb158-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb158-32"><a href="#cb158-32" aria-hidden="true" tabindex="-1"></a>print.cssr <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">cutoff=</span><span class="dv">0</span>, <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>, ...){</span>
<span id="cb158-33"><a href="#cb158-33" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> <span class="fu">printCssDf</span>(<span class="at">css_results=</span>x, <span class="at">cutoff=</span>cutoff,</span>
<span id="cb158-34"><a href="#cb158-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_num_clusts=</span>min_num_clusts, <span class="at">max_num_clusts=</span>max_num_clusts)</span>
<span id="cb158-35"><a href="#cb158-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print.data.frame</span>(df, ...)</span>
<span id="cb158-36"><a href="#cb158-36" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="wrapper-functions" class="section level1 hasAnchor" number="7">
<h1 class="hasAnchor"><span class="header-section-number">7</span> Convenient wrapper functions<a href="#wrapper-functions" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Finally, we provide convenient wrapper functions which yield user-desired output in a single step at the price of flexibility and efficiency. <code>cssSelect()</code> yields a selected set of clusters and features (the same output as <code>getCssSelections()</code>) in a single function call. <code>cssPredict()</code> takes in a training/selection data set as well as a test X. It uses the labeled data to select a set of features and train an OLS model on the selected features, and then it generates predictions on the test set using the fitted model.</p>
<p>Besides requiring only a single function call to yield desired output, these wrapper functions also automatically select hyperparameters (lambda used for the lasso, a desired model size, and even selection and training splits for <code>cssPredict()</code>) in a sensible way if these values are not provided by the user. So these functions are very convenient for an end user who wants quick results without getting “under the hood.”</p>
<p>The two main disadvantages of these functions are flexibility and computational efficiency. For simplicity of use, these functions do not provide as many options as the component functions they call (for example, <code>min_num_clusts</code> is not an available argument for these models). Further, both of these functions make (computationally intensive) calls to <code>css()</code> internally every time they are called, so these functions are not recommended for users who want to tinker with the model size and other parameters. Instead, it would be more efficient to call css once and then work with the output as desired using the other package functions, which are very efficient given the stored output from <code>css()</code>.</p>
<p><code>cssSelect()</code> and <code>cssPredict()</code> have no new dependencies; they rely only on already-defined functions.</p>
<p><code>cssSelect()</code>:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Obtain a selected set of clusters and features using cluster stability</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Takes in data X and y and returns a set of clusters (and a set of features)</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; that are useful for predicting y from the data in X. This is a wrapper</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; function for css and getCssSelections. Using cssSelect is simpler, but it</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; has fewer options, and it executes the full (computationally expensive)</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; subsampling procedured every time it is called. In contrast, css can be</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; called just once, and then getCssSelections can quickly return results using</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; different values of cutoff, max_num_clusts, etc. from the calculations done</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; in one call to css.</span></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X An n x p numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the p &gt;= 2 features/predictors.</span></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y A length-n numeric vector containing the responses; `y[i]` is the</span></span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response corresponding to observation `X[i, ]`. (Note that for the css</span></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; function, y does not have to be a numeric response, but for this function,</span></span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the underlying selection procedure is the lasso, so y must be a real-valued</span></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; response.)</span></span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters Optional; either an integer vector of a list of integer</span></span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vectors; each vector should contain the indices of a cluster of features (a</span></span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; subset of 1:p). (If there is only one cluster, clusters can either be a list</span></span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of length 1 or an integer vector.) All of the provided clusters must be</span></span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; non-overlapping. Every feature not appearing in any cluster will be assumed</span></span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to be unclustered (that is, they  will be treated as if they are in a</span></span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;cluster&quot; containing only themselves). If clusters is a list of length 0 (or</span></span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; a list only containing clusters of length 1), then css() returns the same</span></span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; results as stability selection (so feat_sel_mat will be identical to</span></span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clus_sel_mat). Names for the clusters will be needed later; any clusters that</span></span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; are not given names in the list clusters will be given names automatically by</span></span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css. Default is list() (so no clusters are specified, and every feature is</span></span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; assumed to be in a &quot;cluster&quot; containng only itself).</span></span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda Optional; the tuning parameter to be used by the lasso for</span></span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; feature selection in each subsample. If lambda is not provided, cssSelect</span></span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will choose one automatically by cross-validation. Default is NA.</span></span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; cssSelect will only select those clusters with</span></span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection proportions equal to at least cutoff. Must be between 0 and 1.</span></span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Default is NA (in which case max_num_clusts are used).</span></span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) Default is NA (in which case</span></span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; either cutoff is used to choose the number of clusters, or if cutoff was also</span></span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; unspecified, cssSelect chooses max_num_clusts by cross-validation).</span></span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param auto_select_size Logical; if TRUE, then max_num_clusts will be</span></span>
<span id="cb159-46"><a href="#cb159-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; automatically estimated using the lasso with cross-validation. Default is</span></span>
<span id="cb159-47"><a href="#cb159-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; TRUE, though his argument is ignored if either cutoff or max_num_clusts is</span></span>
<span id="cb159-48"><a href="#cb159-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided. (If desired output is to return all clusters, you should set</span></span>
<span id="cb159-49"><a href="#cb159-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; auto_select_size to FALSE and do not provide cutoff or max_num_clusts.)</span></span>
<span id="cb159-50"><a href="#cb159-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A named list with two items. \item{selected_clusts}{A list of</span></span>
<span id="cb159-51"><a href="#cb159-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; integer vectors; each vector contains the indices of one of the selected</span></span>
<span id="cb159-52"><a href="#cb159-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters.} \item{selected_feats}{An integer vector; the indices of the</span></span>
<span id="cb159-53"><a href="#cb159-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; all of the selected features within all of the selected clusters (typically</span></span>
<span id="cb159-54"><a href="#cb159-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; only one feature is selected from each cluster).}</span></span>
<span id="cb159-55"><a href="#cb159-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb159-56"><a href="#cb159-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb159-57"><a href="#cb159-57" aria-hidden="true" tabindex="-1"></a>cssSelect <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, <span class="at">clusters =</span> <span class="fu">list</span>(), <span class="at">lambda=</span><span class="cn">NA</span>, <span class="at">cutoff=</span><span class="cn">NA</span>,</span>
<span id="cb159-58"><a href="#cb159-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">auto_select_size=</span><span class="cn">TRUE</span>){</span>
<span id="cb159-59"><a href="#cb159-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-60"><a href="#cb159-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs (most inputs will be checked by called functions)</span></span>
<span id="cb159-61"><a href="#cb159-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-62"><a href="#cb159-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(auto_select_size))</span>
<span id="cb159-63"><a href="#cb159-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(auto_select_size) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb159-64"><a href="#cb159-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(auto_select_size))</span>
<span id="cb159-65"><a href="#cb159-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-66"><a href="#cb159-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X) <span class="sc">|</span> <span class="fu">is.data.frame</span>(X))</span>
<span id="cb159-67"><a href="#cb159-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(X)))</span>
<span id="cb159-68"><a href="#cb159-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-69"><a href="#cb159-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if x is a matrix; if it&#39;s a data.frame, convert to matrix.</span></span>
<span id="cb159-70"><a href="#cb159-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.data.frame</span>(X)){</span>
<span id="cb159-71"><a href="#cb159-71" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X)</span>
<span id="cb159-72"><a href="#cb159-72" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> X[, <span class="fu">colnames</span>(X) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb159-73"><a href="#cb159-73" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-74"><a href="#cb159-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-75"><a href="#cb159-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X))</span>
<span id="cb159-76"><a href="#cb159-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(X)))</span>
<span id="cb159-77"><a href="#cb159-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-78"><a href="#cb159-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.numeric</span>(y) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.integer</span>(y)){</span>
<span id="cb159-79"><a href="#cb159-79" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;The provided y must be real-valued, because cssSelect uses the lasso for feature selection. (In order to use a different form of response, use the css function and provide your own selection function accommodating your choice of y.)&quot;</span>)</span>
<span id="cb159-80"><a href="#cb159-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-81"><a href="#cb159-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-82"><a href="#cb159-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(lambda) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb159-83"><a href="#cb159-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(lambda)){</span>
<span id="cb159-84"><a href="#cb159-84" aria-hidden="true" tabindex="-1"></a>        lambda <span class="ot">&lt;-</span> <span class="fu">getLassoLambda</span>(X, y)</span>
<span id="cb159-85"><a href="#cb159-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-86"><a href="#cb159-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-87"><a href="#cb159-87" aria-hidden="true" tabindex="-1"></a>    css_results <span class="ot">&lt;-</span> <span class="fu">css</span>(X, y, lambda, clusters)</span>
<span id="cb159-88"><a href="#cb159-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-89"><a href="#cb159-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no indication of how to select model size was provided, choose model</span></span>
<span id="cb159-90"><a href="#cb159-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># size by cross-validation</span></span>
<span id="cb159-91"><a href="#cb159-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(cutoff) <span class="sc">&amp;</span> <span class="fu">is.na</span>(max_num_clusts)){</span>
<span id="cb159-92"><a href="#cb159-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(auto_select_size){</span>
<span id="cb159-93"><a href="#cb159-93" aria-hidden="true" tabindex="-1"></a>            max_num_clusts <span class="ot">&lt;-</span> <span class="fu">getModelSize</span>(X, y, css_results<span class="sc">$</span>clusters)</span>
<span id="cb159-94"><a href="#cb159-94" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb159-95"><a href="#cb159-95" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-96"><a href="#cb159-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-97"><a href="#cb159-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(cutoff)){</span>
<span id="cb159-98"><a href="#cb159-98" aria-hidden="true" tabindex="-1"></a>        cutoff <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb159-99"><a href="#cb159-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-100"><a href="#cb159-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-101"><a href="#cb159-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get selected features</span></span>
<span id="cb159-102"><a href="#cb159-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">getCssSelections</span>(css_results, <span class="at">weighting=</span><span class="st">&quot;sparse&quot;</span>, <span class="at">cutoff=</span>cutoff,</span>
<span id="cb159-103"><a href="#cb159-103" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_num_clusts=</span><span class="dv">1</span>, <span class="at">max_num_clusts=</span>max_num_clusts)</span>
<span id="cb159-104"><a href="#cb159-104" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>cssSelect()</code>:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;cssSelect works&quot;</span>, {</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">73212</span>)</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">15</span>, <span class="at">p=</span><span class="dv">11</span>, <span class="at">k_unclustered=</span><span class="dv">1</span>, <span class="at">cluster_size=</span><span class="dv">3</span>,</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">n_clusters=</span><span class="dv">2</span>, <span class="at">sig_clusters=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="dv">1</span>)</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> data<span class="sc">$</span>X</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data<span class="sc">$</span>y</span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Intentionally don&#39;t provide clusters for all features, mix up formatting,</span></span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># etc.</span></span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>3L, <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters)</span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)))</span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)))</span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span></span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total of 11 - 2*(3 - 1) = 7 clusters</span></span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span> <span class="dv">7</span>)</span>
<span id="cb160-26"><a href="#cb160-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-27"><a href="#cb160-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-28"><a href="#cb160-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb160-29"><a href="#cb160-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb160-30"><a href="#cb160-30" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts))))</span>
<span id="cb160-31"><a href="#cb160-31" aria-hidden="true" tabindex="-1"></a>  already_used_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb160-32"><a href="#cb160-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts)){</span>
<span id="cb160-33"><a href="#cb160-33" aria-hidden="true" tabindex="-1"></a>    sels_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts[[i]]</span>
<span id="cb160-34"><a href="#cb160-34" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(sels_i) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-35"><a href="#cb160-35" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(sels_i))</span>
<span id="cb160-36"><a href="#cb160-36" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sels_i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb160-37"><a href="#cb160-37" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sels_i), <span class="fu">length</span>(<span class="fu">unique</span>(sels_i)))</span>
<span id="cb160-38"><a href="#cb160-38" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(already_used_feats, sels_i)), <span class="dv">0</span>)</span>
<span id="cb160-39"><a href="#cb160-39" aria-hidden="true" tabindex="-1"></a>    already_used_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(already_used_feats, sels_i)</span>
<span id="cb160-40"><a href="#cb160-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-41"><a href="#cb160-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(already_used_feats) <span class="sc">&lt;=</span> <span class="dv">11</span>)</span>
<span id="cb160-42"><a href="#cb160-42" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(already_used_feats),</span>
<span id="cb160-43"><a href="#cb160-43" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(already_used_feats)))</span>
<span id="cb160-44"><a href="#cb160-44" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(already_used_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb160-45"><a href="#cb160-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-46"><a href="#cb160-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&lt;=</span> <span class="dv">11</span>)</span>
<span id="cb160-47"><a href="#cb160-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb160-48"><a href="#cb160-48" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-49"><a href="#cb160-49" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb160-50"><a href="#cb160-50" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats))))</span>
<span id="cb160-51"><a href="#cb160-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb160-52"><a href="#cb160-52" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&lt;=</span> <span class="dv">11</span>))</span>
<span id="cb160-53"><a href="#cb160-53" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats),</span>
<span id="cb160-54"><a href="#cb160-54" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(<span class="fu">unique</span>(res<span class="sc">$</span>selected_feats)))</span>
<span id="cb160-55"><a href="#cb160-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-56"><a href="#cb160-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># No provided clusters</span></span>
<span id="cb160-57"><a href="#cb160-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-58"><a href="#cb160-58" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y)</span>
<span id="cb160-59"><a href="#cb160-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-60"><a href="#cb160-60" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb160-61"><a href="#cb160-61" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb160-62"><a href="#cb160-62" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb160-63"><a href="#cb160-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-64"><a href="#cb160-64" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)))</span>
<span id="cb160-65"><a href="#cb160-65" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)))</span>
<span id="cb160-66"><a href="#cb160-66" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span></span>
<span id="cb160-67"><a href="#cb160-67" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb160-68"><a href="#cb160-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-69"><a href="#cb160-69" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span> <span class="dv">11</span>)</span>
<span id="cb160-70"><a href="#cb160-70" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-71"><a href="#cb160-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-72"><a href="#cb160-72" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb160-73"><a href="#cb160-73" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb160-74"><a href="#cb160-74" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts))))</span>
<span id="cb160-75"><a href="#cb160-75" aria-hidden="true" tabindex="-1"></a>  already_used_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb160-76"><a href="#cb160-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts)){</span>
<span id="cb160-77"><a href="#cb160-77" aria-hidden="true" tabindex="-1"></a>    sels_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts[[i]]</span>
<span id="cb160-78"><a href="#cb160-78" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(sels_i) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-79"><a href="#cb160-79" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(sels_i))</span>
<span id="cb160-80"><a href="#cb160-80" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sels_i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb160-81"><a href="#cb160-81" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sels_i), <span class="fu">length</span>(<span class="fu">unique</span>(sels_i)))</span>
<span id="cb160-82"><a href="#cb160-82" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(already_used_feats, sels_i)), <span class="dv">0</span>)</span>
<span id="cb160-83"><a href="#cb160-83" aria-hidden="true" tabindex="-1"></a>    already_used_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(already_used_feats, sels_i)</span>
<span id="cb160-84"><a href="#cb160-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-85"><a href="#cb160-85" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(already_used_feats) <span class="sc">&lt;=</span> <span class="dv">11</span>)</span>
<span id="cb160-86"><a href="#cb160-86" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(already_used_feats),</span>
<span id="cb160-87"><a href="#cb160-87" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(already_used_feats)))</span>
<span id="cb160-88"><a href="#cb160-88" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(already_used_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb160-89"><a href="#cb160-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-90"><a href="#cb160-90" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&lt;=</span> <span class="dv">11</span>)</span>
<span id="cb160-91"><a href="#cb160-91" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb160-92"><a href="#cb160-92" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-93"><a href="#cb160-93" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb160-94"><a href="#cb160-94" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats))))</span>
<span id="cb160-95"><a href="#cb160-95" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb160-96"><a href="#cb160-96" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&lt;=</span> <span class="dv">11</span>))</span>
<span id="cb160-97"><a href="#cb160-97" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats),</span>
<span id="cb160-98"><a href="#cb160-98" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(<span class="fu">unique</span>(res<span class="sc">$</span>selected_feats)))</span>
<span id="cb160-99"><a href="#cb160-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-100"><a href="#cb160-100" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying other inputs</span></span>
<span id="cb160-101"><a href="#cb160-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-102"><a href="#cb160-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a data.frame</span></span>
<span id="cb160-103"><a href="#cb160-103" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb160-104"><a href="#cb160-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-105"><a href="#cb160-105" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssSelect</span>(<span class="at">X=</span>X_df, <span class="at">y=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)), <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb160-106"><a href="#cb160-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-107"><a href="#cb160-107" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb160-108"><a href="#cb160-108" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb160-109"><a href="#cb160-109" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb160-110"><a href="#cb160-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-111"><a href="#cb160-111" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)))</span>
<span id="cb160-112"><a href="#cb160-112" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)))</span>
<span id="cb160-113"><a href="#cb160-113" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span></span>
<span id="cb160-114"><a href="#cb160-114" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb160-115"><a href="#cb160-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total of ncol(X_df) - (3 - 1) clusters</span></span>
<span id="cb160-116"><a href="#cb160-116" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span> <span class="fu">ncol</span>(X_df) <span class="sc">-</span> <span class="dv">2</span>)</span>
<span id="cb160-117"><a href="#cb160-117" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-118"><a href="#cb160-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-119"><a href="#cb160-119" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb160-120"><a href="#cb160-120" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb160-121"><a href="#cb160-121" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts))))</span>
<span id="cb160-122"><a href="#cb160-122" aria-hidden="true" tabindex="-1"></a>  already_used_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb160-123"><a href="#cb160-123" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts)){</span>
<span id="cb160-124"><a href="#cb160-124" aria-hidden="true" tabindex="-1"></a>    sels_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts[[i]]</span>
<span id="cb160-125"><a href="#cb160-125" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(sels_i) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-126"><a href="#cb160-126" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(sels_i))</span>
<span id="cb160-127"><a href="#cb160-127" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sels_i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(X_df)))</span>
<span id="cb160-128"><a href="#cb160-128" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sels_i), <span class="fu">length</span>(<span class="fu">unique</span>(sels_i)))</span>
<span id="cb160-129"><a href="#cb160-129" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(already_used_feats, sels_i)), <span class="dv">0</span>)</span>
<span id="cb160-130"><a href="#cb160-130" aria-hidden="true" tabindex="-1"></a>    already_used_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(already_used_feats, sels_i)</span>
<span id="cb160-131"><a href="#cb160-131" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-132"><a href="#cb160-132" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(already_used_feats) <span class="sc">&lt;=</span> <span class="fu">ncol</span>(X_df))</span>
<span id="cb160-133"><a href="#cb160-133" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(already_used_feats),</span>
<span id="cb160-134"><a href="#cb160-134" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(already_used_feats)))</span>
<span id="cb160-135"><a href="#cb160-135" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(already_used_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(X_df)))</span>
<span id="cb160-136"><a href="#cb160-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-137"><a href="#cb160-137" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&lt;=</span> <span class="fu">ncol</span>(X_df))</span>
<span id="cb160-138"><a href="#cb160-138" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb160-139"><a href="#cb160-139" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-140"><a href="#cb160-140" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb160-141"><a href="#cb160-141" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats))))</span>
<span id="cb160-142"><a href="#cb160-142" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb160-143"><a href="#cb160-143" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&lt;=</span> <span class="fu">ncol</span>(X_df)))</span>
<span id="cb160-144"><a href="#cb160-144" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats),</span>
<span id="cb160-145"><a href="#cb160-145" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(<span class="fu">unique</span>(res<span class="sc">$</span>selected_feats)))</span>
<span id="cb160-146"><a href="#cb160-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-147"><a href="#cb160-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a dataframe with factors (number of columns of final design matrix</span></span>
<span id="cb160-148"><a href="#cb160-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after one-hot encoding factors won&#39;t match number of columns of df2)</span></span>
<span id="cb160-149"><a href="#cb160-149" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> X_df</span>
<span id="cb160-150"><a href="#cb160-150" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>cyl)</span>
<span id="cb160-151"><a href="#cb160-151" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>vs)</span>
<span id="cb160-152"><a href="#cb160-152" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>am)</span>
<span id="cb160-153"><a href="#cb160-153" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>gear)</span>
<span id="cb160-154"><a href="#cb160-154" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>carb)</span>
<span id="cb160-155"><a href="#cb160-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-156"><a href="#cb160-156" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssSelect</span>(<span class="at">X=</span>df2, <span class="at">y=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)), <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb160-157"><a href="#cb160-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-158"><a href="#cb160-158" aria-hidden="true" tabindex="-1"></a>  X_df_mat <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., df2)</span>
<span id="cb160-159"><a href="#cb160-159" aria-hidden="true" tabindex="-1"></a>  X_df_mat <span class="ot">&lt;-</span> X_df_mat[, <span class="fu">colnames</span>(X_df_mat) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb160-160"><a href="#cb160-160" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X_df_mat)</span>
<span id="cb160-161"><a href="#cb160-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-162"><a href="#cb160-162" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb160-163"><a href="#cb160-163" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb160-164"><a href="#cb160-164" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb160-165"><a href="#cb160-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-166"><a href="#cb160-166" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)))</span>
<span id="cb160-167"><a href="#cb160-167" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)))</span>
<span id="cb160-168"><a href="#cb160-168" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span></span>
<span id="cb160-169"><a href="#cb160-169" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb160-170"><a href="#cb160-170" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total of p - (3 - 1) clusters</span></span>
<span id="cb160-171"><a href="#cb160-171" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span> p <span class="sc">-</span> <span class="dv">2</span>)</span>
<span id="cb160-172"><a href="#cb160-172" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-173"><a href="#cb160-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-174"><a href="#cb160-174" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb160-175"><a href="#cb160-175" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb160-176"><a href="#cb160-176" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts))))</span>
<span id="cb160-177"><a href="#cb160-177" aria-hidden="true" tabindex="-1"></a>  already_used_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb160-178"><a href="#cb160-178" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts)){</span>
<span id="cb160-179"><a href="#cb160-179" aria-hidden="true" tabindex="-1"></a>    sels_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts[[i]]</span>
<span id="cb160-180"><a href="#cb160-180" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(sels_i) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-181"><a href="#cb160-181" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(sels_i))</span>
<span id="cb160-182"><a href="#cb160-182" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sels_i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span>p))</span>
<span id="cb160-183"><a href="#cb160-183" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sels_i), <span class="fu">length</span>(<span class="fu">unique</span>(sels_i)))</span>
<span id="cb160-184"><a href="#cb160-184" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(already_used_feats, sels_i)), <span class="dv">0</span>)</span>
<span id="cb160-185"><a href="#cb160-185" aria-hidden="true" tabindex="-1"></a>    already_used_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(already_used_feats, sels_i)</span>
<span id="cb160-186"><a href="#cb160-186" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-187"><a href="#cb160-187" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(already_used_feats) <span class="sc">&lt;=</span> p)</span>
<span id="cb160-188"><a href="#cb160-188" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(already_used_feats),</span>
<span id="cb160-189"><a href="#cb160-189" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(already_used_feats)))</span>
<span id="cb160-190"><a href="#cb160-190" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(already_used_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span>p))</span>
<span id="cb160-191"><a href="#cb160-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-192"><a href="#cb160-192" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&lt;=</span> p)</span>
<span id="cb160-193"><a href="#cb160-193" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb160-194"><a href="#cb160-194" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-195"><a href="#cb160-195" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb160-196"><a href="#cb160-196" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats))))</span>
<span id="cb160-197"><a href="#cb160-197" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb160-198"><a href="#cb160-198" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&lt;=</span> p))</span>
<span id="cb160-199"><a href="#cb160-199" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats),</span>
<span id="cb160-200"><a href="#cb160-200" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(<span class="fu">unique</span>(res<span class="sc">$</span>selected_feats)))</span>
<span id="cb160-201"><a href="#cb160-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-202"><a href="#cb160-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-203"><a href="#cb160-203" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a matrix with column names</span></span>
<span id="cb160-204"><a href="#cb160-204" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> x</span>
<span id="cb160-205"><a href="#cb160-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x2) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb160-206"><a href="#cb160-206" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-207"><a href="#cb160-207" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssSelect</span>(<span class="at">X=</span>x2, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters)</span>
<span id="cb160-208"><a href="#cb160-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-209"><a href="#cb160-209" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb160-210"><a href="#cb160-210" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb160-211"><a href="#cb160-211" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb160-212"><a href="#cb160-212" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-213"><a href="#cb160-213" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)))</span>
<span id="cb160-214"><a href="#cb160-214" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)))</span>
<span id="cb160-215"><a href="#cb160-215" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span></span>
<span id="cb160-216"><a href="#cb160-216" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">length</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb160-217"><a href="#cb160-217" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total of 11 - 2*(3 - 1) = 7 clusters</span></span>
<span id="cb160-218"><a href="#cb160-218" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span> <span class="dv">7</span>)</span>
<span id="cb160-219"><a href="#cb160-219" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-220"><a href="#cb160-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-221"><a href="#cb160-221" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts))</span>
<span id="cb160-222"><a href="#cb160-222" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts)),</span>
<span id="cb160-223"><a href="#cb160-223" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_clusts))))</span>
<span id="cb160-224"><a href="#cb160-224" aria-hidden="true" tabindex="-1"></a>  already_used_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb160-225"><a href="#cb160-225" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts)){</span>
<span id="cb160-226"><a href="#cb160-226" aria-hidden="true" tabindex="-1"></a>    sels_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts[[i]]</span>
<span id="cb160-227"><a href="#cb160-227" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(sels_i) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-228"><a href="#cb160-228" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(sels_i))</span>
<span id="cb160-229"><a href="#cb160-229" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sels_i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb160-230"><a href="#cb160-230" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sels_i), <span class="fu">length</span>(<span class="fu">unique</span>(sels_i)))</span>
<span id="cb160-231"><a href="#cb160-231" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(already_used_feats, sels_i)), <span class="dv">0</span>)</span>
<span id="cb160-232"><a href="#cb160-232" aria-hidden="true" tabindex="-1"></a>    already_used_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(already_used_feats, sels_i)</span>
<span id="cb160-233"><a href="#cb160-233" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-234"><a href="#cb160-234" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(already_used_feats) <span class="sc">&lt;=</span> <span class="dv">11</span>)</span>
<span id="cb160-235"><a href="#cb160-235" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(already_used_feats),</span>
<span id="cb160-236"><a href="#cb160-236" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(already_used_feats)))</span>
<span id="cb160-237"><a href="#cb160-237" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(already_used_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb160-238"><a href="#cb160-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-239"><a href="#cb160-239" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&lt;=</span> <span class="dv">11</span>)</span>
<span id="cb160-240"><a href="#cb160-240" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_feats))</span>
<span id="cb160-241"><a href="#cb160-241" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb160-242"><a href="#cb160-242" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats)),</span>
<span id="cb160-243"><a href="#cb160-243" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(res<span class="sc">$</span>selected_feats))))</span>
<span id="cb160-244"><a href="#cb160-244" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb160-245"><a href="#cb160-245" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_feats <span class="sc">&lt;=</span> <span class="dv">11</span>))</span>
<span id="cb160-246"><a href="#cb160-246" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_feats),</span>
<span id="cb160-247"><a href="#cb160-247" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(<span class="fu">unique</span>(res<span class="sc">$</span>selected_feats)))</span>
<span id="cb160-248"><a href="#cb160-248" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-249"><a href="#cb160-249" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Vary inputs</span></span>
<span id="cb160-250"><a href="#cb160-250" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters, <span class="at">lambda=</span><span class="fl">0.01</span>)</span>
<span id="cb160-251"><a href="#cb160-251" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-252"><a href="#cb160-252" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb160-253"><a href="#cb160-253" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb160-254"><a href="#cb160-254" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb160-255"><a href="#cb160-255" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-256"><a href="#cb160-256" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters, <span class="at">cutoff=</span><span class="fl">0.6</span>)</span>
<span id="cb160-257"><a href="#cb160-257" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-258"><a href="#cb160-258" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb160-259"><a href="#cb160-259" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb160-260"><a href="#cb160-260" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb160-261"><a href="#cb160-261" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-262"><a href="#cb160-262" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters, <span class="at">max_num_clusts=</span><span class="dv">6</span>)</span>
<span id="cb160-263"><a href="#cb160-263" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-264"><a href="#cb160-264" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb160-265"><a href="#cb160-265" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb160-266"><a href="#cb160-266" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb160-267"><a href="#cb160-267" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts) <span class="sc">&lt;=</span> <span class="dv">6</span>)</span>
<span id="cb160-268"><a href="#cb160-268" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-269"><a href="#cb160-269" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters, <span class="at">auto_select_size=</span><span class="cn">FALSE</span>)</span>
<span id="cb160-270"><a href="#cb160-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-271"><a href="#cb160-271" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb160-272"><a href="#cb160-272" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">2</span>)</span>
<span id="cb160-273"><a href="#cb160-273" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_clusts&quot;</span>, <span class="st">&quot;selected_feats&quot;</span>))</span>
<span id="cb160-274"><a href="#cb160-274" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total of 11 - 2*(3 - 1) = 7 clusters</span></span>
<span id="cb160-275"><a href="#cb160-275" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts), <span class="dv">7</span>)</span>
<span id="cb160-276"><a href="#cb160-276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-277"><a href="#cb160-277" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad inputs</span></span>
<span id="cb160-278"><a href="#cb160-278" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssSelect</span>(<span class="at">X=</span>x[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ], <span class="at">y=</span>y),</span>
<span id="cb160-279"><a href="#cb160-279" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n == length(y) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-280"><a href="#cb160-280" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-281"><a href="#cb160-281" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssSelect</span>(<span class="at">X=</span><span class="fu">character</span>(<span class="dv">5</span>), <span class="at">y=</span>y),</span>
<span id="cb160-282"><a href="#cb160-282" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.matrix(X) | is.data.frame(X) is not TRUE&quot;</span>,</span>
<span id="cb160-283"><a href="#cb160-283" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-284"><a href="#cb160-284" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-285"><a href="#cb160-285" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span><span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>, <span class="dv">5</span>, <span class="dv">3</span>)),</span>
<span id="cb160-286"><a href="#cb160-286" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.matrix(y) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-287"><a href="#cb160-287" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-288"><a href="#cb160-288" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span><span class="fu">factor</span>(<span class="fu">rbinom</span>(<span class="dv">15</span>, <span class="at">size=</span><span class="dv">1</span>, <span class="at">prob=</span>.<span class="dv">5</span>))),</span>
<span id="cb160-289"><a href="#cb160-289" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;The provided y must be real-valued, because cssSelect uses the lasso for feature selection. (In order to use a different form of response, use the css function and provide your own selection function accommodating your choice of y.)&quot;</span>,</span>
<span id="cb160-290"><a href="#cb160-290" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-291"><a href="#cb160-291" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-292"><a href="#cb160-292" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span><span class="st">&quot;clusters&quot;</span>),</span>
<span id="cb160-293"><a href="#cb160-293" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(clusters) | is.integer(clusters) is not TRUE&quot;</span>,</span>
<span id="cb160-294"><a href="#cb160-294" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-295"><a href="#cb160-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-296"><a href="#cb160-296" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">lambda=</span><span class="sc">-</span>.<span class="dv">1</span>),</span>
<span id="cb160-297"><a href="#cb160-297" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be nonnegative.&quot;</span>,</span>
<span id="cb160-298"><a href="#cb160-298" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-299"><a href="#cb160-299" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-300"><a href="#cb160-300" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">cutoff=</span><span class="fl">1.1</span>),</span>
<span id="cb160-301"><a href="#cb160-301" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;cutoff &lt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-302"><a href="#cb160-302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-303"><a href="#cb160-303" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">max_num_clusts=</span><span class="dv">1000</span>),</span>
<span id="cb160-304"><a href="#cb160-304" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &lt;= p is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-305"><a href="#cb160-305" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-306"><a href="#cb160-306" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssSelect</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">auto_select_size=</span><span class="dv">1</span>),</span>
<span id="cb160-307"><a href="#cb160-307" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.logical(auto_select_size) is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-308"><a href="#cb160-308" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## ── Warning (&#39;&lt;text&gt;:14&#39;): cssSelect works ──────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = x, y = y, clusters = good_clusters)
##  2. litr (local) getLassoLambda(X, y)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:14&#39;): cssSelect works ──────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = x, y = y, clusters = good_clusters)
##  2. litr (local) getModelSize(X, y, css_results$clusters)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:58&#39;): cssSelect works ──────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = x, y = y)
##  2. litr (local) getLassoLambda(X, y)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:58&#39;): cssSelect works ──────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = x, y = y)
##  2. litr (local) getModelSize(X, y, css_results$clusters)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:105&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = X_df, y = stats::rnorm(nrow(X_df)), clusters = 1:3)
##  2. litr (local) getLassoLambda(X, y)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:105&#39;): cssSelect works ─────────────────────────────────────
## Returning more than max_num_clusts = 1 clusters because increasing the cutoff any further would require returning 0 clusters
## Backtrace:
##  1. litr (local) cssSelect(X = X_df, y = stats::rnorm(nrow(X_df)), clusters = 1:3)
##  2. litr (local) getCssSelections(...)
##  3. litr (local) getSelectedClusters(...)
##  4. litr (local) checkSelectedClusters(...)
## 
## ── Warning (&#39;&lt;text&gt;:156&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = df2, y = stats::rnorm(nrow(X_df)), clusters = 1:3)
##  2. litr (local) getLassoLambda(X, y)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:207&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = x2, y = y, clusters = good_clusters)
##  2. litr (local) getLassoLambda(X, y)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:207&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = x2, y = y, clusters = good_clusters)
##  2. litr (local) getModelSize(X, y, css_results$clusters)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:250&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = x, y = y, clusters = good_clusters, lambda = 0.01)
##  2. litr (local) getModelSize(X, y, css_results$clusters)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:256&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = x, y = y, clusters = good_clusters, cutoff = 0.6)
##  2. litr (local) getLassoLambda(X, y)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:262&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = x, y = y, clusters = good_clusters, max_num_clusts = 6)
##  2. litr (local) getLassoLambda(X, y)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:269&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssSelect(X = x, y = y, clusters = good_clusters, auto_select_size = FALSE)
##  2. litr (local) getLassoLambda(X, y)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:285&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##   1. testthat::expect_error(...)
##   7. litr (local) cssSelect(X = x, y = matrix(1:15, 5, 3))
##   8. litr (local) getLassoLambda(X, y)
##   9. glmnet::cv.glmnet(...)
##  10. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:292&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##   1. testthat::expect_error(...)
##   7. litr (local) cssSelect(X = x, y = y, clusters = &quot;clusters&quot;)
##   8. litr (local) getLassoLambda(X, y)
##   9. glmnet::cv.glmnet(...)
##  10. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:300&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##   1. testthat::expect_error(...)
##   7. litr (local) cssSelect(X = x, y = y, cutoff = 1.1)
##   8. litr (local) getLassoLambda(X, y)
##   9. glmnet::cv.glmnet(...)
##  10. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:303&#39;): cssSelect works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##   1. testthat::expect_error(...)
##   7. litr (local) cssSelect(X = x, y = y, max_num_clusts = 1000)
##   8. litr (local) getLassoLambda(X, y)
##   9. glmnet::cv.glmnet(...)
##  10. glmnet:::cv.glmnet.raw(...)</code></pre>
<p><code>cssPredict()</code>:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Wrapper function to generate predictions from cluster stability selected</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; model in one step</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Select clusters using cluster stability selection, form cluster</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; representatives, fit a linear model, and generate predictions from a matrix</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of unlabeled data. This is a wrapper function for css and getCssPreds. Using</span></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cssPredict is simpler, but it has fewer options, and it executes the full</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (computationally expensive) subsampling procedured every time it is called.</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; In contrast, css can be called just once, and then cssPredict can quickly</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; return results for different matrices of new data or using different values</span></span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of cutoff, max_num_clusts, etc. by using the calculations done in one call to</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css.</span></span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X_train_selec An n x p numeric matrix (preferably) or a data.frame</span></span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (which will be coerced internally to a matrix by the function model.matrix)</span></span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; containing the p &gt;= 2 features/predictors. The data from X_train_selec and</span></span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; y_train_selec will be split into two parts; half of the data will be used for</span></span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; feature selection by cluster stability selection, and half will be used for</span></span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; estimating a linear model on the selected cluster representatives.</span></span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y_train_selec A length-n numeric vector containing the responses;</span></span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; `y[i]` is the response corresponding to observation `X[i, ]`. Unlke the more</span></span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; general setup of css, y_train_selec must be real-valued because predictions</span></span>
<span id="cb162-23"><a href="#cb162-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will be generated by ordinary least squares.</span></span>
<span id="cb162-24"><a href="#cb162-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X_test A numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb162-25"><a href="#cb162-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb162-26"><a href="#cb162-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the data that will be used to generate predictions. Must contain the same</span></span>
<span id="cb162-27"><a href="#cb162-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features (in the same number of columns) as X_train_selec, and if the columns</span></span>
<span id="cb162-28"><a href="#cb162-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of X_test are named, they must match the names of X_train_selec.</span></span>
<span id="cb162-29"><a href="#cb162-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters Optional; either an integer vector of a list of integer</span></span>
<span id="cb162-30"><a href="#cb162-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vectors; each vector should contain the indices of a cluster of features (a</span></span>
<span id="cb162-31"><a href="#cb162-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; subset of 1:p). (If there is only one cluster, clusters can either be a list</span></span>
<span id="cb162-32"><a href="#cb162-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of length 1 or an integer vector.) All of the provided clusters must be</span></span>
<span id="cb162-33"><a href="#cb162-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; non-overlapping. Every feature not appearing in any cluster will be assumed</span></span>
<span id="cb162-34"><a href="#cb162-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to be unclustered (that is, they  will be treated as if they are in a</span></span>
<span id="cb162-35"><a href="#cb162-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &quot;cluster&quot; containing only themselves). If clusters is a list of length 0 (or</span></span>
<span id="cb162-36"><a href="#cb162-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; a list only containing clusters of length 1), then css() returns the same</span></span>
<span id="cb162-37"><a href="#cb162-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; results as stability selection (so feat_sel_mat will be identical to</span></span>
<span id="cb162-38"><a href="#cb162-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clus_sel_mat). Names for the clusters will be needed later; any clusters that</span></span>
<span id="cb162-39"><a href="#cb162-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; are not given names in the list clusters will be given names automatically by</span></span>
<span id="cb162-40"><a href="#cb162-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; css. Default is list() (so no clusters are specified, and every feature is</span></span>
<span id="cb162-41"><a href="#cb162-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; assumed to be in a &quot;cluster&quot; containng only itself).</span></span>
<span id="cb162-42"><a href="#cb162-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lambda Optional; the tuning parameter to be used by the lasso for</span></span>
<span id="cb162-43"><a href="#cb162-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; feature selection in each subsample. If lambda is not provided, cssPredict</span></span>
<span id="cb162-44"><a href="#cb162-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will choose one automatically by cross-validation. Default is NA.</span></span>
<span id="cb162-45"><a href="#cb162-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param cutoff Numeric; getCssPreds will make use only of those clusters with</span></span>
<span id="cb162-46"><a href="#cb162-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; selection proportions equal to at least cutoff. Must be between 0 and 1.</span></span>
<span id="cb162-47"><a href="#cb162-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Default is 0 (in which case either all clusters are used, or max_num_clusts</span></span>
<span id="cb162-48"><a href="#cb162-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; are used, if max_num_clusts is specified).</span></span>
<span id="cb162-49"><a href="#cb162-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param max_num_clusts Integer or numeric; the maximum number of clusters to</span></span>
<span id="cb162-50"><a href="#cb162-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; use regardless of cutoff. (That is, if the chosen cutoff returns more than</span></span>
<span id="cb162-51"><a href="#cb162-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters, the cutoff will be decreased until at most</span></span>
<span id="cb162-52"><a href="#cb162-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts clusters are selected.) Default is NA (in which case</span></span>
<span id="cb162-53"><a href="#cb162-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts is ignored).</span></span>
<span id="cb162-54"><a href="#cb162-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param train_inds Optional; an integer or numeric vector containing the</span></span>
<span id="cb162-55"><a href="#cb162-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of observations in X and y to set aside for model training after</span></span>
<span id="cb162-56"><a href="#cb162-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; feature selection. If train_inds is not provided, half of the data will be</span></span>
<span id="cb162-57"><a href="#cb162-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; used for feature selection and half for model estimation (chosen at random).</span></span>
<span id="cb162-58"><a href="#cb162-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param auto_select_size Logical; if TRUE, then max_num_clusts will be</span></span>
<span id="cb162-59"><a href="#cb162-59" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; automatically estimated using the lasso with cross-validation. Default is</span></span>
<span id="cb162-60"><a href="#cb162-60" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; TRUE, though his argument is ignored if either cutoff or max_num_clusts is</span></span>
<span id="cb162-61"><a href="#cb162-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided. (If desired output is to generate predictions using all clusters,</span></span>
<span id="cb162-62"><a href="#cb162-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; you should set auto_select_size to FALSE and do not provide cutoff or</span></span>
<span id="cb162-63"><a href="#cb162-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; max_num_clusts.)</span></span>
<span id="cb162-64"><a href="#cb162-64" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A numeric vector of length nrow(X_test) of predictions</span></span>
<span id="cb162-65"><a href="#cb162-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; corresponding to the observations from X_test.</span></span>
<span id="cb162-66"><a href="#cb162-66" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb162-67"><a href="#cb162-67" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb162-68"><a href="#cb162-68" aria-hidden="true" tabindex="-1"></a>cssPredict <span class="ot">&lt;-</span> <span class="cf">function</span>(X_train_selec, y_train_selec, X_test, <span class="at">clusters=</span><span class="fu">list</span>(),</span>
<span id="cb162-69"><a href="#cb162-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda=</span><span class="cn">NA</span>, <span class="at">cutoff=</span><span class="cn">NA</span>, <span class="at">max_num_clusts=</span><span class="cn">NA</span>, <span class="at">train_inds=</span><span class="cn">NA</span>,</span>
<span id="cb162-70"><a href="#cb162-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">auto_select_size=</span><span class="cn">TRUE</span>){</span>
<span id="cb162-71"><a href="#cb162-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-72"><a href="#cb162-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs (most inputs will be checked by called functions)</span></span>
<span id="cb162-73"><a href="#cb162-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.numeric</span>(y_train_selec) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.integer</span>(y_train_selec)){</span>
<span id="cb162-74"><a href="#cb162-74" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;The provided y_train_selec must be real-valued, because predictions will be generated by ordinary least squares regression.&quot;</span>)</span>
<span id="cb162-75"><a href="#cb162-75" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb162-76"><a href="#cb162-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-77"><a href="#cb162-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(auto_select_size))</span>
<span id="cb162-78"><a href="#cb162-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(auto_select_size) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb162-79"><a href="#cb162-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(auto_select_size))</span>
<span id="cb162-80"><a href="#cb162-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-81"><a href="#cb162-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X_train_selec) <span class="sc">|</span> <span class="fu">is.data.frame</span>(X_train_selec))</span>
<span id="cb162-82"><a href="#cb162-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(X_train_selec)))</span>
<span id="cb162-83"><a href="#cb162-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-84"><a href="#cb162-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if x is a matrix; if it&#39;s a data.frame, convert to matrix.</span></span>
<span id="cb162-85"><a href="#cb162-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.data.frame</span>(X_train_selec)){</span>
<span id="cb162-86"><a href="#cb162-86" aria-hidden="true" tabindex="-1"></a>        X_train_selec <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X_train_selec)</span>
<span id="cb162-87"><a href="#cb162-87" aria-hidden="true" tabindex="-1"></a>        X_train_selec <span class="ot">&lt;-</span> X_train_selec[, <span class="fu">colnames</span>(X_train_selec) <span class="sc">!=</span></span>
<span id="cb162-88"><a href="#cb162-88" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb162-89"><a href="#cb162-89" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb162-90"><a href="#cb162-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-91"><a href="#cb162-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X_train_selec))</span>
<span id="cb162-92"><a href="#cb162-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(X_train_selec)))</span>
<span id="cb162-93"><a href="#cb162-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-94"><a href="#cb162-94" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_train_selec)</span>
<span id="cb162-95"><a href="#cb162-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-96"><a href="#cb162-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(train_inds))){</span>
<span id="cb162-97"><a href="#cb162-97" aria-hidden="true" tabindex="-1"></a>        train_inds <span class="ot">&lt;-</span> <span class="fu">sample</span>(n, <span class="at">size=</span><span class="fu">round</span>(n<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb162-98"><a href="#cb162-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb162-99"><a href="#cb162-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-100"><a href="#cb162-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(lambda) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb162-101"><a href="#cb162-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(lambda)){</span>
<span id="cb162-102"><a href="#cb162-102" aria-hidden="true" tabindex="-1"></a>        lambda <span class="ot">&lt;-</span> <span class="fu">getLassoLambda</span>(X_train_selec[<span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, train_inds), ],</span>
<span id="cb162-103"><a href="#cb162-103" aria-hidden="true" tabindex="-1"></a>            y_train_selec[<span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, train_inds)]) </span>
<span id="cb162-104"><a href="#cb162-104" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb162-105"><a href="#cb162-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-106"><a href="#cb162-106" aria-hidden="true" tabindex="-1"></a>    css_results <span class="ot">&lt;-</span> <span class="fu">css</span>(<span class="at">X=</span>X_train_selec, <span class="at">y=</span>y_train_selec, <span class="at">lambda=</span>lambda,</span>
<span id="cb162-107"><a href="#cb162-107" aria-hidden="true" tabindex="-1"></a>        <span class="at">clusters=</span>clusters, <span class="at">train_inds=</span>train_inds)</span>
<span id="cb162-108"><a href="#cb162-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-109"><a href="#cb162-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no indication of how to select model size was provided, choose model</span></span>
<span id="cb162-110"><a href="#cb162-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># size by cross-validation</span></span>
<span id="cb162-111"><a href="#cb162-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(cutoff) <span class="sc">&amp;</span> <span class="fu">is.na</span>(max_num_clusts)){</span>
<span id="cb162-112"><a href="#cb162-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(auto_select_size){</span>
<span id="cb162-113"><a href="#cb162-113" aria-hidden="true" tabindex="-1"></a>            max_num_clusts <span class="ot">&lt;-</span> <span class="fu">getModelSize</span>(X_train_selec[train_inds, ],</span>
<span id="cb162-114"><a href="#cb162-114" aria-hidden="true" tabindex="-1"></a>                y_train_selec[train_inds], css_results<span class="sc">$</span>clusters)</span>
<span id="cb162-115"><a href="#cb162-115" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb162-116"><a href="#cb162-116" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb162-117"><a href="#cb162-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-118"><a href="#cb162-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(cutoff)){</span>
<span id="cb162-119"><a href="#cb162-119" aria-hidden="true" tabindex="-1"></a>        cutoff <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb162-120"><a href="#cb162-120" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb162-121"><a href="#cb162-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-122"><a href="#cb162-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get predictions</span></span>
<span id="cb162-123"><a href="#cb162-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">getCssPreds</span>(css_results, <span class="at">testX=</span>X_test, <span class="at">weighting=</span><span class="st">&quot;weighted_avg&quot;</span>,</span>
<span id="cb162-124"><a href="#cb162-124" aria-hidden="true" tabindex="-1"></a>        <span class="at">cutoff=</span>cutoff, <span class="at">max_num_clusts=</span>max_num_clusts)</span>
<span id="cb162-125"><a href="#cb162-125" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>cssPredict()</code>:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;cssPredict works&quot;</span>, {</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">84231</span>)</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> <span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">30</span>, <span class="at">p=</span><span class="dv">11</span>, <span class="at">k_unclustered=</span><span class="dv">1</span>, <span class="at">cluster_size=</span><span class="dv">3</span>,</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n_clusters=</span><span class="dv">2</span>, <span class="at">sig_clusters=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="dv">1</span>)</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> train_data<span class="sc">$</span>X</span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> train_data<span class="sc">$</span>y</span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a>  test_x <span class="ot">&lt;-</span> <span class="fu">genClusteredData</span>(<span class="at">n=</span><span class="dv">5</span>, <span class="at">p=</span><span class="dv">11</span>, <span class="at">k_unclustered=</span><span class="dv">1</span>, <span class="at">cluster_size=</span><span class="dv">3</span>,</span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">n_clusters=</span><span class="dv">2</span>, <span class="at">sig_clusters=</span><span class="dv">1</span>, <span class="at">sigma_eps_sq=</span><span class="dv">1</span>)<span class="sc">$</span>X</span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Intentionally don&#39;t provide clusters for all features, mix up formatting,</span></span>
<span id="cb163-14"><a href="#cb163-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># etc.</span></span>
<span id="cb163-15"><a href="#cb163-15" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>3L, <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb163-16"><a href="#cb163-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-17"><a href="#cb163-17" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y, <span class="at">X_test=</span>test_x,</span>
<span id="cb163-18"><a href="#cb163-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">clusters=</span>good_clusters)</span>
<span id="cb163-19"><a href="#cb163-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-20"><a href="#cb163-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb163-21"><a href="#cb163-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb163-22"><a href="#cb163-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">5</span>)</span>
<span id="cb163-23"><a href="#cb163-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-24"><a href="#cb163-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># No provided clusters</span></span>
<span id="cb163-25"><a href="#cb163-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-26"><a href="#cb163-26" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y, <span class="at">X_test=</span>test_x)</span>
<span id="cb163-27"><a href="#cb163-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-28"><a href="#cb163-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb163-29"><a href="#cb163-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb163-30"><a href="#cb163-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">5</span>)</span>
<span id="cb163-31"><a href="#cb163-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-32"><a href="#cb163-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Provide training indices</span></span>
<span id="cb163-33"><a href="#cb163-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-34"><a href="#cb163-34" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y, <span class="at">X_test=</span>test_x,</span>
<span id="cb163-35"><a href="#cb163-35" aria-hidden="true" tabindex="-1"></a>                    <span class="at">train_inds=</span><span class="dv">13</span><span class="sc">:</span><span class="dv">28</span>)</span>
<span id="cb163-36"><a href="#cb163-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-37"><a href="#cb163-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb163-38"><a href="#cb163-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb163-39"><a href="#cb163-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">5</span>)</span>
<span id="cb163-40"><a href="#cb163-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-41"><a href="#cb163-41" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Trying other inputs</span></span>
<span id="cb163-42"><a href="#cb163-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-43"><a href="#cb163-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a data.frame</span></span>
<span id="cb163-44"><a href="#cb163-44" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb163-45"><a href="#cb163-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-46"><a href="#cb163-46" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_df)</span>
<span id="cb163-47"><a href="#cb163-47" aria-hidden="true" tabindex="-1"></a>  test_inds <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">round</span>(n<span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb163-48"><a href="#cb163-48" aria-hidden="true" tabindex="-1"></a>  n_test <span class="ot">&lt;-</span> <span class="fu">length</span>(test_inds)</span>
<span id="cb163-49"><a href="#cb163-49" aria-hidden="true" tabindex="-1"></a>  selec_train_inds <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n, test_inds)</span>
<span id="cb163-50"><a href="#cb163-50" aria-hidden="true" tabindex="-1"></a>  n_selec_train <span class="ot">&lt;-</span> <span class="fu">length</span>(selec_train_inds)</span>
<span id="cb163-51"><a href="#cb163-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-52"><a href="#cb163-52" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>X_df[selec_train_inds, ],</span>
<span id="cb163-53"><a href="#cb163-53" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y_train_selec=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(n_selec_train),</span>
<span id="cb163-54"><a href="#cb163-54" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X_test=</span>X_df[test_inds, ])</span>
<span id="cb163-55"><a href="#cb163-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-56"><a href="#cb163-56" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb163-57"><a href="#cb163-57" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb163-58"><a href="#cb163-58" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), n_test)</span>
<span id="cb163-59"><a href="#cb163-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-60"><a href="#cb163-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a dataframe with factors (number of columns of final design matrix</span></span>
<span id="cb163-61"><a href="#cb163-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after one-hot encoding factors won&#39;t match number of columns of df2)</span></span>
<span id="cb163-62"><a href="#cb163-62" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> X_df</span>
<span id="cb163-63"><a href="#cb163-63" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>cyl)</span>
<span id="cb163-64"><a href="#cb163-64" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>vs)</span>
<span id="cb163-65"><a href="#cb163-65" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>am)</span>
<span id="cb163-66"><a href="#cb163-66" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>gear)</span>
<span id="cb163-67"><a href="#cb163-67" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>carb)</span>
<span id="cb163-68"><a href="#cb163-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-69"><a href="#cb163-69" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>df2[selec_train_inds, ],</span>
<span id="cb163-70"><a href="#cb163-70" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y_train_selec=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(n_selec_train),</span>
<span id="cb163-71"><a href="#cb163-71" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X_test=</span>df2[test_inds, ])</span>
<span id="cb163-72"><a href="#cb163-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-73"><a href="#cb163-73" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb163-74"><a href="#cb163-74" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb163-75"><a href="#cb163-75" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), n_test)</span>
<span id="cb163-76"><a href="#cb163-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-77"><a href="#cb163-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a matrix with column names</span></span>
<span id="cb163-78"><a href="#cb163-78" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> x</span>
<span id="cb163-79"><a href="#cb163-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x2) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb163-80"><a href="#cb163-80" aria-hidden="true" tabindex="-1"></a>  test_x2 <span class="ot">&lt;-</span> test_x</span>
<span id="cb163-81"><a href="#cb163-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(test_x2) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb163-82"><a href="#cb163-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-83"><a href="#cb163-83" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x2, <span class="at">y_train_selec=</span>y, <span class="at">X_test=</span>test_x2,</span>
<span id="cb163-84"><a href="#cb163-84" aria-hidden="true" tabindex="-1"></a>                    <span class="at">clusters=</span>good_clusters)</span>
<span id="cb163-85"><a href="#cb163-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-86"><a href="#cb163-86" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb163-87"><a href="#cb163-87" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb163-88"><a href="#cb163-88" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">5</span>)</span>
<span id="cb163-89"><a href="#cb163-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-90"><a href="#cb163-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Vary inputs</span></span>
<span id="cb163-91"><a href="#cb163-91" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y, <span class="at">X_test=</span>test_x,</span>
<span id="cb163-92"><a href="#cb163-92" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lambda=</span><span class="fl">0.01</span>)</span>
<span id="cb163-93"><a href="#cb163-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-94"><a href="#cb163-94" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb163-95"><a href="#cb163-95" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb163-96"><a href="#cb163-96" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">5</span>)</span>
<span id="cb163-97"><a href="#cb163-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-98"><a href="#cb163-98" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y, <span class="at">X_test=</span>test_x, <span class="at">cutoff=</span><span class="fl">0.6</span>)</span>
<span id="cb163-99"><a href="#cb163-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-100"><a href="#cb163-100" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb163-101"><a href="#cb163-101" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb163-102"><a href="#cb163-102" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">5</span>)</span>
<span id="cb163-103"><a href="#cb163-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-104"><a href="#cb163-104" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y, <span class="at">X_test=</span>test_x,</span>
<span id="cb163-105"><a href="#cb163-105" aria-hidden="true" tabindex="-1"></a>                    <span class="at">max_num_clusts=</span><span class="dv">6</span>)</span>
<span id="cb163-106"><a href="#cb163-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-107"><a href="#cb163-107" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb163-108"><a href="#cb163-108" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb163-109"><a href="#cb163-109" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">5</span>)</span>
<span id="cb163-110"><a href="#cb163-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-111"><a href="#cb163-111" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y, <span class="at">X_test=</span>test_x,</span>
<span id="cb163-112"><a href="#cb163-112" aria-hidden="true" tabindex="-1"></a>                    <span class="at">auto_select_size=</span><span class="cn">FALSE</span>)</span>
<span id="cb163-113"><a href="#cb163-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-114"><a href="#cb163-114" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res)))</span>
<span id="cb163-115"><a href="#cb163-115" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb163-116"><a href="#cb163-116" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res), <span class="dv">5</span>)</span>
<span id="cb163-117"><a href="#cb163-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-118"><a href="#cb163-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad inputs</span></span>
<span id="cb163-119"><a href="#cb163-119" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ], <span class="at">y_train_selec=</span>y,</span>
<span id="cb163-120"><a href="#cb163-120" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">X_test=</span>test_x),</span>
<span id="cb163-121"><a href="#cb163-121" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(y) == n is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb163-122"><a href="#cb163-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-123"><a href="#cb163-123" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span><span class="fu">character</span>(<span class="dv">30</span>),</span>
<span id="cb163-124"><a href="#cb163-124" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">y_train_selec=</span>y, <span class="at">X_test=</span>test_x),</span>
<span id="cb163-125"><a href="#cb163-125" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.matrix(X_train_selec) | is.data.frame(X_train_selec) is not TRUE&quot;</span>,</span>
<span id="cb163-126"><a href="#cb163-126" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb163-127"><a href="#cb163-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-128"><a href="#cb163-128" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x,</span>
<span id="cb163-129"><a href="#cb163-129" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">y_train_selec=</span><span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, <span class="dv">10</span>, <span class="dv">3</span>),</span>
<span id="cb163-130"><a href="#cb163-130" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">X_test=</span>test_x), <span class="st">&quot;!is.matrix(y) is not TRUE&quot;</span>,</span>
<span id="cb163-131"><a href="#cb163-131" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb163-132"><a href="#cb163-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-133"><a href="#cb163-133" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x,</span>
<span id="cb163-134"><a href="#cb163-134" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">y_train_selec=</span><span class="fu">factor</span>(<span class="fu">rbinom</span>(<span class="dv">30</span>, <span class="at">size=</span><span class="dv">1</span>,</span>
<span id="cb163-135"><a href="#cb163-135" aria-hidden="true" tabindex="-1"></a>                                                                <span class="at">prob=</span>.<span class="dv">5</span>)),</span>
<span id="cb163-136"><a href="#cb163-136" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">X_test=</span>test_x),</span>
<span id="cb163-137"><a href="#cb163-137" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;The provided y_train_selec must be real-valued, because predictions will be generated by ordinary least squares regression.&quot;</span>,</span>
<span id="cb163-138"><a href="#cb163-138" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb163-139"><a href="#cb163-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-140"><a href="#cb163-140" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y,</span>
<span id="cb163-141"><a href="#cb163-141" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">X_test=</span>test_x, <span class="at">clusters=</span><span class="st">&quot;clusters&quot;</span>),</span>
<span id="cb163-142"><a href="#cb163-142" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(clusters) | is.integer(clusters) is not TRUE&quot;</span>,</span>
<span id="cb163-143"><a href="#cb163-143" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb163-144"><a href="#cb163-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-145"><a href="#cb163-145" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y,</span>
<span id="cb163-146"><a href="#cb163-146" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">X_test=</span>test_x, <span class="at">lambda=</span><span class="st">&quot;lambda&quot;</span>),</span>
<span id="cb163-147"><a href="#cb163-147" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;For method cssLasso, lambda must be a numeric.&quot;</span>,</span>
<span id="cb163-148"><a href="#cb163-148" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb163-149"><a href="#cb163-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-150"><a href="#cb163-150" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y,</span>
<span id="cb163-151"><a href="#cb163-151" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">X_test=</span>test_x, <span class="at">cutoff=</span><span class="sc">-</span>.<span class="dv">1</span>),</span>
<span id="cb163-152"><a href="#cb163-152" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;cutoff &gt;= 0 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb163-153"><a href="#cb163-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-154"><a href="#cb163-154" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y,</span>
<span id="cb163-155"><a href="#cb163-155" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">X_test=</span>test_x, <span class="at">max_num_clusts=</span><span class="dv">0</span>),</span>
<span id="cb163-156"><a href="#cb163-156" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;max_num_clusts &gt;= 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb163-157"><a href="#cb163-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-158"><a href="#cb163-158" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">cssPredict</span>(<span class="at">X_train_selec=</span>x, <span class="at">y_train_selec=</span>y,</span>
<span id="cb163-159"><a href="#cb163-159" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">X_test=</span>test_x, <span class="at">auto_select_size=</span><span class="fu">c</span>(<span class="cn">TRUE</span>,</span>
<span id="cb163-160"><a href="#cb163-160" aria-hidden="true" tabindex="-1"></a>                                                                      <span class="cn">FALSE</span>)),</span>
<span id="cb163-161"><a href="#cb163-161" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(auto_select_size) == 1 is not TRUE&quot;</span>,</span>
<span id="cb163-162"><a href="#cb163-162" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb163-163"><a href="#cb163-163" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## ── Warning (&#39;&lt;text&gt;:17&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getLassoLambda(...)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:17&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getModelSize(...)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:26&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(X_train_selec = x, y_train_selec = y, X_test = test_x)
##  2. litr (local) getLassoLambda(...)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:26&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(X_train_selec = x, y_train_selec = y, X_test = test_x)
##  2. litr (local) getModelSize(...)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:34&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getLassoLambda(...)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:34&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getModelSize(...)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:52&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getLassoLambda(...)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:52&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getModelSize(...)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:69&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getLassoLambda(...)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:69&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getModelSize(...)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:83&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getLassoLambda(...)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:83&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getModelSize(...)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:91&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getModelSize(...)
##  3. glmnet::cv.glmnet(x = X_size, y = y, family = &quot;gaussian&quot;)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:98&#39;): cssPredict works ─────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getLassoLambda(...)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:104&#39;): cssPredict works ────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getLassoLambda(...)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:111&#39;): cssPredict works ────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##  1. litr (local) cssPredict(...)
##  2. litr (local) getLassoLambda(...)
##  3. glmnet::cv.glmnet(...)
##  4. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:119&#39;): cssPredict works ────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##   1. testthat::expect_error(...)
##   7. litr (local) cssPredict(X_train_selec = x[1:10, ], y_train_selec = y, X_test = test_x)
##   8. litr (local) getLassoLambda(...)
##   9. glmnet::cv.glmnet(...)
##  10. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:128&#39;): cssPredict works ────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##   1. testthat::expect_error(...)
##   7. litr (local) cssPredict(...)
##   8. litr (local) getLassoLambda(...)
##   9. glmnet::cv.glmnet(...)
##  10. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:140&#39;): cssPredict works ────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##   1. testthat::expect_error(...)
##   7. litr (local) cssPredict(...)
##   8. litr (local) getLassoLambda(...)
##   9. glmnet::cv.glmnet(...)
##  10. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:150&#39;): cssPredict works ────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##   1. testthat::expect_error(...)
##   7. litr (local) cssPredict(...)
##   8. litr (local) getLassoLambda(...)
##   9. glmnet::cv.glmnet(...)
##  10. glmnet:::cv.glmnet.raw(...)
## 
## ── Warning (&#39;&lt;text&gt;:154&#39;): cssPredict works ────────────────────────────────────
## Option grouped=FALSE enforced in cv.glmnet, since &lt; 3 observations per fold
## Backtrace:
##   1. testthat::expect_error(...)
##   7. litr (local) cssPredict(...)
##   8. litr (local) getLassoLambda(...)
##   9. glmnet::cv.glmnet(...)
##  10. glmnet:::cv.glmnet.raw(...)</code></pre>
</div>
<div id="competitor-methods" class="section level1 hasAnchor" number="8">
<h1 class="hasAnchor"><span class="header-section-number">8</span> Competitor Methods<a href="#competitor-methods" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We also provide implementations of some competitor feature selection methods. We used these in the simulation studies in our paper to compare cluster stability selection to the protolasso (Redi and Tibshirani, 2016) and the cluster representative lasso (Bühlmann et. al. 2013), two other feature selection methods that are designed for data with clustered features. These feature selection methods are in some ways closely related, so their implementations share helper functions.</p>
<ul>
<li><code>protolasso()</code>
<ul>
<li><code>processClusterLassoInputs()</code> checks and formats the function inputs</li>
<li><code>getXglmnet()</code> formats the provided design matrix <code>Xglmnet</code> for the lasso as implemented by <code>glmnet</code> (for the protolasso, this means discarding all features from each cluster except the one most highly correlated with the response; for the cluster representative lasso, this means replacing the clustered features with a simple average of the cluster members).
<ul>
<li><code>checkGetXglmnetInputs()</code> verifies the inputs to <code>getXglmnet()</code></li>
</ul></li>
<li>Finally, <code>getClusterSelsFromGlmnet()</code> extracts the relevant output from the results yielded by a <code>glmnet</code> lasso fit.
<ul>
<li><code>getSelectedSets()</code> takes in a single selected set from <code>Xglmnet</code> and yields a selected feature set in the original feature space (with each selected cluster from <code>Xglmnet</code> replaced by its prototype) as well as a selected set of clusters.</li>
</ul></li>
</ul></li>
<li><code>clusterRepLasso()</code></li>
</ul>
<p><code>protolasso()</code>:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Select features via the protolasso (Reid and Tibshirani 2016)</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X An n x p numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; p &gt;= 2 features/predictors</span></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y The response; A length n numeric (or integer) real-valued vector.</span></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A list of integer vectors; each vector should contain the </span></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of a cluster of features (a subset of 1:p). (If there is only one</span></span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster, clusters can either be a list of length 1 or an integer vector.)</span></span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; All of the provided clusters must be non-overlapping. Every feature not</span></span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; appearing in any cluster will be assumed to be unclustered (that is, they</span></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will be treated as if they are in a &quot;cluster&quot; containing only themselves).</span></span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Default is list() (so no clusters are specified).</span></span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param nlambda Integer; the number of lambda values to use in the lasso fit</span></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for the protolasso. Default is 100 (following the default for glmnet). For</span></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; now, nlambda must be at least 2 (using a single lambda is not supported).</span></span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list with three elements. \item{selected_sets}{A list of integer</span></span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vectors. Entry k of this list contains a selected set (an integer vector) of</span></span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; size k yielded by the protolasso (If no set of size k was selected, entry k</span></span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will be empty.)} \item{selected_clusts_list}{A list; each element of the list</span></span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; is a named list of selected clusters. (That is, if a selected set of size k</span></span>
<span id="cb165-22"><a href="#cb165-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; was yielded by the protolasso, then selected_clusts_list[[k]] is a named</span></span>
<span id="cb165-23"><a href="#cb165-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; list of length k, where each member of the list is an integer vector</span></span>
<span id="cb165-24"><a href="#cb165-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of cluster members. In particular, selected_clusts_lists[[k]][[j]] will be</span></span>
<span id="cb165-25"><a href="#cb165-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the cluster that contains feature selected_sets[[k]][j].)} \item{beta}{The</span></span>
<span id="cb165-26"><a href="#cb165-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; beta output from glmnet when the lasso was estimated on a matrix of</span></span>
<span id="cb165-27"><a href="#cb165-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; prototypes. (See documentation for the function glmnet from the glmnet</span></span>
<span id="cb165-28"><a href="#cb165-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; package for details.)}</span></span>
<span id="cb165-29"><a href="#cb165-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb165-30"><a href="#cb165-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references Reid, S., &amp; Tibshirani, R. (2016). Sparse regression and marginal</span></span>
<span id="cb165-31"><a href="#cb165-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; testing using cluster prototypes. \emph{Biostatistics}, 17(2), 364–376.</span></span>
<span id="cb165-32"><a href="#cb165-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://doi.org/10.1093/biostatistics/kxv049}.</span></span>
<span id="cb165-33"><a href="#cb165-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @export</span></span>
<span id="cb165-34"><a href="#cb165-34" aria-hidden="true" tabindex="-1"></a>protolasso <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, clusters, <span class="at">nlambda=</span><span class="dv">100</span>){</span>
<span id="cb165-35"><a href="#cb165-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-36"><a href="#cb165-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle and format inputs; get cluster prototypes</span></span>
<span id="cb165-37"><a href="#cb165-37" aria-hidden="true" tabindex="-1"></a>    ret <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(X, y, clusters, nlambda)</span>
<span id="cb165-38"><a href="#cb165-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-39"><a href="#cb165-39" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> ret<span class="sc">$</span>x</span>
<span id="cb165-40"><a href="#cb165-40" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> ret<span class="sc">$</span>clusters</span>
<span id="cb165-41"><a href="#cb165-41" aria-hidden="true" tabindex="-1"></a>    prototypes <span class="ot">&lt;-</span> ret<span class="sc">$</span>prototypes</span>
<span id="cb165-42"><a href="#cb165-42" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="ot">&lt;-</span> ret<span class="sc">$</span>var_names</span>
<span id="cb165-43"><a href="#cb165-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-44"><a href="#cb165-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(ret)</span>
<span id="cb165-45"><a href="#cb165-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-46"><a href="#cb165-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format the design matrix for glmnet according to the protolasso procedure</span></span>
<span id="cb165-47"><a href="#cb165-47" aria-hidden="true" tabindex="-1"></a>    X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(x, clusters, <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>,</span>
<span id="cb165-48"><a href="#cb165-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">prototypes=</span>prototypes)</span>
<span id="cb165-49"><a href="#cb165-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-50"><a href="#cb165-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimate the lasso on the cluster prototypes</span></span>
<span id="cb165-51"><a href="#cb165-51" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span>y, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">nlambda=</span>nlambda)</span>
<span id="cb165-52"><a href="#cb165-52" aria-hidden="true" tabindex="-1"></a>    lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb165-53"><a href="#cb165-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-54"><a href="#cb165-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Finally, obtain a tidy list of selected sets--one for each model size</span></span>
<span id="cb165-55"><a href="#cb165-55" aria-hidden="true" tabindex="-1"></a>    cluster_sel_results <span class="ot">&lt;-</span> <span class="fu">getClusterSelsFromGlmnet</span>(lasso_sets, clusters,</span>
<span id="cb165-56"><a href="#cb165-56" aria-hidden="true" tabindex="-1"></a>        prototypes, feat_names)</span>
<span id="cb165-57"><a href="#cb165-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-58"><a href="#cb165-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">selected_sets=</span>cluster_sel_results<span class="sc">$</span>selected_sets,</span>
<span id="cb165-59"><a href="#cb165-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">selected_clusts_list=</span>cluster_sel_results<span class="sc">$</span>selected_clusts_list,</span>
<span id="cb165-60"><a href="#cb165-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta=</span>fit<span class="sc">$</span>beta))</span>
<span id="cb165-61"><a href="#cb165-61" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>processClusterLassoInputs()</code>:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Check the inputs to protolasso and clusterRepLasso, format clusters, and</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; identify prototypes for each cluster</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X An n x p numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; p &gt;= 2 features/predictors</span></span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y The response; A length n numeric (or integer) real-valued vector.</span></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A list of integer vectors; each vector should contain the </span></span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of a cluster of features (a subset of 1:p). (If there is only one</span></span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster, clusters can either be a list of length 1 or an integer vector.)</span></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; All of the provided clusters must be non-overlapping. Every feature not</span></span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; appearing in any cluster will be assumed to be unclustered (that is, they</span></span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will be treated as if they are in a &quot;cluster&quot; containing only themselves).</span></span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Default is list() (so no clusters are specified).</span></span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param nlambda Integer; the number of lambda values to use in the lasso fit</span></span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for the protolasso. Default is 100 (following the default for glmnet). For</span></span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; now, nlambda must be at least 2 (using a single lambda is not supported).</span></span>
<span id="cb166-18"><a href="#cb166-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list with four elements. \item{x}{The provided X, converted to a</span></span>
<span id="cb166-19"><a href="#cb166-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; matrix if it was provided as a data.frame, and with column names removed.}</span></span>
<span id="cb166-20"><a href="#cb166-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{clusters}{A named list where each entry is an integer vector of indices</span></span>
<span id="cb166-21"><a href="#cb166-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of features that are in a common cluster. (The length of list clusters is</span></span>
<span id="cb166-22"><a href="#cb166-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; equal to the number of clusters.) All identified clusters are</span></span>
<span id="cb166-23"><a href="#cb166-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; non-overlapping. All features appear in exactly one cluster (any unclustered</span></span>
<span id="cb166-24"><a href="#cb166-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features will be put in their own &quot;cluster&quot; of size 1).}</span></span>
<span id="cb166-25"><a href="#cb166-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{prototypes}{An integer vector whose length is equal to the number of</span></span>
<span id="cb166-26"><a href="#cb166-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; clusters. Entry i is the index of the feature belonging to cluster i that is</span></span>
<span id="cb166-27"><a href="#cb166-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; most highly correlated with y (that is, the prototype for the cluster, as in</span></span>
<span id="cb166-28"><a href="#cb166-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the protolasso; see Reid and Tibshirani 2016).} \item{var_names}{If the</span></span>
<span id="cb166-29"><a href="#cb166-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; provided X matrix had column names, the names of the featurrs in the provided</span></span>
<span id="cb166-30"><a href="#cb166-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; X matrix. If no names were provided, feat_names will be NA.}</span></span>
<span id="cb166-31"><a href="#cb166-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb166-32"><a href="#cb166-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references Reid, S., &amp; Tibshirani, R. (2016). Sparse regression and marginal</span></span>
<span id="cb166-33"><a href="#cb166-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; testing using cluster prototypes. \emph{Biostatistics}, 17(2), 364–376.</span></span>
<span id="cb166-34"><a href="#cb166-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://doi.org/10.1093/biostatistics/kxv049}.</span></span>
<span id="cb166-35"><a href="#cb166-35" aria-hidden="true" tabindex="-1"></a>processClusterLassoInputs <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, clusters, nlambda){</span>
<span id="cb166-36"><a href="#cb166-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-37"><a href="#cb166-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X) <span class="sc">|</span> <span class="fu">is.data.frame</span>(X))</span>
<span id="cb166-38"><a href="#cb166-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-39"><a href="#cb166-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if x is a matrix; if it&#39;s a data.frame, convert to matrix.</span></span>
<span id="cb166-40"><a href="#cb166-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.data.frame</span>(X)){</span>
<span id="cb166-41"><a href="#cb166-41" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X)</span>
<span id="cb166-42"><a href="#cb166-42" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> X[, <span class="fu">colnames</span>(X) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb166-43"><a href="#cb166-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb166-44"><a href="#cb166-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-45"><a href="#cb166-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X))</span>
<span id="cb166-46"><a href="#cb166-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(X)))</span>
<span id="cb166-47"><a href="#cb166-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-48"><a href="#cb166-48" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)</span>
<span id="cb166-49"><a href="#cb166-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">colnames</span>(X))){</span>
<span id="cb166-50"><a href="#cb166-50" aria-hidden="true" tabindex="-1"></a>        feat_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X)</span>
<span id="cb166-51"><a href="#cb166-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(feat_names))){</span>
<span id="cb166-52"><a href="#cb166-52" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stop</span>(<span class="st">&quot;Some features in provided X matrix had valid names and some had NA names; please neither name all features in X or remove the names altogether.&quot;</span>)</span>
<span id="cb166-53"><a href="#cb166-53" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb166-54"><a href="#cb166-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb166-55"><a href="#cb166-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-56"><a href="#cb166-56" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb166-57"><a href="#cb166-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-58"><a href="#cb166-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb166-59"><a href="#cb166-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-60"><a href="#cb166-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(y) <span class="sc">|</span> <span class="fu">is.integer</span>(y))</span>
<span id="cb166-61"><a href="#cb166-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(n <span class="sc">==</span> <span class="fu">length</span>(y))</span>
<span id="cb166-62"><a href="#cb166-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(y)))</span>
<span id="cb166-63"><a href="#cb166-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-64"><a href="#cb166-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check clusters argument</span></span>
<span id="cb166-65"><a href="#cb166-65" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> <span class="fu">checkCssClustersInput</span>(clusters)</span>
<span id="cb166-66"><a href="#cb166-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-67"><a href="#cb166-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format clusters into a list where all features are in exactly one</span></span>
<span id="cb166-68"><a href="#cb166-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cluster (any unclustered features are put in their own &quot;cluster&quot; of size</span></span>
<span id="cb166-69"><a href="#cb166-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1).</span></span>
<span id="cb166-70"><a href="#cb166-70" aria-hidden="true" tabindex="-1"></a>    clust_names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)</span>
<span id="cb166-71"><a href="#cb166-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(clusters)) <span class="sc">&amp;</span> <span class="fu">is.list</span>(clusters)){</span>
<span id="cb166-72"><a href="#cb166-72" aria-hidden="true" tabindex="-1"></a>        clust_names <span class="ot">&lt;-</span> <span class="fu">names</span>(clusters)</span>
<span id="cb166-73"><a href="#cb166-73" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb166-74"><a href="#cb166-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-75"><a href="#cb166-75" aria-hidden="true" tabindex="-1"></a>    cluster_results <span class="ot">&lt;-</span> <span class="fu">formatClusters</span>(clusters, <span class="at">p=</span><span class="fu">ncol</span>(X),</span>
<span id="cb166-76"><a href="#cb166-76" aria-hidden="true" tabindex="-1"></a>        <span class="at">clust_names=</span>clust_names, <span class="at">get_prototypes=</span><span class="cn">TRUE</span>, <span class="at">x=</span>X, <span class="at">y=</span>y)</span>
<span id="cb166-77"><a href="#cb166-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-78"><a href="#cb166-78" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> cluster_results<span class="sc">$</span>clusters</span>
<span id="cb166-79"><a href="#cb166-79" aria-hidden="true" tabindex="-1"></a>    prototypes <span class="ot">&lt;-</span> cluster_results<span class="sc">$</span>prototypes</span>
<span id="cb166-80"><a href="#cb166-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-81"><a href="#cb166-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(cluster_results)</span>
<span id="cb166-82"><a href="#cb166-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-83"><a href="#cb166-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(clusters) <span class="sc">==</span> <span class="fu">length</span>(prototypes))</span>
<span id="cb166-84"><a href="#cb166-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-85"><a href="#cb166-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(nlambda) <span class="sc">|</span> <span class="fu">is.integer</span>(nlambda))</span>
<span id="cb166-86"><a href="#cb166-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(nlambda) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb166-87"><a href="#cb166-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(nlambda))</span>
<span id="cb166-88"><a href="#cb166-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(nlambda <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb166-89"><a href="#cb166-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(nlambda <span class="sc">==</span> <span class="fu">round</span>(nlambda))</span>
<span id="cb166-90"><a href="#cb166-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-91"><a href="#cb166-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">x=</span>X, <span class="at">clusters=</span>clusters, <span class="at">prototypes=</span>prototypes,</span>
<span id="cb166-92"><a href="#cb166-92" aria-hidden="true" tabindex="-1"></a>        <span class="at">var_names=</span>feat_names))</span>
<span id="cb166-93"><a href="#cb166-93" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>processClusterLassoInputs()</code>:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;processClusterLassoInputs works&quot;</span>, {</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">82612</span>)</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span><span class="sc">*</span><span class="dv">11</span>), <span class="at">nrow=</span><span class="dv">15</span>, <span class="at">ncol=</span><span class="dv">11</span>)</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span>)</span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>4L, <span class="at">green_cluster=</span>5L<span class="sc">:</span>8L)</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters, <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret))</span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(ret), <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;clusters&quot;</span>, <span class="st">&quot;prototypes&quot;</span>,</span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;var_names&quot;</span>))</span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X</span></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret<span class="sc">$</span>x))</span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(ret<span class="sc">$</span>x)))</span>
<span id="cb167-18"><a href="#cb167-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>x))</span>
<span id="cb167-19"><a href="#cb167-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret<span class="sc">$</span>x), <span class="dv">11</span>)</span>
<span id="cb167-20"><a href="#cb167-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret<span class="sc">$</span>x), <span class="dv">15</span>)</span>
<span id="cb167-21"><a href="#cb167-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret<span class="sc">$</span>x <span class="sc">-</span> x) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb167-22"><a href="#cb167-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-23"><a href="#cb167-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># clusters</span></span>
<span id="cb167-24"><a href="#cb167-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret<span class="sc">$</span>clusters))</span>
<span id="cb167-25"><a href="#cb167-25" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>clusters), <span class="dv">5</span>)</span>
<span id="cb167-26"><a href="#cb167-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">5</span>, <span class="fu">length</span>(<span class="fu">names</span>(ret<span class="sc">$</span>clusters)))</span>
<span id="cb167-27"><a href="#cb167-27" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">5</span>, <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">names</span>(ret<span class="sc">$</span>clusters))))</span>
<span id="cb167-28"><a href="#cb167-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="st">&quot;red_cluster&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(ret<span class="sc">$</span>clusters))</span>
<span id="cb167-29"><a href="#cb167-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="st">&quot;green_cluster&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(ret<span class="sc">$</span>clusters))</span>
<span id="cb167-30"><a href="#cb167-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">names</span>(ret<span class="sc">$</span>clusters))))</span>
<span id="cb167-31"><a href="#cb167-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(ret<span class="sc">$</span>clusters))))</span>
<span id="cb167-32"><a href="#cb167-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">names</span>(ret<span class="sc">$</span>clusters) <span class="sc">!=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb167-33"><a href="#cb167-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-34"><a href="#cb167-34" aria-hidden="true" tabindex="-1"></a>  clust_feats <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb167-35"><a href="#cb167-35" aria-hidden="true" tabindex="-1"></a>  true_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>)</span>
<span id="cb167-36"><a href="#cb167-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ret<span class="sc">$</span>clusters)){</span>
<span id="cb167-37"><a href="#cb167-37" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>clusters[[i]]))</span>
<span id="cb167-38"><a href="#cb167-38" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(<span class="fu">intersect</span>(clust_feats, ret<span class="sc">$</span>clusters[[i]])), <span class="dv">0</span>)</span>
<span id="cb167-39"><a href="#cb167-39" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret<span class="sc">$</span>clusters[[i]] <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb167-40"><a href="#cb167-40" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>clusters[[i]]),</span>
<span id="cb167-41"><a href="#cb167-41" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">length</span>(<span class="fu">unique</span>(ret<span class="sc">$</span>clusters[[i]])))</span>
<span id="cb167-42"><a href="#cb167-42" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret<span class="sc">$</span>clusters[[i]] <span class="sc">==</span> true_list[[i]]))</span>
<span id="cb167-43"><a href="#cb167-43" aria-hidden="true" tabindex="-1"></a>    clust_feats <span class="ot">&lt;-</span> <span class="fu">c</span>(clust_feats, ret<span class="sc">$</span>clusters[[i]])</span>
<span id="cb167-44"><a href="#cb167-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb167-45"><a href="#cb167-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-46"><a href="#cb167-46" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(clust_feats), <span class="dv">11</span>)</span>
<span id="cb167-47"><a href="#cb167-47" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">11</span>, <span class="fu">length</span>(<span class="fu">unique</span>(clust_feats)))</span>
<span id="cb167-48"><a href="#cb167-48" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="dv">11</span>, <span class="fu">length</span>(<span class="fu">intersect</span>(clust_feats, <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>)))</span>
<span id="cb167-49"><a href="#cb167-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-50"><a href="#cb167-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prototypes</span></span>
<span id="cb167-51"><a href="#cb167-51" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(ret<span class="sc">$</span>prototypes))</span>
<span id="cb167-52"><a href="#cb167-52" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(ret<span class="sc">$</span>prototypes <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb167-53"><a href="#cb167-53" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>prototypes), <span class="dv">5</span>)</span>
<span id="cb167-54"><a href="#cb167-54" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret<span class="sc">$</span>prototypes[<span class="dv">1</span>] <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb167-55"><a href="#cb167-55" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(ret<span class="sc">$</span>prototypes[<span class="dv">2</span>] <span class="sc">%in%</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb167-56"><a href="#cb167-56" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret<span class="sc">$</span>prototypes[<span class="dv">3</span>], <span class="dv">9</span>)</span>
<span id="cb167-57"><a href="#cb167-57" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret<span class="sc">$</span>prototypes[<span class="dv">4</span>], <span class="dv">10</span>)</span>
<span id="cb167-58"><a href="#cb167-58" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(ret<span class="sc">$</span>prototypes[<span class="dv">5</span>], <span class="dv">11</span>)</span>
<span id="cb167-59"><a href="#cb167-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-60"><a href="#cb167-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># var_names</span></span>
<span id="cb167-61"><a href="#cb167-61" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>var_names), <span class="dv">1</span>)</span>
<span id="cb167-62"><a href="#cb167-62" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.na</span>(ret<span class="sc">$</span>var_names))</span>
<span id="cb167-63"><a href="#cb167-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-64"><a href="#cb167-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a data.frame</span></span>
<span id="cb167-65"><a href="#cb167-65" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb167-66"><a href="#cb167-66" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>X_df, <span class="at">y=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)),</span>
<span id="cb167-67"><a href="#cb167-67" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb167-68"><a href="#cb167-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-69"><a href="#cb167-69" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb167-70"><a href="#cb167-70" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;clusters&quot;</span>, <span class="st">&quot;prototypes&quot;</span>,</span>
<span id="cb167-71"><a href="#cb167-71" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;var_names&quot;</span>))</span>
<span id="cb167-72"><a href="#cb167-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-73"><a href="#cb167-73" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X_df)</span>
<span id="cb167-74"><a href="#cb167-74" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb167-75"><a href="#cb167-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-76"><a href="#cb167-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X</span></span>
<span id="cb167-77"><a href="#cb167-77" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>x))</span>
<span id="cb167-78"><a href="#cb167-78" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>x)))</span>
<span id="cb167-79"><a href="#cb167-79" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>x))</span>
<span id="cb167-80"><a href="#cb167-80" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>x), <span class="fu">ncol</span>(X_df_model))</span>
<span id="cb167-81"><a href="#cb167-81" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>x), <span class="fu">nrow</span>(X_df))</span>
<span id="cb167-82"><a href="#cb167-82" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res<span class="sc">$</span>x <span class="sc">-</span> X_df_model) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb167-83"><a href="#cb167-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-84"><a href="#cb167-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># var_names</span></span>
<span id="cb167-85"><a href="#cb167-85" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>var_names), <span class="fu">ncol</span>(X_df_model))</span>
<span id="cb167-86"><a href="#cb167-86" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res<span class="sc">$</span>var_names))</span>
<span id="cb167-87"><a href="#cb167-87" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res<span class="sc">$</span>var_names, <span class="fu">colnames</span>(X_df_model))</span>
<span id="cb167-88"><a href="#cb167-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-89"><a href="#cb167-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-90"><a href="#cb167-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a dataframe with factors (number of columns of final design matrix</span></span>
<span id="cb167-91"><a href="#cb167-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after one-hot encoding factors won&#39;t match number of columns of df2)</span></span>
<span id="cb167-92"><a href="#cb167-92" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> X_df</span>
<span id="cb167-93"><a href="#cb167-93" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>cyl)</span>
<span id="cb167-94"><a href="#cb167-94" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>vs)</span>
<span id="cb167-95"><a href="#cb167-95" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>am)</span>
<span id="cb167-96"><a href="#cb167-96" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>gear)</span>
<span id="cb167-97"><a href="#cb167-97" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>carb)</span>
<span id="cb167-98"><a href="#cb167-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-99"><a href="#cb167-99" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>df2, <span class="at">y=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(df2)),</span>
<span id="cb167-100"><a href="#cb167-100" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb167-101"><a href="#cb167-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-102"><a href="#cb167-102" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb167-103"><a href="#cb167-103" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;clusters&quot;</span>, <span class="st">&quot;prototypes&quot;</span>,</span>
<span id="cb167-104"><a href="#cb167-104" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;var_names&quot;</span>))</span>
<span id="cb167-105"><a href="#cb167-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-106"><a href="#cb167-106" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., df2)</span>
<span id="cb167-107"><a href="#cb167-107" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb167-108"><a href="#cb167-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-109"><a href="#cb167-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X</span></span>
<span id="cb167-110"><a href="#cb167-110" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res<span class="sc">$</span>x))</span>
<span id="cb167-111"><a href="#cb167-111" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>x)))</span>
<span id="cb167-112"><a href="#cb167-112" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res<span class="sc">$</span>x))</span>
<span id="cb167-113"><a href="#cb167-113" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(res<span class="sc">$</span>x), <span class="fu">ncol</span>(X_df_model))</span>
<span id="cb167-114"><a href="#cb167-114" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(res<span class="sc">$</span>x), <span class="fu">nrow</span>(X_df))</span>
<span id="cb167-115"><a href="#cb167-115" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res<span class="sc">$</span>x <span class="sc">-</span> X_df_model) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb167-116"><a href="#cb167-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-117"><a href="#cb167-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># var_names</span></span>
<span id="cb167-118"><a href="#cb167-118" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>var_names), <span class="fu">ncol</span>(X_df_model))</span>
<span id="cb167-119"><a href="#cb167-119" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(res<span class="sc">$</span>var_names))</span>
<span id="cb167-120"><a href="#cb167-120" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(res<span class="sc">$</span>var_names, <span class="fu">colnames</span>(X_df_model))</span>
<span id="cb167-121"><a href="#cb167-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-122"><a href="#cb167-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a matrix with column names</span></span>
<span id="cb167-123"><a href="#cb167-123" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> x</span>
<span id="cb167-124"><a href="#cb167-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x2) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb167-125"><a href="#cb167-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-126"><a href="#cb167-126" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x2, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters, <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb167-127"><a href="#cb167-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-128"><a href="#cb167-128" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(ret))</span>
<span id="cb167-129"><a href="#cb167-129" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(ret), <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;clusters&quot;</span>, <span class="st">&quot;prototypes&quot;</span>,</span>
<span id="cb167-130"><a href="#cb167-130" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;var_names&quot;</span>))</span>
<span id="cb167-131"><a href="#cb167-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-132"><a href="#cb167-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X</span></span>
<span id="cb167-133"><a href="#cb167-133" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret<span class="sc">$</span>x))</span>
<span id="cb167-134"><a href="#cb167-134" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(ret<span class="sc">$</span>x)))</span>
<span id="cb167-135"><a href="#cb167-135" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret<span class="sc">$</span>x))</span>
<span id="cb167-136"><a href="#cb167-136" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">ncol</span>(ret<span class="sc">$</span>x), <span class="dv">11</span>)</span>
<span id="cb167-137"><a href="#cb167-137" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">nrow</span>(ret<span class="sc">$</span>x), <span class="dv">15</span>)</span>
<span id="cb167-138"><a href="#cb167-138" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret<span class="sc">$</span>x <span class="sc">-</span> x) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb167-139"><a href="#cb167-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-140"><a href="#cb167-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># var_names</span></span>
<span id="cb167-141"><a href="#cb167-141" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(ret<span class="sc">$</span>var_names), <span class="fu">ncol</span>(x2))</span>
<span id="cb167-142"><a href="#cb167-142" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.character</span>(ret<span class="sc">$</span>var_names))</span>
<span id="cb167-143"><a href="#cb167-143" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(ret<span class="sc">$</span>var_names, LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>])</span>
<span id="cb167-144"><a href="#cb167-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-145"><a href="#cb167-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad inputs</span></span>
<span id="cb167-146"><a href="#cb167-146" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span><span class="st">&quot;x&quot;</span>, <span class="at">y=</span>y[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb167-147"><a href="#cb167-147" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">clusters=</span>good_clusters,</span>
<span id="cb167-148"><a href="#cb167-148" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nlambda=</span><span class="dv">10</span>),</span>
<span id="cb167-149"><a href="#cb167-149" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.matrix(X) | is.data.frame(X) is not TRUE&quot;</span>,</span>
<span id="cb167-150"><a href="#cb167-150" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb167-151"><a href="#cb167-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-152"><a href="#cb167-152" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb167-153"><a href="#cb167-153" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">clusters=</span>good_clusters,</span>
<span id="cb167-154"><a href="#cb167-154" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nlambda=</span><span class="dv">10</span>),</span>
<span id="cb167-155"><a href="#cb167-155" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;n == length(y) is not TRUE&quot;</span>,</span>
<span id="cb167-156"><a href="#cb167-156" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb167-157"><a href="#cb167-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-158"><a href="#cb167-158" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb167-159"><a href="#cb167-159" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>),</span>
<span id="cb167-160"><a href="#cb167-160" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nlambda=</span><span class="dv">10</span>),</span>
<span id="cb167-161"><a href="#cb167-161" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Overlapping clusters detected; clusters must be non-overlapping. Overlapping clusters: 1, 2.&quot;</span>,</span>
<span id="cb167-162"><a href="#cb167-162" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb167-163"><a href="#cb167-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-164"><a href="#cb167-164" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb167-165"><a href="#cb167-165" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>),</span>
<span id="cb167-166"><a href="#cb167-166" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nlambda=</span><span class="dv">10</span>),</span>
<span id="cb167-167"><a href="#cb167-167" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(clusters) == length(unique(clusters)) is not TRUE&quot;</span>,</span>
<span id="cb167-168"><a href="#cb167-168" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb167-169"><a href="#cb167-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-170"><a href="#cb167-170" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb167-171"><a href="#cb167-171" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb167-172"><a href="#cb167-172" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="fu">as.integer</span>(<span class="cn">NA</span>)),</span>
<span id="cb167-173"><a href="#cb167-173" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nlambda=</span><span class="dv">10</span>),</span>
<span id="cb167-174"><a href="#cb167-174" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.na(clusters) are not all TRUE&quot;</span>,</span>
<span id="cb167-175"><a href="#cb167-175" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb167-176"><a href="#cb167-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-177"><a href="#cb167-177" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb167-178"><a href="#cb167-178" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">clusters=</span><span class="fu">list</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb167-179"><a href="#cb167-179" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">5</span>)),</span>
<span id="cb167-180"><a href="#cb167-180" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nlambda=</span><span class="dv">10</span>),</span>
<span id="cb167-181"><a href="#cb167-181" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(clusters[[i]]) == length(unique(clusters[[i]])) is not TRUE&quot;</span>,</span>
<span id="cb167-182"><a href="#cb167-182" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb167-183"><a href="#cb167-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-184"><a href="#cb167-184" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb167-185"><a href="#cb167-185" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">clusters=</span>good_clusters,</span>
<span id="cb167-186"><a href="#cb167-186" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nlambda=</span><span class="dv">1</span>),</span>
<span id="cb167-187"><a href="#cb167-187" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;nlambda &gt;= 2 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb167-188"><a href="#cb167-188" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-189"><a href="#cb167-189" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb167-190"><a href="#cb167-190" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">clusters=</span>good_clusters,</span>
<span id="cb167-191"><a href="#cb167-191" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nlambda=</span>x),</span>
<span id="cb167-192"><a href="#cb167-192" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(nlambda) == 1 is not TRUE&quot;</span>, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb167-193"><a href="#cb167-193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-194"><a href="#cb167-194" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb167-195"><a href="#cb167-195" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">clusters=</span>good_clusters,</span>
<span id="cb167-196"><a href="#cb167-196" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nlambda=</span><span class="st">&quot;nlambda&quot;</span>),</span>
<span id="cb167-197"><a href="#cb167-197" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.numeric(nlambda) | is.integer(nlambda) is not TRUE&quot;</span>,</span>
<span id="cb167-198"><a href="#cb167-198" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb167-199"><a href="#cb167-199" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-200"><a href="#cb167-200" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y,</span>
<span id="cb167-201"><a href="#cb167-201" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">clusters=</span>good_clusters,</span>
<span id="cb167-202"><a href="#cb167-202" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nlambda=</span><span class="fl">10.5</span>),</span>
<span id="cb167-203"><a href="#cb167-203" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;nlambda == round(nlambda) is not TRUE&quot;</span>,</span>
<span id="cb167-204"><a href="#cb167-204" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb167-205"><a href="#cb167-205" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-206"><a href="#cb167-206" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p><code>getXglmnet()</code>:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Converts the provided design matrix to an appropriate format for either the</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; protolasso or the cluster representative lasso.</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Creates design matrix for glmnet by dealing with clusters (for</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; type=&quot;protolasso&quot;, discards all cluster members except prototype; for</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; type=&quot;clusterRepLasso&quot;, replaces all cluster members with a simple</span></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; average of all the cluster members).</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x A numeric matrix; the provided matrix with n observations and p</span></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features.</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A named list where each entry is an integer vector of indices</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of features that are in a common cluster. (The length of list clusters should</span></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be equal to the number of clusters.) All identified clusters should be</span></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; non-overlapping. All features should appear in exactly one cluster (any</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; unclustered features should be put in their own &quot;cluster&quot; of size 1).</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param type Character; &quot;protolasso&quot; for the protolasso or &quot;clusterRepLasso&quot;</span></span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for the cluster representative lasso.</span></span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prototypes Only required for type &quot;protolasso&quot;. An integer vector</span></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; whose length is equal to the number of clusters. Entry i should be the</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; prototype for cluster i (the feature belonging to cluster i that is most</span></span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; highly correlated with y; see Reid and Tibshirani 2016).</span></span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A numeric matrix; the design matrix as required for the protolasso or</span></span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster representative lasso, prepared for input to glmnet.</span></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references Reid, S., &amp; Tibshirani, R. (2016). Sparse regression and marginal</span></span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; testing using cluster prototypes. \emph{Biostatistics}, 17(2), 364–376.</span></span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://doi.org/10.1093/biostatistics/kxv049}.</span></span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a>getXglmnet <span class="ot">&lt;-</span> <span class="cf">function</span>(x, clusters, type, <span class="at">prototypes=</span><span class="cn">NA</span>){</span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check inputs</span></span>
<span id="cb169-30"><a href="#cb169-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">checkGetXglmnetInputs</span>(x, clusters, type, prototypes)</span>
<span id="cb169-31"><a href="#cb169-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-32"><a href="#cb169-32" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb169-33"><a href="#cb169-33" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(x)</span>
<span id="cb169-34"><a href="#cb169-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-35"><a href="#cb169-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(clusters)){</span>
<span id="cb169-36"><a href="#cb169-36" aria-hidden="true" tabindex="-1"></a>        cluster_i <span class="ot">&lt;-</span> clusters[[i]]</span>
<span id="cb169-37"><a href="#cb169-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-38"><a href="#cb169-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(cluster_i) <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb169-39"><a href="#cb169-39" aria-hidden="true" tabindex="-1"></a>            X_glmnet_i <span class="ot">&lt;-</span> x[, cluster_i]</span>
<span id="cb169-40"><a href="#cb169-40" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span>{</span>
<span id="cb169-41"><a href="#cb169-41" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">length</span>(cluster_i) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb169-42"><a href="#cb169-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb169-43"><a href="#cb169-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">&quot;protolasso&quot;</span>){</span>
<span id="cb169-44"><a href="#cb169-44" aria-hidden="true" tabindex="-1"></a>                prototype_ind_i <span class="ot">&lt;-</span> <span class="fu">which</span>(prototypes <span class="sc">%in%</span> cluster_i)</span>
<span id="cb169-45"><a href="#cb169-45" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(<span class="fu">length</span>(prototype_ind_i) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb169-46"><a href="#cb169-46" aria-hidden="true" tabindex="-1"></a>                prototype_i <span class="ot">&lt;-</span> prototypes[prototype_ind_i]</span>
<span id="cb169-47"><a href="#cb169-47" aria-hidden="true" tabindex="-1"></a>                X_glmnet_i <span class="ot">&lt;-</span> x[, prototype_i]</span>
<span id="cb169-48"><a href="#cb169-48" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb169-49"><a href="#cb169-49" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stopifnot</span>(type <span class="sc">==</span> <span class="st">&quot;clusterRepLasso&quot;</span>)</span>
<span id="cb169-50"><a href="#cb169-50" aria-hidden="true" tabindex="-1"></a>                X_glmnet_i <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(x[, cluster_i])</span>
<span id="cb169-51"><a href="#cb169-51" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb169-52"><a href="#cb169-52" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb169-53"><a href="#cb169-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb169-54"><a href="#cb169-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(X_glmnet_i) <span class="sc">==</span> n)</span>
<span id="cb169-55"><a href="#cb169-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb169-56"><a href="#cb169-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb169-57"><a href="#cb169-57" aria-hidden="true" tabindex="-1"></a>            X_glmnet <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X_glmnet_i)</span>
<span id="cb169-58"><a href="#cb169-58" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span>{</span>
<span id="cb169-59"><a href="#cb169-59" aria-hidden="true" tabindex="-1"></a>            X_glmnet <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X_glmnet, X_glmnet_i)</span>
<span id="cb169-60"><a href="#cb169-60" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb169-61"><a href="#cb169-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb169-62"><a href="#cb169-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-63"><a href="#cb169-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(X_glmnet) <span class="sc">==</span> <span class="fu">length</span>(clusters))</span>
<span id="cb169-64"><a href="#cb169-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(X_glmnet) <span class="sc">==</span> <span class="fu">length</span>(clusters))</span>
<span id="cb169-65"><a href="#cb169-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(X_glmnet) <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb169-66"><a href="#cb169-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-67"><a href="#cb169-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check output</span></span>
<span id="cb169-68"><a href="#cb169-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(X_glmnet))</span>
<span id="cb169-69"><a href="#cb169-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(X_glmnet) <span class="sc">==</span> n)</span>
<span id="cb169-70"><a href="#cb169-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(X_glmnet) <span class="sc">&lt;=</span> p)</span>
<span id="cb169-71"><a href="#cb169-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">ncol</span>(X_glmnet) <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb169-72"><a href="#cb169-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-73"><a href="#cb169-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(X_glmnet)</span>
<span id="cb169-74"><a href="#cb169-74" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>checkGetXglmnetInputs()</code>:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Verifies the inputs for getXglmnet.</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x A numeric matrix; the provided matrix with n observations and p</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features.</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A named list where each entry is an integer vector of indices</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of features that are in a common cluster. (The length of list clusters should</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be equal to the number of clusters.) All identified clusters should be</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; non-overlapping. All features should appear in exactly one cluster (any</span></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; unclustered features should be put in their own &quot;cluster&quot; of size 1).</span></span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param type Character; &quot;protolasso&quot; for the protolasso or &quot;clusterRepLasso&quot;</span></span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for the cluster representative lasso.</span></span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prototypes Only required for type &quot;protolasso&quot;. An integer vector</span></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; whose length is equal to the number of clusters. Entry i should be the</span></span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; prototype for cluster i (the feature belonging to cluster i that is most</span></span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; highly correlated with y; see Reid and Tibshirani 2016).</span></span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references Reid, S., &amp; Tibshirani, R. (2016). Sparse regression and marginal</span></span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; testing using cluster prototypes. \emph{Biostatistics}, 17(2), 364–376.</span></span>
<span id="cb170-19"><a href="#cb170-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://doi.org/10.1093/biostatistics/kxv049}.</span></span>
<span id="cb170-20"><a href="#cb170-20" aria-hidden="true" tabindex="-1"></a>checkGetXglmnetInputs <span class="ot">&lt;-</span> <span class="cf">function</span>(x, clusters, type, prototypes){</span>
<span id="cb170-21"><a href="#cb170-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.matrix</span>(x))</span>
<span id="cb170-22"><a href="#cb170-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-23"><a href="#cb170-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.list</span>(clusters))</span>
<span id="cb170-24"><a href="#cb170-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">lengths</span>(clusters) <span class="sc">&gt;=</span> <span class="dv">1</span>))</span>
<span id="cb170-25"><a href="#cb170-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-26"><a href="#cb170-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(type) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb170-27"><a href="#cb170-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(type))</span>
<span id="cb170-28"><a href="#cb170-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(type))</span>
<span id="cb170-29"><a href="#cb170-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;protolasso&quot;</span>, <span class="st">&quot;clusterRepLasso&quot;</span>))</span>
<span id="cb170-30"><a href="#cb170-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-31"><a href="#cb170-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(type<span class="sc">==</span><span class="st">&quot;protolasso&quot;</span>){</span>
<span id="cb170-32"><a href="#cb170-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(prototypes))</span>
<span id="cb170-33"><a href="#cb170-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(prototypes))</span>
<span id="cb170-34"><a href="#cb170-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(prototypes)))</span>
<span id="cb170-35"><a href="#cb170-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">length</span>(prototypes) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(prototypes)))</span>
<span id="cb170-36"><a href="#cb170-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(prototypes <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(x)))</span>
<span id="cb170-37"><a href="#cb170-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb170-38"><a href="#cb170-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(clusters)){</span>
<span id="cb170-39"><a href="#cb170-39" aria-hidden="true" tabindex="-1"></a>        cluster_i <span class="ot">&lt;-</span> clusters[[i]]</span>
<span id="cb170-40"><a href="#cb170-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(cluster_i) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb170-41"><a href="#cb170-41" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">sum</span>(prototypes <span class="sc">%in%</span> cluster_i) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb170-42"><a href="#cb170-42" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb170-43"><a href="#cb170-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb170-44"><a href="#cb170-44" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>checkGetXglmnetInputs()</code>:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;checkGetXglmnetInputs works&quot;</span>, {</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">82612</span>)</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span><span class="sc">*</span><span class="dv">11</span>), <span class="at">nrow=</span><span class="dv">15</span>, <span class="at">ncol=</span><span class="dv">11</span>)</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span>)</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>4L, <span class="at">green_cluster=</span>5L<span class="sc">:</span>8L)</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkGetXglmnetInputs</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkGetXglmnetInputs</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>,</span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a>                        <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a data.frame</span></span>
<span id="cb171-20"><a href="#cb171-20" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb171-21"><a href="#cb171-21" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>X_df, <span class="at">y=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)),</span>
<span id="cb171-22"><a href="#cb171-22" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb171-23"><a href="#cb171-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-24"><a href="#cb171-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkGetXglmnetInputs</span>(<span class="at">x=</span>res<span class="sc">$</span>x, <span class="at">clusters=</span>res<span class="sc">$</span>clusters, <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>,</span>
<span id="cb171-25"><a href="#cb171-25" aria-hidden="true" tabindex="-1"></a>                        <span class="at">prototypes=</span>res<span class="sc">$</span>prototypes)</span>
<span id="cb171-26"><a href="#cb171-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-27"><a href="#cb171-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a dataframe with factors (number of columns of final design matrix</span></span>
<span id="cb171-28"><a href="#cb171-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after one-hot encoding factors won&#39;t match number of columns of df2)</span></span>
<span id="cb171-29"><a href="#cb171-29" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> X_df</span>
<span id="cb171-30"><a href="#cb171-30" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>cyl)</span>
<span id="cb171-31"><a href="#cb171-31" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>vs)</span>
<span id="cb171-32"><a href="#cb171-32" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>am)</span>
<span id="cb171-33"><a href="#cb171-33" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>gear)</span>
<span id="cb171-34"><a href="#cb171-34" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>carb)</span>
<span id="cb171-35"><a href="#cb171-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-36"><a href="#cb171-36" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>df2, <span class="at">y=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(df2)),</span>
<span id="cb171-37"><a href="#cb171-37" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb171-38"><a href="#cb171-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-39"><a href="#cb171-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkGetXglmnetInputs</span>(<span class="at">x=</span>res<span class="sc">$</span>x, <span class="at">clusters=</span>res<span class="sc">$</span>clusters, <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>,</span>
<span id="cb171-40"><a href="#cb171-40" aria-hidden="true" tabindex="-1"></a>                        <span class="at">prototypes=</span>res<span class="sc">$</span>prototypes)</span>
<span id="cb171-41"><a href="#cb171-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-42"><a href="#cb171-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a matrix with column names</span></span>
<span id="cb171-43"><a href="#cb171-43" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> x</span>
<span id="cb171-44"><a href="#cb171-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x2) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb171-45"><a href="#cb171-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-46"><a href="#cb171-46" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x2, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters, <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb171-47"><a href="#cb171-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-48"><a href="#cb171-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkGetXglmnetInputs</span>(<span class="at">x=</span>ret<span class="sc">$</span>x, <span class="at">clusters=</span>ret<span class="sc">$</span>clusters, <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>,</span>
<span id="cb171-49"><a href="#cb171-49" aria-hidden="true" tabindex="-1"></a>                        <span class="at">prototypes=</span>ret<span class="sc">$</span>prototypes)</span>
<span id="cb171-50"><a href="#cb171-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-51"><a href="#cb171-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad prototype inputs</span></span>
<span id="cb171-52"><a href="#cb171-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Error has quotation marks</span></span>
<span id="cb171-53"><a href="#cb171-53" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetXglmnetInputs</span>(<span class="at">x=</span>process<span class="sc">$</span>x,</span>
<span id="cb171-54"><a href="#cb171-54" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb171-55"><a href="#cb171-55" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">type=</span><span class="st">&quot;clsterRepLasso&quot;</span>,</span>
<span id="cb171-56"><a href="#cb171-56" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes))</span>
<span id="cb171-57"><a href="#cb171-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-58"><a href="#cb171-58" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetXglmnetInputs</span>(<span class="at">x=</span>process<span class="sc">$</span>x,</span>
<span id="cb171-59"><a href="#cb171-59" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb171-60"><a href="#cb171-60" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">type=</span><span class="fu">c</span>(<span class="st">&quot;clusterRepLasso&quot;</span>,</span>
<span id="cb171-61"><a href="#cb171-61" aria-hidden="true" tabindex="-1"></a>                                                      <span class="st">&quot;protolasso&quot;</span>),</span>
<span id="cb171-62"><a href="#cb171-62" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes),</span>
<span id="cb171-63"><a href="#cb171-63" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(type) == 1 is not TRUE&quot;</span>,</span>
<span id="cb171-64"><a href="#cb171-64" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb171-65"><a href="#cb171-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-66"><a href="#cb171-66" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetXglmnetInputs</span>(<span class="at">x=</span>process<span class="sc">$</span>x,</span>
<span id="cb171-67"><a href="#cb171-67" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb171-68"><a href="#cb171-68" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">type=</span><span class="dv">2</span>,</span>
<span id="cb171-69"><a href="#cb171-69" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes),</span>
<span id="cb171-70"><a href="#cb171-70" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.character(type) is not TRUE&quot;</span>,</span>
<span id="cb171-71"><a href="#cb171-71" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb171-72"><a href="#cb171-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-73"><a href="#cb171-73" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">checkGetXglmnetInputs</span>(<span class="at">x=</span>process<span class="sc">$</span>x,</span>
<span id="cb171-74"><a href="#cb171-74" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb171-75"><a href="#cb171-75" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">type=</span><span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb171-76"><a href="#cb171-76" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes),</span>
<span id="cb171-77"><a href="#cb171-77" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.na(type) is not TRUE&quot;</span>,</span>
<span id="cb171-78"><a href="#cb171-78" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb171-79"><a href="#cb171-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-80"><a href="#cb171-80" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p>Tests for <code>getXglmnet()</code>:</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getXglmnet works&quot;</span>, {</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">82612</span>)</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span><span class="sc">*</span><span class="dv">11</span>), <span class="at">nrow=</span><span class="dv">15</span>, <span class="at">ncol=</span><span class="dv">11</span>)</span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span>)</span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>4L, <span class="at">green_cluster=</span>5L<span class="sc">:</span>8L)</span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(<span class="fu">colnames</span>(res)))</span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(res) <span class="sc">==</span> <span class="dv">15</span>)</span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each column of res should be one of the prototypes. Features 9 - 11 are</span></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in clusters by themselves and are therefore their own prototypes.</span></span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(res) <span class="sc">==</span> <span class="dv">5</span>)</span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(good_clusters)){</span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a>    proto_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a>    cluster_i <span class="ot">&lt;-</span> good_clusters[[i]]</span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cluster_i)){</span>
<span id="cb173-26"><a href="#cb173-26" aria-hidden="true" tabindex="-1"></a>      proto_i_found <span class="ot">&lt;-</span> proto_i_found <span class="sc">|</span> <span class="fu">all</span>(<span class="fu">abs</span>(res[, i] <span class="sc">-</span> x[, cluster_i[j]]) <span class="sc">&lt;</span></span>
<span id="cb173-27"><a href="#cb173-27" aria-hidden="true" tabindex="-1"></a>                                             <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>))</span>
<span id="cb173-28"><a href="#cb173-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb173-29"><a href="#cb173-29" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(proto_i_found)</span>
<span id="cb173-30"><a href="#cb173-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-31"><a href="#cb173-31" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">3</span>] <span class="sc">-</span> x[, <span class="dv">9</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-32"><a href="#cb173-32" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">4</span>] <span class="sc">-</span> x[, <span class="dv">10</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-33"><a href="#cb173-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">5</span>] <span class="sc">-</span> x[, <span class="dv">11</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-34"><a href="#cb173-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-35"><a href="#cb173-35" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb173-36"><a href="#cb173-36" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb173-37"><a href="#cb173-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-38"><a href="#cb173-38" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb173-39"><a href="#cb173-39" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb173-40"><a href="#cb173-40" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(<span class="fu">colnames</span>(res)))</span>
<span id="cb173-41"><a href="#cb173-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(res) <span class="sc">==</span> <span class="dv">15</span>)</span>
<span id="cb173-42"><a href="#cb173-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each column of res should be one of the cluster representatives. Features 9</span></span>
<span id="cb173-43"><a href="#cb173-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - 11 are in clusters by themselves and are therefore their own cluster</span></span>
<span id="cb173-44"><a href="#cb173-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># representatives.</span></span>
<span id="cb173-45"><a href="#cb173-45" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(res) <span class="sc">==</span> <span class="dv">5</span>)</span>
<span id="cb173-46"><a href="#cb173-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(good_clusters)){</span>
<span id="cb173-47"><a href="#cb173-47" aria-hidden="true" tabindex="-1"></a>    cluster_i <span class="ot">&lt;-</span> good_clusters[[i]]</span>
<span id="cb173-48"><a href="#cb173-48" aria-hidden="true" tabindex="-1"></a>    clus_rep_i <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(x[, cluster_i])</span>
<span id="cb173-49"><a href="#cb173-49" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, i] <span class="sc">-</span> clus_rep_i) <span class="sc">&lt;</span></span>
<span id="cb173-50"><a href="#cb173-50" aria-hidden="true" tabindex="-1"></a>                                             <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-51"><a href="#cb173-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-52"><a href="#cb173-52" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">3</span>] <span class="sc">-</span> x[, <span class="dv">9</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-53"><a href="#cb173-53" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">4</span>] <span class="sc">-</span> x[, <span class="dv">10</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-54"><a href="#cb173-54" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">5</span>] <span class="sc">-</span> x[, <span class="dv">11</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-55"><a href="#cb173-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-56"><a href="#cb173-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a data.frame</span></span>
<span id="cb173-57"><a href="#cb173-57" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb173-58"><a href="#cb173-58" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>X_df, <span class="at">y=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)),</span>
<span id="cb173-59"><a href="#cb173-59" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb173-60"><a href="#cb173-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-61"><a href="#cb173-61" aria-hidden="true" tabindex="-1"></a>  ret_df <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>res<span class="sc">$</span>x, <span class="at">clusters=</span>res<span class="sc">$</span>clusters, <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>,</span>
<span id="cb173-62"><a href="#cb173-62" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prototypes=</span>res<span class="sc">$</span>prototypes)</span>
<span id="cb173-63"><a href="#cb173-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-64"><a href="#cb173-64" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X_df)</span>
<span id="cb173-65"><a href="#cb173-65" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb173-66"><a href="#cb173-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-67"><a href="#cb173-67" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret_df))</span>
<span id="cb173-68"><a href="#cb173-68" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret_df))</span>
<span id="cb173-69"><a href="#cb173-69" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(<span class="fu">colnames</span>(ret_df)))</span>
<span id="cb173-70"><a href="#cb173-70" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(ret_df) <span class="sc">==</span> <span class="fu">nrow</span>(X_df))</span>
<span id="cb173-71"><a href="#cb173-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each column of ret_df should be one of the prototypes.</span></span>
<span id="cb173-72"><a href="#cb173-72" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(ret_df) <span class="sc">==</span> <span class="fu">ncol</span>(X_df_model) <span class="sc">-</span> <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb173-73"><a href="#cb173-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-74"><a href="#cb173-74" aria-hidden="true" tabindex="-1"></a>  proto_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb173-75"><a href="#cb173-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>){</span>
<span id="cb173-76"><a href="#cb173-76" aria-hidden="true" tabindex="-1"></a>    proto_found <span class="ot">&lt;-</span> proto_found <span class="sc">|</span> <span class="fu">all</span>(<span class="fu">abs</span>(ret_df[, <span class="dv">1</span>] <span class="sc">-</span> X_df_model[, j]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>))</span>
<span id="cb173-77"><a href="#cb173-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-78"><a href="#cb173-78" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(proto_found)</span>
<span id="cb173-79"><a href="#cb173-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-80"><a href="#cb173-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">4</span><span class="sc">:</span><span class="fu">ncol</span>(X_df_model)){</span>
<span id="cb173-81"><a href="#cb173-81" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret_df[, j <span class="sc">-</span> <span class="dv">2</span>] <span class="sc">-</span> X_df_model[, j]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-82"><a href="#cb173-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-83"><a href="#cb173-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-84"><a href="#cb173-84" aria-hidden="true" tabindex="-1"></a>  ret_df <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>res<span class="sc">$</span>x, <span class="at">clusters=</span>res<span class="sc">$</span>clusters, <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>,</span>
<span id="cb173-85"><a href="#cb173-85" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prototypes=</span>res<span class="sc">$</span>prototypes)</span>
<span id="cb173-86"><a href="#cb173-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-87"><a href="#cb173-87" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret_df))</span>
<span id="cb173-88"><a href="#cb173-88" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret_df))</span>
<span id="cb173-89"><a href="#cb173-89" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(<span class="fu">colnames</span>(ret_df)))</span>
<span id="cb173-90"><a href="#cb173-90" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(ret_df) <span class="sc">==</span> <span class="fu">nrow</span>(X_df))</span>
<span id="cb173-91"><a href="#cb173-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each column of ret_df should be one of the prototypes.</span></span>
<span id="cb173-92"><a href="#cb173-92" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(ret_df) <span class="sc">==</span> <span class="fu">ncol</span>(X_df_model) <span class="sc">-</span> <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb173-93"><a href="#cb173-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-94"><a href="#cb173-94" aria-hidden="true" tabindex="-1"></a>  proto_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb173-95"><a href="#cb173-95" aria-hidden="true" tabindex="-1"></a>  clus_rep <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(X_df_model[, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb173-96"><a href="#cb173-96" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret_df[, <span class="dv">1</span>] <span class="sc">-</span> clus_rep) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-97"><a href="#cb173-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-98"><a href="#cb173-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">4</span><span class="sc">:</span><span class="fu">ncol</span>(X_df_model)){</span>
<span id="cb173-99"><a href="#cb173-99" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret_df[, j <span class="sc">-</span> <span class="dv">2</span>] <span class="sc">-</span> X_df_model[, j]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-100"><a href="#cb173-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-101"><a href="#cb173-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-102"><a href="#cb173-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a dataframe with factors (number of columns of final design matrix</span></span>
<span id="cb173-103"><a href="#cb173-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after one-hot encoding factors won&#39;t match number of columns of df2)</span></span>
<span id="cb173-104"><a href="#cb173-104" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> X_df</span>
<span id="cb173-105"><a href="#cb173-105" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>cyl)</span>
<span id="cb173-106"><a href="#cb173-106" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>vs)</span>
<span id="cb173-107"><a href="#cb173-107" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>am)</span>
<span id="cb173-108"><a href="#cb173-108" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>gear)</span>
<span id="cb173-109"><a href="#cb173-109" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>carb)</span>
<span id="cb173-110"><a href="#cb173-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-111"><a href="#cb173-111" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>df2, <span class="at">y=</span>stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(df2)),</span>
<span id="cb173-112"><a href="#cb173-112" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb173-113"><a href="#cb173-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-114"><a href="#cb173-114" aria-hidden="true" tabindex="-1"></a>  ret_df <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>res<span class="sc">$</span>x, <span class="at">clusters=</span>res<span class="sc">$</span>clusters, <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>,</span>
<span id="cb173-115"><a href="#cb173-115" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prototypes=</span>res<span class="sc">$</span>prototypes)</span>
<span id="cb173-116"><a href="#cb173-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-117"><a href="#cb173-117" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., df2)</span>
<span id="cb173-118"><a href="#cb173-118" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb173-119"><a href="#cb173-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-120"><a href="#cb173-120" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret_df))</span>
<span id="cb173-121"><a href="#cb173-121" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret_df))</span>
<span id="cb173-122"><a href="#cb173-122" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(<span class="fu">colnames</span>(ret_df)))</span>
<span id="cb173-123"><a href="#cb173-123" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(ret_df) <span class="sc">==</span> <span class="fu">nrow</span>(X_df))</span>
<span id="cb173-124"><a href="#cb173-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each column of ret_df should be one of the prototypes.</span></span>
<span id="cb173-125"><a href="#cb173-125" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(ret_df) <span class="sc">==</span> <span class="fu">ncol</span>(X_df_model) <span class="sc">-</span> <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb173-126"><a href="#cb173-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-127"><a href="#cb173-127" aria-hidden="true" tabindex="-1"></a>  proto_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb173-128"><a href="#cb173-128" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>){</span>
<span id="cb173-129"><a href="#cb173-129" aria-hidden="true" tabindex="-1"></a>    proto_found <span class="ot">&lt;-</span> proto_found <span class="sc">|</span> <span class="fu">all</span>(<span class="fu">abs</span>(ret_df[, <span class="dv">1</span>] <span class="sc">-</span> X_df_model[, j]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>))</span>
<span id="cb173-130"><a href="#cb173-130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-131"><a href="#cb173-131" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(proto_found)</span>
<span id="cb173-132"><a href="#cb173-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-133"><a href="#cb173-133" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">4</span><span class="sc">:</span><span class="fu">ncol</span>(X_df_model)){</span>
<span id="cb173-134"><a href="#cb173-134" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret_df[, j <span class="sc">-</span> <span class="dv">2</span>] <span class="sc">-</span> X_df_model[, j]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-135"><a href="#cb173-135" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-136"><a href="#cb173-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-137"><a href="#cb173-137" aria-hidden="true" tabindex="-1"></a>  ret_df <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>res<span class="sc">$</span>x, <span class="at">clusters=</span>res<span class="sc">$</span>clusters, <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>,</span>
<span id="cb173-138"><a href="#cb173-138" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prototypes=</span>res<span class="sc">$</span>prototypes)</span>
<span id="cb173-139"><a href="#cb173-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-140"><a href="#cb173-140" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(ret_df))</span>
<span id="cb173-141"><a href="#cb173-141" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(ret_df))</span>
<span id="cb173-142"><a href="#cb173-142" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(<span class="fu">colnames</span>(ret_df)))</span>
<span id="cb173-143"><a href="#cb173-143" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(ret_df) <span class="sc">==</span> <span class="fu">nrow</span>(X_df))</span>
<span id="cb173-144"><a href="#cb173-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each column of ret_df should be one of the prototypes.</span></span>
<span id="cb173-145"><a href="#cb173-145" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(ret_df) <span class="sc">==</span> <span class="fu">ncol</span>(X_df_model) <span class="sc">-</span> <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb173-146"><a href="#cb173-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-147"><a href="#cb173-147" aria-hidden="true" tabindex="-1"></a>  proto_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb173-148"><a href="#cb173-148" aria-hidden="true" tabindex="-1"></a>  clus_rep <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(X_df_model[, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb173-149"><a href="#cb173-149" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret_df[, <span class="dv">1</span>] <span class="sc">-</span> clus_rep) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-150"><a href="#cb173-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-151"><a href="#cb173-151" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">4</span><span class="sc">:</span><span class="fu">ncol</span>(X_df_model)){</span>
<span id="cb173-152"><a href="#cb173-152" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(ret_df[, j <span class="sc">-</span> <span class="dv">2</span>] <span class="sc">-</span> X_df_model[, j]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-153"><a href="#cb173-153" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-154"><a href="#cb173-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-155"><a href="#cb173-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a matrix with column names (returned X shouldn&#39;t have column names)</span></span>
<span id="cb173-156"><a href="#cb173-156" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> x</span>
<span id="cb173-157"><a href="#cb173-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x2) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb173-158"><a href="#cb173-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-159"><a href="#cb173-159" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x2, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb173-160"><a href="#cb173-160" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nlambda=</span><span class="dv">10</span>)</span>
<span id="cb173-161"><a href="#cb173-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-162"><a href="#cb173-162" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb173-163"><a href="#cb173-163" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb173-164"><a href="#cb173-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-165"><a href="#cb173-165" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb173-166"><a href="#cb173-166" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb173-167"><a href="#cb173-167" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(<span class="fu">colnames</span>(res)))</span>
<span id="cb173-168"><a href="#cb173-168" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(res) <span class="sc">==</span> <span class="dv">15</span>)</span>
<span id="cb173-169"><a href="#cb173-169" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each column of res should be one of the prototypes. Features 9 - 11 are</span></span>
<span id="cb173-170"><a href="#cb173-170" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in clusters by themselves and are therefore their own prototypes.</span></span>
<span id="cb173-171"><a href="#cb173-171" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(res) <span class="sc">==</span> <span class="dv">5</span>)</span>
<span id="cb173-172"><a href="#cb173-172" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(good_clusters)){</span>
<span id="cb173-173"><a href="#cb173-173" aria-hidden="true" tabindex="-1"></a>    proto_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb173-174"><a href="#cb173-174" aria-hidden="true" tabindex="-1"></a>    cluster_i <span class="ot">&lt;-</span> good_clusters[[i]]</span>
<span id="cb173-175"><a href="#cb173-175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cluster_i)){</span>
<span id="cb173-176"><a href="#cb173-176" aria-hidden="true" tabindex="-1"></a>      proto_i_found <span class="ot">&lt;-</span> proto_i_found <span class="sc">|</span> <span class="fu">all</span>(<span class="fu">abs</span>(res[, i] <span class="sc">-</span> x[, cluster_i[j]]) <span class="sc">&lt;</span></span>
<span id="cb173-177"><a href="#cb173-177" aria-hidden="true" tabindex="-1"></a>                                             <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>))</span>
<span id="cb173-178"><a href="#cb173-178" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb173-179"><a href="#cb173-179" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(proto_i_found)</span>
<span id="cb173-180"><a href="#cb173-180" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-181"><a href="#cb173-181" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">3</span>] <span class="sc">-</span> x[, <span class="dv">9</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-182"><a href="#cb173-182" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">4</span>] <span class="sc">-</span> x[, <span class="dv">10</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-183"><a href="#cb173-183" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">5</span>] <span class="sc">-</span> x[, <span class="dv">11</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-184"><a href="#cb173-184" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-185"><a href="#cb173-185" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb173-186"><a href="#cb173-186" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb173-187"><a href="#cb173-187" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-188"><a href="#cb173-188" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.matrix</span>(res))</span>
<span id="cb173-189"><a href="#cb173-189" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.numeric</span>(res))</span>
<span id="cb173-190"><a href="#cb173-190" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(<span class="fu">colnames</span>(res)))</span>
<span id="cb173-191"><a href="#cb173-191" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">nrow</span>(res) <span class="sc">==</span> <span class="dv">15</span>)</span>
<span id="cb173-192"><a href="#cb173-192" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each column of res should be one of the cluster representatives. Features 9</span></span>
<span id="cb173-193"><a href="#cb173-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - 11 are in clusters by themselves and are therefore their own cluster</span></span>
<span id="cb173-194"><a href="#cb173-194" aria-hidden="true" tabindex="-1"></a>  <span class="co"># representatives.</span></span>
<span id="cb173-195"><a href="#cb173-195" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">ncol</span>(res) <span class="sc">==</span> <span class="dv">5</span>)</span>
<span id="cb173-196"><a href="#cb173-196" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(good_clusters)){</span>
<span id="cb173-197"><a href="#cb173-197" aria-hidden="true" tabindex="-1"></a>    cluster_i <span class="ot">&lt;-</span> good_clusters[[i]]</span>
<span id="cb173-198"><a href="#cb173-198" aria-hidden="true" tabindex="-1"></a>    clus_rep_i <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(x[, cluster_i])</span>
<span id="cb173-199"><a href="#cb173-199" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, i] <span class="sc">-</span> clus_rep_i) <span class="sc">&lt;</span></span>
<span id="cb173-200"><a href="#cb173-200" aria-hidden="true" tabindex="-1"></a>                                             <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-201"><a href="#cb173-201" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-202"><a href="#cb173-202" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">3</span>] <span class="sc">-</span> x[, <span class="dv">9</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-203"><a href="#cb173-203" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">4</span>] <span class="sc">-</span> x[, <span class="dv">10</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-204"><a href="#cb173-204" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="fu">abs</span>(res[, <span class="dv">5</span>] <span class="sc">-</span> x[, <span class="dv">11</span>]) <span class="sc">&lt;</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">9</span>)))</span>
<span id="cb173-205"><a href="#cb173-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-206"><a href="#cb173-206" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad prototype inputs</span></span>
<span id="cb173-207"><a href="#cb173-207" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Error has quotation marks</span></span>
<span id="cb173-208"><a href="#cb173-208" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb173-209"><a href="#cb173-209" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">type=</span><span class="st">&quot;clsterRepLasso&quot;</span>,</span>
<span id="cb173-210"><a href="#cb173-210" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes))</span>
<span id="cb173-211"><a href="#cb173-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-212"><a href="#cb173-212" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb173-213"><a href="#cb173-213" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">type=</span><span class="fu">c</span>(<span class="st">&quot;clusterRepLasso&quot;</span>, <span class="st">&quot;protolasso&quot;</span>),</span>
<span id="cb173-214"><a href="#cb173-214" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes),</span>
<span id="cb173-215"><a href="#cb173-215" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;length(type) == 1 is not TRUE&quot;</span>,</span>
<span id="cb173-216"><a href="#cb173-216" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb173-217"><a href="#cb173-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-218"><a href="#cb173-218" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb173-219"><a href="#cb173-219" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">type=</span><span class="dv">2</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes),</span>
<span id="cb173-220"><a href="#cb173-220" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;is.character(type) is not TRUE&quot;</span>,</span>
<span id="cb173-221"><a href="#cb173-221" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb173-222"><a href="#cb173-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-223"><a href="#cb173-223" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb173-224"><a href="#cb173-224" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">type=</span><span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb173-225"><a href="#cb173-225" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes),</span>
<span id="cb173-226"><a href="#cb173-226" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;!is.na(type) is not TRUE&quot;</span>,</span>
<span id="cb173-227"><a href="#cb173-227" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb173-228"><a href="#cb173-228" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-229"><a href="#cb173-229" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p><code>getClusterSelsFromGlmnet()</code>:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Extracts selected clusters and cluster prototypes from the glmnet lasso</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; output</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lasso_sets A list of integer vectors. Each vector represents a set of</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features selected by the lasso for a given value of the penalty parameter</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; lambda.</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A named list where each entry is an integer vector of indices</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of features that are in a common cluster. (The length of list clusters is</span></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; equal to the number of clusters.) All identified clusters must be</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; non-overlapping. All features appear in exactly one cluster (any unclustered</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features must be in their own &quot;cluster&quot; of size 1).</span></span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prototypes An integer vector whose length must be equal to the number</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of clusters. Entry i should be the index of the feature belonging to cluster</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; i that is most highly correlated with y (that is, the prototype for the</span></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster, as in the protolasso; see Reid and Tibshirani 2016).</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param feat_names Character vector; the names of the features in X. (If the</span></span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; X provided to protolasso or clusterRepLasso did not have feature names,</span></span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; feat_names will be NA.)</span></span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list containing the following items: \item{selected_sets}{A list of</span></span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; integer vectors. Entry k of this list contains a selected set of size k</span></span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; yielded by glmnet--each member of the set is the index of a single feature</span></span>
<span id="cb175-22"><a href="#cb175-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; from a cluster selected by either the protolasso or the cluster</span></span>
<span id="cb175-23"><a href="#cb175-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; representative lasso (the prototype from that cluster--the cluster member</span></span>
<span id="cb175-24"><a href="#cb175-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; most highly correlated with y). (If no set of size k was selected, entry k</span></span>
<span id="cb175-25"><a href="#cb175-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will be NULL.)} \item{selected_clusts_list}{A list of lists; entry k of this</span></span>
<span id="cb175-26"><a href="#cb175-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; list is a list of length k of clusters (the clusters that were selected by</span></span>
<span id="cb175-27"><a href="#cb175-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the cluster representative lasso). Again, if no set of size k was selected,</span></span>
<span id="cb175-28"><a href="#cb175-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; entry k will be NULL.}</span></span>
<span id="cb175-29"><a href="#cb175-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb175-30"><a href="#cb175-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references Reid, S., &amp; Tibshirani, R. (2016). Sparse regression and marginal</span></span>
<span id="cb175-31"><a href="#cb175-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; testing using cluster prototypes. \emph{Biostatistics}, 17(2), 364–376.</span></span>
<span id="cb175-32"><a href="#cb175-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://doi.org/10.1093/biostatistics/kxv049}. \cr Bühlmann, P.,</span></span>
<span id="cb175-33"><a href="#cb175-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Rütimann, P., van de Geer, S., &amp; Zhang, C. H. (2013). Correlated variables in</span></span>
<span id="cb175-34"><a href="#cb175-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; regression: Clustering and sparse estimation.</span></span>
<span id="cb175-35"><a href="#cb175-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \emph{Journal of Statistical Planning and Inference}, 143(11), 1835–1858.</span></span>
<span id="cb175-36"><a href="#cb175-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://doi.org/10.1016/j.jspi.2013.05.019}.</span></span>
<span id="cb175-37"><a href="#cb175-37" aria-hidden="true" tabindex="-1"></a>getClusterSelsFromGlmnet <span class="ot">&lt;-</span> <span class="cf">function</span>(lasso_sets, clusters, prototypes,</span>
<span id="cb175-38"><a href="#cb175-38" aria-hidden="true" tabindex="-1"></a>    feat_names){</span>
<span id="cb175-39"><a href="#cb175-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-40"><a href="#cb175-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="sc">!</span><span class="fu">is.na</span>(feat_names))){</span>
<span id="cb175-41"><a href="#cb175-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(feat_names)))</span>
<span id="cb175-42"><a href="#cb175-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb175-43"><a href="#cb175-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-44"><a href="#cb175-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Largest selected set among all those in lasso_sets</span></span>
<span id="cb175-45"><a href="#cb175-45" aria-hidden="true" tabindex="-1"></a>    max_length <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">vapply</span>(lasso_sets, length, <span class="fu">integer</span>(<span class="dv">1</span>)))</span>
<span id="cb175-46"><a href="#cb175-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-47"><a href="#cb175-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparing lists to store </span></span>
<span id="cb175-48"><a href="#cb175-48" aria-hidden="true" tabindex="-1"></a>    selected_sets <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb175-49"><a href="#cb175-49" aria-hidden="true" tabindex="-1"></a>    selected_clusts_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb175-50"><a href="#cb175-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-51"><a href="#cb175-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>max_length){</span>
<span id="cb175-52"><a href="#cb175-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Lasso selected set of size j</span></span>
<span id="cb175-53"><a href="#cb175-53" aria-hidden="true" tabindex="-1"></a>        lasso_sets_j <span class="ot">&lt;-</span> lasso_sets[<span class="fu">lapply</span>(lasso_sets, length) <span class="sc">==</span> j]</span>
<span id="cb175-54"><a href="#cb175-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Are there any lasso selected sets of size j? (If not, we will skip to</span></span>
<span id="cb175-55"><a href="#cb175-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the next j, and slot j in the list will be empty.)</span></span>
<span id="cb175-56"><a href="#cb175-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(lasso_sets_j) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb175-57"><a href="#cb175-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-58"><a href="#cb175-58" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Select the first set of size j</span></span>
<span id="cb175-59"><a href="#cb175-59" aria-hidden="true" tabindex="-1"></a>            lasso_set_j <span class="ot">&lt;-</span> lasso_sets_j[[<span class="dv">1</span>]]</span>
<span id="cb175-60"><a href="#cb175-60" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">length</span>(lasso_set_j) <span class="sc">==</span> j)</span>
<span id="cb175-61"><a href="#cb175-61" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb175-62"><a href="#cb175-62" aria-hidden="true" tabindex="-1"></a>            ret <span class="ot">&lt;-</span> <span class="fu">getSelectedSets</span>(<span class="at">lasso_set=</span>lasso_set_j, <span class="at">clusters=</span>clusters,</span>
<span id="cb175-63"><a href="#cb175-63" aria-hidden="true" tabindex="-1"></a>                <span class="at">prototypes=</span>prototypes, <span class="at">feat_names=</span>feat_names)</span>
<span id="cb175-64"><a href="#cb175-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-65"><a href="#cb175-65" aria-hidden="true" tabindex="-1"></a>            selected_sets[[j]] <span class="ot">&lt;-</span> ret<span class="sc">$</span>selected_set</span>
<span id="cb175-66"><a href="#cb175-66" aria-hidden="true" tabindex="-1"></a>            selected_clusts_list[[j]] <span class="ot">&lt;-</span> ret<span class="sc">$</span>selected_clusts_list</span>
<span id="cb175-67"><a href="#cb175-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-68"><a href="#cb175-68" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rm</span>(ret)</span>
<span id="cb175-69"><a href="#cb175-69" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb175-70"><a href="#cb175-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb175-71"><a href="#cb175-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-72"><a href="#cb175-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_sets) <span class="sc">&lt;=</span> max_length)</span>
<span id="cb175-73"><a href="#cb175-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_clusts_list) <span class="sc">&lt;=</span> max_length)</span>
<span id="cb175-74"><a href="#cb175-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-75"><a href="#cb175-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">selected_sets=</span>selected_sets,</span>
<span id="cb175-76"><a href="#cb175-76" aria-hidden="true" tabindex="-1"></a>        <span class="at">selected_clusts_list=</span>selected_clusts_list))</span>
<span id="cb175-77"><a href="#cb175-77" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>getSelectedSets()</code>:</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Converts a selected set from X_glmnet to selected sets and selected clusters</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; from the original feature space of X.</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param lasso_set A vector containing the indices of selected cluster</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; representatives or prototypes.</span></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A named list where each entry is an integer vector of indices</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of features that are in a common cluster. (The length of list clusters is</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; equal to the number of clusters.) All identified clusters must be</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; non-overlapping. All features appear in exactly one cluster (any unclustered</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; features must be in their own &quot;cluster&quot; of size 1).</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param prototypes An integer vector whose length must be equal to the number</span></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of clusters. Entry i should be the index of the feature belonging to cluster</span></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; i that is most highly correlated with y (that is, the prototype for the</span></span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster, as in the protolasso).</span></span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param feat_names Character vector; the names of the features in X.</span></span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list containing two items: \item{selected_set}{An integer vector</span></span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; with length equal to lasso_set containing a set of selected features in the</span></span>
<span id="cb176-18"><a href="#cb176-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; original X matrix. (Selections in lasso_set corresponding to a cluster will</span></span>
<span id="cb176-19"><a href="#cb176-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be replaced by the cluster&#39;s prototype from X.)}</span></span>
<span id="cb176-20"><a href="#cb176-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{selected_clusts_list}{A named list of integer vectors with length equal</span></span>
<span id="cb176-21"><a href="#cb176-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; to selected_set. selected_clusts_list[[k]] will be an integer vector</span></span>
<span id="cb176-22"><a href="#cb176-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; containing the indices of the features in X that are in the cluster</span></span>
<span id="cb176-23"><a href="#cb176-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; containing prototype selected_set[k].}</span></span>
<span id="cb176-24"><a href="#cb176-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @author Gregory Faletto, Jacob Bien</span></span>
<span id="cb176-25"><a href="#cb176-25" aria-hidden="true" tabindex="-1"></a>getSelectedSets <span class="ot">&lt;-</span> <span class="cf">function</span>(lasso_set, clusters, prototypes, feat_names){</span>
<span id="cb176-26"><a href="#cb176-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-27"><a href="#cb176-27" aria-hidden="true" tabindex="-1"></a>    model_size <span class="ot">&lt;-</span> <span class="fu">length</span>(lasso_set)</span>
<span id="cb176-28"><a href="#cb176-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(model_size <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb176-29"><a href="#cb176-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-30"><a href="#cb176-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">unique</span>(lasso_set)) <span class="sc">==</span> model_size)</span>
<span id="cb176-31"><a href="#cb176-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">all</span>(lasso_set <span class="sc">&lt;=</span> <span class="fu">length</span>(clusters)))</span>
<span id="cb176-32"><a href="#cb176-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-33"><a href="#cb176-33" aria-hidden="true" tabindex="-1"></a>    selected_set <span class="ot">&lt;-</span> <span class="fu">integer</span>()</span>
<span id="cb176-34"><a href="#cb176-34" aria-hidden="true" tabindex="-1"></a>    selected_clusts_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb176-35"><a href="#cb176-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recover features from original feature space</span></span>
<span id="cb176-36"><a href="#cb176-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>model_size){</span>
<span id="cb176-37"><a href="#cb176-37" aria-hidden="true" tabindex="-1"></a>        selected_cluster_k <span class="ot">&lt;-</span> clusters[[lasso_set[k]]]</span>
<span id="cb176-38"><a href="#cb176-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(selected_cluster_k))</span>
<span id="cb176-39"><a href="#cb176-39" aria-hidden="true" tabindex="-1"></a>        selected_clusts_list[[k]] <span class="ot">&lt;-</span> selected_cluster_k</span>
<span id="cb176-40"><a href="#cb176-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-41"><a href="#cb176-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(selected_cluster_k) <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb176-42"><a href="#cb176-42" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="sc">!</span>(selected_cluster_k <span class="sc">%in%</span> selected_set))</span>
<span id="cb176-43"><a href="#cb176-43" aria-hidden="true" tabindex="-1"></a>            selected_set <span class="ot">&lt;-</span> <span class="fu">c</span>(selected_set, selected_cluster_k)</span>
<span id="cb176-44"><a href="#cb176-44" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span>{</span>
<span id="cb176-45"><a href="#cb176-45" aria-hidden="true" tabindex="-1"></a>            sel_prototype <span class="ot">&lt;-</span> <span class="fu">which</span>(prototypes <span class="sc">%in%</span> selected_cluster_k)</span>
<span id="cb176-46"><a href="#cb176-46" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="fu">length</span>(sel_prototype) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb176-47"><a href="#cb176-47" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stopifnot</span>(<span class="sc">!</span>(prototypes[sel_prototype] <span class="sc">%in%</span> selected_set))</span>
<span id="cb176-48"><a href="#cb176-48" aria-hidden="true" tabindex="-1"></a>            selected_set <span class="ot">&lt;-</span> <span class="fu">c</span>(selected_set, prototypes[sel_prototype])</span>
<span id="cb176-49"><a href="#cb176-49" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb176-50"><a href="#cb176-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb176-51"><a href="#cb176-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-52"><a href="#cb176-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_set) <span class="sc">==</span> model_size)</span>
<span id="cb176-53"><a href="#cb176-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(<span class="fu">unique</span>(selected_set)) <span class="sc">==</span> model_size)</span>
<span id="cb176-54"><a href="#cb176-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-55"><a href="#cb176-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="sc">!</span><span class="fu">is.na</span>(feat_names))){</span>
<span id="cb176-56"><a href="#cb176-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(selected_set) <span class="ot">&lt;-</span> feat_names[selected_set]</span>
<span id="cb176-57"><a href="#cb176-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb176-58"><a href="#cb176-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-59"><a href="#cb176-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(selected_clusts_list) <span class="sc">==</span> model_size)</span>
<span id="cb176-60"><a href="#cb176-60" aria-hidden="true" tabindex="-1"></a>    all_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(selected_clusts_list)</span>
<span id="cb176-61"><a href="#cb176-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">length</span>(all_feats) <span class="sc">==</span> <span class="fu">length</span>(<span class="fu">unique</span>(all_feats)))</span>
<span id="cb176-62"><a href="#cb176-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-63"><a href="#cb176-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">selected_set=</span>selected_set,</span>
<span id="cb176-64"><a href="#cb176-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">selected_clusts_list=</span>selected_clusts_list))</span>
<span id="cb176-65"><a href="#cb176-65" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>getSelectedSets()</code>:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getSelectedSets works&quot;</span>, {</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">82612</span>)</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span><span class="sc">*</span><span class="dv">11</span>), <span class="at">nrow=</span><span class="dv">15</span>, <span class="at">ncol=</span><span class="dv">11</span>)</span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span>)</span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>4L, <span class="at">green_cluster=</span>5L<span class="sc">:</span>8L)</span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb177-14"><a href="#cb177-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-15"><a href="#cb177-15" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span>y, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-16"><a href="#cb177-16" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb177-17"><a href="#cb177-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pick an arbitrary lasso set</span></span>
<span id="cb177-18"><a href="#cb177-18" aria-hidden="true" tabindex="-1"></a>  lasso_set <span class="ot">&lt;-</span> lasso_sets[[<span class="dv">5</span>]]</span>
<span id="cb177-19"><a href="#cb177-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-20"><a href="#cb177-20" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getSelectedSets</span>(lasso_set, process<span class="sc">$</span>clusters, process<span class="sc">$</span>prototypes,</span>
<span id="cb177-21"><a href="#cb177-21" aria-hidden="true" tabindex="-1"></a>                         process<span class="sc">$</span>var_names)</span>
<span id="cb177-22"><a href="#cb177-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-23"><a href="#cb177-23" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb177-24"><a href="#cb177-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_set&quot;</span>,</span>
<span id="cb177-25"><a href="#cb177-25" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb177-26"><a href="#cb177-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-27"><a href="#cb177-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_set</span></span>
<span id="cb177-28"><a href="#cb177-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_set))</span>
<span id="cb177-29"><a href="#cb177-29" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_set)))</span>
<span id="cb177-30"><a href="#cb177-30" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_set <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb177-31"><a href="#cb177-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-32"><a href="#cb177-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb177-33"><a href="#cb177-33" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-34"><a href="#cb177-34" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_set),</span>
<span id="cb177-35"><a href="#cb177-35" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-36"><a href="#cb177-36" aria-hidden="true" tabindex="-1"></a>  sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-37"><a href="#cb177-37" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb177-38"><a href="#cb177-38" aria-hidden="true" tabindex="-1"></a>  n_clusts <span class="ot">&lt;-</span> <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-39"><a href="#cb177-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb177-40"><a href="#cb177-40" aria-hidden="true" tabindex="-1"></a>    clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb177-41"><a href="#cb177-41" aria-hidden="true" tabindex="-1"></a>    clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[i]]</span>
<span id="cb177-42"><a href="#cb177-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb177-43"><a href="#cb177-43" aria-hidden="true" tabindex="-1"></a>      clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i, process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb177-44"><a href="#cb177-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb177-45"><a href="#cb177-45" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb177-46"><a href="#cb177-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb177-47"><a href="#cb177-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-48"><a href="#cb177-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try again with cluster representative lasso</span></span>
<span id="cb177-49"><a href="#cb177-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-50"><a href="#cb177-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-51"><a href="#cb177-51" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb177-52"><a href="#cb177-52" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb177-53"><a href="#cb177-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-54"><a href="#cb177-54" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span>y, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-55"><a href="#cb177-55" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb177-56"><a href="#cb177-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pick an arbitrary lasso set</span></span>
<span id="cb177-57"><a href="#cb177-57" aria-hidden="true" tabindex="-1"></a>  lasso_set <span class="ot">&lt;-</span> lasso_sets[[<span class="dv">5</span>]]</span>
<span id="cb177-58"><a href="#cb177-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-59"><a href="#cb177-59" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getSelectedSets</span>(lasso_set, process<span class="sc">$</span>clusters, process<span class="sc">$</span>prototypes,</span>
<span id="cb177-60"><a href="#cb177-60" aria-hidden="true" tabindex="-1"></a>                         process<span class="sc">$</span>var_names)</span>
<span id="cb177-61"><a href="#cb177-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-62"><a href="#cb177-62" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb177-63"><a href="#cb177-63" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_set&quot;</span>,</span>
<span id="cb177-64"><a href="#cb177-64" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb177-65"><a href="#cb177-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-66"><a href="#cb177-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_set</span></span>
<span id="cb177-67"><a href="#cb177-67" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_set))</span>
<span id="cb177-68"><a href="#cb177-68" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_set)))</span>
<span id="cb177-69"><a href="#cb177-69" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_set <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb177-70"><a href="#cb177-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-71"><a href="#cb177-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb177-72"><a href="#cb177-72" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-73"><a href="#cb177-73" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_set),</span>
<span id="cb177-74"><a href="#cb177-74" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-75"><a href="#cb177-75" aria-hidden="true" tabindex="-1"></a>  sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-76"><a href="#cb177-76" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb177-77"><a href="#cb177-77" aria-hidden="true" tabindex="-1"></a>  n_clusts <span class="ot">&lt;-</span> <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-78"><a href="#cb177-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb177-79"><a href="#cb177-79" aria-hidden="true" tabindex="-1"></a>    clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb177-80"><a href="#cb177-80" aria-hidden="true" tabindex="-1"></a>    clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[i]]</span>
<span id="cb177-81"><a href="#cb177-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb177-82"><a href="#cb177-82" aria-hidden="true" tabindex="-1"></a>      clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i, process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb177-83"><a href="#cb177-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb177-84"><a href="#cb177-84" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb177-85"><a href="#cb177-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb177-86"><a href="#cb177-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-87"><a href="#cb177-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-88"><a href="#cb177-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-89"><a href="#cb177-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-90"><a href="#cb177-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-91"><a href="#cb177-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a data.frame</span></span>
<span id="cb177-92"><a href="#cb177-92" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb177-93"><a href="#cb177-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-94"><a href="#cb177-94" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X_df)</span>
<span id="cb177-95"><a href="#cb177-95" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb177-96"><a href="#cb177-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-97"><a href="#cb177-97" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>X_df, <span class="at">y=</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)),</span>
<span id="cb177-98"><a href="#cb177-98" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-99"><a href="#cb177-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-100"><a href="#cb177-100" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb177-101"><a href="#cb177-101" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb177-102"><a href="#cb177-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-103"><a href="#cb177-103" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)), <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb177-104"><a href="#cb177-104" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-105"><a href="#cb177-105" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb177-106"><a href="#cb177-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pick an arbitrary lasso set</span></span>
<span id="cb177-107"><a href="#cb177-107" aria-hidden="true" tabindex="-1"></a>  lasso_set <span class="ot">&lt;-</span> lasso_sets[[<span class="fu">min</span>(<span class="fu">length</span>(lasso_sets), <span class="dv">3</span>)]]</span>
<span id="cb177-108"><a href="#cb177-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-109"><a href="#cb177-109" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getSelectedSets</span>(lasso_set, process<span class="sc">$</span>clusters, process<span class="sc">$</span>prototypes,</span>
<span id="cb177-110"><a href="#cb177-110" aria-hidden="true" tabindex="-1"></a>                         process<span class="sc">$</span>var_names)</span>
<span id="cb177-111"><a href="#cb177-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-112"><a href="#cb177-112" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb177-113"><a href="#cb177-113" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_set&quot;</span>,</span>
<span id="cb177-114"><a href="#cb177-114" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb177-115"><a href="#cb177-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-116"><a href="#cb177-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_set</span></span>
<span id="cb177-117"><a href="#cb177-117" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_set))</span>
<span id="cb177-118"><a href="#cb177-118" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_set)))</span>
<span id="cb177-119"><a href="#cb177-119" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_set <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb177-120"><a href="#cb177-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-121"><a href="#cb177-121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb177-122"><a href="#cb177-122" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-123"><a href="#cb177-123" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_set),</span>
<span id="cb177-124"><a href="#cb177-124" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-125"><a href="#cb177-125" aria-hidden="true" tabindex="-1"></a>  sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-126"><a href="#cb177-126" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(X_df_model)))</span>
<span id="cb177-127"><a href="#cb177-127" aria-hidden="true" tabindex="-1"></a>  n_clusts <span class="ot">&lt;-</span> <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-128"><a href="#cb177-128" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb177-129"><a href="#cb177-129" aria-hidden="true" tabindex="-1"></a>    clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb177-130"><a href="#cb177-130" aria-hidden="true" tabindex="-1"></a>    clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[i]]</span>
<span id="cb177-131"><a href="#cb177-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb177-132"><a href="#cb177-132" aria-hidden="true" tabindex="-1"></a>      clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i, process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb177-133"><a href="#cb177-133" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb177-134"><a href="#cb177-134" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb177-135"><a href="#cb177-135" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb177-136"><a href="#cb177-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-137"><a href="#cb177-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a dataframe with factors (number of columns of final design matrix</span></span>
<span id="cb177-138"><a href="#cb177-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after one-hot encoding factors won&#39;t match number of columns of df2)</span></span>
<span id="cb177-139"><a href="#cb177-139" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> X_df</span>
<span id="cb177-140"><a href="#cb177-140" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>cyl)</span>
<span id="cb177-141"><a href="#cb177-141" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>vs)</span>
<span id="cb177-142"><a href="#cb177-142" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>am)</span>
<span id="cb177-143"><a href="#cb177-143" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>gear)</span>
<span id="cb177-144"><a href="#cb177-144" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>carb)</span>
<span id="cb177-145"><a href="#cb177-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-146"><a href="#cb177-146" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., df2)</span>
<span id="cb177-147"><a href="#cb177-147" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb177-148"><a href="#cb177-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-149"><a href="#cb177-149" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>df2, <span class="at">y=</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(df2)),</span>
<span id="cb177-150"><a href="#cb177-150" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-151"><a href="#cb177-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-152"><a href="#cb177-152" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb177-153"><a href="#cb177-153" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb177-154"><a href="#cb177-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-155"><a href="#cb177-155" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(df2)), <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb177-156"><a href="#cb177-156" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-157"><a href="#cb177-157" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb177-158"><a href="#cb177-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pick an arbitrary lasso set</span></span>
<span id="cb177-159"><a href="#cb177-159" aria-hidden="true" tabindex="-1"></a>  lasso_set <span class="ot">&lt;-</span> lasso_sets[[<span class="fu">min</span>(<span class="fu">length</span>(lasso_sets), <span class="dv">3</span>)]]</span>
<span id="cb177-160"><a href="#cb177-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-161"><a href="#cb177-161" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getSelectedSets</span>(lasso_set, process<span class="sc">$</span>clusters, process<span class="sc">$</span>prototypes,</span>
<span id="cb177-162"><a href="#cb177-162" aria-hidden="true" tabindex="-1"></a>                         process<span class="sc">$</span>var_names)</span>
<span id="cb177-163"><a href="#cb177-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-164"><a href="#cb177-164" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb177-165"><a href="#cb177-165" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_set&quot;</span>,</span>
<span id="cb177-166"><a href="#cb177-166" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb177-167"><a href="#cb177-167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-168"><a href="#cb177-168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_set</span></span>
<span id="cb177-169"><a href="#cb177-169" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_set))</span>
<span id="cb177-170"><a href="#cb177-170" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_set)))</span>
<span id="cb177-171"><a href="#cb177-171" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_set <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb177-172"><a href="#cb177-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-173"><a href="#cb177-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb177-174"><a href="#cb177-174" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-175"><a href="#cb177-175" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_set),</span>
<span id="cb177-176"><a href="#cb177-176" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-177"><a href="#cb177-177" aria-hidden="true" tabindex="-1"></a>  sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-178"><a href="#cb177-178" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(X_df_model)))</span>
<span id="cb177-179"><a href="#cb177-179" aria-hidden="true" tabindex="-1"></a>  n_clusts <span class="ot">&lt;-</span> <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-180"><a href="#cb177-180" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb177-181"><a href="#cb177-181" aria-hidden="true" tabindex="-1"></a>    clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb177-182"><a href="#cb177-182" aria-hidden="true" tabindex="-1"></a>    clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[i]]</span>
<span id="cb177-183"><a href="#cb177-183" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb177-184"><a href="#cb177-184" aria-hidden="true" tabindex="-1"></a>      clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i, process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb177-185"><a href="#cb177-185" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb177-186"><a href="#cb177-186" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb177-187"><a href="#cb177-187" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb177-188"><a href="#cb177-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-189"><a href="#cb177-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-190"><a href="#cb177-190" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-191"><a href="#cb177-191" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-192"><a href="#cb177-192" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a dataframe with factors (number of columns of final design matrix</span></span>
<span id="cb177-193"><a href="#cb177-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after one-hot encoding factors won&#39;t match number of columns of df2)</span></span>
<span id="cb177-194"><a href="#cb177-194" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> X_df</span>
<span id="cb177-195"><a href="#cb177-195" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>cyl)</span>
<span id="cb177-196"><a href="#cb177-196" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>vs)</span>
<span id="cb177-197"><a href="#cb177-197" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>am)</span>
<span id="cb177-198"><a href="#cb177-198" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>gear)</span>
<span id="cb177-199"><a href="#cb177-199" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>carb)</span>
<span id="cb177-200"><a href="#cb177-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-201"><a href="#cb177-201" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., df2)</span>
<span id="cb177-202"><a href="#cb177-202" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb177-203"><a href="#cb177-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-204"><a href="#cb177-204" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>df2, <span class="at">y=</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(df2)),</span>
<span id="cb177-205"><a href="#cb177-205" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-206"><a href="#cb177-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-207"><a href="#cb177-207" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb177-208"><a href="#cb177-208" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb177-209"><a href="#cb177-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-210"><a href="#cb177-210" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(df2)), <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb177-211"><a href="#cb177-211" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-212"><a href="#cb177-212" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb177-213"><a href="#cb177-213" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pick an arbitrary lasso set</span></span>
<span id="cb177-214"><a href="#cb177-214" aria-hidden="true" tabindex="-1"></a>  lasso_set <span class="ot">&lt;-</span> lasso_sets[[<span class="fu">min</span>(<span class="fu">length</span>(lasso_sets), <span class="dv">3</span>)]]</span>
<span id="cb177-215"><a href="#cb177-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-216"><a href="#cb177-216" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getSelectedSets</span>(lasso_set, process<span class="sc">$</span>clusters, process<span class="sc">$</span>prototypes,</span>
<span id="cb177-217"><a href="#cb177-217" aria-hidden="true" tabindex="-1"></a>                         process<span class="sc">$</span>var_names)</span>
<span id="cb177-218"><a href="#cb177-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-219"><a href="#cb177-219" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb177-220"><a href="#cb177-220" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_set&quot;</span>,</span>
<span id="cb177-221"><a href="#cb177-221" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb177-222"><a href="#cb177-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-223"><a href="#cb177-223" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_set</span></span>
<span id="cb177-224"><a href="#cb177-224" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_set))</span>
<span id="cb177-225"><a href="#cb177-225" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_set)))</span>
<span id="cb177-226"><a href="#cb177-226" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_set <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb177-227"><a href="#cb177-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-228"><a href="#cb177-228" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb177-229"><a href="#cb177-229" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-230"><a href="#cb177-230" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_set),</span>
<span id="cb177-231"><a href="#cb177-231" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-232"><a href="#cb177-232" aria-hidden="true" tabindex="-1"></a>  sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-233"><a href="#cb177-233" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(X_df_model)))</span>
<span id="cb177-234"><a href="#cb177-234" aria-hidden="true" tabindex="-1"></a>  n_clusts <span class="ot">&lt;-</span> <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-235"><a href="#cb177-235" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb177-236"><a href="#cb177-236" aria-hidden="true" tabindex="-1"></a>    clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb177-237"><a href="#cb177-237" aria-hidden="true" tabindex="-1"></a>    clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[i]]</span>
<span id="cb177-238"><a href="#cb177-238" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb177-239"><a href="#cb177-239" aria-hidden="true" tabindex="-1"></a>      clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i, process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb177-240"><a href="#cb177-240" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb177-241"><a href="#cb177-241" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb177-242"><a href="#cb177-242" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb177-243"><a href="#cb177-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-244"><a href="#cb177-244" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-245"><a href="#cb177-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-246"><a href="#cb177-246" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a matrix with column names</span></span>
<span id="cb177-247"><a href="#cb177-247" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> x</span>
<span id="cb177-248"><a href="#cb177-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x2) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb177-249"><a href="#cb177-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-250"><a href="#cb177-250" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x2, <span class="at">y=</span>y,</span>
<span id="cb177-251"><a href="#cb177-251" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">clusters=</span>good_clusters, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-252"><a href="#cb177-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-253"><a href="#cb177-253" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb177-254"><a href="#cb177-254" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb177-255"><a href="#cb177-255" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-256"><a href="#cb177-256" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span>y, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb177-257"><a href="#cb177-257" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb177-258"><a href="#cb177-258" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb177-259"><a href="#cb177-259" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pick an arbitrary lasso set</span></span>
<span id="cb177-260"><a href="#cb177-260" aria-hidden="true" tabindex="-1"></a>  lasso_set <span class="ot">&lt;-</span> lasso_sets[[<span class="fu">min</span>(<span class="fu">length</span>(lasso_sets), <span class="dv">3</span>)]]</span>
<span id="cb177-261"><a href="#cb177-261" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-262"><a href="#cb177-262" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getSelectedSets</span>(lasso_set, process<span class="sc">$</span>clusters, process<span class="sc">$</span>prototypes,</span>
<span id="cb177-263"><a href="#cb177-263" aria-hidden="true" tabindex="-1"></a>                         process<span class="sc">$</span>var_names)</span>
<span id="cb177-264"><a href="#cb177-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-265"><a href="#cb177-265" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb177-266"><a href="#cb177-266" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_set&quot;</span>,</span>
<span id="cb177-267"><a href="#cb177-267" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb177-268"><a href="#cb177-268" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-269"><a href="#cb177-269" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_set</span></span>
<span id="cb177-270"><a href="#cb177-270" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_set))</span>
<span id="cb177-271"><a href="#cb177-271" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_set)))</span>
<span id="cb177-272"><a href="#cb177-272" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_set <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb177-273"><a href="#cb177-273" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-274"><a href="#cb177-274" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb177-275"><a href="#cb177-275" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-276"><a href="#cb177-276" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_set),</span>
<span id="cb177-277"><a href="#cb177-277" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb177-278"><a href="#cb177-278" aria-hidden="true" tabindex="-1"></a>  sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-279"><a href="#cb177-279" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb177-280"><a href="#cb177-280" aria-hidden="true" tabindex="-1"></a>  n_clusts <span class="ot">&lt;-</span> <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)</span>
<span id="cb177-281"><a href="#cb177-281" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb177-282"><a href="#cb177-282" aria-hidden="true" tabindex="-1"></a>    clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb177-283"><a href="#cb177-283" aria-hidden="true" tabindex="-1"></a>    clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[i]]</span>
<span id="cb177-284"><a href="#cb177-284" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb177-285"><a href="#cb177-285" aria-hidden="true" tabindex="-1"></a>      clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i, process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb177-286"><a href="#cb177-286" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb177-287"><a href="#cb177-287" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb177-288"><a href="#cb177-288" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb177-289"><a href="#cb177-289" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-290"><a href="#cb177-290" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 😸</code></pre>
<p>Tests for <code>getClusterSelsFromGlmnet()</code>:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;getClusterSelsFromGlmnet works&quot;</span>, {</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">61282</span>)</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span><span class="sc">*</span><span class="dv">11</span>), <span class="at">nrow=</span><span class="dv">15</span>, <span class="at">ncol=</span><span class="dv">11</span>)</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span>)</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>4L, <span class="at">green_cluster=</span>5L<span class="sc">:</span>8L)</span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x, <span class="at">y=</span>y, <span class="at">clusters=</span>good_clusters,</span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span>y, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getClusterSelsFromGlmnet</span>(lasso_sets, process<span class="sc">$</span>clusters,</span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a>                                  process<span class="sc">$</span>prototypes, process<span class="sc">$</span>var_names)</span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb179-22"><a href="#cb179-22" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_sets&quot;</span>,</span>
<span id="cb179-23"><a href="#cb179-23" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb179-24"><a href="#cb179-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-25"><a href="#cb179-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_sets</span></span>
<span id="cb179-26"><a href="#cb179-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_sets))</span>
<span id="cb179-27"><a href="#cb179-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb179-28"><a href="#cb179-28" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets),</span>
<span id="cb179-29"><a href="#cb179-29" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets)))</span>
<span id="cb179-30"><a href="#cb179-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_sets)){</span>
<span id="cb179-31"><a href="#cb179-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]])){</span>
<span id="cb179-32"><a href="#cb179-32" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb179-33"><a href="#cb179-33" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_sets[[i]])))</span>
<span id="cb179-34"><a href="#cb179-34" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_sets[[i]] <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb179-35"><a href="#cb179-35" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[i]]), i)</span>
<span id="cb179-36"><a href="#cb179-36" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb179-37"><a href="#cb179-37" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb179-38"><a href="#cb179-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-39"><a href="#cb179-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-40"><a href="#cb179-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-41"><a href="#cb179-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-42"><a href="#cb179-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb179-43"><a href="#cb179-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb179-44"><a href="#cb179-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb179-45"><a href="#cb179-45" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list),</span>
<span id="cb179-46"><a href="#cb179-46" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list)))</span>
<span id="cb179-47"><a href="#cb179-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-48"><a href="#cb179-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)){</span>
<span id="cb179-49"><a href="#cb179-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]])){</span>
<span id="cb179-50"><a href="#cb179-50" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-51"><a href="#cb179-51" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[k]]),</span>
<span id="cb179-52"><a href="#cb179-52" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-53"><a href="#cb179-53" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]), k)</span>
<span id="cb179-54"><a href="#cb179-54" aria-hidden="true" tabindex="-1"></a>      sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list[[k]])</span>
<span id="cb179-55"><a href="#cb179-55" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb179-56"><a href="#cb179-56" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sel_feats), <span class="fu">length</span>(<span class="fu">unique</span>(sel_feats)))</span>
<span id="cb179-57"><a href="#cb179-57" aria-hidden="true" tabindex="-1"></a>      n_clusts <span class="ot">&lt;-</span> k</span>
<span id="cb179-58"><a href="#cb179-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb179-59"><a href="#cb179-59" aria-hidden="true" tabindex="-1"></a>        clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb179-60"><a href="#cb179-60" aria-hidden="true" tabindex="-1"></a>        clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[k]][[i]]</span>
<span id="cb179-61"><a href="#cb179-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb179-62"><a href="#cb179-62" aria-hidden="true" tabindex="-1"></a>          clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i,</span>
<span id="cb179-63"><a href="#cb179-63" aria-hidden="true" tabindex="-1"></a>                                                     process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb179-64"><a href="#cb179-64" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb179-65"><a href="#cb179-65" aria-hidden="true" tabindex="-1"></a>        testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb179-66"><a href="#cb179-66" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb179-67"><a href="#cb179-67" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb179-68"><a href="#cb179-68" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-69"><a href="#cb179-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-70"><a href="#cb179-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-71"><a href="#cb179-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-72"><a href="#cb179-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try again with cluster representative lasso</span></span>
<span id="cb179-73"><a href="#cb179-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-74"><a href="#cb179-74" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb179-75"><a href="#cb179-75" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb179-76"><a href="#cb179-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-77"><a href="#cb179-77" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span>y, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb179-78"><a href="#cb179-78" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb179-79"><a href="#cb179-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-80"><a href="#cb179-80" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getClusterSelsFromGlmnet</span>(lasso_sets, process<span class="sc">$</span>clusters,</span>
<span id="cb179-81"><a href="#cb179-81" aria-hidden="true" tabindex="-1"></a>                                  process<span class="sc">$</span>prototypes, process<span class="sc">$</span>var_names)</span>
<span id="cb179-82"><a href="#cb179-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-83"><a href="#cb179-83" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb179-84"><a href="#cb179-84" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_sets&quot;</span>,</span>
<span id="cb179-85"><a href="#cb179-85" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb179-86"><a href="#cb179-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-87"><a href="#cb179-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_sets</span></span>
<span id="cb179-88"><a href="#cb179-88" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_sets))</span>
<span id="cb179-89"><a href="#cb179-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb179-90"><a href="#cb179-90" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets),</span>
<span id="cb179-91"><a href="#cb179-91" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets)))</span>
<span id="cb179-92"><a href="#cb179-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_sets)){</span>
<span id="cb179-93"><a href="#cb179-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]])){</span>
<span id="cb179-94"><a href="#cb179-94" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb179-95"><a href="#cb179-95" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_sets[[i]])))</span>
<span id="cb179-96"><a href="#cb179-96" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_sets[[i]] <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb179-97"><a href="#cb179-97" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[i]]), i)</span>
<span id="cb179-98"><a href="#cb179-98" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb179-99"><a href="#cb179-99" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb179-100"><a href="#cb179-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-101"><a href="#cb179-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-102"><a href="#cb179-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-103"><a href="#cb179-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-104"><a href="#cb179-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb179-105"><a href="#cb179-105" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb179-106"><a href="#cb179-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb179-107"><a href="#cb179-107" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list),</span>
<span id="cb179-108"><a href="#cb179-108" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list)))</span>
<span id="cb179-109"><a href="#cb179-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-110"><a href="#cb179-110" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)){</span>
<span id="cb179-111"><a href="#cb179-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]])){</span>
<span id="cb179-112"><a href="#cb179-112" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-113"><a href="#cb179-113" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[k]]),</span>
<span id="cb179-114"><a href="#cb179-114" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-115"><a href="#cb179-115" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]), k)</span>
<span id="cb179-116"><a href="#cb179-116" aria-hidden="true" tabindex="-1"></a>      sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list[[k]])</span>
<span id="cb179-117"><a href="#cb179-117" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb179-118"><a href="#cb179-118" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sel_feats), <span class="fu">length</span>(<span class="fu">unique</span>(sel_feats)))</span>
<span id="cb179-119"><a href="#cb179-119" aria-hidden="true" tabindex="-1"></a>      n_clusts <span class="ot">&lt;-</span> k</span>
<span id="cb179-120"><a href="#cb179-120" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb179-121"><a href="#cb179-121" aria-hidden="true" tabindex="-1"></a>        clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb179-122"><a href="#cb179-122" aria-hidden="true" tabindex="-1"></a>        clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[k]][[i]]</span>
<span id="cb179-123"><a href="#cb179-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb179-124"><a href="#cb179-124" aria-hidden="true" tabindex="-1"></a>          clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i,</span>
<span id="cb179-125"><a href="#cb179-125" aria-hidden="true" tabindex="-1"></a>                                                     process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb179-126"><a href="#cb179-126" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb179-127"><a href="#cb179-127" aria-hidden="true" tabindex="-1"></a>        testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb179-128"><a href="#cb179-128" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb179-129"><a href="#cb179-129" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb179-130"><a href="#cb179-130" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-131"><a href="#cb179-131" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-132"><a href="#cb179-132" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-133"><a href="#cb179-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-134"><a href="#cb179-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-135"><a href="#cb179-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-136"><a href="#cb179-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-137"><a href="#cb179-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-138"><a href="#cb179-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a data.frame</span></span>
<span id="cb179-139"><a href="#cb179-139" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb179-140"><a href="#cb179-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-141"><a href="#cb179-141" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X_df)</span>
<span id="cb179-142"><a href="#cb179-142" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb179-143"><a href="#cb179-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-144"><a href="#cb179-144" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>X_df, <span class="at">y=</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)),</span>
<span id="cb179-145"><a href="#cb179-145" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb179-146"><a href="#cb179-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-147"><a href="#cb179-147" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb179-148"><a href="#cb179-148" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb179-149"><a href="#cb179-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-150"><a href="#cb179-150" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df)), <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb179-151"><a href="#cb179-151" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb179-152"><a href="#cb179-152" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb179-153"><a href="#cb179-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-154"><a href="#cb179-154" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getClusterSelsFromGlmnet</span>(lasso_sets, process<span class="sc">$</span>clusters,</span>
<span id="cb179-155"><a href="#cb179-155" aria-hidden="true" tabindex="-1"></a>                                  process<span class="sc">$</span>prototypes, process<span class="sc">$</span>var_names)</span>
<span id="cb179-156"><a href="#cb179-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-157"><a href="#cb179-157" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb179-158"><a href="#cb179-158" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_sets&quot;</span>,</span>
<span id="cb179-159"><a href="#cb179-159" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb179-160"><a href="#cb179-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-161"><a href="#cb179-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_sets</span></span>
<span id="cb179-162"><a href="#cb179-162" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_sets))</span>
<span id="cb179-163"><a href="#cb179-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb179-164"><a href="#cb179-164" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets),</span>
<span id="cb179-165"><a href="#cb179-165" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets)))</span>
<span id="cb179-166"><a href="#cb179-166" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_sets)){</span>
<span id="cb179-167"><a href="#cb179-167" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]])){</span>
<span id="cb179-168"><a href="#cb179-168" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb179-169"><a href="#cb179-169" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_sets[[i]])))</span>
<span id="cb179-170"><a href="#cb179-170" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_sets[[i]] <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb179-171"><a href="#cb179-171" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[i]]), i)</span>
<span id="cb179-172"><a href="#cb179-172" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb179-173"><a href="#cb179-173" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb179-174"><a href="#cb179-174" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-175"><a href="#cb179-175" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-176"><a href="#cb179-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-177"><a href="#cb179-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-178"><a href="#cb179-178" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb179-179"><a href="#cb179-179" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb179-180"><a href="#cb179-180" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb179-181"><a href="#cb179-181" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list),</span>
<span id="cb179-182"><a href="#cb179-182" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list)))</span>
<span id="cb179-183"><a href="#cb179-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-184"><a href="#cb179-184" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)){</span>
<span id="cb179-185"><a href="#cb179-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]])){</span>
<span id="cb179-186"><a href="#cb179-186" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-187"><a href="#cb179-187" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[k]]),</span>
<span id="cb179-188"><a href="#cb179-188" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-189"><a href="#cb179-189" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]), k)</span>
<span id="cb179-190"><a href="#cb179-190" aria-hidden="true" tabindex="-1"></a>      sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list[[k]])</span>
<span id="cb179-191"><a href="#cb179-191" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(X_df_model)))</span>
<span id="cb179-192"><a href="#cb179-192" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sel_feats), <span class="fu">length</span>(<span class="fu">unique</span>(sel_feats)))</span>
<span id="cb179-193"><a href="#cb179-193" aria-hidden="true" tabindex="-1"></a>      n_clusts <span class="ot">&lt;-</span> k</span>
<span id="cb179-194"><a href="#cb179-194" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb179-195"><a href="#cb179-195" aria-hidden="true" tabindex="-1"></a>        clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb179-196"><a href="#cb179-196" aria-hidden="true" tabindex="-1"></a>        clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[k]][[i]]</span>
<span id="cb179-197"><a href="#cb179-197" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb179-198"><a href="#cb179-198" aria-hidden="true" tabindex="-1"></a>          clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i,</span>
<span id="cb179-199"><a href="#cb179-199" aria-hidden="true" tabindex="-1"></a>                                                     process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb179-200"><a href="#cb179-200" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb179-201"><a href="#cb179-201" aria-hidden="true" tabindex="-1"></a>        testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb179-202"><a href="#cb179-202" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb179-203"><a href="#cb179-203" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb179-204"><a href="#cb179-204" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-205"><a href="#cb179-205" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-206"><a href="#cb179-206" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-207"><a href="#cb179-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-208"><a href="#cb179-208" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a dataframe with factors (number of columns of final design matrix</span></span>
<span id="cb179-209"><a href="#cb179-209" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after one-hot encoding factors won&#39;t match number of columns of df2)</span></span>
<span id="cb179-210"><a href="#cb179-210" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> X_df</span>
<span id="cb179-211"><a href="#cb179-211" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>cyl)</span>
<span id="cb179-212"><a href="#cb179-212" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>vs)</span>
<span id="cb179-213"><a href="#cb179-213" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>am)</span>
<span id="cb179-214"><a href="#cb179-214" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>gear)</span>
<span id="cb179-215"><a href="#cb179-215" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>carb)</span>
<span id="cb179-216"><a href="#cb179-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-217"><a href="#cb179-217" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., df2)</span>
<span id="cb179-218"><a href="#cb179-218" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb179-219"><a href="#cb179-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-220"><a href="#cb179-220" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>df2, <span class="at">y=</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(df2)),</span>
<span id="cb179-221"><a href="#cb179-221" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb179-222"><a href="#cb179-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-223"><a href="#cb179-223" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb179-224"><a href="#cb179-224" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb179-225"><a href="#cb179-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-226"><a href="#cb179-226" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span><span class="fu">rnorm</span>(<span class="fu">nrow</span>(df2)), <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb179-227"><a href="#cb179-227" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb179-228"><a href="#cb179-228" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-229"><a href="#cb179-229" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb179-230"><a href="#cb179-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-231"><a href="#cb179-231" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getClusterSelsFromGlmnet</span>(lasso_sets, process<span class="sc">$</span>clusters,</span>
<span id="cb179-232"><a href="#cb179-232" aria-hidden="true" tabindex="-1"></a>                                  process<span class="sc">$</span>prototypes, process<span class="sc">$</span>var_names)</span>
<span id="cb179-233"><a href="#cb179-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-234"><a href="#cb179-234" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb179-235"><a href="#cb179-235" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_sets&quot;</span>,</span>
<span id="cb179-236"><a href="#cb179-236" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb179-237"><a href="#cb179-237" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-238"><a href="#cb179-238" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_sets</span></span>
<span id="cb179-239"><a href="#cb179-239" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_sets))</span>
<span id="cb179-240"><a href="#cb179-240" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb179-241"><a href="#cb179-241" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets),</span>
<span id="cb179-242"><a href="#cb179-242" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets)))</span>
<span id="cb179-243"><a href="#cb179-243" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_sets)){</span>
<span id="cb179-244"><a href="#cb179-244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]])){</span>
<span id="cb179-245"><a href="#cb179-245" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb179-246"><a href="#cb179-246" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_sets[[i]])))</span>
<span id="cb179-247"><a href="#cb179-247" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_sets[[i]] <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb179-248"><a href="#cb179-248" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[i]]), i)</span>
<span id="cb179-249"><a href="#cb179-249" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb179-250"><a href="#cb179-250" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb179-251"><a href="#cb179-251" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-252"><a href="#cb179-252" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-253"><a href="#cb179-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-254"><a href="#cb179-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-255"><a href="#cb179-255" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb179-256"><a href="#cb179-256" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb179-257"><a href="#cb179-257" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb179-258"><a href="#cb179-258" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list),</span>
<span id="cb179-259"><a href="#cb179-259" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list)))</span>
<span id="cb179-260"><a href="#cb179-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-261"><a href="#cb179-261" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)){</span>
<span id="cb179-262"><a href="#cb179-262" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]])){</span>
<span id="cb179-263"><a href="#cb179-263" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-264"><a href="#cb179-264" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[k]]),</span>
<span id="cb179-265"><a href="#cb179-265" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-266"><a href="#cb179-266" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]), k)</span>
<span id="cb179-267"><a href="#cb179-267" aria-hidden="true" tabindex="-1"></a>      sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list[[k]])</span>
<span id="cb179-268"><a href="#cb179-268" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(X_df_model)))</span>
<span id="cb179-269"><a href="#cb179-269" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sel_feats), <span class="fu">length</span>(<span class="fu">unique</span>(sel_feats)))</span>
<span id="cb179-270"><a href="#cb179-270" aria-hidden="true" tabindex="-1"></a>      n_clusts <span class="ot">&lt;-</span> k</span>
<span id="cb179-271"><a href="#cb179-271" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb179-272"><a href="#cb179-272" aria-hidden="true" tabindex="-1"></a>        clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb179-273"><a href="#cb179-273" aria-hidden="true" tabindex="-1"></a>        clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[k]][[i]]</span>
<span id="cb179-274"><a href="#cb179-274" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb179-275"><a href="#cb179-275" aria-hidden="true" tabindex="-1"></a>          clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i,</span>
<span id="cb179-276"><a href="#cb179-276" aria-hidden="true" tabindex="-1"></a>                                                     process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb179-277"><a href="#cb179-277" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb179-278"><a href="#cb179-278" aria-hidden="true" tabindex="-1"></a>        testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb179-279"><a href="#cb179-279" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb179-280"><a href="#cb179-280" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb179-281"><a href="#cb179-281" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-282"><a href="#cb179-282" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-283"><a href="#cb179-283" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-284"><a href="#cb179-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-285"><a href="#cb179-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-286"><a href="#cb179-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-287"><a href="#cb179-287" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a matrix with column names</span></span>
<span id="cb179-288"><a href="#cb179-288" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> x</span>
<span id="cb179-289"><a href="#cb179-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(x2) <span class="ot">&lt;-</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb179-290"><a href="#cb179-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-291"><a href="#cb179-291" aria-hidden="true" tabindex="-1"></a>  process <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(<span class="at">X=</span>x2, <span class="at">y=</span>y,</span>
<span id="cb179-292"><a href="#cb179-292" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">clusters=</span>good_clusters, <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb179-293"><a href="#cb179-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-294"><a href="#cb179-294" aria-hidden="true" tabindex="-1"></a>  X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(<span class="at">x=</span>process<span class="sc">$</span>x, <span class="at">clusters=</span>process<span class="sc">$</span>clusters,</span>
<span id="cb179-295"><a href="#cb179-295" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type=</span><span class="st">&quot;protolasso&quot;</span>, <span class="at">prototypes=</span>process<span class="sc">$</span>prototypes)</span>
<span id="cb179-296"><a href="#cb179-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-297"><a href="#cb179-297" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span>y, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb179-298"><a href="#cb179-298" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nlambda=</span><span class="dv">100</span>)</span>
<span id="cb179-299"><a href="#cb179-299" aria-hidden="true" tabindex="-1"></a>  lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb179-300"><a href="#cb179-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-301"><a href="#cb179-301" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">getClusterSelsFromGlmnet</span>(lasso_sets, process<span class="sc">$</span>clusters,</span>
<span id="cb179-302"><a href="#cb179-302" aria-hidden="true" tabindex="-1"></a>                                  process<span class="sc">$</span>prototypes, process<span class="sc">$</span>var_names)</span>
<span id="cb179-303"><a href="#cb179-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-304"><a href="#cb179-304" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb179-305"><a href="#cb179-305" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_sets&quot;</span>,</span>
<span id="cb179-306"><a href="#cb179-306" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>))</span>
<span id="cb179-307"><a href="#cb179-307" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-308"><a href="#cb179-308" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_sets</span></span>
<span id="cb179-309"><a href="#cb179-309" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_sets))</span>
<span id="cb179-310"><a href="#cb179-310" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb179-311"><a href="#cb179-311" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets),</span>
<span id="cb179-312"><a href="#cb179-312" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets)))</span>
<span id="cb179-313"><a href="#cb179-313" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_sets)){</span>
<span id="cb179-314"><a href="#cb179-314" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]])){</span>
<span id="cb179-315"><a href="#cb179-315" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb179-316"><a href="#cb179-316" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_sets[[i]])))</span>
<span id="cb179-317"><a href="#cb179-317" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_sets[[i]] <span class="sc">%in%</span> process<span class="sc">$</span>prototypes))</span>
<span id="cb179-318"><a href="#cb179-318" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[i]]), i)</span>
<span id="cb179-319"><a href="#cb179-319" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb179-320"><a href="#cb179-320" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb179-321"><a href="#cb179-321" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-322"><a href="#cb179-322" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-323"><a href="#cb179-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-324"><a href="#cb179-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-325"><a href="#cb179-325" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb179-326"><a href="#cb179-326" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb179-327"><a href="#cb179-327" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb179-328"><a href="#cb179-328" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list),</span>
<span id="cb179-329"><a href="#cb179-329" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list)))</span>
<span id="cb179-330"><a href="#cb179-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-331"><a href="#cb179-331" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)){</span>
<span id="cb179-332"><a href="#cb179-332" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]])){</span>
<span id="cb179-333"><a href="#cb179-333" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-334"><a href="#cb179-334" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[k]]),</span>
<span id="cb179-335"><a href="#cb179-335" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-336"><a href="#cb179-336" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]), k)</span>
<span id="cb179-337"><a href="#cb179-337" aria-hidden="true" tabindex="-1"></a>      sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list[[k]])</span>
<span id="cb179-338"><a href="#cb179-338" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb179-339"><a href="#cb179-339" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sel_feats), <span class="fu">length</span>(<span class="fu">unique</span>(sel_feats)))</span>
<span id="cb179-340"><a href="#cb179-340" aria-hidden="true" tabindex="-1"></a>      n_clusts <span class="ot">&lt;-</span> k</span>
<span id="cb179-341"><a href="#cb179-341" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb179-342"><a href="#cb179-342" aria-hidden="true" tabindex="-1"></a>        clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb179-343"><a href="#cb179-343" aria-hidden="true" tabindex="-1"></a>        clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[k]][[i]]</span>
<span id="cb179-344"><a href="#cb179-344" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(process<span class="sc">$</span>clusters)){</span>
<span id="cb179-345"><a href="#cb179-345" aria-hidden="true" tabindex="-1"></a>          clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i,</span>
<span id="cb179-346"><a href="#cb179-346" aria-hidden="true" tabindex="-1"></a>                                                     process<span class="sc">$</span>clusters[[j]])</span>
<span id="cb179-347"><a href="#cb179-347" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb179-348"><a href="#cb179-348" aria-hidden="true" tabindex="-1"></a>        testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb179-349"><a href="#cb179-349" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb179-350"><a href="#cb179-350" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb179-351"><a href="#cb179-351" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb179-352"><a href="#cb179-352" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-353"><a href="#cb179-353" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-354"><a href="#cb179-354" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-355"><a href="#cb179-355" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥳</code></pre>
<p>Finally, tests for <code>protolasso()</code>:</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">&quot;protolasso works&quot;</span>, {</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">61282</span>)</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span><span class="sc">*</span><span class="dv">11</span>), <span class="at">nrow=</span><span class="dv">15</span>, <span class="at">ncol=</span><span class="dv">11</span>)</span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">15</span>)</span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a>  good_clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">red_cluster=</span>1L<span class="sc">:</span>4L, <span class="at">green_cluster=</span>5L<span class="sc">:</span>8L)</span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get properly formatted clusters and prototypes for testing</span></span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>  format_clust_res <span class="ot">&lt;-</span> <span class="fu">formatClusters</span>(<span class="at">clusters=</span>good_clusters, <span class="at">p=</span><span class="dv">11</span>,</span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">clust_names=</span><span class="fu">names</span>(good_clusters),</span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">get_prototypes=</span><span class="cn">TRUE</span>, <span class="at">x=</span>x, <span class="at">y=</span>y)</span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a>  prototypes <span class="ot">&lt;-</span> format_clust_res<span class="sc">$</span>prototypes</span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>  clus_formatted <span class="ot">&lt;-</span> format_clust_res<span class="sc">$</span>clusters</span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">protolasso</span>(x, y, good_clusters)</span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_sets&quot;</span>,</span>
<span id="cb181-21"><a href="#cb181-21" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>, <span class="st">&quot;beta&quot;</span>))</span>
<span id="cb181-22"><a href="#cb181-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-23"><a href="#cb181-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_sets</span></span>
<span id="cb181-24"><a href="#cb181-24" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_sets))</span>
<span id="cb181-25"><a href="#cb181-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb181-26"><a href="#cb181-26" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets),</span>
<span id="cb181-27"><a href="#cb181-27" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets)))</span>
<span id="cb181-28"><a href="#cb181-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_sets)){</span>
<span id="cb181-29"><a href="#cb181-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]])){</span>
<span id="cb181-30"><a href="#cb181-30" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb181-31"><a href="#cb181-31" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_sets[[i]])))</span>
<span id="cb181-32"><a href="#cb181-32" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_sets[[i]] <span class="sc">%in%</span> prototypes))</span>
<span id="cb181-33"><a href="#cb181-33" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[i]]), i)</span>
<span id="cb181-34"><a href="#cb181-34" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb181-35"><a href="#cb181-35" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb181-36"><a href="#cb181-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb181-37"><a href="#cb181-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb181-38"><a href="#cb181-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-39"><a href="#cb181-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-40"><a href="#cb181-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb181-41"><a href="#cb181-41" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb181-42"><a href="#cb181-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb181-43"><a href="#cb181-43" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list),</span>
<span id="cb181-44"><a href="#cb181-44" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list)))</span>
<span id="cb181-45"><a href="#cb181-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-46"><a href="#cb181-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)){</span>
<span id="cb181-47"><a href="#cb181-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]])){</span>
<span id="cb181-48"><a href="#cb181-48" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb181-49"><a href="#cb181-49" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[k]]),</span>
<span id="cb181-50"><a href="#cb181-50" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb181-51"><a href="#cb181-51" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]), k)</span>
<span id="cb181-52"><a href="#cb181-52" aria-hidden="true" tabindex="-1"></a>      sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list[[k]])</span>
<span id="cb181-53"><a href="#cb181-53" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>))</span>
<span id="cb181-54"><a href="#cb181-54" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sel_feats), <span class="fu">length</span>(<span class="fu">unique</span>(sel_feats)))</span>
<span id="cb181-55"><a href="#cb181-55" aria-hidden="true" tabindex="-1"></a>      n_clusts <span class="ot">&lt;-</span> k</span>
<span id="cb181-56"><a href="#cb181-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb181-57"><a href="#cb181-57" aria-hidden="true" tabindex="-1"></a>        clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb181-58"><a href="#cb181-58" aria-hidden="true" tabindex="-1"></a>        clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[k]][[i]]</span>
<span id="cb181-59"><a href="#cb181-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(clus_formatted)){</span>
<span id="cb181-60"><a href="#cb181-60" aria-hidden="true" tabindex="-1"></a>          clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i,</span>
<span id="cb181-61"><a href="#cb181-61" aria-hidden="true" tabindex="-1"></a>                                                     clus_formatted[[j]])</span>
<span id="cb181-62"><a href="#cb181-62" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb181-63"><a href="#cb181-63" aria-hidden="true" tabindex="-1"></a>        testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb181-64"><a href="#cb181-64" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb181-65"><a href="#cb181-65" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb181-66"><a href="#cb181-66" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb181-67"><a href="#cb181-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb181-68"><a href="#cb181-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb181-69"><a href="#cb181-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-70"><a href="#cb181-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-71"><a href="#cb181-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-72"><a href="#cb181-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-73"><a href="#cb181-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-74"><a href="#cb181-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-75"><a href="#cb181-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-76"><a href="#cb181-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a data.frame</span></span>
<span id="cb181-77"><a href="#cb181-77" aria-hidden="true" tabindex="-1"></a>  X_df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>mtcars</span>
<span id="cb181-78"><a href="#cb181-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-79"><a href="#cb181-79" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., X_df)</span>
<span id="cb181-80"><a href="#cb181-80" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb181-81"><a href="#cb181-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-82"><a href="#cb181-82" aria-hidden="true" tabindex="-1"></a>  y_df <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(X_df))</span>
<span id="cb181-83"><a href="#cb181-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-84"><a href="#cb181-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get properly formatted clusters and prototypes for testing</span></span>
<span id="cb181-85"><a href="#cb181-85" aria-hidden="true" tabindex="-1"></a>  format_clust_res <span class="ot">&lt;-</span> <span class="fu">formatClusters</span>(<span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">p=</span><span class="fu">ncol</span>(X_df_model),</span>
<span id="cb181-86"><a href="#cb181-86" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">get_prototypes=</span><span class="cn">TRUE</span>, <span class="at">x=</span>X_df_model, <span class="at">y=</span>y_df)</span>
<span id="cb181-87"><a href="#cb181-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-88"><a href="#cb181-88" aria-hidden="true" tabindex="-1"></a>  prototypes <span class="ot">&lt;-</span> format_clust_res<span class="sc">$</span>prototypes</span>
<span id="cb181-89"><a href="#cb181-89" aria-hidden="true" tabindex="-1"></a>  clus_formatted <span class="ot">&lt;-</span> format_clust_res<span class="sc">$</span>clusters</span>
<span id="cb181-90"><a href="#cb181-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-91"><a href="#cb181-91" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">protolasso</span>(X_df, y_df, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb181-92"><a href="#cb181-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-93"><a href="#cb181-93" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb181-94"><a href="#cb181-94" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_sets&quot;</span>,</span>
<span id="cb181-95"><a href="#cb181-95" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>, <span class="st">&quot;beta&quot;</span>))</span>
<span id="cb181-96"><a href="#cb181-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-97"><a href="#cb181-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_sets</span></span>
<span id="cb181-98"><a href="#cb181-98" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_sets))</span>
<span id="cb181-99"><a href="#cb181-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb181-100"><a href="#cb181-100" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets),</span>
<span id="cb181-101"><a href="#cb181-101" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets)))</span>
<span id="cb181-102"><a href="#cb181-102" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_sets)){</span>
<span id="cb181-103"><a href="#cb181-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]])){</span>
<span id="cb181-104"><a href="#cb181-104" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb181-105"><a href="#cb181-105" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_sets[[i]])))</span>
<span id="cb181-106"><a href="#cb181-106" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(res<span class="sc">$</span>selected_sets[[i]] <span class="sc">%in%</span> prototypes))</span>
<span id="cb181-107"><a href="#cb181-107" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[i]]), i)</span>
<span id="cb181-108"><a href="#cb181-108" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb181-109"><a href="#cb181-109" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb181-110"><a href="#cb181-110" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb181-111"><a href="#cb181-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb181-112"><a href="#cb181-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-113"><a href="#cb181-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-114"><a href="#cb181-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_clusts_list</span></span>
<span id="cb181-115"><a href="#cb181-115" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list))</span>
<span id="cb181-116"><a href="#cb181-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb181-117"><a href="#cb181-117" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list),</span>
<span id="cb181-118"><a href="#cb181-118" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_clusts_list)))</span>
<span id="cb181-119"><a href="#cb181-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-120"><a href="#cb181-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list)){</span>
<span id="cb181-121"><a href="#cb181-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]])){</span>
<span id="cb181-122"><a href="#cb181-122" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb181-123"><a href="#cb181-123" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_sets[[k]]),</span>
<span id="cb181-124"><a href="#cb181-124" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb181-125"><a href="#cb181-125" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(res<span class="sc">$</span>selected_clusts_list[[k]]), k)</span>
<span id="cb181-126"><a href="#cb181-126" aria-hidden="true" tabindex="-1"></a>      sel_feats <span class="ot">&lt;-</span> <span class="fu">unlist</span>(res<span class="sc">$</span>selected_clusts_list[[k]])</span>
<span id="cb181-127"><a href="#cb181-127" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(sel_feats <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(X_df_model)))</span>
<span id="cb181-128"><a href="#cb181-128" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">length</span>(sel_feats), <span class="fu">length</span>(<span class="fu">unique</span>(sel_feats)))</span>
<span id="cb181-129"><a href="#cb181-129" aria-hidden="true" tabindex="-1"></a>      n_clusts <span class="ot">&lt;-</span> k</span>
<span id="cb181-130"><a href="#cb181-130" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_clusts){</span>
<span id="cb181-131"><a href="#cb181-131" aria-hidden="true" tabindex="-1"></a>        clust_i_found <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb181-132"><a href="#cb181-132" aria-hidden="true" tabindex="-1"></a>        clust_i <span class="ot">&lt;-</span> res<span class="sc">$</span>selected_clusts_list[[k]][[i]]</span>
<span id="cb181-133"><a href="#cb181-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(clus_formatted)){</span>
<span id="cb181-134"><a href="#cb181-134" aria-hidden="true" tabindex="-1"></a>          clust_i_found <span class="ot">&lt;-</span> clust_i_found <span class="sc">|</span> <span class="fu">identical</span>(clust_i,</span>
<span id="cb181-135"><a href="#cb181-135" aria-hidden="true" tabindex="-1"></a>                                                     clus_formatted[[j]])</span>
<span id="cb181-136"><a href="#cb181-136" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb181-137"><a href="#cb181-137" aria-hidden="true" tabindex="-1"></a>        testthat<span class="sc">::</span><span class="fu">expect_true</span>(clust_i_found)</span>
<span id="cb181-138"><a href="#cb181-138" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb181-139"><a href="#cb181-139" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb181-140"><a href="#cb181-140" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_clusts_list[[k]]))</span>
<span id="cb181-141"><a href="#cb181-141" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb181-142"><a href="#cb181-142" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb181-143"><a href="#cb181-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-144"><a href="#cb181-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X as a dataframe with factors (number of columns of final design matrix</span></span>
<span id="cb181-145"><a href="#cb181-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after one-hot encoding factors won&#39;t match number of columns of df2)</span></span>
<span id="cb181-146"><a href="#cb181-146" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> X_df</span>
<span id="cb181-147"><a href="#cb181-147" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>cyl)</span>
<span id="cb181-148"><a href="#cb181-148" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>vs <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>vs)</span>
<span id="cb181-149"><a href="#cb181-149" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>am)</span>
<span id="cb181-150"><a href="#cb181-150" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>gear <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>gear)</span>
<span id="cb181-151"><a href="#cb181-151" aria-hidden="true" tabindex="-1"></a>  df2<span class="sc">$</span>carb <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>carb)</span>
<span id="cb181-152"><a href="#cb181-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-153"><a href="#cb181-153" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(<span class="sc">~</span> ., df2)</span>
<span id="cb181-154"><a href="#cb181-154" aria-hidden="true" tabindex="-1"></a>  X_df_model <span class="ot">&lt;-</span> X_df_model[, <span class="fu">colnames</span>(X_df_model) <span class="sc">!=</span> <span class="st">&quot;(Intercept)&quot;</span>]</span>
<span id="cb181-155"><a href="#cb181-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-156"><a href="#cb181-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-157"><a href="#cb181-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get properly formatted clusters and prototypes for testing</span></span>
<span id="cb181-158"><a href="#cb181-158" aria-hidden="true" tabindex="-1"></a>  format_clust_res <span class="ot">&lt;-</span> <span class="fu">formatClusters</span>(<span class="at">clusters=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">p=</span><span class="fu">ncol</span>(X_df_model),</span>
<span id="cb181-159"><a href="#cb181-159" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">get_prototypes=</span><span class="cn">TRUE</span>, <span class="at">x=</span>X_df_model, <span class="at">y=</span>y_df)</span>
<span id="cb181-160"><a href="#cb181-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-161"><a href="#cb181-161" aria-hidden="true" tabindex="-1"></a>  prototypes <span class="ot">&lt;-</span> format_clust_res<span class="sc">$</span>prototypes</span>
<span id="cb181-162"><a href="#cb181-162" aria-hidden="true" tabindex="-1"></a>  clus_formatted <span class="ot">&lt;-</span> format_clust_res<span class="sc">$</span>clusters</span>
<span id="cb181-163"><a href="#cb181-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-164"><a href="#cb181-164" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">protolasso</span>(X_df, y_df, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb181-165"><a href="#cb181-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-166"><a href="#cb181-166" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res))</span>
<span id="cb181-167"><a href="#cb181-167" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">names</span>(res), <span class="fu">c</span>(<span class="st">&quot;selected_sets&quot;</span>,</span>
<span id="cb181-168"><a href="#cb181-168" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&quot;selected_clusts_list&quot;</span>, <span class="st">&quot;beta&quot;</span>))</span>
<span id="cb181-169"><a href="#cb181-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-170"><a href="#cb181-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-171"><a href="#cb181-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># selected_sets</span></span>
<span id="cb181-172"><a href="#cb181-172" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.list</span>(res<span class="sc">$</span>selected_sets))</span>
<span id="cb181-173"><a href="#cb181-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selected models should have one of each size without repetition</span></span>
<span id="cb181-174"><a href="#cb181-174" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_identical</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets),</span>
<span id="cb181-175"><a href="#cb181-175" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">unique</span>(<span class="fu">lengths</span>(res<span class="sc">$</span>selected_sets)))</span>
<span id="cb181-176"><a href="#cb181-176" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res<span class="sc">$</span>selected_sets)){</span>
<span id="cb181-177"><a href="#cb181-177" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]])){</span>
<span id="cb181-178"><a href="#cb181-178" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.integer</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb181-179"><a href="#cb181-179" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(res<span class="sc">$</span>selected_sets[[i]])))</span>
<span id="cb181-180"><a href="#cb181-180" aria-hidden="true" tabindex="-1"></a>      <span class="co"># testthat::expect_true(all(res$selected_sets[[i]] %in% prototypes))</span></span>
<span id="cb181-181"><a href="#cb181-181" aria-hidden="true" tabindex="-1"></a>      <span class="co"># testthat::expect_equal(length(res$selected_sets[[i]]), i)</span></span>
<span id="cb181-182"><a href="#cb181-182" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb181-183"><a href="#cb181-183" aria-hidden="true" tabindex="-1"></a>      testthat<span class="sc">::</span><span class="fu">expect_true</span>(<span class="fu">is.null</span>(res<span class="sc">$</span>selected_sets[[i]]))</span>
<span id="cb181-184"><a href="#cb181-184" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb181-185"><a href="#cb181-185" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb181-186"><a href="#cb181-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-187"><a href="#cb181-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-188"><a href="#cb181-188" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # selected_clusts_list</span></span>
<span id="cb181-189"><a href="#cb181-189" aria-hidden="true" tabindex="-1"></a>  <span class="co"># testthat::expect_true(is.list(res$selected_clusts_list))</span></span>
<span id="cb181-190"><a href="#cb181-190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Selected models should have one of each size without repetition</span></span>
<span id="cb181-191"><a href="#cb181-191" aria-hidden="true" tabindex="-1"></a>  <span class="co"># testthat::expect_identical(lengths(res$selected_clusts_list),</span></span>
<span id="cb181-192"><a href="#cb181-192" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                        unique(lengths(res$selected_clusts_list)))</span></span>
<span id="cb181-193"><a href="#cb181-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-194"><a href="#cb181-194" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for(k in 1:length(res$selected_clusts_list)){</span></span>
<span id="cb181-195"><a href="#cb181-195" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   if(!is.null(res$selected_clusts_list[[k]])){</span></span>
<span id="cb181-196"><a href="#cb181-196" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_true(is.list(res$selected_clusts_list[[k]]))</span></span>
<span id="cb181-197"><a href="#cb181-197" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_equal(length(res$selected_sets[[k]]),</span></span>
<span id="cb181-198"><a href="#cb181-198" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                            length(res$selected_clusts_list[[k]]))</span></span>
<span id="cb181-199"><a href="#cb181-199" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_equal(length(res$selected_clusts_list[[k]]), k)</span></span>
<span id="cb181-200"><a href="#cb181-200" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     sel_feats &lt;- unlist(res$selected_clusts_list[[k]])</span></span>
<span id="cb181-201"><a href="#cb181-201" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_true(all(sel_feats %in% 1:ncol(X_df_model)))</span></span>
<span id="cb181-202"><a href="#cb181-202" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_equal(length(sel_feats), length(unique(sel_feats)))</span></span>
<span id="cb181-203"><a href="#cb181-203" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     n_clusts &lt;- k</span></span>
<span id="cb181-204"><a href="#cb181-204" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     for(i in 1:n_clusts){</span></span>
<span id="cb181-205"><a href="#cb181-205" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       clust_i_found &lt;- FALSE</span></span>
<span id="cb181-206"><a href="#cb181-206" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       clust_i &lt;- res$selected_clusts_list[[k]][[i]]</span></span>
<span id="cb181-207"><a href="#cb181-207" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       for(j in 1:length(clus_formatted)){</span></span>
<span id="cb181-208"><a href="#cb181-208" aria-hidden="true" tabindex="-1"></a>  <span class="co">#         clust_i_found &lt;- clust_i_found | identical(clust_i,</span></span>
<span id="cb181-209"><a href="#cb181-209" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                                                    clus_formatted[[j]])</span></span>
<span id="cb181-210"><a href="#cb181-210" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       }</span></span>
<span id="cb181-211"><a href="#cb181-211" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       testthat::expect_true(clust_i_found)</span></span>
<span id="cb181-212"><a href="#cb181-212" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     }</span></span>
<span id="cb181-213"><a href="#cb181-213" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   } else{</span></span>
<span id="cb181-214"><a href="#cb181-214" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_true(is.null(res$selected_clusts_list[[k]]))</span></span>
<span id="cb181-215"><a href="#cb181-215" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   }</span></span>
<span id="cb181-216"><a href="#cb181-216" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb181-217"><a href="#cb181-217" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-218"><a href="#cb181-218" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-219"><a href="#cb181-219" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-220"><a href="#cb181-220" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # X as a matrix with column names</span></span>
<span id="cb181-221"><a href="#cb181-221" aria-hidden="true" tabindex="-1"></a>  <span class="co"># x2 &lt;- x</span></span>
<span id="cb181-222"><a href="#cb181-222" aria-hidden="true" tabindex="-1"></a>  <span class="co"># colnames(x2) &lt;- LETTERS[1:11]</span></span>
<span id="cb181-223"><a href="#cb181-223" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-224"><a href="#cb181-224" aria-hidden="true" tabindex="-1"></a>  <span class="co"># process &lt;- processClusterLassoInputs(X=x2, y=y,</span></span>
<span id="cb181-225"><a href="#cb181-225" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                                      clusters=good_clusters, nlambda=100)</span></span>
<span id="cb181-226"><a href="#cb181-226" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-227"><a href="#cb181-227" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X_glmnet &lt;- getXglmnet(x=process$x, clusters=process$clusters,</span></span>
<span id="cb181-228"><a href="#cb181-228" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                        type=&quot;protolasso&quot;, prototypes=process$prototypes)</span></span>
<span id="cb181-229"><a href="#cb181-229" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-230"><a href="#cb181-230" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fit &lt;- glmnet::glmnet(x=X_glmnet, y=y, family=&quot;gaussian&quot;,</span></span>
<span id="cb181-231"><a href="#cb181-231" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                       nlambda=100)</span></span>
<span id="cb181-232"><a href="#cb181-232" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lasso_sets &lt;- unique(glmnet::predict.glmnet(fit, type=&quot;nonzero&quot;))</span></span>
<span id="cb181-233"><a href="#cb181-233" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-234"><a href="#cb181-234" aria-hidden="true" tabindex="-1"></a>  <span class="co"># res &lt;- protolasso(lasso_sets, process$clusters,</span></span>
<span id="cb181-235"><a href="#cb181-235" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                                 process$prototypes, process$var_names)</span></span>
<span id="cb181-236"><a href="#cb181-236" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-237"><a href="#cb181-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># testthat::expect_true(is.list(res))</span></span>
<span id="cb181-238"><a href="#cb181-238" aria-hidden="true" tabindex="-1"></a>  <span class="co"># testthat::expect_identical(names(res), c(&quot;selected_sets&quot;,</span></span>
<span id="cb181-239"><a href="#cb181-239" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                                          &quot;selected_clusts_list&quot;))</span></span>
<span id="cb181-240"><a href="#cb181-240" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-241"><a href="#cb181-241" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # selected_sets</span></span>
<span id="cb181-242"><a href="#cb181-242" aria-hidden="true" tabindex="-1"></a>  <span class="co"># testthat::expect_true(is.list(res$selected_sets))</span></span>
<span id="cb181-243"><a href="#cb181-243" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Selected models should have one of each size without repetition</span></span>
<span id="cb181-244"><a href="#cb181-244" aria-hidden="true" tabindex="-1"></a>  <span class="co"># testthat::expect_identical(lengths(res$selected_sets),</span></span>
<span id="cb181-245"><a href="#cb181-245" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                        unique(lengths(res$selected_sets)))</span></span>
<span id="cb181-246"><a href="#cb181-246" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for(i in 1:length(res$selected_sets)){</span></span>
<span id="cb181-247"><a href="#cb181-247" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   if(!is.null(res$selected_sets[[i]])){</span></span>
<span id="cb181-248"><a href="#cb181-248" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_true(is.integer(res$selected_sets[[i]]))</span></span>
<span id="cb181-249"><a href="#cb181-249" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_true(all(!is.na(res$selected_sets[[i]])))</span></span>
<span id="cb181-250"><a href="#cb181-250" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_true(all(res$selected_sets[[i]] %in% process$prototypes))</span></span>
<span id="cb181-251"><a href="#cb181-251" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_equal(length(res$selected_sets[[i]]), i)</span></span>
<span id="cb181-252"><a href="#cb181-252" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   } else{</span></span>
<span id="cb181-253"><a href="#cb181-253" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_true(is.null(res$selected_sets[[i]]))</span></span>
<span id="cb181-254"><a href="#cb181-254" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   }</span></span>
<span id="cb181-255"><a href="#cb181-255" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb181-256"><a href="#cb181-256" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-257"><a href="#cb181-257" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-258"><a href="#cb181-258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # selected_clusts_list</span></span>
<span id="cb181-259"><a href="#cb181-259" aria-hidden="true" tabindex="-1"></a>  <span class="co"># testthat::expect_true(is.list(res$selected_clusts_list))</span></span>
<span id="cb181-260"><a href="#cb181-260" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Selected models should have one of each size without repetition</span></span>
<span id="cb181-261"><a href="#cb181-261" aria-hidden="true" tabindex="-1"></a>  <span class="co"># testthat::expect_identical(lengths(res$selected_clusts_list),</span></span>
<span id="cb181-262"><a href="#cb181-262" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                        unique(lengths(res$selected_clusts_list)))</span></span>
<span id="cb181-263"><a href="#cb181-263" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb181-264"><a href="#cb181-264" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for(k in 1:length(res$selected_clusts_list)){</span></span>
<span id="cb181-265"><a href="#cb181-265" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   if(!is.null(res$selected_clusts_list[[k]])){</span></span>
<span id="cb181-266"><a href="#cb181-266" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_true(is.list(res$selected_clusts_list[[k]]))</span></span>
<span id="cb181-267"><a href="#cb181-267" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_equal(length(res$selected_sets[[k]]),</span></span>
<span id="cb181-268"><a href="#cb181-268" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                            length(res$selected_clusts_list[[k]]))</span></span>
<span id="cb181-269"><a href="#cb181-269" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_equal(length(res$selected_clusts_list[[k]]), k)</span></span>
<span id="cb181-270"><a href="#cb181-270" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     sel_feats &lt;- unlist(res$selected_clusts_list[[k]])</span></span>
<span id="cb181-271"><a href="#cb181-271" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_true(all(sel_feats %in% 1:11))</span></span>
<span id="cb181-272"><a href="#cb181-272" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_equal(length(sel_feats), length(unique(sel_feats)))</span></span>
<span id="cb181-273"><a href="#cb181-273" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     n_clusts &lt;- k</span></span>
<span id="cb181-274"><a href="#cb181-274" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     for(i in 1:n_clusts){</span></span>
<span id="cb181-275"><a href="#cb181-275" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       clust_i_found &lt;- FALSE</span></span>
<span id="cb181-276"><a href="#cb181-276" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       clust_i &lt;- res$selected_clusts_list[[k]][[i]]</span></span>
<span id="cb181-277"><a href="#cb181-277" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       for(j in 1:length(process$clusters)){</span></span>
<span id="cb181-278"><a href="#cb181-278" aria-hidden="true" tabindex="-1"></a>  <span class="co">#         clust_i_found &lt;- clust_i_found | identical(clust_i,</span></span>
<span id="cb181-279"><a href="#cb181-279" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                                                    process$clusters[[j]])</span></span>
<span id="cb181-280"><a href="#cb181-280" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       }</span></span>
<span id="cb181-281"><a href="#cb181-281" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       testthat::expect_true(clust_i_found)</span></span>
<span id="cb181-282"><a href="#cb181-282" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     }</span></span>
<span id="cb181-283"><a href="#cb181-283" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   } else{</span></span>
<span id="cb181-284"><a href="#cb181-284" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     testthat::expect_true(is.null(res$selected_clusts_list[[k]]))</span></span>
<span id="cb181-285"><a href="#cb181-285" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   }</span></span>
<span id="cb181-286"><a href="#cb181-286" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb181-287"><a href="#cb181-287" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-288"><a href="#cb181-288" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-289"><a href="#cb181-289" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-290"><a href="#cb181-290" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-291"><a href="#cb181-291" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Test for names of features, clusters</span></span>
<span id="cb181-292"><a href="#cb181-292" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-293"><a href="#cb181-293" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bad inputs</span></span>
<span id="cb181-294"><a href="#cb181-294" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-295"><a href="#cb181-295" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed 🥇</code></pre>
<p><code>clusterRepLasso()</code>:</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Select features via the cluster representative lasso (Bühlmann et. al. 2013)</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param X An n x p numeric matrix (preferably) or a data.frame (which will</span></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; be coerced internally to a matrix by the function model.matrix) containing</span></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; p &gt;= 2 features/predictors</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y The response; A length n numeric (or integer) real-valued vector.</span></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param clusters A list of integer vectors; each vector should contain the </span></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; indices of a cluster of features (a subset of 1:p). (If there is only one</span></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster, clusters can either be a list of length 1 or an integer vector.)</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; All of the provided clusters must be non-overlapping. Every feature not</span></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; appearing in any cluster will be assumed to be unclustered (that is, they</span></span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; will be treated as if they are in a &quot;cluster&quot; containing only themselves).</span></span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Default is list() (so no clusters are specified).</span></span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param nlambda Integer; the number of lambda values to use in the lasso fit</span></span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for the cluster representative lasso. Default is 100 (following the default</span></span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; for glmnet). For now, nlambda must be at least 2 (using a single lambda is</span></span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; not supported).</span></span>
<span id="cb183-18"><a href="#cb183-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return A list with three elements. \item{selected_sets}{A list of integer</span></span>
<span id="cb183-19"><a href="#cb183-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; vectors. Entry k of this list contains a selected set (an integer vector) of</span></span>
<span id="cb183-20"><a href="#cb183-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; size k yielded by the lasso--each member of the set is the index of a single</span></span>
<span id="cb183-21"><a href="#cb183-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; feature from a cluster selected by the cluster representative lasso (the</span></span>
<span id="cb183-22"><a href="#cb183-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; prototype from that cluster--the cluster member most highly correlated with</span></span>
<span id="cb183-23"><a href="#cb183-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; y). (If no set of size k was selected, entry k will be empty.)}</span></span>
<span id="cb183-24"><a href="#cb183-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \item{selected_clusts_list}{A list; each element of the list is a named list</span></span>
<span id="cb183-25"><a href="#cb183-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of selected clusters. (That is, if a selected set of size k was yielded by</span></span>
<span id="cb183-26"><a href="#cb183-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; the cluster representative lasso, then selected_clusts_list[[k]] is a named</span></span>
<span id="cb183-27"><a href="#cb183-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; list of length k, where each member of the list is an integer vector</span></span>
<span id="cb183-28"><a href="#cb183-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; of cluster members. Note that selected_clusts_lists[[k]][[j]] will be the</span></span>
<span id="cb183-29"><a href="#cb183-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; cluster that contains feature selected_sets[[k]][j].)} \item{beta}{The beta</span></span>
<span id="cb183-30"><a href="#cb183-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; output from glmnet when the lasso was estimated on a matrix of prototypes.</span></span>
<span id="cb183-31"><a href="#cb183-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (See documentation for the function glmnet from the glmnet package for</span></span>
<span id="cb183-32"><a href="#cb183-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; details.)}</span></span>
<span id="cb183-33"><a href="#cb183-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @references Bühlmann, P., Rütimann, P., van de Geer, S., &amp; Zhang, C. H.</span></span>
<span id="cb183-34"><a href="#cb183-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; (2013). Correlated variables in regression: Clustering and sparse estimation.</span></span>
<span id="cb183-35"><a href="#cb183-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \emph{Journal of Statistical Planning and Inference}, 143(11), 1835–1858.</span></span>
<span id="cb183-36"><a href="#cb183-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; \url{https://doi.org/10.1016/j.jspi.2013.05.019}. \cr Jerome Friedman, Trevor</span></span>
<span id="cb183-37"><a href="#cb183-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Hastie, Robert Tibshirani (2010). Regularization Paths for Generalized Linear</span></span>
<span id="cb183-38"><a href="#cb183-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Models via Coordinate Descent. \emph{Journal of Statistical Software}, 33(1)</span></span>
<span id="cb183-39"><a href="#cb183-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; &#39; 1-22. URL \url{https://www.jstatsoft.org/v33/i01/}.</span></span>
<span id="cb183-40"><a href="#cb183-40" aria-hidden="true" tabindex="-1"></a>clusterRepLasso <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, <span class="at">clusters=</span><span class="fu">list</span>(), <span class="at">nlambda=</span><span class="dv">100</span>){</span>
<span id="cb183-41"><a href="#cb183-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-42"><a href="#cb183-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle and format inputs; get cluster prototypes</span></span>
<span id="cb183-43"><a href="#cb183-43" aria-hidden="true" tabindex="-1"></a>    ret <span class="ot">&lt;-</span> <span class="fu">processClusterLassoInputs</span>(X, y, clusters, nlambda)</span>
<span id="cb183-44"><a href="#cb183-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-45"><a href="#cb183-45" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> ret<span class="sc">$</span>x</span>
<span id="cb183-46"><a href="#cb183-46" aria-hidden="true" tabindex="-1"></a>    clusters <span class="ot">&lt;-</span> ret<span class="sc">$</span>clusters</span>
<span id="cb183-47"><a href="#cb183-47" aria-hidden="true" tabindex="-1"></a>    prototypes <span class="ot">&lt;-</span> ret<span class="sc">$</span>prototypes</span>
<span id="cb183-48"><a href="#cb183-48" aria-hidden="true" tabindex="-1"></a>    feat_names <span class="ot">&lt;-</span> ret<span class="sc">$</span>var_names</span>
<span id="cb183-49"><a href="#cb183-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-50"><a href="#cb183-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(ret)</span>
<span id="cb183-51"><a href="#cb183-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-52"><a href="#cb183-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format the design matrix for glmnet according to the cluster</span></span>
<span id="cb183-53"><a href="#cb183-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># representative lasso procedure</span></span>
<span id="cb183-54"><a href="#cb183-54" aria-hidden="true" tabindex="-1"></a>    X_glmnet <span class="ot">&lt;-</span> <span class="fu">getXglmnet</span>(x, clusters, <span class="at">type=</span><span class="st">&quot;clusterRepLasso&quot;</span>)</span>
<span id="cb183-55"><a href="#cb183-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-56"><a href="#cb183-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimate the lasso on the cluster representatives</span></span>
<span id="cb183-57"><a href="#cb183-57" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x=</span>X_glmnet, <span class="at">y=</span>y, <span class="at">family=</span><span class="st">&quot;gaussian&quot;</span>, <span class="at">nlambda=</span>nlambda)</span>
<span id="cb183-58"><a href="#cb183-58" aria-hidden="true" tabindex="-1"></a>    lasso_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(glmnet<span class="sc">::</span><span class="fu">predict.glmnet</span>(fit, <span class="at">type=</span><span class="st">&quot;nonzero&quot;</span>))</span>
<span id="cb183-59"><a href="#cb183-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-60"><a href="#cb183-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Finally, extract the desired information from the lasso fit--all the</span></span>
<span id="cb183-61"><a href="#cb183-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sets of selected clusters (one for each observed model size), and</span></span>
<span id="cb183-62"><a href="#cb183-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># corresponding sets of selected features</span></span>
<span id="cb183-63"><a href="#cb183-63" aria-hidden="true" tabindex="-1"></a>    cluster_sel_results <span class="ot">&lt;-</span> <span class="fu">getClusterSelsFromGlmnet</span>(lasso_sets, clusters,</span>
<span id="cb183-64"><a href="#cb183-64" aria-hidden="true" tabindex="-1"></a>        prototypes, feat_names)</span>
<span id="cb183-65"><a href="#cb183-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-66"><a href="#cb183-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">selected_sets=</span>cluster_sel_results<span class="sc">$</span>selected_sets,</span>
<span id="cb183-67"><a href="#cb183-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">selected_clusts_list=</span>cluster_sel_results<span class="sc">$</span>selected_clusts_list,</span>
<span id="cb183-68"><a href="#cb183-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta=</span>fit<span class="sc">$</span>beta))</span>
<span id="cb183-69"><a href="#cb183-69" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Tests for <code>clusterRepLasso()</code>:</p>
</div>
<div id="documenting-the-package-and-adding-readme" class="section level1 hasAnchor" number="9">
<h1 class="hasAnchor"><span class="header-section-number">9</span> Documenting the package and adding README<a href="#documenting-the-package-and-adding-readme" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We finish by running commands that will document, build, and install the package. It may also be a good idea to check the package from within this file.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>litr<span class="sc">::</span><span class="fu">document</span>() <span class="co"># &lt;-- use instead of devtools::document()</span></span></code></pre></div>
<pre><code>## ℹ Updating cssr documentation
## ℹ Loading cssr
## Writing &#39;]8;;file:///Users/gregfaletto/Documents/GitHub/cssr-project/cssr/NAMESPACENAMESPACE]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkB&#39;)checkB.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkClusters&#39;)checkClusters.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkCssClustersInput&#39;)checkCssClustersInput.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkCssInputs&#39;)checkCssInputs.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkCssLassoInputs&#39;)checkCssLassoInputs.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkCssLoopOutput&#39;)checkCssLoopOutput.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkCutoff&#39;)checkCutoff.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkFormCssDesignInputs&#39;)checkFormCssDesignInputs.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkFormatClustersInput&#39;)checkFormatClustersInput.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkGenClusteredDataInputs&#39;)checkGenClusteredDataInputs.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkGetClusterSelMatrixInput&#39;)checkGetClusterSelMatrixInput.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkGetCssPredsInputs&#39;)checkGetCssPredsInputs.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkGetSelectedClustersOutput&#39;)checkGetSelectedClustersOutput.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkGetXglmnetInputs&#39;)checkGetXglmnetInputs.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkMaxNumClusts&#39;)checkMaxNumClusts.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkMinNumClusts&#39;)checkMinNumClusts.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkNewXProvided&#39;)checkNewXProvided.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkPropFeatsRemove&#39;)checkPropFeatsRemove.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkSamplingType&#39;)checkSamplingType.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkSelectedClusters&#39;)checkSelectedClusters.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkWeighting&#39;)checkWeighting.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkXInputResults&#39;)checkXInputResults.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;checkY&#39;)checkY.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;clusterRepLasso&#39;)clusterRepLasso.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;corFunction&#39;)corFunction.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;createSubsamples&#39;)createSubsamples.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;css&#39;)css.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;cssLasso&#39;)cssLasso.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;cssLoop&#39;)cssLoop.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;cssPredict&#39;)cssPredict.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;cssSelect&#39;)cssSelect.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;cssr-package&#39;)cssr-package.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;formCssDesign&#39;)formCssDesign.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;formatClusters&#39;)formatClusters.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;genClusteredData&#39;)genClusteredData.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;genMuXZSd&#39;)genMuXZSd.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getAllClustWeights&#39;)getAllClustWeights.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getClustWeights&#39;)getClustWeights.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getClusterSelMatrix&#39;)getClusterSelMatrix.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getClusterSelsFromGlmnet&#39;)getClusterSelsFromGlmnet.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getCssDesign&#39;)getCssDesign.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getCssPreds&#39;)getCssPreds.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getCssSelections&#39;)getCssSelections.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getLassoLambda&#39;)getLassoLambda.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getModelSize&#39;)getModelSize.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getPrototypes&#39;)getPrototypes.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getSelMatrix&#39;)getSelMatrix.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getSelectedClusters&#39;)getSelectedClusters.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getSelectedSets&#39;)getSelectedSets.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getSelectionPrototypes&#39;)getSelectionPrototypes.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getSubsamps&#39;)getSubsamps.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;getXglmnet&#39;)getXglmnet.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;identifyPrototype&#39;)identifyPrototype.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;makeCoefficients&#39;)makeCoefficients.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;makeCovarianceMatrix&#39;)makeCovarianceMatrix.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;print.cssr&#39;)print.cssr.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;printCssDf&#39;)printCssDf.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;processClusterLassoInputs&#39;)processClusterLassoInputs.Rd]8;;&#39;
## Writing &#39;]8;;ide:run:pkgload::dev_help(&#39;protolasso&#39;)protolasso.Rd]8;;&#39;</code></pre>
<div id="add-readme" class="section level2 hasAnchor" number="9.1">
<h2 class="hasAnchor"><span class="header-section-number">9.1</span> Add README<a href="#add-readme" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>litr<span class="sc">::</span><span class="fu">add_readme</span>(<span class="st">&quot;../source-files/README.Rmd&quot;</span>)</span></code></pre></div>
<pre><code>## ✔ Writing &#39;README.Rmd&#39;
## ✔ Adding &#39;^README\\.Rmd$&#39; to &#39;.Rbuildignore&#39;
## ✔ Creating &#39;.git/hooks/&#39;
## ✔ Writing &#39;.git/hooks/pre-commit&#39;</code></pre>
<!--chapter:end:index.Rmd-->
</div>
</div>
<!--bookdown:body:end-->
            </section>

          </div>
        </div>
      </div>
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
    </div>
  </div>
<!--bookdown:config-->

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
